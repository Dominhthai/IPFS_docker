0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const N1=O1,B1=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class L1{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class M1{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return F1(this,e)}}class U1{constructor(e){this.decoders=e}or(e){return F1(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const F1=(e,t)=>new U1({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class K1{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new L1(e,t,n),this.decoder=new M1(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const j1=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new K1(t,n,r,i)},Z1=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=N1(r,n);return j1({prefix:t,name:n,encode:i,decode:e=>B1(o(e))})},z1=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return j1({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},V1=Z1({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),H1=Z1({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),q1=Z1({prefix:"9",name:"base10",alphabet:"0123456789"}),G1=z1({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),W1=z1({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Q1=z1({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Y1=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),J1=Y1.reduce(((e,t,n)=>(e[n]=t,e)),[]),X1=Y1.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const $1=j1({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=J1[t]),"")},decode:function(e){const t=[];for(const n of e){const e=X1[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),e2=z1({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),t2=z1({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),n2=z1({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),r2=z1({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),i2=z1({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),o2=z1({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),s2=z1({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),a2=z1({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),c2=z1({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),l2=Z1({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),u2=Z1({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),h2=z1({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),d2=z1({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),f2=z1({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),p2=z1({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),g2=z1({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),y2=j1({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),m2=new TextEncoder,v2=new TextDecoder,b2="json",w2=512,E2=e=>m2.encode(JSON.stringify(e)),A2=e=>JSON.parse(v2.decode(e)),S2="raw",_2=85,I2=e=>B1(e),C2=e=>B1(e);var T2=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=x2;)n[r++]=255&t|k2,t/=128;for(;t&R2;)n[r++]=255&t|k2,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},k2=128,R2=-128,x2=Math.pow(2,31);var P2=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&O2)<<o:(r&O2)*Math.pow(2,o),o+=7}while(r>=D2);return e.bytes=s-n,i},D2=128,O2=127;var N2=Math.pow(2,7),B2=Math.pow(2,14),L2=Math.pow(2,21),M2=Math.pow(2,28),U2=Math.pow(2,35),F2=Math.pow(2,42),K2=Math.pow(2,49),j2=Math.pow(2,56),Z2=Math.pow(2,63);const z2={encode:T2,decode:P2,encodingLength:function(e){return e<N2?1:e<B2?2:e<L2?3:e<M2?4:e<U2?5:e<F2?6:e<K2?7:e<j2?8:e<Z2?9:10}},V2=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[z2.decode(e,t),z2.decode.bytes]},H2=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return z2.encode(e,t,n),t},q2=e=>z2.encodingLength(e),G2=(e,t)=>{const n=t.byteLength,r=q2(e),i=r+q2(n),o=new Uint8Array(i+n);return H2(e,o,0),H2(n,o,r),o.set(t,i),new Q2(e,n,t,o)},W2=e=>{const t=B1(e),[n,r]=V2(t),[i,o]=V2(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new Q2(n,i,s,t)};class Q2{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const Y2=B1,J2={code:0,name:"identity",encode:Y2,digest:e=>G2(0,Y2(e))},X2=e=>{let{name:t,code:n,encode:r}=e;return new $2(t,n,r)};class $2{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?G2(this.code,t):t.then((e=>G2(this.code,e)))}throw Error("Unknown type, must be binary type")}}const e3=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),t3=X2({name:"sha2-256",code:18,encode:e3("SHA-256")}),n3=X2({name:"sha2-512",code:19,encode:e3("SHA-512")}),r3=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?c3(n,o3(e),t||V1.encoder):l3(n,o3(e),t||e2.encoder)},i3=new WeakMap,o3=e=>{const t=i3.get(e);if(null==t){const t=new Map;return i3.set(e,t),t}return t};class s3{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==u3)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==h3)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return s3.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=G2(e,t);return s3.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return s3.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return r3(this,e)}toJSON(){return{"/":r3(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof s3)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new s3(e,n,r,i||d3(e,n,r.bytes))}if(!0===t[f3]){const{version:e,multihash:n,code:r}=t,i=W2(n);return s3.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==u3)throw new Error("Version 0 CID must use dag-pb (code: ".concat(u3,") block encoding"));return new s3(e,t,n,n.bytes);case 1:{const r=d3(e,t,n.bytes);return new s3(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return s3.create(0,u3,e)}static createV1(e,t){return s3.create(1,e,t)}static decode(e){const[t,n]=s3.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=s3.inspectBytes(e),n=t.size-t.multihashSize,r=B1(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new Q2(t.multihashCode,t.digestSize,i,r);return[0===t.version?s3.createV0(o):s3.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=V2(e.subarray(t));return t+=r,n};let r=n(),i=u3;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=a3(e,t),i=s3.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return o3(i).set(n,e),i}}const a3=(e,t)=>{switch(e[0]){case"Q":{const n=t||V1;return[V1.prefix,n.decode("".concat(V1.prefix).concat(e))]}case V1.prefix:{const n=t||V1;return[V1.prefix,n.decode(e)]}case e2.prefix:{const n=t||e2;return[e2.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},c3=(e,t,n)=>{const{prefix:r}=n;if(r!==V1.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},l3=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},u3=112,h3=18,d3=(e,t,n)=>{const r=q2(e),i=r+q2(t),o=new Uint8Array(i+n.byteLength);return H2(e,o,0),H2(t,o,r),o.set(n,i),o},f3=Symbol.for("@ipld/js-cid/CID"),p3={...Pn,...In,...xn,...Sn,..._n,...Tn,...kn,...An,...Rn,...Cn};let g3;const y3=Symbol.for("nodejs.util.inspect.custom"),m3=Object.values(p3).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),p3.identity.decoder),v3=114,b3=36,w3=37;g3=Symbol.toStringTag;class E3{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,pu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[g3](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=V1.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return s3.createV1(v3,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:m3,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=W2(V1.decode("z".concat(e)));return e.startsWith("12D")?new S3({multihash:t}):e.startsWith("16U")?new _3({multihash:t}):new A3({multihash:t})}return I3(m3.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[y3](){return"PeerId(".concat(this.toString(),")")}}class A3 extends E3{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class S3 extends E3{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class _3 extends E3{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function I3(e){try{const t=W2(e);if(t.code===J2.code){if(t.digest.length===b3)return new S3({multihash:t});if(t.digest.length===w3)return new _3({multihash:t})}if(t.code===t3.code)return new A3({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==v3)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===t3.code)return new A3({multihash:e.multihash});if(t.code===J2.code){if(t.digest.length===b3)return new S3({multihash:e.multihash});if(t.digest.length===w3)return new _3({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(s3.decode(e))}throw new Error("Supplied PeerID CID is invalid")}const C3="lock:worker:request-read",T3="lock:worker:release-read",k3="lock:master:grant-read",R3="lock:worker:request-write",x3="lock:worker:release-write",P3="lock:master:grant-write",D3={},O3=e=>{e.addEventListener("message",(t=>{O3.dispatchEvent("message",e,t)})),null!=e.port&&e.port.addEventListener("message",(t=>{O3.dispatchEvent("message",e,t)}))};O3.addEventListener=(e,t)=>{null==D3[e]&&(D3[e]=[]),D3[e].push(t)},O3.removeEventListener=(e,t)=>{null!=D3[e]&&(D3[e]=D3[e].filter((e=>e===t)))},O3.dispatchEvent=function(e,t,n){null!=D3[e]&&D3[e].forEach((e=>e(t,n)))};const N3=O3,B3=(e,t,n,r,i)=>(o,s)=>{if(s.data.type!==n)return;const a={type:s.data.type,name:s.data.name,identifier:s.data.identifier};e.dispatchEvent(new MessageEvent(t,{data:{name:a.name,handler:async()=>(o.postMessage({type:i,name:a.name,identifier:a.identifier}),await new Promise((e=>{const t=n=>{if(null==n||null==n.data)return;const i=n.data.type,s=(n.data.name,n.data.identifier);i===r&&s===a.identifier&&(o.removeEventListener("message",t),e())};o.addEventListener("message",t)})))}}))},L3=(e,t,n,r)=>async()=>{const i=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),"")}();return globalThis.postMessage({type:t,identifier:i,name:e}),await new Promise((t=>{const o=s=>{if(null==s||null==s.data)return;const a=s.data.type,c=s.data.identifier;a===n&&c===i&&(globalThis.removeEventListener("message",o),t((()=>{globalThis.postMessage({type:r,identifier:i,name:e})})))};globalThis.addEventListener("message",o)}))},M3={singleProcess:!1},U3={};let F3;async function K3(e,t){let n;const r=new Promise((e=>{n=e}));return e.add((async()=>await hL((async()=>await new Promise((e=>{n((()=>{e()}))})))(),{milliseconds:t.timeout}))),await r}const j3={name:"lock",concurrency:1/0,timeout:846e5,singleProcess:!1};function Z3(e){const t=Object.assign({},j3,e);return null==F3&&(F3=(e=>{if(e=Object.assign({},M3,e),Boolean(globalThis.document)||e.singleProcess){const e=new EventTarget;return N3.addEventListener("message",B3(e,"requestReadLock",C3,T3,k3)),N3.addEventListener("message",B3(e,"requestWriteLock",R3,x3,P3)),e}return{isWorker:!0,readLock:e=>L3(e,C3,k3,T3),writeLock:e=>L3(e,R3,P3,x3)}})(t),!0!==F3.isWorker&&(F3.addEventListener("requestReadLock",(e=>{null!=U3[e.data.name]&&U3[e.data.name].readLock().then((async t=>await e.data.handler().finally((()=>t()))))})),F3.addEventListener("requestWriteLock",(async e=>{null!=U3[e.data.name]&&U3[e.data.name].writeLock().then((async t=>await e.data.handler().finally((()=>t()))))})))),null==U3[t.name]&&(U3[t.name]=((e,t)=>{if(!0===F3.isWorker)return{readLock:F3.readLock(e,t),writeLock:F3.writeLock(e,t)};const n=new Fm.Z({concurrency:1});let r;return{async readLock(){if(null!=r)return await K3(r,t);r=new Fm.Z({concurrency:t.concurrency,autoStart:!1});const e=r,i=K3(r,t);return n.add((async()=>(e.start(),await e.onIdle().then((()=>{r===e&&(r=null)}))))),await i},writeLock:async()=>(r=null,await K3(n,t))}})(t.name,t)),U3[t.name]}const z3={ERR_INVALID_PARAMETERS:"ERR_INVALID_PARAMETERS"};var V3,H3,q3;function G3(e,t){var n;const r=V3.decode(t);null!=r.publicKey&&null==e.publicKey&&(e=function(e){if("RSA"===e.type)return new A3(e);if("Ed25519"===e.type)return new S3(e);if("secp256k1"===e.type)return new _3(e);throw new pu.sv("Not a PeerId","ERR_INVALID_PARAMETERS")}({...e,publicKey:e.publicKey}));const i=new Map,o=BigInt(Date.now());for(const[s,a]of r.tags.entries())null!=a.expiry&&a.expiry<o||i.set(s,a);return{...r,id:e,addresses:r.addresses.map((e=>{let{multiaddr:t,isCertified:n}=e;return{multiaddr:(0,og.HM)(t),isCertified:null!==n&&void 0!==n&&n}})),metadata:r.metadata,peerRecordEnvelope:null!==(n=r.peerRecordEnvelope)&&void 0!==n?n:void 0,tags:i}}!function(e){let t,n,r;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&e.value.byteLength>0&&(t.uint32(18),t.bytes(e.value)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:"",value:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(t=e.Peer$metadataEntry||(e.Peer$metadataEntry={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.key&&""!==e.key&&(t.uint32(10),t.string(e.key)),null!=e.value&&(t.uint32(18),q3.codec().encode(e.value,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={key:""},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.key=e.string();break;case 2:n.value=q3.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(n=e.Peer$tagsEntry||(e.Peer$tagsEntry={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.addresses)for(const e of t.addresses)n.uint32(10),H3.codec().encode(e,n);if(null!=t.protocols)for(const e of t.protocols)n.uint32(18),n.string(e);if(null!=t.publicKey&&(n.uint32(34),n.bytes(t.publicKey)),null!=t.peerRecordEnvelope&&(n.uint32(42),n.bytes(t.peerRecordEnvelope)),null!=t.metadata&&0!==t.metadata.size)for(const[i,o]of t.metadata.entries())n.uint32(50),e.Peer$metadataEntry.codec().encode({key:i,value:o},n);if(null!=t.tags&&0!==t.tags.size)for(const[i,o]of t.tags.entries())n.uint32(58),e.Peer$tagsEntry.codec().encode({key:i,value:o},n);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={addresses:[],protocols:[],metadata:new Map,tags:new Map},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.addresses.push(H3.codec().decode(t,t.uint32()));break;case 2:r.protocols.push(t.string());break;case 4:r.publicKey=t.bytes();break;case 5:r.peerRecordEnvelope=t.bytes();break;case 6:{const n=e.Peer$metadataEntry.codec().decode(t,t.uint32());r.metadata.set(n.key,n.value);break}case 7:{const n=e.Peer$tagsEntry.codec().decode(t,t.uint32());r.tags.set(n.key,n.value);break}default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(V3||(V3={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),null!=e.isCertified&&(t.uint32(16),t.bool(e.isCertified)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.multiaddr=e.bytes();break;case 2:n.isCertified=e.bool();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(H3||(H3={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.value&&0!==e.value&&(t.uint32(8),t.uint32(e.value)),null!=e.expiry&&(t.uint32(16),t.uint64(e.expiry)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={value:0},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.value=e.uint32();break;case 2:n.expiry=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(q3||(q3={}));let W3;const Q3="/",Y3=(new TextEncoder).encode(Q3),J3=Y3[0];W3=Symbol.toStringTag;class X3{constructor(e,t){if((0,Yo.Z)(this,"_buf",void 0),"string"===typeof e)this._buf=(0,mu.m)(e);else{if(!(e instanceof Uint8Array))throw new Error("Invalid key, should be String of Uint8Array");this._buf=e}if(null==t&&(t=!0),t&&this.clean(),0===this._buf.byteLength||this._buf[0]!==J3)throw new Error("Invalid key")}toString(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"utf8";return(0,Su.B)(this._buf,e)}uint8Array(){return this._buf}get[W3](){return"Key(".concat(this.toString(),")")}static withNamespaces(e){return new X3(e.join(Q3))}static random(){return new X3(function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:21;return crypto.getRandomValues(new Uint8Array(e)).reduce(((e,t)=>e+((t&=63)<36?t.toString(36):t<62?(t-26).toString(36).toUpperCase():t>62?"-":"_")),"")}().replace(/-/g,""))}static asKey(e){return e instanceof Uint8Array||"string"===typeof e?new X3(e):"function"===typeof e.uint8Array?new X3(e.uint8Array()):null}clean(){if(null!=this._buf&&0!==this._buf.byteLength||(this._buf=Y3),this._buf[0]!==J3){const e=new Uint8Array(this._buf.byteLength+1);e.fill(J3,0,1),e.set(this._buf,1),this._buf=e}for(;this._buf.byteLength>1&&this._buf[this._buf.byteLength-1]===J3;)this._buf=this._buf.subarray(0,-1)}less(e){const t=this.list(),n=e.list();for(let r=0;r<t.length;r++){if(n.length<r+1)return!1;const e=t[r],i=n[r];if(e<i)return!0;if(e>i)return!1}return t.length<n.length}reverse(){return X3.withNamespaces(this.list().slice().reverse())}namespaces(){return this.list()}baseNamespace(){const e=this.namespaces();return e[e.length-1]}list(){return this.toString().split(Q3).slice(1)}type(){return function(e){const t=e.split(":");if(t.length<2)return"";return t.slice(0,-1).join(":")}(this.baseNamespace())}name(){return function(e){const t=e.split(":");return t[t.length-1]}(this.baseNamespace())}instance(e){return new X3(this.toString()+":"+e)}path(){let e=this.parent().toString();return e.endsWith(Q3)||(e+=Q3),e+=this.type(),new X3(e)}parent(){const e=this.list();return 1===e.length?new X3(Q3):new X3(e.slice(0,-1).join(Q3))}child(e){return this.toString()===Q3?e:e.toString()===Q3?this:new X3(this.toString()+e.toString(),!1)}isAncestorOf(e){return e.toString()!==this.toString()&&e.toString().startsWith(this.toString())}isDecendantOf(e){return e.toString()!==this.toString()&&this.toString().startsWith(e.toString())}isTopLevel(){return 1===this.list().length}concat(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return X3.withNamespaces([...this.namespaces(),...(r=t.map((e=>e.namespaces())),[].concat(...r))]);var r}}const $3="/peers/";function e5(e){if(!(0,pu.I$)(e)||null==e.type)throw new pu.sv("Invalid PeerId",z3.ERR_INVALID_PARAMETERS);const t=e.toCID().toString();return new X3("".concat($3).concat(t))}async function t5(e,t,n){const r=new Map;for(const o of n){var i;if(null==o)continue;if(o.multiaddr instanceof Uint8Array&&(o.multiaddr=(0,og.HM)(o.multiaddr)),!(0,og.h2)(o.multiaddr))throw new pu.sv("Multiaddr was invalid",z3.ERR_INVALID_PARAMETERS);if(!await t(e,o.multiaddr))continue;const n=null!==(i=o.isCertified)&&void 0!==i&&i,s=o.multiaddr.toString(),a=r.get(s);null!=a?o.isCertified=a.isCertified||n:r.set(s,{multiaddr:o.multiaddr,isCertified:n})}return[...r.values()].sort(((e,t)=>e.multiaddr.toString().localeCompare(t.multiaddr.toString()))).map((e=>{let{isCertified:t,multiaddr:n}=e;return{isCertified:t,multiaddr:n.bytes}}))}async function n5(e,t,n,r){var i,o,s,a,c,l,u;if(null==t)throw new pu.sv("Invalid PeerData",z3.ERR_INVALID_PARAMETERS);if(null!=t.publicKey&&null!=e.publicKey&&!(0,Ms.f)(t.publicKey,e.publicKey))throw new pu.sv("publicKey bytes do not match peer id publicKey bytes",z3.ERR_INVALID_PARAMETERS);const h=r.existingPeer;if(null!=h&&!e.equals(h.id))throw new pu.sv("peer id did not match existing peer id",z3.ERR_INVALID_PARAMETERS);let d=null!==(i=null===h||void 0===h?void 0:h.addresses)&&void 0!==i?i:[],f=new Set(null!==(o=null===h||void 0===h?void 0:h.protocols)&&void 0!==o?o:[]),p=null!==(s=null===h||void 0===h?void 0:h.metadata)&&void 0!==s?s:new Map,g=null!==(a=null===h||void 0===h?void 0:h.tags)&&void 0!==a?a:new Map,y=null===h||void 0===h?void 0:h.peerRecordEnvelope;if("patch"===n){if(null==t.multiaddrs&&null==t.addresses||(d=[],null!=t.multiaddrs&&d.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&d.push(...t.addresses)),null!=t.protocols&&(f=new Set(t.protocols)),null!=t.metadata){p=r5(t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata),{validate:i5})}if(null!=t.tags){g=r5(t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),{validate:o5,map:s5})}null!=t.peerRecordEnvelope&&(y=t.peerRecordEnvelope)}if("merge"===n){if(null!=t.multiaddrs&&d.push(...t.multiaddrs.map((e=>({isCertified:!1,multiaddr:e})))),null!=t.addresses&&d.push(...t.addresses),null!=t.protocols&&(f=new Set([...f,...t.protocols])),null!=t.metadata){const e=t.metadata instanceof Map?[...t.metadata.entries()]:Object.entries(t.metadata);for(const[t,n]of e)null==n?p.delete(t):p.set(t,n);p=r5([...p.entries()],{validate:i5})}if(null!=t.tags){const e=t.tags instanceof Map?[...t.tags.entries()]:Object.entries(t.tags),n=new Map(g);for(const[t,r]of e)null==r?n.delete(t):n.set(t,r);g=r5([...n.entries()],{validate:o5,map:s5})}null!=t.peerRecordEnvelope&&(y=t.peerRecordEnvelope)}const m={addresses:await t5(e,null!==(c=r.addressFilter)&&void 0!==c?c:async()=>!0,d),protocols:[...f.values()].sort(((e,t)=>e.localeCompare(t))),metadata:p,tags:g,publicKey:null!==(l=null!==(u=null===h||void 0===h?void 0:h.id.publicKey)&&void 0!==u?u:t.publicKey)&&void 0!==l?l:e.publicKey,peerRecordEnvelope:y};return"RSA"!==e.type&&delete m.publicKey,m}function r5(e,t){const n=new Map;for(const[o,s]of e)null!=s&&t.validate(o,s);for(const[o,s]of e.sort(((e,t)=>{let[n]=e,[r]=t;return n.localeCompare(r)}))){var r,i;if(null!=s)n.set(o,null!==(r=null===(i=t.map)||void 0===i?void 0:i.call(t,o,s))&&void 0!==r?r:s)}return n}function i5(e,t){if("string"!==typeof e)throw new pu.sv("Metadata key must be a string",z3.ERR_INVALID_PARAMETERS);if(!(t instanceof Uint8Array))throw new pu.sv("Metadata value must be a Uint8Array",z3.ERR_INVALID_PARAMETERS)}function o5(e,t){if("string"!==typeof e)throw new pu.sv("Tag name must be a string",z3.ERR_INVALID_PARAMETERS);if(null!=t.value){if(parseInt("".concat(t.value),10)!==t.value)throw new pu.sv("Tag value must be an integer",z3.ERR_INVALID_PARAMETERS);if(t.value<0||t.value>100)throw new pu.sv("Tag value must be between 0-100",z3.ERR_INVALID_PARAMETERS)}if(null!=t.ttl){if(parseInt("".concat(t.ttl),10)!==t.ttl)throw new pu.sv("Tag ttl must be an integer",z3.ERR_INVALID_PARAMETERS);if(t.ttl<0)throw new pu.sv("Tag ttl must be between greater than 0",z3.ERR_INVALID_PARAMETERS)}}function s5(e,t){var n;let r;return null!=t.expiry&&(r=t.expiry),null!=t.ttl&&(r=BigInt(Date.now()+Number(t.ttl))),{value:null!==(n=t.value)&&void 0!==n?n:0,expiry:r}}function a5(e,t,n){const r=e.toString().split("/")[2],i=I3(e2.decode(r)),o=n.get(i);if(null!=o)return o;const s=G3(i,t);return n.set(i,s),s}var c5=new WeakSet,l5=new WeakSet;class u5{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Jd(this,l5),Jd(this,c5),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"datastore",void 0),(0,Yo.Z)(this,"lock",void 0),(0,Yo.Z)(this,"addressFilter",void 0),this.peerId=e.peerId,this.datastore=e.datastore,this.addressFilter=t.addressFilter,this.lock=Z3({name:"peer-store",singleProcess:!0})}async has(e){return this.datastore.has(e5(e))}async delete(e){if(this.peerId.equals(e))throw new pu.sv("Cannot delete self peer",z3.ERR_INVALID_PARAMETERS);await this.datastore.delete(e5(e))}async load(e){return G3(e,await this.datastore.get(e5(e)))}async save(e,t){const{existingBuf:n,existingPeer:r}=await Xd(this,c5,h5).call(this,e),i=await n5(e,t,"patch",{addressFilter:this.addressFilter});return Xd(this,l5,d5).call(this,e,i,n,r)}async patch(e,t){const{existingBuf:n,existingPeer:r}=await Xd(this,c5,h5).call(this,e),i=await n5(e,t,"patch",{addressFilter:this.addressFilter,existingPeer:r});return Xd(this,l5,d5).call(this,e,i,n,r)}async merge(e,t){const{existingBuf:n,existingPeer:r}=await Xd(this,c5,h5).call(this,e),i=await n5(e,t,"merge",{addressFilter:this.addressFilter,existingPeer:r});return Xd(this,l5,d5).call(this,e,i,n,r)}async*all(e){const t=new Ex;for await(const{key:n,value:r}of this.datastore.query(function(e,t){var n,r;return null==e?{}:{prefix:$3,filters:(null!==(n=e.filters)&&void 0!==n?n:[]).map((e=>n=>{let{key:r,value:i}=n;return e(a5(r,i,t))})),orders:(null!==(r=e.orders)&&void 0!==r?r:[]).map((e=>(n,r)=>e(a5(n.key,n.value,t),a5(r.key,r.value,t))))}}(null!==e&&void 0!==e?e:{},t))){const e=a5(n,r,t);e.id.equals(this.peerId)||(yield e)}}}async function h5(e){try{const t=await this.datastore.get(e5(e));return{existingBuf:t,existingPeer:G3(e,t)}}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}return{}}async function d5(e,t,n,r){const i=V3.encode(t);return null!=n&&(0,Ms.f)(i,n)?{peer:G3(e,i),previous:r,updated:!1}:(await this.datastore.put(e5(e),i),{peer:G3(e,i),previous:r,updated:!0})}var f5=new WeakSet;class p5{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Jd(this,f5),(0,Yo.Z)(this,"store",void 0),(0,Yo.Z)(this,"events",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"log",void 0),this.log=e.logger.forComponent("libp2p:peer-store"),this.events=e.events,this.peerId=e.peerId,this.store=new u5(e,t)}async forEach(e,t){this.log.trace("forEach await read lock");const n=await this.store.lock.readLock();this.log.trace("forEach got read lock");try{for await(const n of this.store.all(t))e(n)}finally{this.log.trace("forEach release read lock"),n()}}async all(e){this.log.trace("all await read lock");const t=await this.store.lock.readLock();this.log.trace("all got read lock");try{return await D1(this.store.all(e))}finally{this.log.trace("all release read lock"),t()}}async delete(e){this.log.trace("delete await write lock");const t=await this.store.lock.writeLock();this.log.trace("delete got write lock");try{await this.store.delete(e)}finally{this.log.trace("delete release write lock"),t()}}async has(e){this.log.trace("has await read lock");const t=await this.store.lock.readLock();this.log.trace("has got read lock");try{return await this.store.has(e)}finally{this.log.trace("has release read lock"),t()}}async get(e){this.log.trace("get await read lock");const t=await this.store.lock.readLock();this.log.trace("get got read lock");try{return await this.store.load(e)}finally{this.log.trace("get release read lock"),t()}}async save(e,t){this.log.trace("save await write lock");const n=await this.store.lock.writeLock();this.log.trace("save got write lock");try{const n=await this.store.save(e,t);return Xd(this,f5,g5).call(this,e,n),n.peer}finally{this.log.trace("save release write lock"),n()}}async patch(e,t){this.log.trace("patch await write lock");const n=await this.store.lock.writeLock();this.log.trace("patch got write lock");try{const n=await this.store.patch(e,t);return Xd(this,f5,g5).call(this,e,n),n.peer}finally{this.log.trace("patch release write lock"),n()}}async merge(e,t){this.log.trace("merge await write lock");const n=await this.store.lock.writeLock();this.log.trace("merge got write lock");try{const n=await this.store.merge(e,t);return Xd(this,f5,g5).call(this,e,n),n.peer}finally{this.log.trace("merge release write lock"),n()}}async consumePeerRecord(e,t){var n;const r=await sk.openAndCertify(e,uk.DOMAIN);if(!1===(null===t||void 0===t?void 0:t.equals(r.peerId)))return this.log("envelope peer id was not the expected peer id - expected: %p received: %p",t,r.peerId),!1;const i=uk.createFromProtobuf(r.payload);let o;try{o=await this.get(r.peerId)}catch(s){if("ERR_NOT_FOUND"!==s.code)throw s}if(null!=(null===(n=o)||void 0===n?void 0:n.peerRecordEnvelope)){const e=await sk.createFromProtobuf(o.peerRecordEnvelope),t=uk.createFromProtobuf(e.payload);if(t.seqNumber>=i.seqNumber)return this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,i.seqNumber),!1}return await this.patch(i.peerId,{peerRecordEnvelope:e,addresses:i.multiaddrs.map((e=>({isCertified:!0,multiaddr:e})))}),!0}}function g5(e,t){t.updated&&(this.peerId.equals(e)?this.events.safeDispatchEvent("self:peer:update",{detail:t}):this.events.safeDispatchEvent("peer:update",{detail:t}))}const y5=xH("libp2p:address-manager"),m5=e=>e;function v5(e,t){const n=e.getPeerId();if(null!=n){R1(n).equals(t)&&(e=e.decapsulate((0,og.HM)("/p2p/".concat(t.toString()))))}return e}class b5{constructor(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"listen",void 0),(0,Yo.Z)(this,"announce",void 0),(0,Yo.Z)(this,"observed",void 0),(0,Yo.Z)(this,"announceFilter",void 0);const{listen:r=[],announce:i=[]}=n;this.components=e,this.listen=r.map((e=>e.toString())),this.announce=new Set(i.map((e=>e.toString()))),this.observed=new Map,this.announceFilter=null!==(t=n.announceFilter)&&void 0!==t?t:m5,this._updatePeerStoreAddresses=function(e,t){let n;return function(){clearTimeout(n),n=setTimeout((function(){n=void 0,e()}),t)}}(this._updatePeerStoreAddresses.bind(this),1e3),e.events.addEventListener("transport:listening",(()=>{this._updatePeerStoreAddresses()})),e.events.addEventListener("transport:close",(()=>{this._updatePeerStoreAddresses()}))}_updatePeerStoreAddresses(){const e=this.getAnnounceAddrs().concat(this.components.transportManager.getAddrs()).concat([...this.observed.entries()].filter((e=>{let[t,n]=e;return n.confident})).map((e=>{let[t]=e;return(0,og.HM)(t)}))).map((e=>e.getPeerId()===this.components.peerId.toString()?e.decapsulate("/p2p/".concat(this.components.peerId.toString())):e));this.components.peerStore.patch(this.components.peerId,{multiaddrs:e}).catch((e=>{y5.error("error updating addresses",e)}))}getListenAddrs(){return Array.from(this.listen).map((e=>(0,og.HM)(e)))}getAnnounceAddrs(){return Array.from(this.announce).map((e=>(0,og.HM)(e)))}getObservedAddrs(){return Array.from(this.observed).map((e=>{let[t]=e;return(0,og.HM)(t)}))}addObservedAddr(e){const t=(e=v5(e,this.components.peerId)).toString();this.observed.has(t)||this.observed.set(t,{confident:!1})}confirmObservedAddr(e){var t;const n=(e=v5(e,this.components.peerId)).toString(),r=(null!==(t=this.observed.get(n))&&void 0!==t?t:{confident:!1}).confident;this.observed.set(n,{confident:!0}),r||this._updatePeerStoreAddresses()}removeObservedAddr(e){const t=(e=v5(e,this.components.peerId)).toString();this.observed.delete(t)}getAddresses(){let e=this.getAnnounceAddrs().map((e=>e.toString()));0===e.length&&(e=this.components.transportManager.getAddrs().map((e=>e.toString()))),e=e.concat(Array.from(this.observed).filter((e=>{let[t,n]=e;return n.confident})).map((e=>{let[t]=e;return t})));const t=new Set(e);return this.announceFilter(Array.from(t).map((e=>(0,og.HM)(e)))).map((e=>{var t;return!0===(null===(t=e.protos().pop())||void 0===t?void 0:t.path)||e.getPeerId()===this.components.peerId.toString()?e:e.encapsulate("/p2p/".concat(this.components.peerId.toString()))}))}}class w5{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"components",{}),(0,Yo.Z)(this,"_started",!1),this.components={};for(const[t,n]of Object.entries(e))this.components[t]=n;null==this.components.logger&&(this.components.logger=RH())}isStarted(){return this._started}async _invokeStartableMethod(e){await Promise.all(Object.values(this.components).filter((e=>zH(e))).map((async t=>{var n;await(null===(n=t[e])||void 0===n?void 0:n.call(t))})))}async beforeStart(){await this._invokeStartableMethod("beforeStart")}async start(){await this._invokeStartableMethod("start"),this._started=!0}async afterStart(){await this._invokeStartableMethod("afterStart")}async beforeStop(){await this._invokeStartableMethod("beforeStop")}async stop(){await this._invokeStartableMethod("stop"),this._started=!1}async afterStop(){await this._invokeStartableMethod("afterStop")}}const E5=["metrics","connectionProtector"],A5=["components","isStarted","beforeStart","start","afterStart","beforeStop","stop","afterStop","then","_invokeStartableMethod"];function S5(){return{denyDialPeer:async()=>!1,denyDialMultiaddr:async e=>{const t=e.stringTuples();return(4===t[0][0]||41===t[0][0])&&Boolean(SS("".concat(t[0][1])))},denyInboundConnection:async()=>!1,denyOutboundConnection:async()=>!1,denyInboundEncryptedConnection:async()=>!1,denyOutboundEncryptedConnection:async()=>!1,denyInboundUpgradedConnection:async()=>!1,denyOutboundUpgradedConnection:async()=>!1,filterMultiaddrForPeer:async()=>!0,...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}}const _5=Symbol.for("@libp2p/transport");var I5;function C5(e){try{const{address:t}=e.nodeAddress();return Boolean(SS(t))}catch{return!0}}function T5(e,t){const n=function(e,t){const n=C5(e.multiaddr),r=C5(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==n)return n;const r=function(e,t){const n=gO.dx.exactMatch(e.multiaddr),r=gO.dx.exactMatch(t.multiaddr);return n&&!r?1:!n&&r?-1:0}(e,t);if(0!==r)return r;const i=function(e,t){return e.isCertified&&!t.isCertified?-1:!e.isCertified&&t.isCertified?1:0}(e,t);return i}!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(I5||(I5={}));var k5=n(67024),R5=n(449),x5=n.n(R5);function P5(e,t,n){return"".concat(e,"?name=").concat(t,"&type=").concat(n)}async function D5(e,t){const n=await fetch(e,{headers:new Headers({accept:"application/dns-json"}),signal:t});return await n.json()}function O5(e,t){return"".concat(t,"_").concat(e)}const N5=Object.assign(cf()("dns-over-http-resolver"),{error:cf()("dns-over-http-resolver:error")});const B5=class{constructor(){var e,t,n;let r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"_cache",void 0),(0,Yo.Z)(this,"_TXTcache",void 0),(0,Yo.Z)(this,"_servers",void 0),(0,Yo.Z)(this,"_request",void 0),(0,Yo.Z)(this,"_abortControllers",void 0),this._cache=new(x5())({max:null!==(e=null===r||void 0===r?void 0:r.maxCache)&&void 0!==e?e:100}),this._TXTcache=new(x5())({max:null!==(t=null===r||void 0===r?void 0:r.maxCache)&&void 0!==t?t:100}),this._servers=["https://cloudflare-dns.com/dns-query","https://dns.google/resolve"],this._request=null!==(n=r.request)&&void 0!==n?n:D5,this._abortControllers=[]}cancel(){this._abortControllers.forEach((e=>{e.abort()}))}getServers(){return this._servers}_getShuffledServers(){const e=[...this._servers];for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*t),r=e[t];e[t]=e[n],e[n]=r}return e}setServers(e){this._servers=e}async resolve(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"A";switch(t){case"A":return this.resolve4(e);case"AAAA":return this.resolve6(e);case"TXT":return this.resolveTxt(e);default:throw new Error("".concat(t," is not supported"))}}async resolve4(e){const t="A",n=this._cache.get(O5(e,t));if(null!=n)return n;let r=!1;for(const o of this._getShuffledServers()){const n=new AbortController;this._abortControllers.push(n);try{const r=await this._request(P5(o,e,t),n.signal),i=r.Answer.map((e=>e.data)),s=Math.min(...r.Answer.map((e=>e.TTL)));return this._cache.set(O5(e,t),i,{ttl:s}),i}catch(i){n.signal.aborted&&(r=!0),N5.error("".concat(o," could not resolve ").concat(e," record ").concat(t))}finally{this._abortControllers=this._abortControllers.filter((e=>e!==n))}}if(r)throw Object.assign(new Error("queryA ECANCELLED"),{code:"ECANCELLED"});throw new Error("Could not resolve ".concat(e," record ").concat(t))}async resolve6(e){const t="AAAA",n=this._cache.get(O5(e,t));if(null!=n)return n;let r=!1;for(const o of this._getShuffledServers()){const n=new AbortController;this._abortControllers.push(n);try{const r=await this._request(P5(o,e,t),n.signal),i=r.Answer.map((e=>e.data)),s=Math.min(...r.Answer.map((e=>e.TTL)));return this._cache.set(O5(e,t),i,{ttl:s}),i}catch(i){n.signal.aborted&&(r=!0),N5.error("".concat(o," could not resolve ").concat(e," record ").concat(t))}finally{this._abortControllers=this._abortControllers.filter((e=>e!==n))}}if(r)throw Object.assign(new Error("queryAaaa ECANCELLED"),{code:"ECANCELLED"});throw new Error("Could not resolve ".concat(e," record ").concat(t))}async resolveTxt(e){const t="TXT",n=this._TXTcache.get(O5(e,t));if(null!=n)return n;let r=!1;for(const o of this._getShuffledServers()){const n=new AbortController;this._abortControllers.push(n);try{const r=await this._request(P5(o,e,t),n.signal),i=r.Answer.map((e=>[e.data.replace(/['"]+/g,"")])),s=Math.min(...r.Answer.map((e=>e.TTL)));return this._TXTcache.set(O5(e,t),i,{ttl:s}),i}catch(i){n.signal.aborted&&(r=!0),N5.error("".concat(o," could not resolve ").concat(e," record ").concat(t))}finally{this._abortControllers=this._abortControllers.filter((e=>e!==n))}}if(r)throw Object.assign(new Error("queryTxt ECANCELLED"),{code:"ECANCELLED"});throw new Error("Could not resolve ".concat(e," record ").concat(t))}clearCache(){this._cache.clear(),this._TXTcache.clear()}},{code:L5}=(0,k5.Ev)("dnsaddr");async function M5(e,t={}){const n=new B5;null!=t.signal&&t.signal.addEventListener("abort",(()=>{n.cancel()}));const r=e.getPeerId(),[,i]=e.stringTuples().find((([e])=>e===L5))??[];if(null==i)throw new Error("No hostname found in multiaddr");let o=(await n.resolveTxt(`_dnsaddr.${i}`)).flat().map((e=>e.split("=")[1])).filter(Boolean);return null!=r&&(o=o.filter((e=>e.includes(r)))),o}var U5,F5;!function(e){e.NOT_STARTED_YET="The libp2p node is not started yet",e.DHT_DISABLED="DHT is not available",e.PUBSUB_DISABLED="PubSub is not available",e.CONN_ENCRYPTION_REQUIRED="At least one connection encryption module is required",e.ERR_TRANSPORTS_REQUIRED="At least one transport module is required",e.ERR_PROTECTOR_REQUIRED="Private network is enforced, but no protector was provided",e.NOT_FOUND="Not found"}(U5||(U5={})),function(e){e.DHT_DISABLED="ERR_DHT_DISABLED",e.ERR_PUBSUB_DISABLED="ERR_PUBSUB_DISABLED",e.PUBSUB_NOT_STARTED="ERR_PUBSUB_NOT_STARTED",e.DHT_NOT_STARTED="ERR_DHT_NOT_STARTED",e.CONN_ENCRYPTION_REQUIRED="ERR_CONN_ENCRYPTION_REQUIRED",e.ERR_TRANSPORTS_REQUIRED="ERR_TRANSPORTS_REQUIRED",e.ERR_PROTECTOR_REQUIRED="ERR_PROTECTOR_REQUIRED",e.ERR_PEER_DIAL_INTERCEPTED="ERR_PEER_DIAL_INTERCEPTED",e.ERR_CONNECTION_INTERCEPTED="ERR_CONNECTION_INTERCEPTED",e.ERR_INVALID_PROTOCOLS_FOR_STREAM="ERR_INVALID_PROTOCOLS_FOR_STREAM",e.ERR_CONNECTION_ENDED="ERR_CONNECTION_ENDED",e.ERR_CONNECTION_FAILED="ERR_CONNECTION_FAILED",e.ERR_NODE_NOT_STARTED="ERR_NODE_NOT_STARTED",e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_TOO_MANY_ADDRESSES="ERR_TOO_MANY_ADDRESSES",e.ERR_NO_VALID_ADDRESSES="ERR_NO_VALID_ADDRESSES",e.ERR_RELAYED_DIAL="ERR_RELAYED_DIAL",e.ERR_DIALED_SELF="ERR_DIALED_SELF",e.ERR_DISCOVERED_SELF="ERR_DISCOVERED_SELF",e.ERR_DUPLICATE_TRANSPORT="ERR_DUPLICATE_TRANSPORT",e.ERR_ENCRYPTION_FAILED="ERR_ENCRYPTION_FAILED",e.ERR_HOP_REQUEST_FAILED="ERR_HOP_REQUEST_FAILED",e.ERR_INVALID_KEY="ERR_INVALID_KEY",e.ERR_INVALID_MESSAGE="ERR_INVALID_MESSAGE",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_INVALID_PEER="ERR_INVALID_PEER",e.ERR_MUXER_UNAVAILABLE="ERR_MUXER_UNAVAILABLE",e.ERR_NOT_FOUND="ERR_NOT_FOUND",e.ERR_TIMEOUT="ERR_TIMEOUT",e.ERR_TRANSPORT_UNAVAILABLE="ERR_TRANSPORT_UNAVAILABLE",e.ERR_TRANSPORT_DIAL_FAILED="ERR_TRANSPORT_DIAL_FAILED",e.ERR_UNSUPPORTED_PROTOCOL="ERR_UNSUPPORTED_PROTOCOL",e.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED="ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_SIGNATURE_NOT_VALID="ERR_SIGNATURE_NOT_VALID",e.ERR_FIND_SELF="ERR_FIND_SELF",e.ERR_NO_ROUTERS_AVAILABLE="ERR_NO_ROUTERS_AVAILABLE",e.ERR_CONNECTION_NOT_MULTIPLEXED="ERR_CONNECTION_NOT_MULTIPLEXED",e.ERR_NO_DIAL_TOKENS="ERR_NO_DIAL_TOKENS",e.ERR_KEYCHAIN_REQUIRED="ERR_KEYCHAIN_REQUIRED",e.ERR_INVALID_CMS="ERR_INVALID_CMS",e.ERR_MISSING_KEYS="ERR_MISSING_KEYS",e.ERR_NO_KEY="ERR_NO_KEY",e.ERR_INVALID_KEY_NAME="ERR_INVALID_KEY_NAME",e.ERR_INVALID_KEY_TYPE="ERR_INVALID_KEY_TYPE",e.ERR_KEY_ALREADY_EXISTS="ERR_KEY_ALREADY_EXISTS",e.ERR_INVALID_KEY_SIZE="ERR_INVALID_KEY_SIZE",e.ERR_KEY_NOT_FOUND="ERR_KEY_NOT_FOUND",e.ERR_OLD_KEY_NAME_INVALID="ERR_OLD_KEY_NAME_INVALID",e.ERR_NEW_KEY_NAME_INVALID="ERR_NEW_KEY_NAME_INVALID",e.ERR_PASSWORD_REQUIRED="ERR_PASSWORD_REQUIRED",e.ERR_PEM_REQUIRED="ERR_PEM_REQUIRED",e.ERR_CANNOT_READ_KEY="ERR_CANNOT_READ_KEY",e.ERR_MISSING_PRIVATE_KEY="ERR_MISSING_PRIVATE_KEY",e.ERR_MISSING_PUBLIC_KEY="ERR_MISSING_PUBLIC_KEY",e.ERR_INVALID_OLD_PASS_TYPE="ERR_INVALID_OLD_PASS_TYPE",e.ERR_INVALID_NEW_PASS_TYPE="ERR_INVALID_NEW_PASS_TYPE",e.ERR_INVALID_PASS_LENGTH="ERR_INVALID_PASS_LENGTH",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_WRONG_PING_ACK="ERR_WRONG_PING_ACK",e.ERR_INVALID_RECORD="ERR_INVALID_RECORD",e.ERR_ALREADY_SUCCEEDED="ERR_ALREADY_SUCCEEDED",e.ERR_NO_HANDLER_FOR_PROTOCOL="ERR_NO_HANDLER_FOR_PROTOCOL",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_CONNECTION_DENIED="ERR_CONNECTION_DENIED",e.ERR_TRANSFER_LIMIT_EXCEEDED="ERR_TRANSFER_LIMIT_EXCEEDED"}(F5||(F5={}));const K5={addresses:{listen:[],announce:[],noAnnounce:[],announceFilter:e=>e},connectionManager:{resolvers:{dnsaddr:M5},addressSorter:T5},transportManager:{faultTolerance:I5.FATAL_ALL}};var j5=n(57896);const Z5=xH("libp2p:get-peer");function z5(e){if(a1(e))return{peerId:e,multiaddrs:[]};let t;if(Array.isArray(e)||(e=[e]),e.length>0){const n=e[0].getPeerId();t=null==n?void 0:R1(n),e.forEach((e=>{if(!(0,og.h2)(e))throw Z5.error("multiaddr %s was invalid",e),new Pq("Invalid Multiaddr",F5.ERR_INVALID_MULTIADDR);const n=e.getPeerId();if(null==n){if(null!=t)throw new Pq("Multiaddrs must all have the same peer id or have no peer id",F5.ERR_INVALID_PARAMETERS)}else{const e=R1(n);if(null==t||!t.equals(e))throw new Pq("Multiaddrs must all have the same peer id or have no peer id",F5.ERR_INVALID_PARAMETERS)}}))}return{peerId:t,multiaddrs:e}}var V5=new WeakMap;class H5{constructor(){(0,_x.Z)(this,V5,{writable:!0,value:[]})}enqueue(e,t){var n;const r=null===t||void 0===t?void 0:t.peerId,i=null!==(n=null===t||void 0===t?void 0:t.priority)&&void 0!==n?n:0;if(null==r)throw new Pq("missing peer id",F5.ERR_INVALID_PARAMETERS);const o={priority:i,peerId:r,run:e};if(this.size>0&&(0,Ix.Z)(this,V5)[this.size-1].priority>=i)return void(0,Ix.Z)(this,V5).push(o);const s=function(e,t,n){let r=0,i=e.length;for(;i>0;){const o=Math.trunc(i/2);let s=r+o;n(e[s],t)<=0?(r=++s,i-=o+1):i=o}return r}((0,Ix.Z)(this,V5),o,((e,t)=>t.priority-e.priority));(0,Ix.Z)(this,V5).splice(s,0,o)}dequeue(){const e=(0,Ix.Z)(this,V5).shift();return null===e||void 0===e?void 0:e.run}filter(e){if(null!=e.peerId){const t=e.peerId;return(0,Ix.Z)(this,V5).filter((e=>t.equals(e.peerId))).map((e=>e.run))}return(0,Ix.Z)(this,V5).filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return(0,Ix.Z)(this,V5).length}}class q5 extends Fm.Z{constructor(){super({...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},queueClass:H5})}hasJob(e){return this.sizeBy({peerId:e})>0}}const G5=100,W5="last-dial-failure",Q5={minConnections:5,maxQueueLength:100,autoDialConcurrency:25,autoDialPriority:0,autoDialInterval:5e3,autoDialPeerRetryThreshold:42e4,autoDialDiscoveredPeersDebounce:10};var Y5=new WeakMap;class J5{constructor(e,t){var n,r,i,o,s,a,c;let l;(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"queue",void 0),(0,Yo.Z)(this,"minConnections",void 0),(0,Yo.Z)(this,"autoDialPriority",void 0),(0,Yo.Z)(this,"autoDialIntervalMs",void 0),(0,Yo.Z)(this,"autoDialMaxQueueLength",void 0),(0,Yo.Z)(this,"autoDialPeerRetryThresholdMs",void 0),(0,Yo.Z)(this,"autoDialDiscoveredPeersDebounce",void 0),(0,Yo.Z)(this,"autoDialInterval",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"running",void 0),(0,_x.Z)(this,Y5,{writable:!0,value:void 0}),this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.minConnections=null!==(n=t.minConnections)&&void 0!==n?n:Q5.minConnections,this.autoDialPriority=null!==(r=t.autoDialPriority)&&void 0!==r?r:Q5.autoDialPriority,this.autoDialIntervalMs=null!==(i=t.autoDialInterval)&&void 0!==i?i:Q5.autoDialInterval,this.autoDialMaxQueueLength=null!==(o=t.maxQueueLength)&&void 0!==o?o:Q5.maxQueueLength,this.autoDialPeerRetryThresholdMs=null!==(s=t.autoDialPeerRetryThreshold)&&void 0!==s?s:Q5.autoDialPeerRetryThreshold,this.autoDialDiscoveredPeersDebounce=null!==(a=t.autoDialDiscoveredPeersDebounce)&&void 0!==a?a:Q5.autoDialDiscoveredPeersDebounce,eW(this,Y5,e.logger.forComponent("libp2p:connection-manager:auto-dial")),this.started=!1,this.running=!1,this.queue=new q5({concurrency:null!==(c=t.autoDialConcurrency)&&void 0!==c?c:Q5.autoDialConcurrency}),this.queue.addListener("error",(e=>{(0,Ix.Z)(this,Y5).error("error during auto-dial",e)})),e.events.addEventListener("connection:close",(()=>{this.autoDial().catch((e=>{(0,Ix.Z)(this,Y5).error(e)}))})),e.events.addEventListener("peer:discovery",(()=>{clearTimeout(l),l=setTimeout((()=>{this.autoDial().catch((e=>{(0,Ix.Z)(this,Y5).error(e)}))}),this.autoDialDiscoveredPeersDebounce)}))}isStarted(){return this.started}start(){this.autoDialInterval=setTimeout((()=>{this.autoDial().catch((e=>{(0,Ix.Z)(this,Y5).error("error while autodialing",e)}))}),this.autoDialIntervalMs),this.started=!0}afterStart(){this.autoDial().catch((e=>{(0,Ix.Z)(this,Y5).error("error while autodialing",e)}))}stop(){this.queue.clear(),clearTimeout(this.autoDialInterval),this.started=!1,this.running=!1}async autoDial(){if(!this.started)return;const e=this.connectionManager.getConnectionsMap(),t=e.size;if(t>=this.minConnections)return void(this.minConnections>0&&(0,Ix.Z)(this,Y5).trace("have enough connections %d/%d",t,this.minConnections));if(this.queue.size>this.autoDialMaxQueueLength)return void(0,Ix.Z)(this,Y5).call(this,"not enough connections %d/%d but auto dial queue is full",t,this.minConnections);if(this.running)return void(0,Ix.Z)(this,Y5).call(this,"not enough connections %d/%d - but skipping autodial as it is already running",t,this.minConnections);this.running=!0,(0,Ix.Z)(this,Y5).call(this,"not enough connections %d/%d - will dial peers to increase the number of connections",t,this.minConnections);const n=new Ax(this.connectionManager.getDialQueue().map((e=>e.peerId)).filter(Boolean)),r=await this.peerStore.all({filters:[t=>0===t.addresses.length?((0,Ix.Z)(this,Y5).trace("not autodialing %p because they have no addresses",t.id),!1):e.has(t.id)?((0,Ix.Z)(this,Y5).trace("not autodialing %p because they are already connected",t.id),!1):n.has(t.id)?((0,Ix.Z)(this,Y5).trace("not autodialing %p because they are already being dialed",t.id),!1):!this.queue.hasJob(t.id)||((0,Ix.Z)(this,Y5).trace("not autodialing %p because they are already being autodialed",t.id),!1)]}),i=r.sort((()=>Math.random()>.5?1:-1)),o=new Ex;for(const a of i)o.has(a.id)||o.set(a.id,[...a.tags.values()].reduce(((e,t)=>e+t.value),0));const s=i.sort(((e,t)=>{var n,r;const i=null!==(n=o.get(e.id))&&void 0!==n?n:0,s=null!==(r=o.get(t.id))&&void 0!==r?r:0;return i>s?-1:i<s?1:0})).filter((e=>{const t=e.metadata.get(W5);if(null==t)return!0;const n=parseInt((0,Su.B)(t));return!!isNaN(n)||Date.now()-n>this.autoDialPeerRetryThresholdMs}));(0,Ix.Z)(this,Y5).call(this,"selected %d/%d peers to dial",s.length,r.length);for(const a of s)this.queue.add((async()=>{const e=this.connectionManager.getConnectionsMap().size;if(e>=this.minConnections)return(0,Ix.Z)(this,Y5).call(this,"got enough connections now %d/%d",e,this.minConnections),void this.queue.clear();(0,Ix.Z)(this,Y5).call(this,"connecting to a peerStore stored peer %p",a.id),await this.connectionManager.openConnection(a.id,{priority:this.autoDialPriority})}),{peerId:a.id}).catch((e=>{(0,Ix.Z)(this,Y5).error("could not connect to peerStore stored peer",e)}));this.running=!1,this.started&&(this.autoDialInterval=setTimeout((()=>{this.autoDial().catch((e=>{(0,Ix.Z)(this,Y5).error("error while autodialing",e)}))}),this.autoDialIntervalMs))}}const X5={maxConnections:G5,allow:[]};var $5=new WeakMap;class e4{constructor(e){var t,n;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"maxConnections",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"allow",void 0),(0,Yo.Z)(this,"events",void 0),(0,_x.Z)(this,$5,{writable:!0,value:void 0}),this.maxConnections=null!==(t=r.maxConnections)&&void 0!==t?t:X5.maxConnections,this.allow=null!==(n=r.allow)&&void 0!==n?n:X5.allow,this.connectionManager=e.connectionManager,this.peerStore=e.peerStore,this.events=e.events,eW(this,$5,e.logger.forComponent("libp2p:connection-manager:connection-pruner")),e.events.addEventListener("connection:open",(()=>{this.maybePruneConnections().catch((e=>{(0,Ix.Z)(this,$5).error(e)}))}))}async maybePruneConnections(){const e=this.connectionManager.getConnections(),t=e.length,n=Math.max(t-this.maxConnections,0);if((0,Ix.Z)(this,$5).call(this,"checking max connections limit %d/%d",t,this.maxConnections),t<=this.maxConnections)return;(0,Ix.Z)(this,$5).call(this,"max connections limit exceeded %d/%d, pruning %d connection(s)",t,this.maxConnections,n);const r=new Ex;for(const a of e){const e=a.remotePeer;if(!r.has(e)){r.set(e,0);try{const t=await this.peerStore.get(e);r.set(e,[...t.tags.values()].reduce(((e,t)=>e+t.value),0))}catch(s){"ERR_NOT_FOUND"!==s.code&&(0,Ix.Z)(this,$5).error("error loading peer tags",s)}}}const i=e.sort(((e,t)=>{var n,i;const o=null!==(n=r.get(e.remotePeer))&&void 0!==n?n:0,s=null!==(i=r.get(t.remotePeer))&&void 0!==i?i:0;if(o>s)return 1;if(o<s)return-1;const a=e.timeline.open,c=t.timeline.open;return a<c?1:a>c?-1:0})),o=[];for(const a of i){(0,Ix.Z)(this,$5).call(this,"too many connections open - closing a connection to %p",a.remotePeer);if(this.allow.some((e=>a.remoteAddr.toString().startsWith(e.toString())))||o.push(a),o.length===n)break}await Promise.all(o.map((async e=>{try{await e.close()}catch(s){(0,Ix.Z)(this,$5).error(s)}}))),this.events.safeDispatchEvent("connection:prune",{detail:o})}}async function t4(e,t){if(!e.protoNames().includes("dnsaddr"))return[e];const n=await async function(e,t){try{e=(0,og.HM)(e.toString());return await e.resolve(t)}catch(n){return t.log.error("multiaddr ".concat(e.toString()," could not be resolved"),n),[]}}(e,t),r=(await Promise.all(n.map((async e=>t4(e,t))))).flat().reduce(((e,t)=>(null==e.find((e=>e.equals(t)))&&e.push(t),e)),[]);return t.log("resolved %s to",e,r.map((e=>e.toString()))),r}const n4={addressSorter:T5,maxParallelDials:50,maxPeerAddrsToDial:25,maxParallelDialsPerPeer:1,dialTimeout:3e4,resolvers:{dnsaddr:M5}};var r4=new WeakMap;class i4{constructor(e){var t,n,r,i,o,s,a,c;let l=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"pendingDials",void 0),(0,Yo.Z)(this,"queue",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"connectionGater",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"addressSorter",void 0),(0,Yo.Z)(this,"maxPeerAddrsToDial",void 0),(0,Yo.Z)(this,"maxParallelDialsPerPeer",void 0),(0,Yo.Z)(this,"dialTimeout",void 0),(0,Yo.Z)(this,"inProgressDialCount",void 0),(0,Yo.Z)(this,"pendingDialCount",void 0),(0,Yo.Z)(this,"shutDownController",void 0),(0,Yo.Z)(this,"connections",void 0),(0,_x.Z)(this,r4,{writable:!0,value:void 0}),this.addressSorter=null!==(t=l.addressSorter)&&void 0!==t?t:n4.addressSorter,this.maxPeerAddrsToDial=null!==(n=l.maxPeerAddrsToDial)&&void 0!==n?n:n4.maxPeerAddrsToDial,this.maxParallelDialsPerPeer=null!==(r=l.maxParallelDialsPerPeer)&&void 0!==r?r:n4.maxParallelDialsPerPeer,this.dialTimeout=null!==(i=l.dialTimeout)&&void 0!==i?i:n4.dialTimeout,this.connections=null!==(o=l.connections)&&void 0!==o?o:new Ex,eW(this,r4,e.logger.forComponent("libp2p:connection-manager:dial-queue")),this.peerId=e.peerId,this.peerStore=e.peerStore,this.connectionGater=e.connectionGater,this.transportManager=e.transportManager,this.shutDownController=new AbortController,KJ(1/0,this.shutDownController.signal),this.pendingDialCount=null===(s=e.metrics)||void 0===s?void 0:s.registerMetric("libp2p_dialler_pending_dials"),this.inProgressDialCount=null===(a=e.metrics)||void 0===a?void 0:a.registerMetric("libp2p_dialler_in_progress_dials"),this.pendingDials=[];for(const[h,d]of Object.entries(null!==(u=l.resolvers)&&void 0!==u?u:{})){var u;og.s_.set(h,d)}this.queue=new Fm.Z({concurrency:null!==(c=l.maxParallelDials)&&void 0!==c?c:n4.maxParallelDials}),this.queue.on("add",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("active",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("completed",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("error",(e=>{var t,n;(0,Ix.Z)(this,r4).error("error in dial queue",e),null===(t=this.pendingDialCount)||void 0===t||t.update(this.queue.size),null===(n=this.inProgressDialCount)||void 0===n||n.update(this.queue.pending)})),this.queue.on("empty",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)})),this.queue.on("idle",(()=>{var e,t;null===(e=this.pendingDialCount)||void 0===e||e.update(this.queue.size),null===(t=this.inProgressDialCount)||void 0===t||t.update(this.queue.pending)}))}stop(){this.shutDownController.abort()}async dial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{peerId:n,multiaddrs:r}=z5(e),i=r.map((e=>({multiaddr:e,isCertified:!1}))),o=this.createDialAbortControllers(t.signal);let s;try{s=await this.calculateMultiaddrs(n,i,{...t,signal:o})}catch(h){throw o.clear(),h}let a=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&s.find((t=>t.multiaddr.equals(e.remoteAddr)))));if(null!=a)return(0,Ix.Z)(this,r4).call(this,"already connected to %a",a.remoteAddr),a;const c=this.pendingDials.find((e=>!(null==e.peerId||null==n||!e.peerId.equals(n))||s.map((e=>{let{multiaddr:t}=e;return t.toString()})).join()===e.multiaddrs.map((e=>e.toString())).join()));if(null!=c)return(0,Ix.Z)(this,r4).call(this,"joining existing dial target for %p",n),o.clear(),c.promise;(0,Ix.Z)(this,r4).call(this,"creating dial target for",s.map((e=>{let{multiaddr:t}=e;return t.toString()})));const l={id:"".concat(parseInt(String(1e9*Math.random()),10).toString()).concat(Date.now()),status:"queued",peerId:n,multiaddrs:s.map((e=>{let{multiaddr:t}=e;return t}))};l.promise=this.performDial(l,{...t,signal:o}).finally((()=>{this.pendingDials=this.pendingDials.filter((e=>e.id!==l.id)),o.clear()})).catch((async e=>{if((0,Ix.Z)(this,r4).error("dial failed to %s",l.multiaddrs.map((e=>e.toString())).join(", "),e),null!=n)try{await this.peerStore.patch(n,{metadata:{[W5]:(0,mu.m)(Date.now().toString())}})}catch(e){(0,Ix.Z)(this,r4).error("could not update last dial failure key for %p",n,e)}if(o.aborted){throw new Pq(e.message,F5.ERR_TIMEOUT)}throw e})),this.pendingDials.push(l);const u=await l.promise;return a=Array.from(this.connections.values()).flat().find((e=>!0!==t.force&&(e.id!==u.id&&e.remoteAddr.equals(u.remoteAddr)))),null!=a?((0,Ix.Z)(this,r4).call(this,"already connected to %a",a.remoteAddr),await u.close(),a):((0,Ix.Z)(this,r4).call(this,"connection opened to %a",u.remoteAddr),u)}createDialAbortControllers(e){const t=GH([AbortSignal.timeout(this.dialTimeout),this.shutDownController.signal,e]);try{null===KJ||void 0===KJ||KJ(1/0,t)}catch{}return t}async calculateMultiaddrs(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null!=e){var r,i;if(this.peerId.equals(e))throw new Pq("Tried to dial self",F5.ERR_DIALED_SELF);if(!0===await(null===(r=(i=this.connectionGater).denyDialPeer)||void 0===r?void 0:r.call(i,e)))throw new Pq("The dial request is blocked by gater.allowDialPeer",F5.ERR_PEER_DIAL_INTERCEPTED);if(0===t.length){(0,Ix.Z)(this,r4).call(this,"loading multiaddrs for %p",e);try{const n=await this.peerStore.get(e);t.push(...n.addresses),(0,Ix.Z)(this,r4).call(this,"loaded multiaddrs for %p",e,t.map((e=>{let{multiaddr:t}=e;return t.toString()})))}catch(h){if(h.code!==F5.ERR_NOT_FOUND)throw h}}}let o=(await Promise.all(t.map((async e=>{const t=await t4(e.multiaddr,{...n,log:(0,Ix.Z)(this,r4)});return 1===t.length&&t[0].equals(e.multiaddr)?e:t.map((e=>({multiaddr:e,isCertified:!1})))})))).flat();if(null!=e){const t="/p2p/".concat(e.toString());o=o.map((e=>{const n=e.multiaddr.protos().pop();return!0===(null===n||void 0===n?void 0:n.path)?e:null==e.multiaddr.getPeerId()?{multiaddr:e.multiaddr.encapsulate(t),isCertified:e.isCertified}:e}))}const s=o.filter((t=>{if(null==this.transportManager.transportForMultiaddr(t.multiaddr))return!1;const n=t.multiaddr.getPeerId();return null==e||null==n||e.equals(n)})),a=new Map;for(const d of s){const e=d.multiaddr.toString(),t=a.get(e);null==t?a.set(e,d):t.isCertified=t.isCertified||d.isCertified||!1}const c=[...a.values()];if((0===c.length||c.length>this.maxPeerAddrsToDial)&&((0,Ix.Z)(this,r4).call(this,"addresses for %p before filtering",null!==e&&void 0!==e?e:"unknown peer",o.map((e=>{let{multiaddr:t}=e;return t.toString()}))),(0,Ix.Z)(this,r4).call(this,"addresses for %p after filtering",null!==e&&void 0!==e?e:"unknown peer",c.map((e=>{let{multiaddr:t}=e;return t.toString()})))),0===c.length)throw new Pq("The dial request has no valid addresses",F5.ERR_NO_VALID_ADDRESSES);if(c.length>this.maxPeerAddrsToDial)throw new Pq("dial with more addresses than allowed",F5.ERR_TOO_MANY_ADDRESSES);const l=[];for(const d of c)null!=this.connectionGater.denyDialMultiaddr&&await this.connectionGater.denyDialMultiaddr(d.multiaddr)||l.push(d);const u=l.sort(this.addressSorter);if(0===u.length)throw new Pq("The connection gater denied all addresses in the dial request",F5.ERR_NO_VALID_ADDRESSES);return u}async performDial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const n=e.multiaddrs.map((()=>new AbortController));try{const r=new Fm.Z({concurrency:this.maxParallelDialsPerPeer});r.on("error",(e=>{(0,Ix.Z)(this,r4).error("error dialling",e)}));const i=await Promise.any(e.multiaddrs.map((async(i,o)=>{const s=n[o];if(null==s)throw new Pq("dialAction did not come with an AbortController",F5.ERR_INVALID_PARAMETERS);const a=function(){const e=[];for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(const o of n)null!=o&&(KJ(1/0,o),e.push(o));const i=GH(e);return KJ(1/0,i),i}(s.signal,t.signal);a.addEventListener("abort",(()=>{(0,Ix.Z)(this,r4).call(this,"dial to %a aborted",i)}));const c=Ws();return await r.add((async()=>{if(a.aborted)return(0,Ix.Z)(this,r4).call(this,"dial to %a was aborted before reaching the head of the peer dial queue",i),void c.reject(new xq);await this.queue.add((async()=>{try{if(a.aborted)return(0,Ix.Z)(this,r4).call(this,"dial to %a was aborted before reaching the head of the dial queue",i),void c.reject(new xq);e.status="active";const r=await this.transportManager.dial(i,{...t,signal:a});if(s.signal.aborted)return(0,Ix.Z)(this,r4).call(this,"multiple dials succeeded, closing superfluous connection"),r.close().catch((e=>{(0,Ix.Z)(this,r4).error("error closing superfluous connection",e)})),void c.reject(new xq);n[o]=void 0,n.forEach((e=>{void 0!==e&&e.abort()})),(0,Ix.Z)(this,r4).call(this,"dial to %a succeeded",i),c.resolve(r)}catch(r){(0,Ix.Z)(this,r4).error("error during dial of %a",i,r),c.reject(r)}}),{...t,signal:a}).catch((e=>{c.reject(e)}))}),{signal:a}).catch((e=>{c.reject(e)})).finally((()=>{a.clear()})),c.promise})));if(null==i)throw new Pq("successful dial led to empty object returned from peer dial queue",F5.ERR_TRANSPORT_DIAL_FAILED);return e.status="success",i}catch(r){if(e.status="error",1===e.multiaddrs.length&&"AggregateError"===r.name)throw r.errors[0];throw r}}}const o4=5,s4=G5,a4=5,c4=10,l4=25,u4=0,h4=100;var d4=new WeakMap;class f4{constructor(e){var t,n,r,i,o,s,a,c,l,u,h,d,f,p,g;let y=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"connections",void 0),(0,Yo.Z)(this,"allow",void 0),(0,Yo.Z)(this,"deny",void 0),(0,Yo.Z)(this,"maxIncomingPendingConnections",void 0),(0,Yo.Z)(this,"incomingPendingConnections",void 0),(0,Yo.Z)(this,"maxConnections",void 0),(0,Yo.Z)(this,"dialQueue",void 0),(0,Yo.Z)(this,"autoDial",void 0),(0,Yo.Z)(this,"connectionPruner",void 0),(0,Yo.Z)(this,"inboundConnectionRateLimiter",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"events",void 0),(0,_x.Z)(this,d4,{writable:!0,value:void 0}),this.maxConnections=null!==(t=y.maxConnections)&&void 0!==t?t:s4;const m=null!==(n=y.minConnections)&&void 0!==n?n:o4;if(this.maxConnections<m)throw new Pq("Connection Manager maxConnections must be greater than minConnections",F5.ERR_INVALID_PARAMETERS);this.connections=new Ex,this.started=!1,this.peerStore=e.peerStore,this.metrics=e.metrics,this.events=e.events,eW(this,d4,e.logger.forComponent("libp2p:connection-manager")),this.onConnect=this.onConnect.bind(this),this.onDisconnect=this.onDisconnect.bind(this),this.events.addEventListener("connection:open",this.onConnect),this.events.addEventListener("connection:close",this.onDisconnect),this.allow=(null!==(r=y.allow)&&void 0!==r?r:[]).map((e=>(0,og.HM)(e))),this.deny=(null!==(i=y.deny)&&void 0!==i?i:[]).map((e=>(0,og.HM)(e))),this.incomingPendingConnections=0,this.maxIncomingPendingConnections=null!==(o=y.maxIncomingPendingConnections)&&void 0!==o?o:c4,this.inboundConnectionRateLimiter=new j5.RateLimiterMemory({points:null!==(s=y.inboundConnectionThreshold)&&void 0!==s?s:a4,duration:1}),this.autoDial=new J5({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{minConnections:m,autoDialConcurrency:null!==(a=y.autoDialConcurrency)&&void 0!==a?a:l4,autoDialPriority:null!==(c=y.autoDialPriority)&&void 0!==c?c:u4,maxQueueLength:null!==(l=y.autoDialMaxQueueLength)&&void 0!==l?l:h4}),this.connectionPruner=new e4({connectionManager:this,peerStore:e.peerStore,events:e.events,logger:e.logger},{maxConnections:this.maxConnections,allow:this.allow}),this.dialQueue=new i4({peerId:e.peerId,metrics:e.metrics,peerStore:e.peerStore,transportManager:e.transportManager,connectionGater:e.connectionGater,logger:e.logger},{addressSorter:null!==(u=y.addressSorter)&&void 0!==u?u:T5,maxParallelDials:null!==(h=y.maxParallelDials)&&void 0!==h?h:50,maxPeerAddrsToDial:null!==(d=y.maxPeerAddrsToDial)&&void 0!==d?d:25,maxParallelDialsPerPeer:null!==(f=y.maxParallelDialsPerPeer)&&void 0!==f?f:1,dialTimeout:null!==(p=y.dialTimeout)&&void 0!==p?p:3e4,resolvers:null!==(g=y.resolvers)&&void 0!==g?g:{dnsaddr:M5},connections:this.connections})}isStarted(){return this.started}async start(){var e,t,n;null===(e=this.metrics)||void 0===e||e.registerMetricGroup("libp2p_connection_manager_connections",{calculate:()=>{const e={inbound:0,outbound:0};for(const t of this.connections.values())for(const n of t)"inbound"===n.direction?e.inbound++:e.outbound++;return e}}),null===(t=this.metrics)||void 0===t||t.registerMetricGroup("libp2p_protocol_streams_total",{label:"protocol",calculate:()=>{const e={};for(const r of this.connections.values())for(const i of r)for(const r of i.streams){var t,n;const i="".concat(r.direction," ").concat(null!==(t=r.protocol)&&void 0!==t?t:"unnegotiated");e[i]=(null!==(n=e[i])&&void 0!==n?n:0)+1}return e}}),null===(n=this.metrics)||void 0===n||n.registerMetricGroup("libp2p_connection_manager_protocol_streams_per_connection_90th_percentile",{label:"protocol",calculate:()=>{const e={};for(const o of this.connections.values())for(const i of o){const o={};for(const e of i.streams){var t,n;const r="".concat(e.direction," ").concat(null!==(t=e.protocol)&&void 0!==t?t:"unnegotiated");o[r]=(null!==(n=o[r])&&void 0!==n?n:0)+1}for(const[t,n]of Object.entries(o)){var r;e[t]=null!==(r=e[t])&&void 0!==r?r:[],e[t].push(n)}}const i={};for(let[o,s]of Object.entries(e)){s=s.sort(((e,t)=>e-t));const e=Math.floor(.9*s.length);i[o]=s[e]}return i}}),this.autoDial.start(),this.started=!0,(0,Ix.Z)(this,d4).call(this,"started")}async afterStart(){Promise.resolve().then((async()=>{const e=await this.peerStore.all({filters:[e=>e.tags.has("keep-alive")]});await Promise.all(e.map((async e=>{await this.openConnection(e.id).catch((e=>{(0,Ix.Z)(this,d4).error(e)}))})))})).catch((e=>{(0,Ix.Z)(this,d4).error(e)})),this.autoDial.afterStart()}async stop(){this.dialQueue.stop(),this.autoDial.stop();const e=[];for(const t of this.connections.values())for(const n of t)e.push((async()=>{try{await n.close()}catch(e){(0,Ix.Z)(this,d4).error(e)}})());(0,Ix.Z)(this,d4).call(this,"closing %d connections",e.length),await Promise.all(e),this.connections.clear(),(0,Ix.Z)(this,d4).call(this,"stopped")}onConnect(e){this._onConnect(e).catch((e=>{(0,Ix.Z)(this,d4).error(e)}))}async _onConnect(e){const{detail:t}=e;if(!this.started)return void await t.close();const n=t.remotePeer,r=this.connections.get(n);let i=!1;null!=r?r.push(t):(i=!0,this.connections.set(n,[t])),null!=n.publicKey&&"RSA"===n.type&&await this.peerStore.patch(n,{publicKey:n.publicKey}),i&&this.events.safeDispatchEvent("peer:connect",{detail:t.remotePeer})}onDisconnect(e){const{detail:t}=e;if(!this.started)return;const n=t.remotePeer;let r=this.connections.get(n);null!=r&&r.length>1?(r=r.filter((e=>e.id!==t.id)),this.connections.set(n,r)):null!=r&&(this.connections.delete(n),this.events.safeDispatchEvent("peer:disconnect",{detail:t.remotePeer}))}getConnections(e){var t;if(null!=e)return null!==(t=this.connections.get(e))&&void 0!==t?t:[];let n=[];for(const r of this.connections.values())n=n.concat(r);return n}getConnectionsMap(){return this.connections}async openConnection(e){var t,n;let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(!this.isStarted())throw new Pq("Not started",F5.ERR_NODE_NOT_STARTED);null===(t=r.signal)||void 0===t||t.throwIfAborted();const{peerId:i}=z5(e);if(null!=i&&!0!==r.force){(0,Ix.Z)(this,d4).call(this,"dial %p",i);const e=this.getConnections(i).find((e=>!e.transient));if(null!=e)return(0,Ix.Z)(this,d4).call(this,"had an existing non-transient connection to %p",i),e}const o=await this.dialQueue.dial(e,{...r,priority:null!==(n=r.priority)&&void 0!==n?n:50});let s=this.connections.get(o.remotePeer);null==s&&(s=[],this.connections.set(o.remotePeer,s));let a=!1;for(const c of s)c.id===o.id&&(a=!0);return a||s.push(o),o}async closeConnections(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=null!==(t=this.connections.get(e))&&void 0!==t?t:[];await Promise.all(r.map((async e=>{try{await e.close(n)}catch(t){e.abort(t)}})))}async acceptIncomingConnection(e){if(this.deny.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return(0,Ix.Z)(this,d4).call(this,"connection from %a refused - connection remote address was in deny list",e.remoteAddr),!1;if(this.allow.some((t=>e.remoteAddr.toString().startsWith(t.toString()))))return this.incomingPendingConnections++,!0;if(this.incomingPendingConnections===this.maxIncomingPendingConnections)return(0,Ix.Z)(this,d4).call(this,"connection from %a refused - incomingPendingConnections exceeded by host",e.remoteAddr),!1;if(e.remoteAddr.isThinWaistAddress()){const t=e.remoteAddr.nodeAddress().address;try{await this.inboundConnectionRateLimiter.consume(t,1)}catch{return(0,Ix.Z)(this,d4).call(this,"connection from %a refused - inboundConnectionThreshold exceeded by host %s",e.remoteAddr,t),!1}}return this.getConnections().length<this.maxConnections?(this.incomingPendingConnections++,!0):((0,Ix.Z)(this,d4).call(this,"connection from %a refused - maxConnections exceeded",e.remoteAddr),!1)}afterUpgradeInbound(){this.incomingPendingConnections--}getDialQueue(){return this.dialQueue.pendingDials}}async function*p4(e,t){yield*mG(e,(async e=>(await t.merge(e.id,{multiaddrs:e.multiaddrs}),e)))}function g4(e){const t=new Set;return FH(e,(e=>!t.has(e.id.toString())&&(t.add(e.id.toString()),!0)))}function y4(e){try{let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return async function*(){let n=0;for await(const t of e)n++,yield t;if(n<t)throw new Pq("more peers required, seen: ".concat(n,"  min: ").concat(t),"NOT_FOUND")}()}catch(t){return Promise.reject(t)}}class m4{constructor(e,t){var n;(0,Yo.Z)(this,"routers",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"components",void 0),this.routers=null!==(n=t.routers)&&void 0!==n?n:[],this.started=!1,this.components=e}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.started=!1}findProviders(e){try{var t=this;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return async function*(){if(0===t.routers.length)throw new Pq("No content routers available",F5.ERR_NO_ROUTERS_AVAILABLE);yield*_G(SG(...t.routers.map((t=>t.findProviders(e,n)))),(e=>p4(e,t.components.peerStore)),(e=>g4(e)),(e=>y4(e)))}()}catch(n){return Promise.reject(n)}}async provide(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(0===this.routers.length)throw new Pq("No content routers available",F5.ERR_NO_ROUTERS_AVAILABLE);await Promise.all(this.routers.map((async n=>{await n.provide(e,t)})))}async put(e,t,n){if(!this.isStarted())throw new Pq(U5.NOT_STARTED_YET,F5.DHT_NOT_STARTED);await Promise.all(this.routers.map((async r=>{await r.put(e,t,n)})))}async get(e,t){if(!this.isStarted())throw new Pq(U5.NOT_STARTED_YET,F5.DHT_NOT_STARTED);return Promise.any(this.routers.map((async n=>n.get(e,t))))}}const v4=function(e){if(null!=e[Symbol.asyncIterator])return(async()=>{for await(const t of e)return t})();for(const t of e)return t},b4=xH("libp2p:peer-routing");class w4{constructor(e,t){var n;(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"routers",void 0),this.components=e,this.routers=null!==(n=t.routers)&&void 0!==n?n:[]}async findPeer(e,t){if(0===this.routers.length)throw new Pq("No peer routers available",F5.ERR_NO_ROUTERS_AVAILABLE);if(e.toString()===this.components.peerId.toString())throw new Pq("Should not try to find self",F5.ERR_FIND_SELF);const n=await _G(SG(...this.routers.map((n=>async function*(){try{yield await n.findPeer(e,t)}catch(r){b4.error(r)}}()))),(e=>FH(e,Boolean)),(e=>p4(e,this.components.peerStore)),(async e=>v4(e)));if(null!=n)return n;throw new Pq(U5.NOT_FOUND,F5.ERR_NOT_FOUND)}async*getClosestPeers(e,t){if(0===this.routers.length)throw new Pq("No peer routers available",F5.ERR_NO_ROUTERS_AVAILABLE);yield*_G(SG(...this.routers.map((n=>n.getClosestPeers(e,t)))),(e=>p4(e,this.components.peerStore)),(e=>g4(e)),(e=>y4(e)))}}const E4=xH("libp2p:registrar");class A4{constructor(e){(0,Yo.Z)(this,"topologies",void 0),(0,Yo.Z)(this,"handlers",void 0),(0,Yo.Z)(this,"components",void 0),this.topologies=new Map,this.handlers=new Map,this.components=e,this._onDisconnect=this._onDisconnect.bind(this),this._onPeerUpdate=this._onPeerUpdate.bind(this),this._onPeerIdentify=this._onPeerIdentify.bind(this),this.components.events.addEventListener("peer:disconnect",this._onDisconnect),this.components.events.addEventListener("peer:update",this._onPeerUpdate),this.components.events.addEventListener("peer:identify",this._onPeerIdentify)}getProtocols(){return Array.from(new Set([...this.handlers.keys()])).sort()}getHandler(e){const t=this.handlers.get(e);if(null==t)throw new Pq("No handler registered for protocol ".concat(e),F5.ERR_NO_HANDLER_FOR_PROTOCOL);return t}getTopologies(e){const t=this.topologies.get(e);return null==t?[]:[...t.values()]}async handle(e,t,n){if(this.handlers.has(e))throw new Pq("Handler already registered for protocol ".concat(e),F5.ERR_PROTOCOL_HANDLER_ALREADY_REGISTERED);const r=H0.Z.bind({ignoreUndefined:!0})({maxInboundStreams:32,maxOutboundStreams:64},n);this.handlers.set(e,{handler:t,options:r}),await this.components.peerStore.merge(this.components.peerId,{protocols:[e]})}async unhandle(e){(Array.isArray(e)?e:[e]).forEach((e=>{this.handlers.delete(e)})),await this.components.peerStore.patch(this.components.peerId,{protocols:this.getProtocols()})}async register(e,t){if(null==t)throw new Pq("invalid topology",F5.ERR_INVALID_PARAMETERS);const n="".concat((1e9*Math.random()).toString(36)).concat(Date.now());let r=this.topologies.get(e);return null==r&&(r=new Map,this.topologies.set(e,r)),r.set(n,t),n}unregister(e){for(const[t,n]of this.topologies.entries())n.has(e)&&(n.delete(e),0===n.size&&this.topologies.delete(t))}_onDisconnect(e){const t=e.detail;this.components.peerStore.get(t).then((e=>{for(const r of e.protocols){const e=this.topologies.get(r);if(null!=e)for(const r of e.values()){var n;null===(n=r.onDisconnect)||void 0===n||n.call(r,t)}}})).catch((e=>{e.code!==F5.ERR_NOT_FOUND&&E4.error("could not inform topologies of disconnecting peer %p",t,e)}))}_onPeerUpdate(e){var t;const{peer:n,previous:r}=e.detail,i=(null!==(t=null===r||void 0===r?void 0:r.protocols)&&void 0!==t?t:[]).filter((e=>!n.protocols.includes(e)));for(const s of i){const e=this.topologies.get(s);if(null!=e)for(const t of e.values()){var o;null===(o=t.onDisconnect)||void 0===o||o.call(t,n.id)}}}_onPeerIdentify(e){const t=e.detail.protocols,n=e.detail.connection,r=e.detail.peerId;for(const o of t){const e=this.topologies.get(o);if(null!=e)for(const t of e.values()){var i;n.transient&&!0!==t.notifyOnTransient||(null===(i=t.onConnect)||void 0===i||i.call(t,r,n))}}}}const S4=xH("libp2p:transports");class _4{constructor(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"transports",void 0),(0,Yo.Z)(this,"listeners",void 0),(0,Yo.Z)(this,"faultTolerance",void 0),(0,Yo.Z)(this,"started",void 0),this.components=e,this.started=!1,this.transports=new Map,this.listeners=Rq({name:"libp2p_transport_manager_listeners",metrics:this.components.metrics}),this.faultTolerance=null!==(t=n.faultTolerance)&&void 0!==t?t:I5.FATAL_ALL}add(e){const t=e[Symbol.toStringTag];if(null==t)throw new Pq("Transport must have a valid tag",F5.ERR_INVALID_KEY);if(this.transports.has(t))throw new Pq("There is already a transport with the tag ".concat(t),F5.ERR_DUPLICATE_TRANSPORT);S4("adding transport %s",t),this.transports.set(t,e),this.listeners.has(t)||this.listeners.set(t,[])}isStarted(){return this.started}start(){this.started=!0}async afterStart(){const e=this.components.addressManager.getListenAddrs();await this.listen(e)}async stop(){const e=[];for(const[t,n]of this.listeners)for(S4("closing listeners for %s",t);n.length>0;){const t=n.pop();null!=t&&e.push(t.close())}await Promise.all(e),S4("all listeners closed");for(const t of this.listeners.keys())this.listeners.set(t,[]);this.started=!1}async dial(e,t){const n=this.transportForMultiaddr(e);if(null==n)throw new Pq("No transport available for address ".concat(String(e)),F5.ERR_TRANSPORT_UNAVAILABLE);try{return await n.dial(e,{...t,upgrader:this.components.upgrader})}catch(r){throw null==r.code&&(r.code=F5.ERR_TRANSPORT_DIAL_FAILED),r}}getAddrs(){let e=[];for(const t of this.listeners.values())for(const n of t)e=[...e,...n.getAddrs()];return e}getTransports(){return Array.of(...this.transports.values())}getListeners(){return Array.of(...this.listeners.values()).flat()}transportForMultiaddr(e){for(const t of this.transports.values()){if(t.filter([e]).length>0)return t}}async listen(e){if(!this.isStarted())throw new Pq("Not started",F5.ERR_NODE_NOT_STARTED);if(null==e||0===e.length)return void S4("no addresses were provided for listening, this node is dial only");const t=[];for(const[r,i]of this.transports.entries()){const o=i.filter(e),s=[];for(const e of o){var n;S4("creating listener for %s on %a",r,e);const t=i.createListener({upgrader:this.components.upgrader});let o=null!==(n=this.listeners.get(r))&&void 0!==n?n:[];null==o&&(o=[],this.listeners.set(r,o)),o.push(t),t.addEventListener("listening",(()=>{this.components.events.safeDispatchEvent("transport:listening",{detail:t})})),t.addEventListener("close",(()=>{const e=o.findIndex((e=>e===t));o.splice(e,1),this.components.events.safeDispatchEvent("transport:close",{detail:t})})),s.push(t.listen(e))}if(0===s.length){t.push(r);continue}if(null==(await Promise.allSettled(s)).find((e=>"fulfilled"===e.status))&&this.faultTolerance!==I5.NO_FATAL)throw new Pq("Transport (".concat(r,") could not listen on any available address"),F5.ERR_NO_VALID_ADDRESSES)}if(t.length===this.transports.size){const e="no valid addresses were provided for transports [".concat(t.join(", "),"]");if(this.faultTolerance===I5.FATAL_ALL)throw new Pq(e,F5.ERR_NO_VALID_ADDRESSES);S4("libp2p in dial mode only: ".concat(e))}}async remove(e){var t;const n=null!==(t=this.listeners.get(e))&&void 0!==t?t:[];S4.trace("removing transport %s",e);const r=[];for(S4.trace("closing listeners for %s",e);n.length>0;){const e=n.pop();null!=e&&r.push(e.close())}await Promise.all(r),this.transports.delete(e),this.listeners.delete(e)}async removeAll(){const e=[];for(const t of this.transports.keys())e.push(this.remove(t));await Promise.all(e)}}const I4="/multistream/1.0.0",C4=1024,T4=(0,mu.m)("\n");async function k4(e,t,n){await e.write(t,n)}async function R4(e,t){const n=await async function(e,t){const n=await e.read(t);if(0===n.byteLength||n.get(n.byteLength-1)!==T4[0])throw null===t||void 0===t||t.log.error("Invalid mss message - missing newline",n),new pu.sv("missing newline","ERR_INVALID_MULTISTREAM_SELECT_MESSAGE");return n.sublist(0,-1)}(e,t);return(0,Su.B)(n.subarray())}async function x4(e,t,n){if(1===(t=Array.isArray(t)?[...t]:[t]).length)return function(e,t,n){const r=e.sink.bind(e),i=e.source;let o=!1,s=!1;const a=Ws();let c=!1,l=!1;const u=Ws();let h=!1,d=!1;const f=Ws(),p=ua({sink:r,source:i},{...n,maxDataLength:C4});async function g(){if(s)return null===n||void 0===n||n.log.trace("optimistic: already negotiating %s stream",t),void await a.promise;s=!0;try{c||(null===n||void 0===n||n.log.trace("optimistic: doing send protocol for %s stream",t),await y()),h||(null===n||void 0===n||n.log.trace("optimistic: doing read protocol for %s stream",t),await m())}finally{s=!1,o=!0,a.resolve()}}async function y(){if(l)await u.promise;else{l=!0;try{null===n||void 0===n||n.log.trace('optimistic: write ["%s", "%s", data] in source',I4,t),await p.writeV([(0,mu.m)("".concat(I4,"\n")),(0,mu.m)("".concat(t,"\n"))]),null===n||void 0===n||n.log.trace('optimistic: wrote ["%s", "%s", data] in source',I4,t)}finally{c=!0,l=!1,u.resolve()}}}async function m(){if(d)await f.promise;else{d=!0;try{null===n||void 0===n||n.log.trace("optimistic: reading multistream select header");let e=await R4(p,n);if(null===n||void 0===n||n.log.trace('optimistic: read multistream select header "%s"',e),e===I4&&(e=await R4(p,n)),null===n||void 0===n||n.log.trace('optimistic: read protocol "%s", expecting "%s"',e,t),e!==t)throw new pu.sv("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}finally{h=!0,d=!1,f.resolve()}}}if(e.sink=async e=>{const{sink:r}=p.unwrap();await r(async function*(){let r=!1;for await(const i of e){if(l&&await u.promise,c)yield i;else{l=!0,null===n||void 0===n||n.log.trace('optimistic: write ["%s", "%s", data(%d)] in sink',I4,t,i.byteLength);const e="".concat(t,"\n");yield new Zs(Uint8Array.from([19]),(0,mu.m)("".concat(I4,"\n")),Bs.cv(e.length),(0,mu.m)(e),i).subarray(),null===n||void 0===n||n.log.trace('optimistic: wrote ["%s", "%s", data(%d)] in sink',I4,t,i.byteLength),c=!0,l=!1,u.resolve()}r=!0}r||await g()}())},e.source=async function*(){await g(),null===n||void 0===n||n.log.trace('optimistic: reading data from "%s" stream',t),yield*p.unwrap().source}(),null!=e.closeRead){const t=e.closeRead.bind(e);e.closeRead=async e=>{o||await g().catch((e=>{null===n||void 0===n||n.log.error("could not negotiate protocol before close read",e)})),await t(e)}}if(null!=e.closeWrite){const t=e.closeWrite.bind(e);e.closeWrite=async e=>{o||await g().catch((e=>{null===n||void 0===n||n.log.error("could not negotiate protocol before close write",e)})),await t(e)}}if(null!=e.close){const t=e.close.bind(e);e.close=async e=>{o||(o=!0,s=!1,a.resolve()),await t(e)}}return{stream:e,protocol:t}}(e,t[0],n);const r=ua(e,{...n,maxDataLength:C4}),i=t.shift();if(null==i)throw new Error("At least one protocol must be specified");null===n||void 0===n||n.log.trace('select: write ["%s", "%s"]',I4,i);const o=(0,mu.m)("".concat(I4,"\n")),s=(0,mu.m)("".concat(i,"\n"));await async function(e,t,n){await e.writeV(t,n)}(r,[o,s],n),null===n||void 0===n||n.log.trace("select: reading multistream-select header");let a=await R4(r,n);if(null===n||void 0===n||n.log.trace('select: read "%s"',a),a===I4&&(null===n||void 0===n||n.log.trace("select: reading protocol response"),a=await R4(r,n),null===n||void 0===n||n.log.trace('select: read "%s"',a)),a===i)return{stream:r.unwrap(),protocol:i};for(const c of t){null===n||void 0===n||n.log.trace('select: write "%s"',c),await k4(r,(0,mu.m)("".concat(c,"\n")),n),null===n||void 0===n||n.log.trace("select: reading protocol response");const e=await R4(r,n);if(null===n||void 0===n||n.log.trace('select: read "%s" for "%s"',e,c),e===c)return{stream:r.unwrap(),protocol:c}}throw new pu.sv("protocol selection failed","ERR_UNSUPPORTED_PROTOCOL")}function P4(e){return null!=e[Symbol.asyncIterator]}const D4=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),D4.bytes=t,n};function O4(e,t){var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:D4;function*o(e){const t=i(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return P4(e)?async function*(){for await(const t of e)yield*o(t)}():function*(){for(const t of e)yield*o(t)}()}D4.bytes=0,O4.single=(e,t)=>{var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:D4;return new Zs(i(e.byteLength),e)};var N4;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(N4||(N4={}));const B4=e=>{const t=Bs.Jx(e);return B4.bytes=Bs.P$(t),t};function L4(e,t){var n,r,i;const o=new Zs;let s=N4.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:B4,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===N4.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=N4.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===N4.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=N4.LENGTH}}}return P4(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}async function M4(e,t,n){t=Array.isArray(t)?t:[t],n.log.trace("handle: available protocols %s",t);const r=ua(e,{...n,maxDataLength:C4,maxLengthLength:2});for(;;){null===n||void 0===n||n.log.trace("handle: reading incoming string");const e=await R4(r,n);if(n.log.trace('handle: read "%s"',e),e!==I4){if(t.includes(e))return n.log.trace('handle: respond with "%s" for "%s"',e,e),await k4(r,(0,mu.m)("".concat(e,"\n")),n),n.log.trace('handle: responded with "%s" for "%s"',e,e),{stream:r.unwrap(),protocol:e};if("ls"!==e)n.log('handle: respond with "na" for "%s"',e),await k4(r,(0,mu.m)("na\n"),n),n.log('handle: responded with "na" for "%s"',e);else{const i=new Zs(...t.map((e=>O4.single((0,mu.m)("".concat(e,"\n"))))),(0,mu.m)("\n"));n.log.trace('handle: respond with "%s" for %s',t,e),await k4(r,i,n),n.log.trace('handle: responded with "%s" for %s',t,e)}}else n.log.trace('handle: respond with "%s" for "%s"',I4,e),await k4(r,(0,mu.m)("".concat(I4,"\n")),n),n.log.trace('handle: responded with "%s" for "%s"',I4,e)}}B4.bytes=0,L4.fromReader=(e,t)=>{let n=1;return L4(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};const U4=Symbol.for("@libp2p/connection");let F4;var K4=new WeakMap;F4=Symbol.toStringTag;class j4{constructor(e){var t;(0,Yo.Z)(this,"id",void 0),(0,Yo.Z)(this,"remoteAddr",void 0),(0,Yo.Z)(this,"remotePeer",void 0),(0,Yo.Z)(this,"direction",void 0),(0,Yo.Z)(this,"timeline",void 0),(0,Yo.Z)(this,"multiplexer",void 0),(0,Yo.Z)(this,"encryption",void 0),(0,Yo.Z)(this,"status",void 0),(0,Yo.Z)(this,"transient",void 0),(0,Yo.Z)(this,"tags",void 0),(0,Yo.Z)(this,"_newStream",void 0),(0,Yo.Z)(this,"_close",void 0),(0,Yo.Z)(this,"_abort",void 0),(0,Yo.Z)(this,"_getStreams",void 0),(0,_x.Z)(this,K4,{writable:!0,value:void 0}),(0,Yo.Z)(this,F4,"Connection"),(0,Yo.Z)(this,U4,!0);const{remoteAddr:n,remotePeer:r,newStream:i,close:o,abort:s,getStreams:a}=e;this.id="".concat(parseInt(String(1e9*Math.random())).toString(36)).concat(Date.now()),this.remoteAddr=n,this.remotePeer=r,this.direction=e.direction,this.status="open",this.timeline=e.timeline,this.multiplexer=e.multiplexer,this.encryption=e.encryption,this.transient=null!==(t=e.transient)&&void 0!==t&&t,eW(this,K4,e.logger.forComponent("libp2p:connection")),null==this.remoteAddr.getPeerId()&&(this.remoteAddr=this.remoteAddr.encapsulate("/p2p/".concat(this.remotePeer))),this._newStream=i,this._close=o,this._abort=s,this._getStreams=a,this.tags=[]}get streams(){return this._getStreams()}async newStream(e,t){if("closing"===this.status)throw new Pq("the connection is being closed","ERR_CONNECTION_BEING_CLOSED");if("closed"===this.status)throw new Pq("the connection is closed","ERR_CONNECTION_CLOSED");if(Array.isArray(e)||(e=[e]),this.transient&&!0!==(null===t||void 0===t?void 0:t.runOnTransientConnection))throw new Pq("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");const n=await this._newStream(e,t);return n.direction="outbound",n}async close(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("closed"!==this.status&&"closing"!==this.status){if((0,Ix.Z)(this,K4).call(this,"closing connection to %a",this.remoteAddr),this.status="closing",null==e.signal){const t=AbortSignal.timeout(500);KJ(1/0,t),e={...e,signal:t}}try{(0,Ix.Z)(this,K4).trace("closing all streams"),await Promise.all(this.streams.map((async t=>t.close(e)))),(0,Ix.Z)(this,K4).trace("closing underlying transport"),await this._close(e),(0,Ix.Z)(this,K4).trace("updating timeline with close time"),this.status="closed",this.timeline.close=Date.now()}catch(t){(0,Ix.Z)(this,K4).error("error encountered during graceful close of connection to %a",this.remoteAddr,t),this.abort(t)}}}abort(e){(0,Ix.Z)(this,K4).error("aborting connection to %a due to error",this.remoteAddr,e),this.status="closing",this.streams.forEach((t=>{t.abort(e)})),(0,Ix.Z)(this,K4).error("all streams aborted",this.streams.length),this._abort(e),this.timeline.close=Date.now(),this.status="closed"}}function Z4(e,t,n){let r=0;return n.streams.forEach((n=>{n.direction===t&&n.protocol===e&&r++})),r}var z4=new WeakMap;class V4{constructor(e,t){var n;(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"connectionEncryption",void 0),(0,Yo.Z)(this,"muxers",void 0),(0,Yo.Z)(this,"inboundUpgradeTimeout",void 0),(0,Yo.Z)(this,"events",void 0),(0,_x.Z)(this,z4,{writable:!0,value:void 0}),this.components=e,this.connectionEncryption=new Map,eW(this,z4,e.logger.forComponent("libp2p:upgrader")),t.connectionEncryption.forEach((e=>{this.connectionEncryption.set(e.protocol,e)})),this.muxers=new Map,t.muxers.forEach((e=>{this.muxers.set(e.protocol,e)})),this.inboundUpgradeTimeout=null!==(n=t.inboundUpgradeTimeout)&&void 0!==n?n:3e4,this.events=e.events}async shouldBlockConnection(e,t,n){const r=this.components.connectionGater[n];if(void 0!==r&&await r(e,t))throw new Pq("The multiaddr connection is blocked by gater.".concat(n),F5.ERR_CONNECTION_INTERCEPTED)}async upgradeInbound(e,t){if(!await this.components.connectionManager.acceptIncomingConnection(e))throw new Pq("connection denied",F5.ERR_CONNECTION_DENIED);let n,r,i,o,s;const a=AbortSignal.timeout(this.inboundUpgradeTimeout),c=()=>{e.abort(new Pq("inbound upgrade timeout",F5.ERR_TIMEOUT))};a.addEventListener("abort",c,{once:!0}),KJ(1/0,a);try{var l,u,h;if(!0===await(null===(l=(u=this.components.connectionGater).denyInboundConnection)||void 0===l?void 0:l.call(u,e)))throw new Pq("The multiaddr connection is blocked by gater.acceptConnection",F5.ERR_CONNECTION_INTERCEPTED);null===(h=this.components.metrics)||void 0===h||h.trackMultiaddrConnection(e),(0,Ix.Z)(this,z4).call(this,"starting the inbound connection upgrade");let a=e;if(!0!==(null===t||void 0===t?void 0:t.skipProtection)){const t=this.components.connectionProtector;null!=t&&((0,Ix.Z)(this,z4).call(this,"protecting the inbound connection"),a=await t.protect(e))}try{if(n=a,!0!==(null===t||void 0===t?void 0:t.skipEncryption)){({conn:n,remotePeer:r,protocol:s}=await this._encryptInbound(a));const e={...a,...n};await this.shouldBlockConnection(r,e,"denyInboundEncryptedConnection")}else{const t=e.remoteAddr.getPeerId();if(null==t)throw new Pq("inbound connection that skipped encryption must have a peer id",F5.ERR_INVALID_MULTIADDR);const n=R1(t);s="native",r=n}if(i=n,null!=(null===t||void 0===t?void 0:t.muxerFactory))o=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexInbound({...a,...n},this.muxers);o=e.muxerFactory,i=e.stream}}catch(d){throw(0,Ix.Z)(this,z4).error("Failed to upgrade inbound connection",d),d}return await this.shouldBlockConnection(r,e,"denyInboundUpgradedConnection"),(0,Ix.Z)(this,z4).call(this,"Successfully upgraded inbound connection"),this._createConnection({cryptoProtocol:s,direction:"inbound",maConn:e,upgradedConn:i,muxerFactory:o,remotePeer:r,transient:null===t||void 0===t?void 0:t.transient})}finally{a.removeEventListener("abort",c),this.components.connectionManager.afterUpgradeInbound()}}async upgradeOutbound(e,t){var n;const r=e.remoteAddr.getPeerId();let i,o,s,a,c,l;null!=r&&(i=R1(r),await this.shouldBlockConnection(i,e,"denyOutboundConnection")),null===(n=this.components.metrics)||void 0===n||n.trackMultiaddrConnection(e),(0,Ix.Z)(this,z4).call(this,"Starting the outbound connection upgrade");let u=e;if(!0!==(null===t||void 0===t?void 0:t.skipProtection)){const t=this.components.connectionProtector;null!=t&&(u=await t.protect(e))}try{if(o=u,!0!==(null===t||void 0===t?void 0:t.skipEncryption)){({conn:o,remotePeer:s,protocol:c}=await this._encryptOutbound(u,i));const e={...u,...o};await this.shouldBlockConnection(s,e,"denyOutboundEncryptedConnection")}else{if(null==i)throw new Pq("Encryption was skipped but no peer id was passed",F5.ERR_INVALID_PEER);c="native",s=i}if(a=o,null!=(null===t||void 0===t?void 0:t.muxerFactory))l=t.muxerFactory;else if(this.muxers.size>0){const e=await this._multiplexOutbound({...u,...o},this.muxers);l=e.muxerFactory,a=e.stream}}catch(h){throw(0,Ix.Z)(this,z4).error("Failed to upgrade outbound connection",h),await e.close(h),h}return await this.shouldBlockConnection(s,e,"denyOutboundUpgradedConnection"),(0,Ix.Z)(this,z4).call(this,"Successfully upgraded outbound connection"),this._createConnection({cryptoProtocol:c,direction:"outbound",maConn:e,upgradedConn:a,muxerFactory:l,remotePeer:s,transient:null===t||void 0===t?void 0:t.transient})}_createConnection(e){var t,n,r=this;const{cryptoProtocol:i,direction:o,maConn:s,upgradedConn:a,remotePeer:c,muxerFactory:l,transient:u}=e;let h,d,f;null!=l&&(h=l.createStreamMuxer({direction:o,onIncomingStream:e=>{null!=f&&Promise.resolve().then((async()=>{var t;const n=this.components.registrar.getProtocols(),{stream:r,protocol:i}=await M4(e,n);if((0,Ix.Z)(this,z4).call(this,"%s: incoming stream opened on %s",o,i),null==f)return;const s=function(e,t){try{const{options:n}=t.getHandler(e);return n.maxInboundStreams}catch(n){if(n.code!==F5.ERR_NO_HANDLER_FOR_PROTOCOL)throw n}return 32}(i,this.components.registrar);if(Z4(i,"inbound",f)===s){const t=new Pq('Too many inbound protocol streams for protocol "'.concat(i,'" - limit ').concat(s),F5.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS);throw e.abort(t),t}e.source=r.source,e.sink=r.sink,e.protocol=i,await this.components.peerStore.merge(c,{protocols:[i]}),null===(t=this.components.metrics)||void 0===t||t.trackProtocolStream(e,f),this._onStream({connection:f,stream:e,protocol:i})})).catch((async t=>{(0,Ix.Z)(this,z4).error(t),null==e.timeline.close&&await e.close()}))}}),d=async function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(null==h)throw new Pq("Stream is not multiplexed",F5.ERR_MUXER_UNAVAILABLE);(0,Ix.Z)(r,z4).call(r,"%s-%s: starting new stream on %s",f.id,o,e);const n=await h.newStream();try{var i;if(null==t.signal){(0,Ix.Z)(r,z4).call(r,"No abort signal was passed while trying to negotiate protocols %s falling back to default timeout",e);const n=AbortSignal.timeout(3e4);KJ(1/0,n),t={...t,signal:n}}const{stream:o,protocol:s}=await x4(n,e,t),a=function(e,t){var n;let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};try{const{options:n}=t.getHandler(e);if(null!=n.maxOutboundStreams)return n.maxOutboundStreams}catch(i){if(i.code!==F5.ERR_NO_HANDLER_FOR_PROTOCOL)throw i}return null!==(n=r.maxOutboundStreams)&&void 0!==n?n:64}(s,r.components.registrar,t);if(Z4(s,"outbound",f)>=a){const e=new Pq('Too many outbound protocol streams for protocol "'.concat(s,'" - limit ').concat(a),F5.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS);throw n.abort(e),e}return await r.components.peerStore.merge(c,{protocols:[s]}),n.source=o.source,n.sink=o.sink,n.protocol=s,null===(i=r.components.metrics)||void 0===i||i.trackProtocolStream(n,f),n}catch(s){if((0,Ix.Z)(r,z4).error("could not create new stream for protocols %s on connection with address %a",e,f.remoteAddr,s),null==n.timeline.close&&n.abort(s),null!=s.code)throw s;throw new Pq(String(s),F5.ERR_UNSUPPORTED_PROTOCOL)}},Promise.all([h.sink(a.source),a.sink(h.source)]).catch((e=>{(0,Ix.Z)(this,z4).error(e)})));const p=s.timeline;s.timeline=new Proxy(p,{set:function(){return null!=f&&"close"===(arguments.length<=1?void 0:arguments[1])&&null!=(arguments.length<=2?void 0:arguments[2])&&null==p.close&&(async()=>{try{"open"===f.status&&await f.close()}catch(e){(0,Ix.Z)(r,z4).error(e)}finally{r.events.safeDispatchEvent("connection:close",{detail:f})}})().catch((e=>{(0,Ix.Z)(r,z4).error(e)})),Reflect.set(...arguments)}}),s.timeline.upgraded=Date.now();var g;return g={remoteAddr:s.remoteAddr,remotePeer:c,status:"open",direction:o,timeline:s.timeline,multiplexer:null===(t=h)||void 0===t?void 0:t.protocol,encryption:i,transient:u,logger:this.components.logger,newStream:null!==(n=d)&&void 0!==n?n:()=>{throw new Pq("connection is not multiplexed",F5.ERR_CONNECTION_NOT_MULTIPLEXED)},getStreams:()=>null!=h?h.streams:[],close:async e=>{null!=h&&((0,Ix.Z)(this,z4).trace("close muxer"),await h.close(e)),(0,Ix.Z)(this,z4).trace("close maconn"),await s.close(e),(0,Ix.Z)(this,z4).trace("closed maconn")},abort:e=>{s.abort(e),null!=h&&h.abort(e)}},f=new j4(g),this.events.safeDispatchEvent("connection:open",{detail:f}),f}_onStream(e){const{connection:t,stream:n,protocol:r}=e,{handler:i,options:o}=this.components.registrar.getHandler(r);if(t.transient&&!0!==o.runOnTransientConnection)throw new Pq("Cannot open protocol stream on transient connection","ERR_TRANSIENT_CONNECTION");i({connection:t,stream:n})}async _encryptInbound(e){const t=Array.from(this.connectionEncryption.keys());(0,Ix.Z)(this,z4).call(this,"handling inbound crypto protocol selection",t);try{const{stream:n,protocol:r}=await M4(e,t,{writeBytes:!0}),i=this.connectionEncryption.get(r);if(null==i)throw new Error("no crypto module found for ".concat(r));return(0,Ix.Z)(this,z4).call(this,"encrypting inbound connection..."),{...await i.secureInbound(this.components.peerId,n),protocol:r}}catch(n){throw new Pq(String(n),F5.ERR_ENCRYPTION_FAILED)}}async _encryptOutbound(e,t){const n=Array.from(this.connectionEncryption.keys());(0,Ix.Z)(this,z4).call(this,"selecting outbound crypto protocol",n);try{const{stream:r,protocol:i}=await x4(e,n,{writeBytes:!0}),o=this.connectionEncryption.get(i);if(null==o)throw new Error("no crypto module found for ".concat(i));return(0,Ix.Z)(this,z4).call(this,"encrypting outbound connection to %p",t),{...await o.secureOutbound(this.components.peerId,r,t),protocol:i}}catch(r){throw new Pq(String(r),F5.ERR_ENCRYPTION_FAILED)}}async _multiplexOutbound(e,t){const n=Array.from(t.keys());(0,Ix.Z)(this,z4).call(this,"outbound selecting muxer %s",n);try{const{stream:r,protocol:i}=await x4(e,n,{writeBytes:!0});(0,Ix.Z)(this,z4).call(this,"%s selected as muxer protocol",i);return{stream:r,muxerFactory:t.get(i)}}catch(r){throw(0,Ix.Z)(this,z4).error("error multiplexing outbound stream",r),new Pq(String(r),F5.ERR_MUXER_UNAVAILABLE)}}async _multiplexInbound(e,t){const n=Array.from(t.keys());(0,Ix.Z)(this,z4).call(this,"inbound handling muxers %s",n);try{const{stream:r,protocol:i}=await M4(e,n,{writeBytes:!0});return{stream:r,muxerFactory:t.get(i)}}catch(r){throw(0,Ix.Z)(this,z4).error("error multiplexing inbound stream",r),new Pq(String(r),F5.ERR_MUXER_UNAVAILABLE)}}}var H4,q4=new WeakMap,G4=new WeakMap,W4=new WeakSet;class Q4 extends MJ{constructor(e){var t,n,r,i,o,s,a;super(),Jd(this,W4),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"contentRouting",void 0),(0,Yo.Z)(this,"peerRouting",void 0),(0,Yo.Z)(this,"keychain",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"services",void 0),(0,Yo.Z)(this,"logger",void 0),(0,Yo.Z)(this,"components",void 0),(0,_x.Z)(this,q4,{writable:!0,value:void 0}),(0,_x.Z)(this,G4,{writable:!0,value:void 0});const c=new MJ,l=c.dispatchEvent.bind(c);c.dispatchEvent=e=>{const t=l(e),n=this.dispatchEvent(new FJ(e.type,{detail:e.detail}));return t||n},KJ(1/0,c),eW(this,q4,!1),this.peerId=e.peerId,this.logger=null!==(t=e.logger)&&void 0!==t?t:RH(),eW(this,G4,this.logger.forComponent("libp2p")),this.services={};const u=this.components=function(){const e=new w5(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{});return new Proxy(e,{get(t,n,r){if("string"===typeof n&&!A5.includes(n)){const t=e.components[n];if(null==t&&!E5.includes(n))throw new Pq("".concat(n," not set"),"ERR_SERVICE_MISSING");return t}return Reflect.get(t,n,r)},set:(t,n,r)=>("string"===typeof n?e.components[n]=r:Reflect.set(t,n,r),!0)})}({peerId:e.peerId,logger:this.logger,events:c,datastore:null!==(n=e.datastore)&&void 0!==n?n:new ZH,connectionGater:S5(e.connectionGater)});this.peerStore=this.configureComponent("peerStore",new p5(u,{addressFilter:this.components.connectionGater.filterMultiaddrForPeer,...e.peerStore})),null!=e.metrics&&(this.metrics=this.configureComponent("metrics",e.metrics(this.components))),u.events.addEventListener("peer:update",(e=>{if(null==e.detail.previous){const t={id:e.detail.peer.id,multiaddrs:e.detail.peer.addresses.map((e=>e.multiaddr)),protocols:e.detail.peer.protocols};u.events.safeDispatchEvent("peer:discovery",{detail:t})}})),null!=e.connectionProtector&&this.configureComponent("connectionProtector",e.connectionProtector(u)),this.components.upgrader=new V4(this.components,{connectionEncryption:(null!==(r=e.connectionEncryption)&&void 0!==r?r:[]).map(((e,t)=>this.configureComponent("connection-encryption-".concat(t),e(this.components)))),muxers:(null!==(i=e.streamMuxers)&&void 0!==i?i:[]).map(((e,t)=>this.configureComponent("stream-muxers-".concat(t),e(this.components)))),inboundUpgradeTimeout:e.connectionManager.inboundUpgradeTimeout}),this.configureComponent("transportManager",new _4(this.components,e.transportManager)),this.configureComponent("connectionManager",new f4(this.components,e.connectionManager)),this.configureComponent("registrar",new A4(this.components)),this.configureComponent("addressManager",new b5(this.components,e.addresses));const h=o1.generateOptions();this.keychain=this.configureComponent("keyChain",new o1(this.components,{...h,...e.keychain}));const d=(null!==(o=e.peerRouters)&&void 0!==o?o:[]).map(((e,t)=>this.configureComponent("peer-router-".concat(t),e(this.components))));this.peerRouting=this.components.peerRouting=this.configureComponent("peerRouting",new w4(this.components,{routers:d}));const f=(null!==(s=e.contentRouters)&&void 0!==s?s:[]).map(((e,t)=>this.configureComponent("content-router-".concat(t),e(this.components))));if(this.contentRouting=this.components.contentRouting=this.configureComponent("contentRouting",new m4(this.components,{routers:f})),(null!==(a=e.peerDiscovery)&&void 0!==a?a:[]).forEach(((e,t)=>{this.configureComponent("peer-discovery-".concat(t),e(this.components)).addEventListener("peer",(e=>{Xd(this,W4,Y4).call(this,e)}))})),e.transports.forEach(((e,t)=>{this.components.transportManager.add(this.configureComponent("transport-".concat(t),e(this.components)))})),null!=e.services)for(const p of Object.keys(e.services)){const t=(0,e.services[p])(this.components);null!=t?(this.services[p]=t,this.configureComponent(p,t),null!=t[NJ]&&((0,Ix.Z)(this,G4).call(this,"registering service %s for content routing",p),f.push(t[NJ])),null!=t[ZJ]&&((0,Ix.Z)(this,G4).call(this,"registering service %s for peer routing",p),d.push(t[ZJ])),null!=t[jJ]&&((0,Ix.Z)(this,G4).call(this,"registering service %s for peer discovery",p),t[jJ].addEventListener("peer",(e=>{Xd(this,W4,Y4).call(this,e)})))):(0,Ix.Z)(this,G4).error("service factory %s returned null or undefined instance",p)}}configureComponent(e,t){return null==t&&(0,Ix.Z)(this,G4).error("component %s was null or undefined",e),this.components[e]=t,t}async start(){if((0,Ix.Z)(this,q4))return;eW(this,q4,!0),(0,Ix.Z)(this,G4).call(this,"libp2p is starting");null==(await this.keychain.listKeys()).find((e=>"self"===e.name))&&((0,Ix.Z)(this,G4).call(this,"importing self key into keychain"),await this.keychain.importPeer("self",this.components.peerId));try{var e,t,n,r;await(null===(e=(t=this.components).beforeStart)||void 0===e?void 0:e.call(t)),await this.components.start(),await(null===(n=(r=this.components).afterStart)||void 0===n?void 0:n.call(r)),this.safeDispatchEvent("start",{detail:this}),(0,Ix.Z)(this,G4).call(this,"libp2p has started")}catch(i){throw(0,Ix.Z)(this,G4).error("An error occurred starting libp2p",i),await this.stop(),i}}async stop(){var e,t,n,r;(0,Ix.Z)(this,q4)&&((0,Ix.Z)(this,G4).call(this,"libp2p is stopping"),eW(this,q4,!1),await(null===(e=(t=this.components).beforeStop)||void 0===e?void 0:e.call(t)),await this.components.stop(),await(null===(n=(r=this.components).afterStop)||void 0===n?void 0:n.call(r)),this.safeDispatchEvent("stop",{detail:this}),(0,Ix.Z)(this,G4).call(this,"libp2p has stopped"))}isStarted(){return(0,Ix.Z)(this,q4)}getConnections(e){return this.components.connectionManager.getConnections(e)}getDialQueue(){return this.components.connectionManager.getDialQueue()}getPeers(){const e=new Ax;for(const t of this.components.connectionManager.getConnections())e.add(t.remotePeer);return Array.from(e)}async dial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.components.connectionManager.openConnection(e,t)}async dialProtocol(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(null==t)throw new Pq("no protocols were provided to open a stream",F5.ERR_INVALID_PROTOCOLS_FOR_STREAM);if(0===(t=Array.isArray(t)?t:[t]).length)throw new Pq("no protocols were provided to open a stream",F5.ERR_INVALID_PROTOCOLS_FOR_STREAM);return(await this.dial(e,n)).newStream(t,n)}getMultiaddrs(){return this.components.addressManager.getAddresses()}getProtocols(){return this.components.registrar.getProtocols()}async hangUp(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};var n;(0,og.h2)(e)&&(e=R1(null!==(n=e.getPeerId())&&void 0!==n?n:""));await this.components.connectionManager.closeConnections(e,t)}async getPublicKey(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((0,Ix.Z)(this,G4).call(this,"getPublicKey %p",e),null!=e.publicKey)return e.publicKey;const n=await this.peerStore.get(e);if(null!=n.id.publicKey)return n.id.publicKey;const r=(0,Ls.z)([(0,mu.m)("/pk/"),e.multihash.digest]),i=await this.contentRouting.get(r,t);return DJ(i),await this.peerStore.patch(e,{publicKey:i}),i}async handle(e,t,n){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.handle(e,t,n)})))}async unhandle(e){Array.isArray(e)||(e=[e]),await Promise.all(e.map((async e=>{await this.components.registrar.unhandle(e)})))}async register(e,t){return this.components.registrar.register(e,t)}unregister(e){this.components.registrar.unregister(e)}}function Y4(e){const{detail:t}=e;t.id.toString()!==this.peerId.toString()?this.components.peerStore.merge(t.id,{multiaddrs:t.multiaddrs,protocols:t.protocols}).catch((e=>{(0,Ix.Z)(this,G4).error(e)})):(0,Ix.Z)(this,G4).error(new Error(F5.ERR_DISCOVERED_SELF))}async function J4(e){if(null==e.peerId){const n=e.datastore;if(null!=n)try{const t=new o1({datastore:n},(0,H0.Z)(o1.generateOptions(),e.keychain));e.peerId=await t.exportPeerId("self")}catch(t){if("ERR_NOT_FOUND"!==t.code)throw t}}return null==e.peerId&&(e.peerId=await OA()),new Q4(function(e){var t,n;const r=(0,H0.Z)(K5,e);if(null==r.transports||r.transports.length<1)throw new Pq(U5.ERR_TRANSPORTS_REQUIRED,F5.ERR_TRANSPORTS_REQUIRED);if(null===r.connectionProtector&&null!=(null===(t=globalThis.process)||void 0===t||null===(n=t.env)||void 0===n?void 0:n.LIBP2P_FORCE_PNET))throw new Pq(U5.ERR_PROTECTOR_REQUIRED,F5.ERR_PROTECTOR_REQUIRED);return r}(e))}var X4=new WeakMap;class $4 extends EventTarget{constructor(){super(...arguments),(0,_x.Z)(this,X4,{writable:!0,value:new Map})}listenerCount(e){const t=(0,Ix.Z)(this,X4).get(e);return null==t?0:t.length}addEventListener(e,t,n){var r;super.addEventListener(e,t,n);let i=(0,Ix.Z)(this,X4).get(e);null==i&&(i=[],(0,Ix.Z)(this,X4).set(e,i)),i.push({callback:t,once:null!==(r=!0!==n&&!1!==n&&(null===n||void 0===n?void 0:n.once))&&void 0!==r&&r})}removeEventListener(e,t,n){super.removeEventListener(e.toString(),null!==t&&void 0!==t?t:null,n);let r=(0,Ix.Z)(this,X4).get(e);null!=r&&(r=r.filter((e=>{let{callback:n}=e;return n!==t})),(0,Ix.Z)(this,X4).set(e,r))}dispatchEvent(e){const t=super.dispatchEvent(e);let n=(0,Ix.Z)(this,X4).get(e.type);return null==n||(n=n.filter((e=>{let{once:t}=e;return!t})),(0,Ix.Z)(this,X4).set(e.type,n)),t}safeDispatchEvent(e,t){return this.dispatchEvent(new t6(e,t))}}class e6 extends Event{constructor(e,t){super(e,t),(0,Yo.Z)(this,"detail",void 0),this.detail=null===t||void 0===t?void 0:t.detail}}const t6=null!==(H4=globalThis.CustomEvent)&&void 0!==H4?H4:e6,n6="StrictSign",r6="StrictNoSign";var i6;!function(e){e.Accept="accept",e.Ignore="ignore",e.Reject="reject"}(i6||(i6={}));var o6=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const s6=o6,a6=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class c6{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class l6{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return h6(this,e)}}class u6{constructor(e){this.decoders=e}or(e){return h6(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const h6=(e,t)=>new u6({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class d6{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new c6(e,t,n),this.decoder=new l6(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const f6=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new d6(t,n,r,i)},p6=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=s6(r,n);return f6({prefix:t,name:n,encode:i,decode:e=>a6(o(e))})},g6=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return f6({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},y6=g6({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),m6=g6({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),v6=g6({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),b6=g6({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),w6=g6({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),E6=g6({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),A6=g6({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),S6=g6({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),_6=g6({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),I6=p6({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),C6=p6({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),T6=g6({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),k6=g6({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),R6=g6({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),x6=g6({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function P6(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}("".concat(e,":trace"));return cf().enabled("".concat(e,":trace"))&&null!=cf().names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=cf()("".concat(e,":trace"))),Object.assign(cf()(e),{error:cf()("".concat(e,":error")),trace:t})}cf().formatters.b=e=>null==e?"undefined":I6.baseEncode(e),cf().formatters.t=e=>null==e?"undefined":y6.baseEncode(e),cf().formatters.m=e=>null==e?"undefined":T6.baseEncode(e),cf().formatters.p=e=>null==e?"undefined":e.toString(),cf().formatters.c=e=>null==e?"undefined":e.toString(),cf().formatters.k=e=>null==e?"undefined":e.toString(),cf().formatters.a=e=>null==e?"undefined":e.toString();class D6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=D6.code,this.type=D6.type}}(0,Yo.Z)(D6,"code","ABORT_ERR"),(0,Yo.Z)(D6,"type","aborted");class O6 extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class N6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=N6.code}}(0,Yo.Z)(N6,"code","ERR_UNEXPECTED_PEER");class B6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=B6.code}}(0,Yo.Z)(B6,"code","ERR_INVALID_CRYPTO_EXCHANGE");class L6 extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=L6.code}}(0,Yo.Z)(L6,"code","ERR_INVALID_CRYPTO_TRANSMISSION");const M6=Symbol.for("@libp2p/peer-id");const U6=p6({prefix:"9",name:"base10",alphabet:"0123456789"}),F6=g6({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),K6=g6({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),j6=g6({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),Z6=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),z6=Z6.reduce(((e,t,n)=>(e[n]=t,e)),[]),V6=Z6.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const H6=f6({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=z6[t]),"")},decode:function(e){const t=[];for(const n of e){const e=V6[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),q6=p6({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),G6=p6({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),W6=g6({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),Q6=f6({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),Y6=new TextEncoder,J6=new TextDecoder,X6="json",$6=512,e8=e=>Y6.encode(JSON.stringify(e)),t8=e=>JSON.parse(J6.decode(e)),n8="raw",r8=85,i8=e=>a6(e),o8=e=>a6(e);var s8=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=l8;)n[r++]=255&t|a8,t/=128;for(;t&c8;)n[r++]=255&t|a8,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},a8=128,c8=-128,l8=Math.pow(2,31);var u8=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&d8)<<o:(r&d8)*Math.pow(2,o),o+=7}while(r>=h8);return e.bytes=s-n,i},h8=128,d8=127;var f8=Math.pow(2,7),p8=Math.pow(2,14),g8=Math.pow(2,21),y8=Math.pow(2,28),m8=Math.pow(2,35),v8=Math.pow(2,42),b8=Math.pow(2,49),w8=Math.pow(2,56),E8=Math.pow(2,63);const A8={encode:s8,decode:u8,encodingLength:function(e){return e<f8?1:e<p8?2:e<g8?3:e<y8?4:e<m8?5:e<v8?6:e<b8?7:e<w8?8:e<E8?9:10}},S8=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[A8.decode(e,t),A8.decode.bytes]},_8=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return A8.encode(e,t,n),t},I8=e=>A8.encodingLength(e),C8=(e,t)=>{const n=t.byteLength,r=I8(e),i=r+I8(n),o=new Uint8Array(i+n);return _8(e,o,0),_8(n,o,r),o.set(t,i),new k8(e,n,t,o)},T8=e=>{const t=a6(e),[n,r]=S8(t),[i,o]=S8(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new k8(n,i,s,t)};class k8{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const R8=a6,x8={code:0,name:"identity",encode:R8,digest:e=>C8(0,R8(e))},P8=e=>{let{name:t,code:n,encode:r}=e;return new D8(t,n,r)};class D8{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?C8(this.code,t):t.then((e=>C8(this.code,e)))}throw Error("Unknown type, must be binary type")}}const O8=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),N8=P8({name:"sha2-256",code:18,encode:O8("SHA-256")}),B8=P8({name:"sha2-512",code:19,encode:O8("SHA-512")}),L8=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?j8(n,U8(e),t||I6.encoder):Z8(n,U8(e),t||y6.encoder)},M8=new WeakMap,U8=e=>{const t=M8.get(e);if(null==t){const t=new Map;return M8.set(e,t),t}return t};class F8{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==z8)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==V8)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return F8.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=C8(e,t);return F8.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return F8.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return L8(this,e)}toJSON(){return{"/":L8(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof F8)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new F8(e,n,r,i||H8(e,n,r.bytes))}if(!0===t[q8]){const{version:e,multihash:n,code:r}=t,i=T8(n);return F8.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==z8)throw new Error("Version 0 CID must use dag-pb (code: ".concat(z8,") block encoding"));return new F8(e,t,n,n.bytes);case 1:{const r=H8(e,t,n.bytes);return new F8(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return F8.create(0,z8,e)}static createV1(e,t){return F8.create(1,e,t)}static decode(e){const[t,n]=F8.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=F8.inspectBytes(e),n=t.size-t.multihashSize,r=a6(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new k8(t.multihashCode,t.digestSize,i,r);return[0===t.version?F8.createV0(o):F8.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=S8(e.subarray(t));return t+=r,n};let r=n(),i=z8;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=K8(e,t),i=F8.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return U8(i).set(n,e),i}}const K8=(e,t)=>{switch(e[0]){case"Q":{const n=t||I6;return[I6.prefix,n.decode("".concat(I6.prefix).concat(e))]}case I6.prefix:{const n=t||I6;return[I6.prefix,n.decode(e)]}case y6.prefix:{const n=t||y6;return[y6.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},j8=(e,t,n)=>{const{prefix:r}=n;if(r!==I6.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},Z8=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},z8=112,V8=18,H8=(e,t,n)=>{const r=I8(e),i=r+I8(t),o=new Uint8Array(i+n.byteLength);return _8(e,o,0),_8(t,o,r),o.set(n,i),o},q8=Symbol.for("@ipld/js-cid/CID"),G8={...Hn,...jn,...Vn,...Fn,...Kn,...Ln,...zn,...Mn,...Un,...Zn};let W8;const Q8=Symbol.for("nodejs.util.inspect.custom"),Y8=Object.values(G8).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),G8.identity.decoder),J8=114,X8=36,$8=37;W8=Symbol.toStringTag;class e7{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,M6,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[W8](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=I6.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return F8.createV1(J8,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return i7(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[Q8](){return"PeerId(".concat(this.toString(),")")}}class t7 extends e7{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class n7 extends e7{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class r7 extends e7{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function i7(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:Y8,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=T8(I6.decode("z".concat(e)));return e.startsWith("12D")?new n7({multihash:t}):e.startsWith("16U")?new r7({multihash:t}):new t7({multihash:t})}return o7(Y8.decode(e))}function o7(e){try{const t=T8(e);if(t.code===x8.code){if(t.digest.length===X8)return new n7({multihash:t});if(t.digest.length===$8)return new r7({multihash:t})}if(t.code===N8.code)return new t7({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==J8)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===N8.code)return new t7({multihash:e.multihash});if(t.code===x8.code){if(t.digest.length===X8)return new n7({multihash:e.multihash});if(t.digest.length===$8)return new r7({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(F8.decode(e))}throw new Error("Supplied PeerID CID is invalid")}class s7{constructor(e){if((0,Yo.Z)(this,"buffer",void 0),(0,Yo.Z)(this,"mask",void 0),(0,Yo.Z)(this,"top",void 0),(0,Yo.Z)(this,"btm",void 0),(0,Yo.Z)(this,"next",void 0),!(e>0)||0!==(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class a7{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"size",void 0),(0,Yo.Z)(this,"hwm",void 0),(0,Yo.Z)(this,"head",void 0),(0,Yo.Z)(this,"tail",void 0),this.hwm=null!==(e=t.splitLimit)&&void 0!==e?e:16,this.head=new s7(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}push(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new s7(2*this.head.buffer.length),this.head.push(e)}}shift(){var e;let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}class c7 extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"code",void 0),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function l7(){return u7((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function u7(e,t){var n;let r,i,o,s=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,a=new a7,c=Ws();const l=e=>null!=i?i(e):(a.push(e),r),u=e=>{var n;if(o)return r;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},h=e=>o?r:(o=!0,null!=e?(e=>(a=new a7,null!=i?i({error:e}):(a.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return a.isEmpty()?o?{done:!0}:await new Promise(((t,n)=>{i=o=>{i=null,a.push(o);try{t(e(a))}catch(s){n(s)}return r}})):e(a)}finally{a.isEmpty()&&queueMicrotask((()=>{c.resolve(),c=Ws()}))}},return:()=>(a=new a7,h(),{done:!0}),throw:e=>(h(e),{done:!0}),push:u,end:h,get readableLength(){return a.size},onEmpty:async e=>{const t=null===e||void 0===e?void 0:e.signal;if(null===t||void 0===t||t.throwIfAborted(),a.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new c7)},t.addEventListener("abort",r)})));try{await Promise.race([c.promise,n])}finally{null!=r&&null!=t&&(null===t||void 0===t||t.removeEventListener("abort",r))}}},null==s)return r;const d=r;return r={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(d.return(),null!=s&&(s(),s=void 0),{done:!0}),push:u,end:e=>(d.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},r}const h7=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[];for(const i of t)null==i[Symbol.asyncIterator]&&r.push(i);return r.length===t.length?function*(){for(const e of r)yield*e}():async function*(){const e=l7({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(t.map((async t=>{for await(const n of t)e.push(n)}))),e.end()}catch(n){e.end(n)}})),yield*e}()};function d7(e){if(null==e)throw new Error("Empty pipeline");if(y7(e)){const t=e;e=()=>t.source}else if(g7(e)||p7(e)){const t=e;e=()=>t}for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];const i=[e,...n];if(i.length>1&&y7(i[i.length-1])&&(i[i.length-1]=i[i.length-1].sink),i.length>2)for(let o=1;o<i.length-1;o++)y7(i[o])&&(i[o]=m7(i[o]));return f7(...i)}const f7=function(){let e;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},p7=e=>null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator]),g7=e=>null!=(null===e||void 0===e?void 0:e[Symbol.iterator]),y7=e=>null!=e&&(null!=e.sink&&null!=e.source),m7=e=>t=>{const n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){const t=l7({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const i=e.source;if(p7(i))r=async function*(){yield*i,t.end()};else{if(!g7(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return h7(t,r())}return e.source},v7="/floodsub/1.0.0",b7="/meshsub/1.0.0",w7="/meshsub/1.1.0",E7=5e3;var A7=n(62001),S7=n.n(A7);const _7={maxSubscriptions:1/0,maxMessages:1/0,maxIhaveMessageIDs:1/0,maxIwantMessageIDs:1/0,maxControlMessages:1/0,maxPeerInfos:1/0};function I7(e,t){t={...t};const n=S7().Reader.create(e),r=e.length,i=void 0===r?n.len:n.pos+r,o={};for(;n.pos<i;){const e=n.uint32();switch(e>>>3){case 1:null!=o.subscriptions&&o.subscriptions.length>0||(o.subscriptions=[]),o.subscriptions.length<t.maxSubscriptions?o.subscriptions.push(C7(n,n.uint32())):n.skipType(7&e);break;case 2:null!=o.messages&&o.messages.length>0||(o.messages=[]),o.messages.length<t.maxMessages?o.messages.push(T7(n,n.uint32())):n.skipType(7&e);break;case 3:o.control=k7(n,n.uint32(),t);break;default:n.skipType(7&e)}}return o}function C7(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.subscribe=e.bool();break;case 2:r.topic=e.string();break;default:e.skipType(7&t)}}return r}function T7(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.from=e.bytes();break;case 2:r.data=e.bytes();break;case 3:r.seqno=e.bytes();break;case 4:r.topic=e.string();break;case 5:r.signature=e.bytes();break;case 6:r.key=e.bytes();break;default:e.skipType(7&t)}}if(!r.topic)throw Error("missing required 'topic'");return r}function k7(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:null!=i.ihave&&i.ihave.length>0||(i.ihave=[]),i.ihave.length<n.maxControlMessages?i.ihave.push(R7(e,e.uint32(),n)):e.skipType(7&t);break;case 2:null!=i.iwant&&i.iwant.length>0||(i.iwant=[]),i.iwant.length<n.maxControlMessages?i.iwant.push(x7(e,e.uint32(),n)):e.skipType(7&t);break;case 3:null!=i.graft&&i.graft.length>0||(i.graft=[]),i.graft.length<n.maxControlMessages?i.graft.push(P7(e,e.uint32())):e.skipType(7&t);break;case 4:null!=i.prune&&i.prune.length>0||(i.prune=[]),i.prune.length<n.maxControlMessages?i.prune.push(D7(e,e.uint32(),n)):e.skipType(7&t);break;default:e.skipType(7&t)}}return i}function R7(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:i.topicID=e.string();break;case 2:null!=i.messageIDs&&i.messageIDs.length>0||(i.messageIDs=[]),n.maxIhaveMessageIDs-- >0?i.messageIDs.push(e.bytes()):e.skipType(7&t);break;default:e.skipType(7&t)}}return i}function x7(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();if(t>>>3===1)null!=i.messageIDs&&i.messageIDs.length>0||(i.messageIDs=[]),n.maxIwantMessageIDs-- >0?i.messageIDs.push(e.bytes()):e.skipType(7&t);else e.skipType(7&t)}return i}function P7(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();if(t>>>3===1)r.topicID=e.string();else e.skipType(7&t)}return r}function D7(e,t,n){const r=void 0===t?e.len:e.pos+t,i={};for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:i.topicID=e.string();break;case 2:null!=i.peers&&i.peers.length>0||(i.peers=[]),n.maxPeerInfos-- >0?i.peers.push(O7(e,e.uint32())):e.skipType(7&t);break;case 3:i.backoff=e.uint64();break;default:e.skipType(7&t)}}return i}function O7(e,t){const n=void 0===t?e.len:e.pos+t,r={};for(;e.pos<n;){const t=e.uint32();switch(t>>>3){case 1:r.peerID=e.bytes();break;case 2:r.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return r}const N7=n.p+"static/media/rpc.3ba5ca7bdb004060d5e2.cjs",{RPC:B7}=N7;class L7{constructor(e,t,n){(0,Yo.Z)(this,"gossip",void 0),(0,Yo.Z)(this,"msgs",new Map),(0,Yo.Z)(this,"msgIdToStrFn",void 0),(0,Yo.Z)(this,"history",[]),(0,Yo.Z)(this,"notValidatedCount",0),this.gossip=e,this.msgIdToStrFn=n;for(let r=0;r<t;r++)this.history[r]=[]}get size(){return this.msgs.size}put(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const{msgIdStr:r}=e;return!this.msgs.has(r)&&(this.msgs.set(r,{message:t,validated:n,originatingPeers:new Set,iwantCounts:new Map}),this.history[0].push({...e,topic:t.topic}),n||this.notValidatedCount++,!0)}observeDuplicate(e,t){const n=this.msgs.get(e);null==n||n.validated||n.originatingPeers.add(t)}get(e){var t;return null===(t=this.msgs.get(this.msgIdToStrFn(e)))||void 0===t?void 0:t.message}getWithIWantCount(e,t){var n;const r=this.msgs.get(e);if(null==r)return null;const i=(null!==(n=r.iwantCounts.get(t))&&void 0!==n?n:0)+1;return r.iwantCounts.set(t,i),{msg:r.message,count:i}}getGossipIDs(e){const t=new Map;for(let n=0;n<this.gossip;n++)this.history[n].forEach((n=>{var r;const i=this.msgs.get(n.msgIdStr);if(null!==(r=null===i||void 0===i?void 0:i.validated)&&void 0!==r&&r&&e.has(n.topic)){let e=t.get(n.topic);null==e&&(e=[],t.set(n.topic,e)),e.push(n.msgId)}}));return t}validate(e){const t=this.msgs.get(e);if(null==t)return null;t.validated||this.notValidatedCount--;const{message:n,originatingPeers:r}=t;return t.validated=!0,t.originatingPeers=new Set,{message:n,originatingPeers:r}}shift(){this.history[this.history.length-1].forEach((e=>{const t=this.msgs.get(e.msgIdStr);null!=t&&(this.msgs.delete(e.msgIdStr),t.validated||this.notValidatedCount--)})),this.history.pop(),this.history.unshift([])}remove(e){const t=this.msgs.get(e);return null==t?null:(this.msgs.delete(e),t)}}var M7,U7,F7,K7,j7,Z7,z7,V7,H7,q7,G7;function W7(e){switch(e){case i6.Ignore:return F7.Ignore;case i6.Reject:return F7.Reject;default:throw new Error("Unreachable")}}!function(e){e.StrictSign="StrictSign",e.StrictNoSign="StrictNoSign"}(M7||(M7={})),function(e){e[e.Signing=0]="Signing",e[e.Anonymous=1]="Anonymous"}(U7||(U7={})),function(e){e.Error="error",e.Ignore="ignore",e.Reject="reject",e.Blacklisted="blacklisted"}(F7||(F7={})),function(e){e.InvalidSignature="invalid_signature",e.InvalidSeqno="invalid_seqno",e.InvalidPeerId="invalid_peerid",e.SignaturePresent="signature_present",e.SeqnoPresent="seqno_present",e.FromPresent="from_present",e.TransformFailed="transform_failed"}(K7||(K7={})),function(e){e.duplicate="duplicate",e.invalid="invalid",e.valid="valid"}(j7||(j7={})),function(e){e.forward="forward",e.publish="publish"}(Z7||(Z7={})),function(e){e.Fanout="fanout",e.Random="random",e.Subscribed="subscribed",e.Outbound="outbound",e.NotEnough="not_enough",e.Opportunistic="opportunistic"}(z7||(z7={})),function(e){e.Dc="disconnected",e.BadScore="bad_score",e.Prune="prune",e.Excess="excess"}(V7||(V7={})),function(e){e.GraftBackoff="graft_backoff",e.BrokenPromise="broken_promise",e.MessageDeficit="message_deficit",e.IPColocation="IP_colocation"}(H7||(H7={})),function(e){e.LowScore="low_score",e.MaxIhave="max_ihave",e.MaxIasked="max_iasked"}(q7||(q7={})),function(e){e.graylist="graylist",e.publish="publish",e.gossip="gossip",e.mesh="mesh"}(G7||(G7={}));const Q7="ERR_INVALID_PEER_SCORE_PARAMS",Y7={topics:{},topicScoreCap:10,appSpecificScore:()=>0,appSpecificWeight:10,IPColocationFactorWeight:-5,IPColocationFactorThreshold:10,IPColocationFactorWhitelist:new Set,behaviourPenaltyWeight:-10,behaviourPenaltyThreshold:0,behaviourPenaltyDecay:.2,decayInterval:1e3,decayToZero:.1,retainScore:36e5},J7={topicWeight:.5,timeInMeshWeight:1,timeInMeshQuantum:1,timeInMeshCap:3600,firstMessageDeliveriesWeight:1,firstMessageDeliveriesDecay:.5,firstMessageDeliveriesCap:2e3,meshMessageDeliveriesWeight:-1,meshMessageDeliveriesDecay:.5,meshMessageDeliveriesCap:100,meshMessageDeliveriesThreshold:20,meshMessageDeliveriesWindow:10,meshMessageDeliveriesActivation:5e3,meshFailurePenaltyWeight:-1,meshFailurePenaltyDecay:.5,invalidMessageDeliveriesWeight:-1,invalidMessageDeliveriesDecay:.3};function X7(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{...Y7,...e,topics:null!=e.topics?Object.entries(e.topics).reduce(((e,t)=>{let[n,r]=t;return e[n]=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return{...J7,...e}}(r),e}),{}):{}}}function $7(e){if(e.topicWeight<0)throw new O6("invalid topic weight; must be >= 0",Q7);if(0===e.timeInMeshQuantum)throw new O6("invalid TimeInMeshQuantum; must be non zero",Q7);if(e.timeInMeshWeight<0)throw new O6("invalid TimeInMeshWeight; must be positive (or 0 to disable)",Q7);if(0!==e.timeInMeshWeight&&e.timeInMeshQuantum<=0)throw new O6("invalid TimeInMeshQuantum; must be positive",Q7);if(0!==e.timeInMeshWeight&&e.timeInMeshCap<=0)throw new O6("invalid TimeInMeshCap; must be positive",Q7);if(e.firstMessageDeliveriesWeight<0)throw new O6("invallid FirstMessageDeliveriesWeight; must be positive (or 0 to disable)",Q7);if(0!==e.firstMessageDeliveriesWeight&&(e.firstMessageDeliveriesDecay<=0||e.firstMessageDeliveriesDecay>=1))throw new O6("invalid FirstMessageDeliveriesDecay; must be between 0 and 1",Q7);if(0!==e.firstMessageDeliveriesWeight&&e.firstMessageDeliveriesCap<=0)throw new O6("invalid FirstMessageDeliveriesCap; must be positive",Q7);if(e.meshMessageDeliveriesWeight>0)throw new O6("invalid MeshMessageDeliveriesWeight; must be negative (or 0 to disable)",Q7);if(0!==e.meshMessageDeliveriesWeight&&(e.meshMessageDeliveriesDecay<=0||e.meshMessageDeliveriesDecay>=1))throw new O6("invalid MeshMessageDeliveriesDecay; must be between 0 and 1",Q7);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesCap<=0)throw new O6("invalid MeshMessageDeliveriesCap; must be positive",Q7);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesThreshold<=0)throw new O6("invalid MeshMessageDeliveriesThreshold; must be positive",Q7);if(e.meshMessageDeliveriesWindow<0)throw new O6("invalid MeshMessageDeliveriesWindow; must be non-negative",Q7);if(0!==e.meshMessageDeliveriesWeight&&e.meshMessageDeliveriesActivation<1e3)throw new O6("invalid MeshMessageDeliveriesActivation; must be at least 1s",Q7);if(e.meshFailurePenaltyWeight>0)throw new O6("invalid MeshFailurePenaltyWeight; must be negative (or 0 to disable)",Q7);if(0!==e.meshFailurePenaltyWeight&&(e.meshFailurePenaltyDecay<=0||e.meshFailurePenaltyDecay>=1))throw new O6("invalid MeshFailurePenaltyDecay; must be between 0 and 1",Q7);if(e.invalidMessageDeliveriesWeight>0)throw new O6("invalid InvalidMessageDeliveriesWeight; must be negative (or 0 to disable)",Q7);if(e.invalidMessageDeliveriesDecay<=0||e.invalidMessageDeliveriesDecay>=1)throw new O6("invalid InvalidMessageDeliveriesDecay; must be between 0 and 1",Q7)}const e9={gossipThreshold:-10,publishThreshold:-50,graylistThreshold:-80,acceptPXThreshold:10,opportunisticGraftThreshold:20};function t9(){return{...e9,...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}}}function n9(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:()=>!0;const r=new Set;if(t<=0)return r;for(const i of e){if(r.size>=t)break;n(i)&&(r.add(i),e.delete(i))}return r}class r9 extends Map{constructor(e){super(),(0,Yo.Z)(this,"getDefault",void 0),this.getDefault=e}getOrDefault(e){let t=super.get(e);return void 0===t&&(t=this.getDefault(),this.set(e,t)),t}}function i9(e,t,n,r){let i=0;Object.entries(t.topics).forEach((e=>{let[t,r]=e;const o=n.topics[t];if(void 0===o)return;let s=0;if(r.inMesh){let e=r.meshTime/o.timeInMeshQuantum;e>o.timeInMeshCap&&(e=o.timeInMeshCap),s+=e*o.timeInMeshWeight}let a=r.firstMessageDeliveries;if(a>o.firstMessageDeliveriesCap&&(a=o.firstMessageDeliveriesCap),s+=a*o.firstMessageDeliveriesWeight,r.meshMessageDeliveriesActive&&r.meshMessageDeliveries<o.meshMessageDeliveriesThreshold){const e=o.meshMessageDeliveriesThreshold-r.meshMessageDeliveries;s+=e*e*o.meshMessageDeliveriesWeight}s+=r.meshFailurePenalty*o.meshFailurePenaltyWeight;s+=r.invalidMessageDeliveries*r.invalidMessageDeliveries*o.invalidMessageDeliveriesWeight,i+=s*o.topicWeight})),n.topicScoreCap>0&&i>n.topicScoreCap&&(i=n.topicScoreCap);const o=n.appSpecificScore(e);if(i+=o*n.appSpecificWeight,t.knownIPs.forEach((e=>{if(n.IPColocationFactorWhitelist.has(e))return;const t=r.get(e),o=null!=t?t.size:0;if(o>n.IPColocationFactorThreshold){const e=o-n.IPColocationFactorThreshold;i+=e*e*n.IPColocationFactorWeight}})),t.behaviourPenalty>n.behaviourPenaltyThreshold){const e=t.behaviourPenalty-n.behaviourPenaltyThreshold;i+=e*e*n.behaviourPenaltyWeight}return i}var o9,s9=n(43663),a9=n.n(s9);!function(e){e[e.unknown=0]="unknown",e[e.valid=1]="valid",e[e.invalid=2]="invalid",e[e.ignored=3]="ignored"}(o9||(o9={}));class c9{constructor(){(0,Yo.Z)(this,"records",void 0),(0,Yo.Z)(this,"queue",void 0),this.records=new Map,this.queue=new(a9())}getRecord(e){return this.records.get(e)}ensureRecord(e){let t=this.records.get(e);if(null!=t)return t;t={status:o9.unknown,firstSeenTsMs:Date.now(),validated:0,peers:new Set},this.records.set(e,t);const n={msgId:e,expire:Date.now()+12e4};return this.queue.push(n),t}gc(){const e=Date.now();let t=this.queue.peekFront();for(;null!=t&&t.expire<e;)this.records.delete(t.msgId),this.queue.shift(),t=this.queue.peekFront()}clear(){this.records.clear(),this.queue.clear()}}const l9=P6("libp2p:gossipsub:score");class u9{constructor(e,t,n){var r;(0,Yo.Z)(this,"params",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"peerStats",new Map),(0,Yo.Z)(this,"peerIPs",new r9((()=>new Set))),(0,Yo.Z)(this,"scoreCache",new Map),(0,Yo.Z)(this,"deliveryRecords",new c9),(0,Yo.Z)(this,"_backgroundInterval",void 0),(0,Yo.Z)(this,"scoreCacheValidityMs",void 0),(0,Yo.Z)(this,"computeScore",void 0),this.params=e,this.metrics=t,function(e){for(const[n,r]of Object.entries(e.topics))try{$7(r)}catch(t){throw new O6("invalid score parameters for topic ".concat(n,": ").concat(t.message),Q7)}if(e.topicScoreCap<0)throw new O6("invalid topic score cap; must be positive (or 0 for no cap)",Q7);if(null===e.appSpecificScore||void 0===e.appSpecificScore)throw new O6("missing application specific score function",Q7);if(e.IPColocationFactorWeight>0)throw new O6("invalid IPColocationFactorWeight; must be negative (or 0 to disable)",Q7);if(0!==e.IPColocationFactorWeight&&e.IPColocationFactorThreshold<1)throw new O6("invalid IPColocationFactorThreshold; must be at least 1",Q7);if(e.behaviourPenaltyWeight>0)throw new O6("invalid BehaviourPenaltyWeight; must be negative (or 0 to disable)",Q7);if(0!==e.behaviourPenaltyWeight&&(e.behaviourPenaltyDecay<=0||e.behaviourPenaltyDecay>=1))throw new O6("invalid BehaviourPenaltyDecay; must be between 0 and 1",Q7);if(e.decayInterval<1e3)throw new O6("invalid DecayInterval; must be at least 1s",Q7);if(e.decayToZero<=0||e.decayToZero>=1)throw new O6("invalid DecayToZero; must be between 0 and 1",Q7)}(e),this.scoreCacheValidityMs=n.scoreCacheValidityMs,this.computeScore=null!==(r=n.computeScore)&&void 0!==r?r:i9}get size(){return this.peerStats.size}start(){null==this._backgroundInterval?(this._backgroundInterval=setInterval((()=>{this.background()}),this.params.decayInterval),l9("started")):l9("Peer score already running")}stop(){null!=this._backgroundInterval?(clearInterval(this._backgroundInterval),delete this._backgroundInterval,this.peerIPs.clear(),this.peerStats.clear(),this.deliveryRecords.clear(),l9("stopped")):l9("Peer score already stopped")}background(){this.refreshScores(),this.deliveryRecords.gc()}dumpPeerScoreStats(){return Object.fromEntries(Array.from(this.peerStats.entries()).map((e=>{let[t,n]=e;return[t,n]})))}messageFirstSeenTimestampMs(e){const t=this.deliveryRecords.getRecord(e);return null!=t?t.firstSeenTsMs:null}refreshScores(){const e=Date.now(),t=this.params.decayToZero;this.peerStats.forEach(((n,r)=>{n.connected?(Object.entries(n.topics).forEach((n=>{let[r,i]=n;const o=this.params.topics[r];void 0!==o&&(i.firstMessageDeliveries*=o.firstMessageDeliveriesDecay,i.firstMessageDeliveries<t&&(i.firstMessageDeliveries=0),i.meshMessageDeliveries*=o.meshMessageDeliveriesDecay,i.meshMessageDeliveries<t&&(i.meshMessageDeliveries=0),i.meshFailurePenalty*=o.meshFailurePenaltyDecay,i.meshFailurePenalty<t&&(i.meshFailurePenalty=0),i.invalidMessageDeliveries*=o.invalidMessageDeliveriesDecay,i.invalidMessageDeliveries<t&&(i.invalidMessageDeliveries=0),i.inMesh&&(i.meshTime=e-i.graftTime,i.meshTime>o.meshMessageDeliveriesActivation&&(i.meshMessageDeliveriesActive=!0)))})),n.behaviourPenalty*=this.params.behaviourPenaltyDecay,n.behaviourPenalty<t&&(n.behaviourPenalty=0)):e>n.expire&&(this.removeIPsForPeer(r,n.knownIPs),this.peerStats.delete(r),this.scoreCache.delete(r))}))}score(e){var t,n;null===(t=this.metrics)||void 0===t||t.scoreFnCalls.inc();const r=this.peerStats.get(e);if(null==r)return 0;const i=Date.now(),o=this.scoreCache.get(e);if(null!=o&&o.cacheUntil>i)return o.score;null===(n=this.metrics)||void 0===n||n.scoreFnRuns.inc();const s=this.computeScore(e,r,this.params,this.peerIPs),a=i+this.scoreCacheValidityMs;var c;null!=o?(null===(c=this.metrics)||void 0===c||c.scoreCachedDelta.observe(Math.abs(s-o.score)),o.score=s,o.cacheUntil=a):this.scoreCache.set(e,{score:s,cacheUntil:a});return s}addPenalty(e,t,n){const r=this.peerStats.get(e);var i;null!=r&&(r.behaviourPenalty+=t,null===(i=this.metrics)||void 0===i||i.onScorePenalty(n))}addPeer(e){const t={connected:!0,expire:0,topics:{},knownIPs:new Set,behaviourPenalty:0};this.peerStats.set(e,t)}addIP(e,t){const n=this.peerStats.get(e);null!=n&&n.knownIPs.add(t),this.peerIPs.getOrDefault(t).add(e)}removeIP(e,t){const n=this.peerStats.get(e);null!=n&&n.knownIPs.delete(t);const r=this.peerIPs.get(t);null!=r&&(r.delete(e),0===r.size&&this.peerIPs.delete(t))}removePeer(e){const t=this.peerStats.get(e);if(null!=t){if(this.score(e)>0)return this.removeIPsForPeer(e,t.knownIPs),void this.peerStats.delete(e);Object.entries(t.topics).forEach((e=>{let[t,n]=e;n.firstMessageDeliveries=0;const r=this.params.topics[t].meshMessageDeliveriesThreshold;if(n.inMesh&&n.meshMessageDeliveriesActive&&n.meshMessageDeliveries<r){const e=r-n.meshMessageDeliveries;n.meshFailurePenalty+=e*e}n.inMesh=!1,n.meshMessageDeliveriesActive=!1})),t.connected=!1,t.expire=Date.now()+this.params.retainScore}}graft(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);null!=e&&(e.inMesh=!0,e.graftTime=Date.now(),e.meshTime=0,e.meshMessageDeliveriesActive=!1)}}prune(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);if(null!=e){const n=this.params.topics[t].meshMessageDeliveriesThreshold;if(e.meshMessageDeliveriesActive&&e.meshMessageDeliveries<n){const t=n-e.meshMessageDeliveries;e.meshFailurePenalty+=t*t}e.meshMessageDeliveriesActive=!1,e.inMesh=!1}}}validateMessage(e){this.deliveryRecords.ensureRecord(e)}deliverMessage(e,t,n){this.markFirstMessageDelivery(e,n);const r=this.deliveryRecords.ensureRecord(t),i=Date.now();r.status===o9.unknown?(r.status=o9.valid,r.validated=i,r.peers.forEach((t=>{t!==e.toString()&&this.markDuplicateMessageDelivery(t,n)}))):l9("unexpected delivery: message from %s was first seen %s ago and has delivery status %s",e,i-r.firstSeenTsMs,o9[r.status])}rejectInvalidMessage(e,t){this.markInvalidMessageDelivery(e,t)}rejectMessage(e,t,n,r){switch(r){case F7.Error:return void this.markInvalidMessageDelivery(e,n);case F7.Blacklisted:return}const i=this.deliveryRecords.ensureRecord(t);if(i.status===o9.unknown){if(r===F7.Ignore)return i.status=o9.ignored,void i.peers.clear();i.status=o9.invalid,this.markInvalidMessageDelivery(e,n),i.peers.forEach((e=>{this.markInvalidMessageDelivery(e,n)})),i.peers.clear()}else l9("unexpected rejection: message from %s was first seen %s ago and has delivery status %d",e,Date.now()-i.firstSeenTsMs,o9[i.status])}duplicateMessage(e,t,n){const r=this.deliveryRecords.ensureRecord(t);if(!r.peers.has(e))switch(r.status){case o9.unknown:r.peers.add(e);break;case o9.valid:r.peers.add(e),this.markDuplicateMessageDelivery(e,n,r.validated);break;case o9.invalid:this.markInvalidMessageDelivery(e,n);case o9.ignored:}}markInvalidMessageDelivery(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);null!=e&&(e.invalidMessageDeliveries+=1)}}markFirstMessageDelivery(e,t){const n=this.peerStats.get(e);if(null!=n){const e=this.getPtopicStats(n,t);if(null!=e){let n=this.params.topics[t].firstMessageDeliveriesCap;e.firstMessageDeliveries=Math.min(n,e.firstMessageDeliveries+1),e.inMesh&&(n=this.params.topics[t].meshMessageDeliveriesCap,e.meshMessageDeliveries=Math.min(n,e.meshMessageDeliveries+1))}}}markDuplicateMessageDelivery(e,t,n){const r=this.peerStats.get(e);if(null!=r){const e=void 0!==n?Date.now():0,o=this.getPtopicStats(r,t);if(null!=o&&o.inMesh){const r=this.params.topics[t];if(void 0!==n){var i;const o=e-n,s=o>r.meshMessageDeliveriesWindow;if(null===(i=this.metrics)||void 0===i||i.onDuplicateMsgDelivery(t,o,s),s)return}const s=r.meshMessageDeliveriesCap;o.meshMessageDeliveries=Math.min(s,o.meshMessageDeliveries+1)}}}removeIPsForPeer(e,t){for(const n of t){const t=this.peerIPs.get(n);null!=t&&(t.delete(e),0===t.size&&this.peerIPs.delete(n))}}getPtopicStats(e,t){let n=e.topics[t];return void 0!==n?n:void 0!==this.params.topics[t]?(n={inMesh:!1,graftTime:0,meshTime:0,firstMessageDeliveries:0,meshMessageDeliveries:0,meshMessageDeliveriesActive:!1,meshFailurePenalty:0,invalidMessageDeliveries:0},e.topics[t]=n,n):null}}function h9(e,t,n,r,i){let o=0;const s=new Map;if(Object.entries(t.topics).forEach((e=>{var t;let[r,a]=e;const c=null!==(t=i.get(r))&&void 0!==t?t:"unknown",l=n.topics[r];if(void 0===l)return;let u=s.get(c);null==u&&(u={p1w:0,p2w:0,p3w:0,p3bw:0,p4w:0},s.set(c,u));let h=0,d=0,f=0,p=0,g=0;if(a.inMesh){h+=Math.max(a.meshTime/l.timeInMeshQuantum,l.timeInMeshCap)*l.timeInMeshWeight}let y=a.firstMessageDeliveries;if(y>l.firstMessageDeliveriesCap&&(y=l.firstMessageDeliveriesCap),d+=y*l.firstMessageDeliveriesWeight,a.meshMessageDeliveriesActive&&a.meshMessageDeliveries<l.meshMessageDeliveriesThreshold){const e=l.meshMessageDeliveriesThreshold-a.meshMessageDeliveries;f+=e*e*l.meshMessageDeliveriesWeight}p+=a.meshFailurePenalty*l.meshFailurePenaltyWeight;g+=a.invalidMessageDeliveries*a.invalidMessageDeliveries*l.invalidMessageDeliveriesWeight,o+=(h+d+f+p+g)*l.topicWeight,u.p1w+=h,u.p2w+=d,u.p3w+=f,u.p3bw+=p,u.p4w+=g})),n.topicScoreCap>0&&o>n.topicScoreCap){o=n.topicScoreCap;const e=n.topicScoreCap/o;for(const t of s.values())t.p1w*=e,t.p2w*=e,t.p3w*=e,t.p3bw*=e,t.p4w*=e}let a=0,c=0,l=0;a+=n.appSpecificScore(e)*n.appSpecificWeight,t.knownIPs.forEach((e=>{if(n.IPColocationFactorWhitelist.has(e))return;const t=r.get(e),i=null!=t?t.size:0;if(i>n.IPColocationFactorThreshold){const e=i-n.IPColocationFactorThreshold;c+=e*e*n.IPColocationFactorWeight}}));return l+=t.behaviourPenalty*t.behaviourPenalty*n.behaviourPenaltyWeight,o+=a+c+l,{byTopic:s,p5w:a,p6w:c,p7w:l,score:o}}function d9(e){return null!=e[Symbol.asyncIterator]}const f9=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),f9.bytes=t,n};function p9(e,t){var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:f9;function*o(e){const t=i(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return d9(e)?async function*(){for await(const t of e)yield*o(t)}():function*(){for(const t of e)yield*o(t)}()}f9.bytes=0,p9.single=(e,t)=>{var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:f9;return new Zs(i(e.byteLength),e)};var g9;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(g9||(g9={}));const y9=e=>{const t=Bs.Jx(e);return y9.bytes=Bs.P$(t),t};function m9(e,t){var n,r,i;const o=new Zs;let s=g9.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:y9,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===g9.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=g9.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===g9.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=g9.LENGTH}}}return d9(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}y9.bytes=0,m9.fromReader=(e,t)=>{let n=1;return m9(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};class v9{constructor(e,t,n){var r;(0,Yo.Z)(this,"rawStream",void 0),(0,Yo.Z)(this,"pushable",void 0),(0,Yo.Z)(this,"closeController",void 0),(0,Yo.Z)(this,"maxBufferSize",void 0),this.rawStream=e,this.pushable=l7({objectMode:!1}),this.closeController=new AbortController,this.maxBufferSize=null!==(r=n.maxBufferSize)&&void 0!==r?r:1/0,d7(PF(this.pushable,this.closeController.signal,{returnOnAbort:!0}),(e=>p9(e)),this.rawStream).catch(t)}get protocol(){return this.rawStream.protocol}push(e){if(this.pushable.readableLength>this.maxBufferSize)throw Error("OutboundStream buffer full, size > ".concat(this.maxBufferSize));this.pushable.push(e)}async close(){this.closeController.abort(),await this.pushable.return(),await this.rawStream.close()}}class b9{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"source",void 0),(0,Yo.Z)(this,"rawStream",void 0),(0,Yo.Z)(this,"closeController",void 0),this.rawStream=e,this.closeController=new AbortController,this.source=PF(d7(this.rawStream,(e=>m9(e,t))),this.closeController.signal,{returnOnAbort:!0})}async close(){this.closeController.abort(),await this.rawStream.close()}}class w9{constructor(e,t,n){(0,Yo.Z)(this,"gossipsubIWantFollowupMs",void 0),(0,Yo.Z)(this,"msgIdToStrFn",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"promises",new Map),(0,Yo.Z)(this,"requestMsByMsg",new Map),(0,Yo.Z)(this,"requestMsByMsgExpire",void 0),this.gossipsubIWantFollowupMs=e,this.msgIdToStrFn=t,this.metrics=n,this.requestMsByMsgExpire=10*e}get size(){return this.promises.size}get requestMsByMsgSize(){return this.requestMsByMsg.size}addPromise(e,t){const n=t[Math.floor(Math.random()*t.length)],r=this.msgIdToStrFn(n);let i=this.promises.get(r);null==i&&(i=new Map,this.promises.set(r,i));const o=Date.now();i.has(e)||(i.set(e,o+this.gossipsubIWantFollowupMs),null!=this.metrics&&(this.metrics.iwantPromiseStarted.inc(1),this.requestMsByMsg.has(r)||this.requestMsByMsg.set(r,o)))}getBrokenPromises(){var e;const t=Date.now(),n=new Map;let r=0;return this.promises.forEach(((e,i)=>{e.forEach(((i,o)=>{var s;i<t&&(n.set(o,(null!==(s=n.get(o))&&void 0!==s?s:0)+1),e.delete(o),r++)})),0===e.size&&this.promises.delete(i)})),null===(e=this.metrics)||void 0===e||e.iwantPromiseBroken.inc(r),n}deliverMessage(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.trackMessage(e);const n=this.promises.get(e);null!=n&&(this.promises.delete(e),null!=this.metrics&&(this.metrics.iwantPromiseResolved.inc(1),t&&this.metrics.iwantPromiseResolvedFromDuplicate.inc(1),this.metrics.iwantPromiseResolvedPeers.inc(n.size)))}rejectMessage(e,t){this.trackMessage(e),t!==F7.Error&&this.promises.delete(e)}clear(){this.promises.clear()}prune(){var e;const t=Date.now()-this.requestMsByMsgExpire;let n=0;for(const[r,i]of this.requestMsByMsg.entries()){if(!(i<t))break;this.requestMsByMsg.delete(r),n++}null===(e=this.metrics)||void 0===e||e.iwantMessagePruned.inc(n)}trackMessage(e){if(null!=this.metrics){const t=this.requestMsByMsg.get(e);void 0!==t&&(this.metrics.iwantPromiseDeliveryTime.observe((Date.now()-t)/1e3),this.requestMsByMsg.delete(e))}}}const E9={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};const A9=32,S9=64,_9=32;function I9(e,t){const n=new Uint8Array(S9);for(let r=0;r<_9;r++)n[r]=e[r],n[_9+r]=t[r];return n}const C9={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function T9(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=E9.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",C9,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",C9,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",C9,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return T6.encode(r)}var k9,R9,x9,P9;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(k9||(k9={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(R9||(R9={})),function(e){e.codec=()=>bs(R9)}(k9||(k9={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),k9.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=k9.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(x9||(x9={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),k9.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=k9.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(P9||(P9={}));class D9{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=U9(e,A9)}async verify(e,t){return async function(e,t,n){return Gl.verify(t,n,e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return x9.encode({Type:k9.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await N8.digest(this.bytes);return e}}class O9{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=U9(e,S9),this._publicKey=U9(t,A9)}async sign(e){return async function(e,t){const n=e.subarray(0,_9);return Gl.sign(t,n)}(this._key,e)}get public(){return new D9(this._publicKey)}marshal(){return this._key}get bytes(){return P9.encode({Type:k9.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await N8.digest(this.bytes);return e}async id(){const e=x8.digest(this.public.bytes);return I6.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return T9(this.bytes,e);throw new O6("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function N9(e){if(e.length>S9){const t=(e=U9(e,S9+A9)).subarray(0,S9),n=e.subarray(S9,e.length);return new O9(t,n)}const t=(e=U9(e,S9)).subarray(0,S9),n=e.subarray(A9);return new O9(t,n)}function B9(e){return e=U9(e,A9),new D9(e)}async function L9(){const{privateKey:e,publicKey:t}=await async function(){const e=Gl.utils.randomPrivateKey(),t=Gl.getPublicKey(e);return{privateKey:I9(e,t),publicKey:t}}();return new O9(e,t)}async function M9(e){const{privateKey:t,publicKey:n}=await async function(e){if(e.length!==_9)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=Gl.getPublicKey(t);return{privateKey:I9(t,n),publicKey:n}}(e);return new O9(t,n)}function U9(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new O6("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}function F9(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Su.B)(n,"base64url")}function K9(e){const t=function(e,t){let n=(0,mu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(yu().jsbn.BigInteger)((0,Su.B)(t,"base16"),16)}const j9={"P-256":256,"P-384":384,"P-521":521};Object.keys(j9).join(" / ");function Z9(e){if(isNaN(e)||e<=0)throw new O6("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Ic(e)}function z9(e,t){return t.map((t=>K9(e[t])))}async function V9(e){const t=[await E9.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await q9(e)],n=await H9({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function H9(e){if(null==e.privateKey||null==e.publicKey)throw new O6("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([E9.get().subtle.exportKey("jwk",e.privateKey),E9.get().subtle.exportKey("jwk",e.publicKey)])}async function q9(e){return E9.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function G9(e,t,n,r){const i=t?function(e){return yu().pki.setRsaPublicKey(...z9(e,["n","e"]))}(e):function(e){return yu().pki.setRsaPrivateKey(...z9(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Su.B)(Uint8Array.from(n),"ascii"),i);return(0,mu.m)(o,"ascii")}function W9(e){if("RSA"!==e.kty)throw new O6("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new O6("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,mu.m)(e.n,"base64url").length}const Q9=8192;class Y9{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}async verify(e,t){return async function(e,t,n){const r=await E9.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return E9.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n)}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new O6("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.publicKeyToAsn1({n:K9(e.n),e:K9(e.e)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return x9.encode({Type:k9.RSA,Data:this.marshal()}).subarray()}encrypt(e){return G9(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await N8.digest(this.bytes);return e}}class J9{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return Z9(16)}async sign(e){return async function(e,t){const n=await E9.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await E9.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,Uint8Array.from(t));return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new O6("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Y9(this._publicKey)}decrypt(e){return G9(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new O6("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.privateKeyToAsn1({n:K9(e.n),e:K9(e.e),d:K9(e.d),p:K9(e.p),q:K9(e.q),dP:K9(e.dp),dQ:K9(e.dq),qInv:K9(e.qi)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return P9.encode({Type:k9.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await N8.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(yu().util.ByteBuffer)(this.marshal()),n=yu().asn1.fromDer(t),r=yu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return yu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return T9(this.bytes,e);throw new O6("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function X9(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:F9(n.n),e:F9(n.e),d:F9(n.d),p:F9(n.p),q:F9(n.q),dp:F9(n.dP),dq:F9(n.dQ),qi:F9(n.qInv),alg:"RS256"}}(e);if(W9(t)>Q9)throw new O6("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await V9(t);return new J9(n.privateKey,n.publicKey)}function $9(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:F9(n.n),e:F9(n.e)}}(e);if(W9(t)>Q9)throw new O6("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Y9(t)}async function eee(e){if(W9(e)>Q9)throw new O6("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await V9(e);return new J9(t.privateKey,t.publicKey)}async function tee(e){if(e>Q9)throw new O6("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await E9.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await H9(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new J9(t.privateKey,t.publicKey)}function nee(e){try{Ah.ProjectivePoint.fromHex(e)}catch(t){throw new O6(String(t),"ERR_INVALID_PUBLIC_KEY")}}class ree{constructor(e){(0,Yo.Z)(this,"_key",void 0),nee(e),this._key=e}async verify(e,t){return async function(e,t,n){try{const{digest:r}=await N8.digest(n);return Ah.verify(t,r,e)}catch(r){throw new O6(String(r),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Ah.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return x9.encode({Type:k9.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await N8.digest(this.bytes);return e}}class iee{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Ah.getPublicKey(e,!0)}catch(t){throw new O6(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Ah.getPublicKey(e,!0)}catch(t){throw new O6(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),nee(this._publicKey)}async sign(e){return async function(e,t){const{digest:n}=await N8.digest(t);try{return Ah.sign(n,e).toDERRawBytes()}catch(r){throw new O6(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new ree(this._publicKey)}marshal(){return this._key}get bytes(){return P9.encode({Type:k9.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await N8.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return T9(this.bytes,e);throw new O6("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function oee(e){return new iee(e)}function see(e){return new ree(e)}async function aee(){const e=Ah.utils.randomPrivateKey();return new iee(e)}const cee={rsa:Jn,ed25519:Yn,secp256k1:Xn};function lee(e){const t=Object.keys(cee).join(" / ");return new O6("invalid or unsupported key type ".concat(e,". Must be ").concat(t),"ERR_UNSUPPORTED_KEY_TYPE")}function uee(e){if("rsa"===(e=e.toLowerCase())||"ed25519"===e||"secp256k1"===e)return cee[e];throw lee(e)}function hee(e){var t,n;const r=x9.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case k9.RSA:return cee.rsa.unmarshalRsaPublicKey(i);case k9.Ed25519:return cee.ed25519.unmarshalEd25519PublicKey(i);case k9.Secp256k1:return cee.secp256k1.unmarshalSecp256k1PublicKey(i);default:throw lee(null!==(n=r.Type)&&void 0!==n?n:"unknown")}}function dee(e,t){var n;return uee(t=(null!==(n=t)&&void 0!==n?n:"rsa").toLowerCase()),e.bytes}async function fee(e){var t,n;const r=P9.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case k9.RSA:return cee.rsa.unmarshalRsaPrivateKey(i);case k9.Ed25519:return cee.ed25519.unmarshalEd25519PrivateKey(i);case k9.Secp256k1:return cee.secp256k1.unmarshalSecp256k1PrivateKey(i);default:throw lee(null!==(n=r.Type)&&void 0!==n?n:"RSA")}}const pee=(0,mu.m)("libp2p-pubsub:");function gee(e){if(e.length<=1)return e;for(let t=0;t<e.length;t++){const n=Math.floor(Math.random()*Math.floor(e.length)),r=e[t];e[t]=e[n],e[n]=r}return e}function yee(e){return(0,Su.B)(e,"base64")}const mee={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}};var vee=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const bee=vee,wee=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class Eee{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class Aee{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return _ee(this,e)}}class See{constructor(e){this.decoders=e}or(e){return _ee(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const _ee=(e,t)=>new See({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class Iee{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new Eee(e,t,n),this.decoder=new Aee(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Cee=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new Iee(t,n,r,i)},Tee=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=bee(r,n);return Cee({prefix:t,name:n,encode:i,decode:e=>wee(o(e))})},kee=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return Cee({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},Ree=Tee({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),xee=Tee({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var Pee=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=Nee;)n[r++]=255&t|Dee,t/=128;for(;t&Oee;)n[r++]=255&t|Dee,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},Dee=128,Oee=-128,Nee=Math.pow(2,31);var Bee=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&Mee)<<o:(r&Mee)*Math.pow(2,o),o+=7}while(r>=Lee);return e.bytes=s-n,i},Lee=128,Mee=127;var Uee=Math.pow(2,7),Fee=Math.pow(2,14),Kee=Math.pow(2,21),jee=Math.pow(2,28),Zee=Math.pow(2,35),zee=Math.pow(2,42),Vee=Math.pow(2,49),Hee=Math.pow(2,56),qee=Math.pow(2,63);const Gee={encode:Pee,decode:Bee,encodingLength:function(e){return e<Uee?1:e<Fee?2:e<Kee?3:e<jee?4:e<Zee?5:e<zee?6:e<Vee?7:e<Hee?8:e<qee?9:10}},Wee=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return Gee.encode(e,t,n),t},Qee=e=>Gee.encodingLength(e),Yee=(e,t)=>{const n=t.byteLength,r=Qee(e),i=r+Qee(n),o=new Uint8Array(i+n);return Wee(e,o,0),Wee(n,o,r),o.set(t,i),new Jee(e,n,t,o)};class Jee{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const Xee=wee,$ee={code:0,name:"identity",encode:Xee,digest:e=>Yee(0,Xee(e))},ete=e=>{let{name:t,code:n,encode:r}=e;return new tte(t,n,r)};class tte{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?Yee(this.code,t):t.then((e=>Yee(this.code,e)))}throw Error("Unknown type, must be binary type")}}const nte=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),rte=ete({name:"sha2-256",code:18,encode:nte("SHA-256")}),ite=ete({name:"sha2-512",code:19,encode:nte("SHA-512")});function ote(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Su.B)(n,"base64url")}function ste(e){const t=function(e,t){let n=(0,mu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(yu().jsbn.BigInteger)((0,Su.B)(t,"base16"),16)}function ate(e){return null!=e&&("function"===typeof e.then&&"function"===typeof e.catch&&"function"===typeof e.finally)}const cte=32,lte=64,ute=32;function hte(e,t){const n=new Uint8Array(lte);for(let r=0;r<ute;r++)n[r]=e[r],n[ute+r]=t[r];return n}const dte=kee({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),fte=kee({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),pte=kee({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),gte=kee({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),yte={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function mte(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=mee.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",yte,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",yte,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",yte,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return dte.encode(r)}var vte,bte,wte,Ete;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(vte||(vte={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(bte||(bte={})),function(e){e.codec=()=>bs(bte)}(vte||(vte={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),vte.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=vte.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(wte||(wte={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),vte.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=vte.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Ete||(Ete={}));class Ate{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=kte(e,cte)}verify(e,t){return function(e,t,n){return Gl.verify(t,n instanceof Uint8Array?n:n.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return wte.encode({Type:vte.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=rte.digest(this.bytes);return ate(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class Ste{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=kte(e,lte),this._publicKey=kte(t,cte)}sign(e){return function(e,t){const n=e.subarray(0,ute);return Gl.sign(t instanceof Uint8Array?t:t.subarray(),n)}(this._key,e)}get public(){return new Ate(this._publicKey)}marshal(){return this._key}get bytes(){return Ete.encode({Type:vte.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=rte.digest(this.bytes);let t;return ate(e)?({bytes:t}=await e):t=e.bytes,t}async id(){const e=$ee.digest(this.public.bytes);return Ree.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return mte(this.bytes,e);throw new pu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function _te(e){if(e.length>lte){const t=(e=kte(e,lte+cte)).subarray(0,lte),n=e.subarray(lte,e.length);return new Ste(t,n)}const t=(e=kte(e,lte)).subarray(0,lte),n=e.subarray(cte);return new Ste(t,n)}function Ite(e){return e=kte(e,cte),new Ate(e)}async function Cte(){const{privateKey:e,publicKey:t}=function(){const e=Gl.utils.randomPrivateKey(),t=Gl.getPublicKey(e);return{privateKey:hte(e,t),publicKey:t}}();return new Ste(e,t)}async function Tte(e){const{privateKey:t,publicKey:n}=function(e){if(e.length!==ute)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=Gl.getPublicKey(t);return{privateKey:hte(t,n),publicKey:n}}(e);return new Ste(t,n)}function kte(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new pu.sv("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}const Rte={"P-256":256,"P-384":384,"P-521":521};Object.keys(Rte).join(" / ");function xte(e,t){return t.map((t=>ste(e[t])))}async function Pte(e){const t=[await mee.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await Ote(e)],n=await Dte({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function Dte(e){if(null==e.privateKey||null==e.publicKey)throw new pu.sv("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([mee.get().subtle.exportKey("jwk",e.privateKey),mee.get().subtle.exportKey("jwk",e.publicKey)])}async function Ote(e){return mee.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function Nte(e,t,n,r){const i=t?function(e){return yu().pki.setRsaPublicKey(...xte(e,["n","e"]))}(e):function(e){return yu().pki.setRsaPrivateKey(...xte(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Su.B)(n instanceof Uint8Array?n:n.subarray(),"ascii"),i);return(0,mu.m)(o,"ascii")}function Bte(e){if("RSA"!==e.kty)throw new pu.sv("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new pu.sv("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,mu.m)(e.n,"base64url").length}const Lte=8192;class Mte{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}verify(e,t){return async function(e,t,n){const r=await mee.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return mee.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n instanceof Uint8Array?n:n.subarray())}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new pu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.publicKeyToAsn1({n:ste(e.n),e:ste(e.e)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return wte.encode({Type:vte.RSA,Data:this.marshal()}).subarray()}encrypt(e){return Nte(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=rte.digest(this.bytes);return ate(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class Ute{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return function(e){if(isNaN(e)||e<=0)throw new pu.sv("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Ic(e)}(16)}sign(e){return async function(e,t){const n=await mee.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await mee.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new pu.sv("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new Mte(this._publicKey)}decrypt(e){return Nte(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new pu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.privateKeyToAsn1({n:ste(e.n),e:ste(e.e),d:ste(e.d),p:ste(e.p),q:ste(e.q),dP:ste(e.dp),dQ:ste(e.dq),qInv:ste(e.qi)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return Ete.encode({Type:vte.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=rte.digest(this.bytes);return ate(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(yu().util.ByteBuffer)(this.marshal()),n=yu().asn1.fromDer(t),r=yu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return yu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return mte(this.bytes,e);throw new pu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function Fte(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:ote(n.n),e:ote(n.e),d:ote(n.d),p:ote(n.p),q:ote(n.q),dp:ote(n.dP),dq:ote(n.dQ),qi:ote(n.qInv),alg:"RS256"}}(e);if(Bte(t)>Lte)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await Pte(t);return new Ute(n.privateKey,n.publicKey)}function Kte(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:ote(n.n),e:ote(n.e)}}(e);if(Bte(t)>Lte)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new Mte(t)}async function jte(e){if(Bte(e)>Lte)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await Pte(e);return new Ute(t.privateKey,t.publicKey)}async function Zte(e){if(e>Lte)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await mee.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await Dte(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new Ute(t.privateKey,t.publicKey)}function zte(e){try{Ah.ProjectivePoint.fromHex(e)}catch(t){throw new pu.sv(String(t),"ERR_INVALID_PUBLIC_KEY")}}class Vte{constructor(e){(0,Yo.Z)(this,"_key",void 0),zte(e),this._key=e}verify(e,t){return function(e,t,n){const r=rte.digest(n instanceof Uint8Array?n:n.subarray());if(ate(r))return r.then((n=>{let{digest:r}=n;return Ah.verify(t,r,e)})).catch((e=>{throw new pu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Ah.verify(t,r.digest,e)}catch(i){throw new pu.sv(String(i),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Ah.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return wte.encode({Type:vte.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=rte.digest(this.bytes);let t;return ate(e)?({bytes:t}=await e):t=e.bytes,t}}class Hte{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Ah.getPublicKey(e,!0)}catch(t){throw new pu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Ah.getPublicKey(e,!0)}catch(t){throw new pu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),zte(this._publicKey)}sign(e){return function(e,t){const n=rte.digest(t instanceof Uint8Array?t:t.subarray());if(ate(n))return n.then((t=>{let{digest:n}=t;return Ah.sign(n,e).toDERRawBytes()})).catch((e=>{throw new pu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Ah.sign(n.digest,e).toDERRawBytes()}catch(r){throw new pu.sv(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new Vte(this._publicKey)}marshal(){return this._key}get bytes(){return Ete.encode({Type:vte.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=rte.digest(this.bytes);return ate(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return mte(this.bytes,e);throw new pu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function qte(e){return new Hte(e)}function Gte(e){return new Vte(e)}async function Wte(){const e=Ah.utils.randomPrivateKey();return new Hte(e)}const Qte=Tee({prefix:"9",name:"base10",alphabet:"0123456789"}),Yte=kee({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Jte=kee({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Xte=kee({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),$te=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),ene=$te.reduce(((e,t,n)=>(e[n]=t,e)),[]),tne=$te.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const nne=Cee({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=ene[t]),"")},decode:function(e){const t=[];for(const n of e){const e=tne[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),rne=kee({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),ine=kee({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),one=kee({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),sne=kee({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),ane=kee({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),cne=kee({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),lne=kee({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),une=kee({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),hne=kee({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),dne=Tee({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),fne=Tee({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),pne=kee({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),gne=Cee({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),yne=new TextEncoder,mne=new TextDecoder,vne="json",bne=512,wne=e=>yne.encode(JSON.stringify(e)),Ene=e=>JSON.parse(mne.decode(e)),Ane="raw",Sne=85,_ne=e=>wee(e),Ine=e=>wee(e);new WeakMap;Symbol.toStringTag,Symbol.for("nodejs.util.inspect.custom");Symbol.for("@ipld/js-cid/CID");const Cne={...fr,...cr,...dr,...sr,...ar,...ur,...hr,...$n,...nr,...lr};let Tne;Symbol.for("nodejs.util.inspect.custom"),Object.values(Cne).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),Cne.identity.decoder);Tne=Symbol.toStringTag;function kne(e){if("signed"!==e.type)throw new Error("expected signed message type");if(null==e.sequenceNumber)throw Error("missing seqno field");return((e,t)=>{const n=(0,mu.m)(t.toString(16).padStart(16,"0"),"base16"),r=new Uint8Array(e.length+n.length);return r.set(e,0),r.set(n,e.length),r})(e.from.toBytes(),e.sequenceNumber)}async function Rne(e){return N8.encode(e.data)}var xne,Pne=n(37318);!function(e){e[e.ip4=4]="ip4",e[e.ip6=41]="ip6"}(xne||(xne={}));class Dne{constructor(e){(0,Yo.Z)(this,"entries",new Map),(0,Yo.Z)(this,"validityMs",void 0),this.validityMs=e.validityMs}get size(){return this.entries.size}put(e,t){return!!this.entries.has(e)||(this.entries.set(e,{value:t,validUntilMs:Date.now()+this.validityMs}),!1)}prune(){const e=Date.now();for(const[t,n]of this.entries.entries()){if(!(n.validUntilMs<e))break;this.entries.delete(t)}}has(e){return this.entries.has(e)}get(e){const t=this.entries.get(e);return null!=t&&t.validUntilMs>=Date.now()?t.value:void 0}clear(){this.entries.clear()}}var One,Nne,Bne;!function(e){e[e.started=0]="started",e[e.stopped=1]="stopped"}(One||(One={}));class Lne extends $4{constructor(e){var t,n,r,i,o;let s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};super(),(0,Yo.Z)(this,"globalSignaturePolicy",void 0),(0,Yo.Z)(this,"multicodecs",[w7,b7]),(0,Yo.Z)(this,"publishConfig",void 0),(0,Yo.Z)(this,"dataTransform",void 0),(0,Yo.Z)(this,"peers",new Set),(0,Yo.Z)(this,"streamsInbound",new Map),(0,Yo.Z)(this,"streamsOutbound",new Map),(0,Yo.Z)(this,"outboundInflightQueue",l7({objectMode:!0})),(0,Yo.Z)(this,"direct",new Set),(0,Yo.Z)(this,"floodsubPeers",new Set),(0,Yo.Z)(this,"seenCache",void 0),(0,Yo.Z)(this,"acceptFromWhitelist",new Map),(0,Yo.Z)(this,"topics",new Map),(0,Yo.Z)(this,"subscriptions",new Set),(0,Yo.Z)(this,"mesh",new Map),(0,Yo.Z)(this,"fanout",new Map),(0,Yo.Z)(this,"fanoutLastpub",new Map),(0,Yo.Z)(this,"gossip",new Map),(0,Yo.Z)(this,"control",new Map),(0,Yo.Z)(this,"peerhave",new Map),(0,Yo.Z)(this,"iasked",new Map),(0,Yo.Z)(this,"backoff",new Map),(0,Yo.Z)(this,"outbound",new Map),(0,Yo.Z)(this,"msgIdFn",void 0),(0,Yo.Z)(this,"fastMsgIdFn",void 0),(0,Yo.Z)(this,"msgIdToStrFn",void 0),(0,Yo.Z)(this,"fastMsgIdCache",void 0),(0,Yo.Z)(this,"publishedMessageIds",void 0),(0,Yo.Z)(this,"mcache",void 0),(0,Yo.Z)(this,"score",void 0),(0,Yo.Z)(this,"topicValidators",new Map),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"heartbeatTicks",0),(0,Yo.Z)(this,"gossipTracer",void 0),(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"directPeerInitial",null),(0,Yo.Z)(this,"opts",void 0),(0,Yo.Z)(this,"decodeRpcLimits",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"status",{code:One.stopped}),(0,Yo.Z)(this,"maxInboundStreams",void 0),(0,Yo.Z)(this,"maxOutboundStreams",void 0),(0,Yo.Z)(this,"allowedTopics",void 0),(0,Yo.Z)(this,"heartbeatTimer",null),(0,Yo.Z)(this,"runHeartbeat",(()=>{var e;const t=null===(e=this.metrics)||void 0===e?void 0:e.heartbeatDuration.startTimer();this.heartbeat().catch((e=>{this.log("Error running heartbeat",e)})).finally((()=>{if(null!=t&&t(),this.status.code===One.started){clearTimeout(this.status.heartbeatTimeout);let t=this.opts.heartbeatInterval-(Date.now()-this.status.hearbeatStartMs)%this.opts.heartbeatInterval;var e;if(t<.25*this.opts.heartbeatInterval)t+=this.opts.heartbeatInterval,null===(e=this.metrics)||void 0===e||e.heartbeatSkipped.inc();this.status.heartbeatTimeout=setTimeout(this.runHeartbeat,t)}}))}));const a={fallbackToFloodsub:!0,floodPublish:!0,doPX:!1,directPeers:[],D:6,Dlo:4,Dhi:12,Dscore:4,Dout:2,Dlazy:6,heartbeatInterval:1e3,fanoutTTL:6e4,mcacheLength:5,mcacheGossip:3,seenTTL:12e4,gossipsubIWantFollowupMs:3e3,prunePeers:16,pruneBackoff:6e4,unsubcribeBackoff:1e4,graftFloodThreshold:1e4,opportunisticGraftPeers:2,opportunisticGraftTicks:60,directConnectTicks:300,...s,scoreParams:X7(s.scoreParams),scoreThresholds:t9(s.scoreThresholds)};if(this.components=e,this.decodeRpcLimits=null!==(t=a.decodeRpcLimits)&&void 0!==t?t:_7,this.globalSignaturePolicy=null!==(n=a.globalSignaturePolicy)&&void 0!==n?n:n6,a.fallbackToFloodsub&&this.multicodecs.push(v7),this.log=P6(null!==(r=a.debugName)&&void 0!==r?r:"libp2p:gossipsub"),this.opts=a,this.direct=new Set(a.directPeers.map((e=>e.id.toString()))),this.seenCache=new Dne({validityMs:a.seenTTL}),this.publishedMessageIds=new Dne({validityMs:a.seenTTL}),null!=s.msgIdFn)this.msgIdFn=s.msgIdFn;else switch(this.globalSignaturePolicy){case n6:this.msgIdFn=kne;break;case r6:this.msgIdFn=Rne;break;default:throw new Error("Invalid globalSignaturePolicy: ".concat(this.globalSignaturePolicy))}if(null!=s.fastMsgIdFn&&(this.fastMsgIdFn=s.fastMsgIdFn,this.fastMsgIdCache=new Dne({validityMs:a.seenTTL})),this.msgIdToStrFn=null!==(i=s.msgIdToStrFn)&&void 0!==i?i:yee,this.mcache=null!==(o=s.messageCache)&&void 0!==o?o:new L7(a.mcacheGossip,a.mcacheLength,this.msgIdToStrFn),null!=s.dataTransform&&(this.dataTransform=s.dataTransform),null!=s.metricsRegister){if(null==s.metricsTopicStrToLabel)throw Error("Must set metricsTopicStrToLabel with metrics");const e=Math.max(...Object.values(a.scoreParams.topics).map((e=>e.meshMessageDeliveriesWindow)),1e3),t=function(e,t,n){return{protocolsEnabled:e.gauge({name:"gossipsub_protocol",help:"Status of enabled protocols",labelNames:["protocol"]}),topicSubscriptionStatus:e.gauge({name:"gossipsub_topic_subscription_status",help:"Status of our subscription to this topic",labelNames:["topicStr"]}),topicPeersCount:e.gauge({name:"gossipsub_topic_peer_count",help:"Number of peers subscribed to each topic",labelNames:["topicStr"]}),meshPeerCounts:e.gauge({name:"gossipsub_mesh_peer_count",help:"Number of peers in our mesh",labelNames:["topicStr"]}),meshPeerInclusionEventsFanout:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_fanout_total",help:"Number of times we include peers in a topic mesh for fanout reasons",labelNames:["topic"]}),meshPeerInclusionEventsRandom:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_random_total",help:"Number of times we include peers in a topic mesh for random reasons",labelNames:["topic"]}),meshPeerInclusionEventsSubscribed:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_subscribed_total",help:"Number of times we include peers in a topic mesh for subscribed reasons",labelNames:["topic"]}),meshPeerInclusionEventsOutbound:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_outbound_total",help:"Number of times we include peers in a topic mesh for outbound reasons",labelNames:["topic"]}),meshPeerInclusionEventsNotEnough:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_not_enough_total",help:"Number of times we include peers in a topic mesh for not_enough reasons",labelNames:["topic"]}),meshPeerInclusionEventsOpportunistic:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_opportunistic_total",help:"Number of times we include peers in a topic mesh for opportunistic reasons",labelNames:["topic"]}),meshPeerInclusionEventsUnknown:e.gauge({name:"gossipsub_mesh_peer_inclusion_events_unknown_total",help:"Number of times we include peers in a topic mesh for unknown reasons",labelNames:["topic"]}),meshPeerChurnEventsDisconnected:e.gauge({name:"gossipsub_peer_churn_events_disconnected_total",help:"Number of times we remove peers in a topic mesh for disconnected reasons",labelNames:["topic"]}),meshPeerChurnEventsBadScore:e.gauge({name:"gossipsub_peer_churn_events_bad_score_total",help:"Number of times we remove peers in a topic mesh for bad_score reasons",labelNames:["topic"]}),meshPeerChurnEventsPrune:e.gauge({name:"gossipsub_peer_churn_events_prune_total",help:"Number of times we remove peers in a topic mesh for prune reasons",labelNames:["topic"]}),meshPeerChurnEventsExcess:e.gauge({name:"gossipsub_peer_churn_events_excess_total",help:"Number of times we remove peers in a topic mesh for excess reasons",labelNames:["topic"]}),meshPeerChurnEventsUnknown:e.gauge({name:"gossipsub_peer_churn_events_unknown_total",help:"Number of times we remove peers in a topic mesh for unknown reasons",labelNames:["topic"]}),peersPerProtocol:e.gauge({name:"gossipsub_peers_per_protocol_count",help:"Peers connected for each topic",labelNames:["protocol"]}),heartbeatDuration:e.histogram({name:"gossipsub_heartbeat_duration_seconds",help:"The time it takes to complete one iteration of the heartbeat",buckets:[.01,.1,1]}),heartbeatSkipped:e.gauge({name:"gossipsub_heartbeat_skipped",help:"Heartbeat run took longer than heartbeat interval so next is skipped"}),acceptedMessagesTotal:e.gauge({name:"gossipsub_accepted_messages_total",help:"Total accepted messages for each topic",labelNames:["topic"]}),ignoredMessagesTotal:e.gauge({name:"gossipsub_ignored_messages_total",help:"Total ignored messages for each topic",labelNames:["topic"]}),rejectedMessagesTotal:e.gauge({name:"gossipsub_rejected_messages_total",help:"Total rejected messages for each topic",labelNames:["topic"]}),unknownValidationResultsTotal:e.gauge({name:"gossipsub_unknown_validation_results_total",help:"Total unknown validation results for each topic",labelNames:["topic"]}),asyncValidationMcacheHit:e.gauge({name:"gossipsub_async_validation_mcache_hit_total",help:"Async validation result reported by the user layer",labelNames:["hit"]}),asyncValidationDelayFromFirstSeenSec:e.histogram({name:"gossipsub_async_validation_delay_from_first_seen",help:"Async validation report delay from first seen in second",labelNames:["topic"],buckets:[.01,.03,.1,.3,1,3,10]}),asyncValidationUnknownFirstSeen:e.gauge({name:"gossipsub_async_validation_unknown_first_seen_count_total",help:"Async validation report unknown first seen value for message"}),peerReadStreamError:e.gauge({name:"gossipsub_peer_read_stream_err_count_total",help:"Peer read stream error"}),rpcRecvBytes:e.gauge({name:"gossipsub_rpc_recv_bytes_total",help:"RPC recv"}),rpcRecvCount:e.gauge({name:"gossipsub_rpc_recv_count_total",help:"RPC recv"}),rpcRecvSubscription:e.gauge({name:"gossipsub_rpc_recv_subscription_total",help:"RPC recv"}),rpcRecvMessage:e.gauge({name:"gossipsub_rpc_recv_message_total",help:"RPC recv"}),rpcRecvControl:e.gauge({name:"gossipsub_rpc_recv_control_total",help:"RPC recv"}),rpcRecvIHave:e.gauge({name:"gossipsub_rpc_recv_ihave_total",help:"RPC recv"}),rpcRecvIWant:e.gauge({name:"gossipsub_rpc_recv_iwant_total",help:"RPC recv"}),rpcRecvGraft:e.gauge({name:"gossipsub_rpc_recv_graft_total",help:"RPC recv"}),rpcRecvPrune:e.gauge({name:"gossipsub_rpc_recv_prune_total",help:"RPC recv"}),rpcDataError:e.gauge({name:"gossipsub_rpc_data_err_count_total",help:"RPC data error"}),rpcRecvError:e.gauge({name:"gossipsub_rpc_recv_err_count_total",help:"RPC recv error"}),rpcRecvNotAccepted:e.gauge({name:"gossipsub_rpc_rcv_not_accepted_total",help:"Total count of RPC dropped because acceptFrom() == false"}),rpcSentBytes:e.gauge({name:"gossipsub_rpc_sent_bytes_total",help:"RPC sent"}),rpcSentCount:e.gauge({name:"gossipsub_rpc_sent_count_total",help:"RPC sent"}),rpcSentSubscription:e.gauge({name:"gossipsub_rpc_sent_subscription_total",help:"RPC sent"}),rpcSentMessage:e.gauge({name:"gossipsub_rpc_sent_message_total",help:"RPC sent"}),rpcSentControl:e.gauge({name:"gossipsub_rpc_sent_control_total",help:"RPC sent"}),rpcSentIHave:e.gauge({name:"gossipsub_rpc_sent_ihave_total",help:"RPC sent"}),rpcSentIWant:e.gauge({name:"gossipsub_rpc_sent_iwant_total",help:"RPC sent"}),rpcSentGraft:e.gauge({name:"gossipsub_rpc_sent_graft_total",help:"RPC sent"}),rpcSentPrune:e.gauge({name:"gossipsub_rpc_sent_prune_total",help:"RPC sent"}),msgPublishCount:e.gauge({name:"gossipsub_msg_publish_count_total",help:"Total count of msg published by topic",labelNames:["topic"]}),msgPublishPeersByTopic:e.gauge({name:"gossipsub_msg_publish_peers_total",help:"Total count of peers that we publish a msg to",labelNames:["topic"]}),directPeersPublishedTotal:e.gauge({name:"gossipsub_direct_peers_published_total",help:"Total direct peers that we publish a msg to",labelNames:["topic"]}),floodsubPeersPublishedTotal:e.gauge({name:"gossipsub_floodsub_peers_published_total",help:"Total floodsub peers that we publish a msg to",labelNames:["topic"]}),meshPeersPublishedTotal:e.gauge({name:"gossipsub_mesh_peers_published_total",help:"Total mesh peers that we publish a msg to",labelNames:["topic"]}),fanoutPeersPublishedTotal:e.gauge({name:"gossipsub_fanout_peers_published_total",help:"Total fanout peers that we publish a msg to",labelNames:["topic"]}),msgPublishBytes:e.gauge({name:"gossipsub_msg_publish_bytes_total",help:"Total count of msg publish data.length bytes",labelNames:["topic"]}),msgPublishTime:e.histogram({name:"gossipsub_msg_publish_seconds",help:"Total time in seconds to publish a message",buckets:[.001,.002,.005,.01,.1,.5,1],labelNames:["topic"]}),msgForwardCount:e.gauge({name:"gossipsub_msg_forward_count_total",help:"Total count of msg forwarded by topic",labelNames:["topic"]}),msgForwardPeers:e.gauge({name:"gossipsub_msg_forward_peers_total",help:"Total count of peers that we forward a msg to",labelNames:["topic"]}),msgReceivedPreValidation:e.gauge({name:"gossipsub_msg_received_prevalidation_total",help:"Total count of recv msgs before any validation",labelNames:["topic"]}),msgReceivedError:e.gauge({name:"gossipsub_msg_received_error_total",help:"Total count of recv msgs error",labelNames:["topic"]}),prevalidationInvalidTotal:e.gauge({name:"gossipsub_pre_validation_invalid_total",help:"Total count of invalid messages received",labelNames:["topic"]}),prevalidationValidTotal:e.gauge({name:"gossipsub_pre_validation_valid_total",help:"Total count of valid messages received",labelNames:["topic"]}),prevalidationDuplicateTotal:e.gauge({name:"gossipsub_pre_validation_duplicate_total",help:"Total count of duplicate messages received",labelNames:["topic"]}),prevalidationUnknownTotal:e.gauge({name:"gossipsub_pre_validation_unknown_status_total",help:"Total count of unknown_status messages received",labelNames:["topic"]}),msgReceivedInvalid:e.gauge({name:"gossipsub_msg_received_invalid_total",help:"Tracks specific reason of invalid",labelNames:["error"]}),msgReceivedInvalidByTopic:e.gauge({name:"gossipsub_msg_received_invalid_by_topic_total",help:"Tracks specific invalid message by topic",labelNames:["topic"]}),duplicateMsgDeliveryDelay:e.histogram({name:"gossisub_duplicate_msg_delivery_delay_seconds",help:"Time since the 1st duplicated message validated",labelNames:["topic"],buckets:[.25*n.maxMeshMessageDeliveriesWindowSec,.5*n.maxMeshMessageDeliveriesWindowSec,Number(n.maxMeshMessageDeliveriesWindowSec),2*n.maxMeshMessageDeliveriesWindowSec,4*n.maxMeshMessageDeliveriesWindowSec]}),duplicateMsgLateDelivery:e.gauge({name:"gossisub_duplicate_msg_late_delivery_total",help:"Total count of late duplicate message delivery by topic, which triggers P3 penalty",labelNames:["topic"]}),duplicateMsgIgnored:e.gauge({name:"gossisub_ignored_published_duplicate_msgs_total",help:"Total count of published duplicate message ignored by topic",labelNames:["topic"]}),scoreFnCalls:e.gauge({name:"gossipsub_score_fn_calls_total",help:"Total times score() is called"}),scoreFnRuns:e.gauge({name:"gossipsub_score_fn_runs_total",help:"Total times score() call actually computed computeScore(), no cache"}),scoreCachedDelta:e.histogram({name:"gossipsub_score_cache_delta",help:"Delta of score between cached values that expired",buckets:[10,100,1e3]}),peersByScoreThreshold:e.gauge({name:"gossipsub_peers_by_score_threshold_count",help:"Current count of peers by score threshold",labelNames:["threshold"]}),score:e.avgMinMax({name:"gossipsub_score",help:"Avg min max of gossip scores"}),scoreWeights:e.avgMinMax({name:"gossipsub_score_weights",help:"Separate score weights",labelNames:["topic","p"]}),scorePerMesh:e.avgMinMax({name:"gossipsub_score_per_mesh",help:"Histogram of the scores for each mesh topic",labelNames:["topic"]}),scoringPenalties:e.gauge({name:"gossipsub_scoring_penalties_total",help:"A counter of the kind of penalties being applied to peers",labelNames:["penalty"]}),behaviourPenalty:e.histogram({name:"gossipsub_peer_stat_behaviour_penalty",help:"Current peer stat behaviour_penalty at each scrape",buckets:[.25*n.behaviourPenaltyThreshold,.5*n.behaviourPenaltyThreshold,Number(n.behaviourPenaltyThreshold),2*n.behaviourPenaltyThreshold,4*n.behaviourPenaltyThreshold]}),ihaveRcvIgnored:e.gauge({name:"gossipsub_ihave_rcv_ignored_total",help:"Total received IHAVE messages that we ignore for some reason",labelNames:["reason"]}),ihaveRcvMsgids:e.gauge({name:"gossipsub_ihave_rcv_msgids_total",help:"Total received IHAVE messages by topic",labelNames:["topic"]}),ihaveRcvNotSeenMsgids:e.gauge({name:"gossipsub_ihave_rcv_not_seen_msgids_total",help:"Total messages per topic we do not have, not actual requests",labelNames:["topic"]}),iwantRcvMsgids:e.gauge({name:"gossipsub_iwant_rcv_msgids_total",help:"Total received IWANT messages by topic",labelNames:["topic"]}),iwantRcvDonthaveMsgids:e.gauge({name:"gossipsub_iwant_rcv_dont_have_msgids_total",help:"Total requested messageIDs that we do not have"}),iwantPromiseStarted:e.gauge({name:"gossipsub_iwant_promise_sent_total",help:"Total count of started IWANT promises"}),iwantPromiseResolved:e.gauge({name:"gossipsub_iwant_promise_resolved_total",help:"Total count of resolved IWANT promises"}),iwantPromiseResolvedFromDuplicate:e.gauge({name:"gossipsub_iwant_promise_resolved_from_duplicate_total",help:"Total count of resolved IWANT promises from duplicate messages"}),iwantPromiseResolvedPeers:e.gauge({name:"gossipsub_iwant_promise_resolved_peers",help:"Total count of peers we have asked IWANT promises that are resolved"}),iwantPromiseBroken:e.gauge({name:"gossipsub_iwant_promise_broken",help:"Total count of broken IWANT promises"}),iwantMessagePruned:e.gauge({name:"gossipsub_iwant_message_pruned",help:"Total count of pruned IWANT messages"}),iwantPromiseDeliveryTime:e.histogram({name:"gossipsub_iwant_promise_delivery_seconds",help:"Histogram of delivery time of resolved IWANT promises",buckets:[.5*n.gossipPromiseExpireSec,Number(n.gossipPromiseExpireSec),2*n.gossipPromiseExpireSec,4*n.gossipPromiseExpireSec]}),iwantPromiseUntracked:e.gauge({name:"gossip_iwant_promise_untracked",help:"Total count of untracked IWANT promise"}),connectedPeersBackoffSec:e.histogram({name:"gossipsub_connected_peers_backoff_seconds",help:"Backoff time in seconds",buckets:[1,2,4,10,20,60,120]}),cacheSize:e.gauge({name:"gossipsub_cache_size",help:"Unbounded cache sizes",labelNames:["cache"]}),mcacheSize:e.gauge({name:"gossipsub_mcache_size",help:"Current mcache msg count"}),mcacheNotValidatedCount:e.gauge({name:"gossipsub_mcache_not_validated_count",help:"Current mcache msg count not validated"}),fastMsgIdCacheCollision:e.gauge({name:"gossipsub_fastmsgid_cache_collision_total",help:"Total count of key collisions on fastmsgid cache put"}),newConnectionCount:e.gauge({name:"gossipsub_new_connection_total",help:"Total new connection by status",labelNames:["status"]}),topicStrToLabel:t,toTopic(e){var t;return null!==(t=this.topicStrToLabel.get(e))&&void 0!==t?t:e},onJoin(e){this.topicSubscriptionStatus.set({topicStr:e},1),this.meshPeerCounts.set({topicStr:e},0)},onLeave(e){this.topicSubscriptionStatus.set({topicStr:e},0),this.meshPeerCounts.set({topicStr:e},0)},onAddToMesh(e,t,n){const r=this.toTopic(e);switch(t){case z7.Fanout:this.meshPeerInclusionEventsFanout.inc({topic:r},n);break;case z7.Random:this.meshPeerInclusionEventsRandom.inc({topic:r},n);break;case z7.Subscribed:this.meshPeerInclusionEventsSubscribed.inc({topic:r},n);break;case z7.Outbound:this.meshPeerInclusionEventsOutbound.inc({topic:r},n);break;case z7.NotEnough:this.meshPeerInclusionEventsNotEnough.inc({topic:r},n);break;case z7.Opportunistic:this.meshPeerInclusionEventsOpportunistic.inc({topic:r},n);break;default:this.meshPeerInclusionEventsUnknown.inc({topic:r},n)}},onRemoveFromMesh(e,t,n){const r=this.toTopic(e);switch(t){case V7.Dc:this.meshPeerChurnEventsDisconnected.inc({topic:r},n);break;case V7.BadScore:this.meshPeerChurnEventsBadScore.inc({topic:r},n);break;case V7.Prune:this.meshPeerChurnEventsPrune.inc({topic:r},n);break;case V7.Excess:this.meshPeerChurnEventsExcess.inc({topic:r},n);break;default:this.meshPeerChurnEventsUnknown.inc({topic:r},n)}},onReportValidation(e,t,n){if(this.asyncValidationMcacheHit.inc({hit:null!=e?"hit":"miss"}),null!=e){const n=this.toTopic(e.message.topic);switch(t){case i6.Accept:this.acceptedMessagesTotal.inc({topic:n});break;case i6.Ignore:this.ignoredMessagesTotal.inc({topic:n});break;case i6.Reject:this.rejectedMessagesTotal.inc({topic:n});break;default:this.unknownValidationResultsTotal.inc({topic:n})}}null!=n?this.asyncValidationDelayFromFirstSeenSec.observe((Date.now()-n)/1e3):this.asyncValidationUnknownFirstSeen.inc()},onScorePenalty(e){this.scoringPenalties.inc({penalty:e},1)},onIhaveRcv(e,t,n){const r=this.toTopic(e);this.ihaveRcvMsgids.inc({topic:r},t),this.ihaveRcvNotSeenMsgids.inc({topic:r},n)},onIwantRcv(e,t){for(const[n,r]of e){const e=this.toTopic(n);this.iwantRcvMsgids.inc({topic:e},r)}this.iwantRcvDonthaveMsgids.inc(t)},onForwardMsg(e,t){const n=this.toTopic(e);this.msgForwardCount.inc({topic:n},1),this.msgForwardPeers.inc({topic:n},t)},onPublishMsg(e,t,n,r,i){const o=this.toTopic(e);this.msgPublishCount.inc({topic:o},1),this.msgPublishBytes.inc({topic:o},n*r),this.msgPublishPeersByTopic.inc({topic:o},n),this.directPeersPublishedTotal.inc({topic:o},t.direct),this.floodsubPeersPublishedTotal.inc({topic:o},t.floodsub),this.meshPeersPublishedTotal.inc({topic:o},t.mesh),this.fanoutPeersPublishedTotal.inc({topic:o},t.fanout),this.msgPublishTime.observe({topic:o},i/1e3)},onMsgRecvPreValidation(e){const t=this.toTopic(e);this.msgReceivedPreValidation.inc({topic:t},1)},onMsgRecvError(e){const t=this.toTopic(e);this.msgReceivedError.inc({topic:t},1)},onPrevalidationResult(e,t){const n=this.toTopic(e);switch(t){case j7.duplicate:this.prevalidationDuplicateTotal.inc({topic:n});break;case j7.invalid:this.prevalidationInvalidTotal.inc({topic:n});break;case j7.valid:this.prevalidationValidTotal.inc({topic:n});break;default:this.prevalidationUnknownTotal.inc({topic:n})}},onMsgRecvInvalid(e,t){const n=this.toTopic(e),r=t.reason===F7.Error?t.error:t.reason;this.msgReceivedInvalid.inc({error:r},1),this.msgReceivedInvalidByTopic.inc({topic:n},1)},onDuplicateMsgDelivery(e,t,n){if(this.duplicateMsgDeliveryDelay.observe(t/1e3),n){const t=this.toTopic(e);this.duplicateMsgLateDelivery.inc({topic:t},1)}},onPublishDuplicateMsg(e){const t=this.toTopic(e);this.duplicateMsgIgnored.inc({topic:t},1)},onPeerReadStreamError(){this.peerReadStreamError.inc(1)},onRpcRecvError(){this.rpcRecvError.inc(1)},onRpcDataError(){this.rpcDataError.inc(1)},onRpcRecv(e,t){this.rpcRecvBytes.inc(t),this.rpcRecvCount.inc(1),null!=e.subscriptions&&this.rpcRecvSubscription.inc(e.subscriptions.length),null!=e.messages&&this.rpcRecvMessage.inc(e.messages.length),null!=e.control&&(this.rpcRecvControl.inc(1),null!=e.control.ihave&&this.rpcRecvIHave.inc(e.control.ihave.length),null!=e.control.iwant&&this.rpcRecvIWant.inc(e.control.iwant.length),null!=e.control.graft&&this.rpcRecvGraft.inc(e.control.graft.length),null!=e.control.prune&&this.rpcRecvPrune.inc(e.control.prune.length))},onRpcSent(e,t){if(this.rpcSentBytes.inc(t),this.rpcSentCount.inc(1),null!=e.subscriptions&&this.rpcSentSubscription.inc(e.subscriptions.length),null!=e.messages&&this.rpcSentMessage.inc(e.messages.length),null!=e.control){var n,r,i,o,s,a,c,l;const t=null!==(n=null===(r=e.control.ihave)||void 0===r?void 0:r.length)&&void 0!==n?n:0,u=null!==(i=null===(o=e.control.iwant)||void 0===o?void 0:o.length)&&void 0!==i?i:0,h=null!==(s=null===(a=e.control.graft)||void 0===a?void 0:a.length)&&void 0!==s?s:0,d=null!==(c=null===(l=e.control.prune)||void 0===l?void 0:l.length)&&void 0!==c?c:0;t>0&&this.rpcSentIHave.inc(t),u>0&&this.rpcSentIWant.inc(u),h>0&&this.rpcSentGraft.inc(h),d>0&&this.rpcSentPrune.inc(d),(t>0||u>0||h>0||d>0)&&this.rpcSentControl.inc(1)}},registerScores(e,t){let n=0,r=0,i=0,o=0;for(const s of e)s>=t.graylistThreshold&&n++,s>=t.publishThreshold&&r++,s>=t.gossipThreshold&&i++,s>=0&&o++;this.peersByScoreThreshold.set({threshold:G7.graylist},n),this.peersByScoreThreshold.set({threshold:G7.publish},r),this.peersByScoreThreshold.set({threshold:G7.gossip},i),this.peersByScoreThreshold.set({threshold:G7.mesh},o),this.score.set(e)},registerScoreWeights(e){for(const[t,n]of e.byTopic)this.scoreWeights.set({topic:t,p:"p1"},n.p1w),this.scoreWeights.set({topic:t,p:"p2"},n.p2w),this.scoreWeights.set({topic:t,p:"p3"},n.p3w),this.scoreWeights.set({topic:t,p:"p3b"},n.p3bw),this.scoreWeights.set({topic:t,p:"p4"},n.p4w);this.scoreWeights.set({p:"p5"},e.p5w),this.scoreWeights.set({p:"p6"},e.p6w),this.scoreWeights.set({p:"p7"},e.p7w)},registerScorePerMesh(e,t){const n=new Map;e.forEach(((e,t)=>{var r;const i=null!==(r=this.topicStrToLabel.get(t))&&void 0!==r?r:"unknown";let o=n.get(i);null==o&&(o=new Set,n.set(i,o)),e.forEach((e=>{var t;return null===(t=o)||void 0===t?void 0:t.add(e)}))}));for(const[r,i]of n){const e=[];i.forEach((n=>{var r;e.push(null!==(r=t.get(n))&&void 0!==r?r:0)})),this.scorePerMesh.set({topic:r},e)}}}}(s.metricsRegister,s.metricsTopicStrToLabel,{gossipPromiseExpireSec:this.opts.gossipsubIWantFollowupMs/1e3,behaviourPenaltyThreshold:a.scoreParams.behaviourPenaltyThreshold,maxMeshMessageDeliveriesWindowSec:e/1e3});t.mcacheSize.addCollect((()=>{this.onScrapeMetrics(t)}));for(const n of this.multicodecs)t.protocolsEnabled.set({protocol:n},1);this.metrics=t}else this.metrics=null;this.gossipTracer=new w9(this.opts.gossipsubIWantFollowupMs,this.msgIdToStrFn,this.metrics),this.score=new u9(this.opts.scoreParams,this.metrics,{scoreCacheValidityMs:a.heartbeatInterval}),this.maxInboundStreams=s.maxInboundStreams,this.maxOutboundStreams=s.maxOutboundStreams,this.allowedTopics=null!=a.allowedTopics?new Set(a.allowedTopics):null}getPeers(){return[...this.peers.keys()].map((e=>i7(e)))}isStarted(){return this.status.code===One.started}async start(){if(this.isStarted())return;this.log("starting"),this.publishConfig=await async function(e,t){switch(e){case n6:{if(null==t)throw Error("Must provide PeerId");if(null==t.privateKey)throw Error("Cannot sign message, no private key present");if(null==t.publicKey)throw Error("Cannot sign message, no public key present");const e=await fee(t.privateKey);return{type:U7.Signing,author:t,key:t.publicKey,privateKey:e}}case r6:return{type:U7.Anonymous};default:throw new Error('Unknown signature policy "'.concat(e,'"'))}}(this.globalSignaturePolicy,this.components.peerId),this.outboundInflightQueue=l7({objectMode:!0}),d7(this.outboundInflightQueue,(async e=>{for await(const{peerId:t,connection:n}of e)await this.createOutboundStream(t,n)})).catch((e=>{this.log.error("outbound inflight queue error",e)})),await Promise.all(this.opts.directPeers.map((async e=>{await this.components.peerStore.merge(e.id,{multiaddrs:e.addrs})})));const e=this.components.registrar;await Promise.all(this.multicodecs.map((async t=>e.handle(t,this.onIncomingStream.bind(this),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams}))));const t={onConnect:this.onPeerConnected.bind(this),onDisconnect:this.onPeerDisconnected.bind(this)},n=await Promise.all(this.multicodecs.map((async n=>e.register(n,t)))),r=setTimeout(this.runHeartbeat,100);this.status={code:One.started,registrarTopologyIds:n,heartbeatTimeout:r,hearbeatStartMs:Date.now()+100},this.score.start(),this.directPeerInitial=setTimeout((()=>{Promise.resolve().then((async()=>{await Promise.all(Array.from(this.direct).map((async e=>this.connect(e))))})).catch((e=>{this.log(e)}))}),1e3),this.log("started")}async stop(){if(this.log("stopping"),this.status.code!==One.started)return;const{registrarTopologyIds:e}=this.status;this.status={code:One.stopped};const t=this.components.registrar;await Promise.all(this.multicodecs.map((async e=>t.unhandle(e)))),e.forEach((e=>{t.unregister(e)})),this.outboundInflightQueue.end();const n=[];for(const r of this.streamsOutbound.values())n.push(r.close());this.streamsOutbound.clear();for(const r of this.streamsInbound.values())n.push(r.close());this.streamsInbound.clear(),await Promise.all(n),this.peers.clear(),this.subscriptions.clear(),null!=this.heartbeatTimer&&(this.heartbeatTimer.cancel(),this.heartbeatTimer=null),this.score.stop(),this.mesh.clear(),this.fanout.clear(),this.fanoutLastpub.clear(),this.gossip.clear(),this.control.clear(),this.peerhave.clear(),this.iasked.clear(),this.backoff.clear(),this.outbound.clear(),this.gossipTracer.clear(),this.seenCache.clear(),null!=this.fastMsgIdCache&&this.fastMsgIdCache.clear(),null!=this.directPeerInitial&&clearTimeout(this.directPeerInitial),this.log("stopped")}dumpPeerScoreStats(){return this.score.dumpPeerScoreStats()}onIncomingStream(e){let{stream:t,connection:n}=e;if(!this.isStarted())return;const r=n.remotePeer;this.addPeer(r,n.direction,n.remoteAddr),this.createInboundStream(r,t),this.outboundInflightQueue.push({peerId:r,connection:n})}onPeerConnected(e,t){var n;null===(n=this.metrics)||void 0===n||n.newConnectionCount.inc({status:t.status}),this.isStarted()&&"open"===t.status&&(this.addPeer(e,t.direction,t.remoteAddr),this.outboundInflightQueue.push({peerId:e,connection:t}))}onPeerDisconnected(e){this.log("connection ended %p",e),this.removePeer(e)}async createOutboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(this.peers.has(n)&&!this.streamsOutbound.has(n))try{var r;const i=new v9(await t.newStream(this.multicodecs),(e=>{this.log.error("outbound pipe error",e)}),{maxBufferSize:this.opts.maxOutboundBufferSize});this.log("create outbound stream %p",e),this.streamsOutbound.set(n,i);const o=i.protocol;o===v7&&this.floodsubPeers.add(n),null===(r=this.metrics)||void 0===r||r.peersPerProtocol.inc({protocol:o},1),this.subscriptions.size>0&&(this.log("send subscriptions to",n),this.sendSubscriptions(n,Array.from(this.subscriptions),!0))}catch(i){this.log.error("createOutboundStream error",i)}}createInboundStream(e,t){if(!this.isStarted())return;const n=e.toString();if(!this.peers.has(n))return;const r=this.streamsInbound.get(n);void 0!==r&&(this.log("replacing existing inbound steam %s",n),r.close().catch((e=>{this.log.error(e)}))),this.log("create inbound stream %s",n);const i=new b9(t,{maxDataLength:this.opts.maxInboundDataLength});this.streamsInbound.set(n,i),this.pipePeerReadStream(e,i.source).catch((e=>{this.log(e)}))}addPeer(e,t,n){const r=e.toString();if(!this.peers.has(r)){this.log("new peer %p",e),this.peers.add(r),this.score.addPeer(r);const i=function(e){for(const t of e.tuples())switch(t[0]){case xne.ip4:case xne.ip6:return(0,Pne.xV)(t[0],t[1])}return null}(n);null!==i?this.score.addIP(r,i):this.log("Added peer has no IP in current address %s %s",r,n.toString()),this.outbound.has(r)||this.outbound.set(r,"outbound"===t)}}removePeer(e){const t=e.toString();if(!this.peers.has(t))return;this.log("delete peer %p",e),this.peers.delete(t);const n=this.streamsOutbound.get(t),r=this.streamsInbound.get(t);var i;null!=n&&(null===(i=this.metrics)||void 0===i||i.peersPerProtocol.inc({protocol:n.protocol},-1));null===n||void 0===n||n.close().catch((e=>{this.log.error(e)})),null===r||void 0===r||r.close().catch((e=>{this.log.error(e)})),this.streamsOutbound.delete(t),this.streamsInbound.delete(t);for(const s of this.topics.values())s.delete(t);for(const[s,a]of this.mesh){var o;if(a.delete(t))null===(o=this.metrics)||void 0===o||o.onRemoveFromMesh(s,V7.Dc,1)}for(const s of this.fanout.values())s.delete(t);this.floodsubPeers.delete(t),this.gossip.delete(t),this.control.delete(t),this.outbound.delete(t),this.score.removePeer(t),this.acceptFromWhitelist.delete(t)}get started(){return this.status.code===One.started}getMeshPeers(e){const t=this.mesh.get(e);return null!=t?Array.from(t):[]}getSubscribers(e){const t=this.topics.get(e);return(null!=t?Array.from(t):[]).map((e=>i7(e)))}getTopics(){return Array.from(this.subscriptions)}async pipePeerReadStream(e,t){try{await d7(t,(async t=>{for await(const a of t)try{var n;const t=a.subarray(),i=I7(t,this.decodeRpcLimits);if(null===(n=this.metrics)||void 0===n||n.onRpcRecv(i,t.length),this.opts.awaitRpcHandler)try{await this.handleReceivedRpc(e,i)}catch(o){var r;null===(r=this.metrics)||void 0===r||r.onRpcRecvError(),this.log(o)}else this.handleReceivedRpc(e,i).catch((e=>{var t;null===(t=this.metrics)||void 0===t||t.onRpcRecvError(),this.log(e)}))}catch(s){var i;null===(i=this.metrics)||void 0===i||i.onRpcDataError(),this.log(s)}}))}catch(r){var n;null===(n=this.metrics)||void 0===n||n.onPeerReadStreamError(),this.handlePeerReadStreamError(r,e)}}handlePeerReadStreamError(e,t){this.log.error(e),this.onPeerDisconnected(t)}async handleReceivedRpc(e,t){var n;if(!this.acceptFrom(e.toString()))return this.log("received message from unacceptable peer %p",e),void(null===(n=this.metrics)||void 0===n||n.rpcRecvNotAccepted.inc());const r=null!=t.subscriptions?t.subscriptions.length:0,i=null!=t.messages?t.messages.length:0;let o=0,s=0,a=0,c=0;if(null!=t.control&&(null!=t.control.ihave&&(o=t.control.ihave.length),null!=t.control.iwant&&(s=t.control.iwant.length),null!=t.control.graft&&(a=t.control.graft.length),null!=t.control.prune&&(c=t.control.prune.length)),this.log("rpc.from ".concat(e.toString()," subscriptions ").concat(r," messages ").concat(i," ihave ").concat(o," iwant ").concat(s," graft ").concat(a," prune ").concat(c)),null!=t.subscriptions&&t.subscriptions.length>0){const n=[];t.subscriptions.forEach((t=>{const r=t.topic,i=!0===t.subscribe;if(null!=r){if(null!=this.allowedTopics&&!this.allowedTopics.has(r))return;this.handleReceivedSubscription(e,r,i),n.push({topic:r,subscribe:i})}})),this.safeDispatchEvent("subscription-change",{detail:{peerId:e,subscriptions:n}})}if(null!=t.messages)for(const l of t.messages){if(null!=this.allowedTopics&&!this.allowedTopics.has(l.topic))continue;const t=this.handleReceivedMessage(e,l).catch((e=>{var t;null===(t=this.metrics)||void 0===t||t.onMsgRecvError(l.topic),this.log(e)}));this.opts.awaitRpcMessageHandler&&await t}null!=t.control&&await this.handleControlMessage(e.toString(),t.control)}handleReceivedSubscription(e,t,n){this.log("subscription update from %p topic %s",e,t);let r=this.topics.get(t);null==r&&(r=new Set,this.topics.set(t,r)),n?r.add(e.toString()):r.delete(e.toString())}async handleReceivedMessage(e,t){var n,r,i;null===(n=this.metrics)||void 0===n||n.onMsgRecvPreValidation(t.topic);const o=await this.validateReceivedMessage(e,t);null===(r=this.metrics)||void 0===r||r.onPrevalidationResult(t.topic,o.code);const s=o.code;switch(s){case j7.duplicate:return this.score.duplicateMessage(e.toString(),o.msgIdStr,t.topic),this.gossipTracer.deliverMessage(o.msgIdStr,!0),void this.mcache.observeDuplicate(o.msgIdStr,e.toString());case j7.invalid:if(null!=o.msgIdStr){const n=o.msgIdStr;this.score.rejectMessage(e.toString(),n,t.topic,o.reason),this.gossipTracer.rejectMessage(n,o.reason)}else this.score.rejectInvalidMessage(e.toString(),t.topic);return void(null===(i=this.metrics)||void 0===i||i.onMsgRecvInvalid(t.topic,o));case j7.valid:if(this.score.validateMessage(o.messageId.msgIdStr),this.gossipTracer.deliverMessage(o.messageId.msgIdStr),this.mcache.put(o.messageId,t,!this.opts.asyncValidation),this.subscriptions.has(t.topic)){this.components.peerId.equals(e)&&!this.opts.emitSelf||(super.dispatchEvent(new t6("gossipsub:message",{detail:{propagationSource:e,msgId:o.messageId.msgIdStr,msg:o.msg}})),super.dispatchEvent(new t6("message",{detail:o.msg})))}this.opts.asyncValidation||this.forwardMessage(o.messageId.msgIdStr,t,e.toString());break;default:throw new Error("Invalid validation result: ".concat(s))}}async validateReceivedMessage(e,t){var n,r;const i=null===(n=this.fastMsgIdFn)||void 0===n?void 0:n.call(this,t),o=void 0!==i?null===(r=this.fastMsgIdCache)||void 0===r?void 0:r.get(i):void 0;if(null!=o)return{code:j7.duplicate,msgIdStr:o};const s=await async function(e,t){var n;switch(e){case r6:return null!=t.signature?{valid:!1,error:K7.SignaturePresent}:null!=t.seqno?{valid:!1,error:K7.SeqnoPresent}:null!=t.key?{valid:!1,error:K7.FromPresent}:{valid:!0,message:{type:"unsigned",topic:t.topic,data:null!==(n=t.data)&&void 0!==n?n:new Uint8Array(0)}};case n6:{var r,i;if(null==t.seqno)return{valid:!1,error:K7.InvalidSeqno};if(8!==t.seqno.length)return{valid:!1,error:K7.InvalidSeqno};if(null==t.signature)return{valid:!1,error:K7.InvalidSignature};if(null==t.from)return{valid:!1,error:K7.InvalidPeerId};let e,n;try{e=o7(t.from)}catch(o){return{valid:!1,error:K7.InvalidPeerId}}if(null!=t.key){if(n=hee(t.key),void 0!==e.publicKey&&!(0,Ms.f)(n.bytes,e.publicKey))return{valid:!1,error:K7.InvalidPeerId}}else{if(null==e.publicKey)return{valid:!1,error:K7.InvalidPeerId};n=hee(e.publicKey)}const s={from:t.from,data:t.data,seqno:t.seqno,topic:t.topic,signature:void 0,key:void 0},a=(0,Ls.z)([pee,B7.Message.encode(s).finish()]);return await n.verify(a,t.signature)?{valid:!0,message:{type:"signed",from:e,data:null!==(r=t.data)&&void 0!==r?r:new Uint8Array(0),sequenceNumber:BigInt("0x".concat((0,Su.B)(t.seqno,"base16"))),topic:t.topic,signature:t.signature,key:null!==(i=t.key)&&void 0!==i?i:dee(n)}}:{valid:!1,error:K7.InvalidSignature}}default:throw new Error("Unreachable")}}(this.globalSignaturePolicy,t);if(!s.valid)return{code:j7.invalid,reason:F7.Error,error:s.error};const a=s.message;try{null!=this.dataTransform&&(a.data=this.dataTransform.inboundTransform(t.topic,a.data))}catch(f){return this.log("Invalid message, transform failed",f),{code:j7.invalid,reason:F7.Error,error:K7.TransformFailed}}const c=await this.msgIdFn(a),l=this.msgIdToStrFn(c),u={msgId:c,msgIdStr:l};if(void 0!==i&&null!=this.fastMsgIdCache){var h;if(this.fastMsgIdCache.put(i,l))null===(h=this.metrics)||void 0===h||h.fastMsgIdCacheCollision.inc()}if(this.seenCache.has(l))return{code:j7.duplicate,msgIdStr:l};this.seenCache.put(l);const d=this.topicValidators.get(t.topic);if(null!=d){let t;try{t=await d(e,a)}catch(f){const e=f.code;"ERR_TOPIC_VALIDATOR_IGNORE"===e&&(t=i6.Ignore),t="ERR_TOPIC_VALIDATOR_REJECT"===e?i6.Reject:i6.Ignore}if(t!==i6.Accept)return{code:j7.invalid,reason:W7(t),msgIdStr:l}}return{code:j7.valid,messageId:u,msg:a}}getScore(e){return this.score.score(e)}sendSubscriptions(e,t,n){this.sendRpc(e,{subscriptions:t.map((e=>({topic:e,subscribe:n})))})}async handleControlMessage(e,t){var n;if(void 0===t)return;const r=null!=t.ihave?this.handleIHave(e,t.ihave):[],i=null!=t.iwant?this.handleIWant(e,t.iwant):[],o=null!=t.graft?await this.handleGraft(e,t.graft):[];if(null!=t.prune&&await this.handlePrune(e,t.prune),0===r.length&&0===i.length&&0===o.length)return;const s=this.sendRpc(e,{messages:i,control:{iwant:r,prune:o}}),a=null===(n=r[0])||void 0===n?void 0:n.messageIDs;var c;null!=a&&(s?this.gossipTracer.addPromise(e,a):null===(c=this.metrics)||void 0===c||c.iwantPromiseUntracked.inc(1))}acceptFrom(e){if(this.direct.has(e))return!0;const t=Date.now(),n=this.acceptFromWhitelist.get(e);if(null!=n&&n.messagesAccepted<128&&n.acceptUntil>=t)return n.messagesAccepted+=1,!0;const r=this.score.score(e);return r>=0?this.acceptFromWhitelist.set(e,{messagesAccepted:0,acceptUntil:t+1e3}):this.acceptFromWhitelist.delete(e),r>=this.opts.scoreThresholds.graylistThreshold}handleIHave(e,t){var n,r;if(0===t.length)return[];const i=this.score.score(e);var o;if(i<this.opts.scoreThresholds.gossipThreshold)return this.log("IHAVE: ignoring peer %s with score below threshold [ score = %d ]",e,i),null===(o=this.metrics)||void 0===o||o.ihaveRcvIgnored.inc({reason:q7.LowScore}),[];const s=(null!==(n=this.peerhave.get(e))&&void 0!==n?n:0)+1;var a;if(this.peerhave.set(e,s),s>10)return this.log("IHAVE: peer %s has advertised too many times (%d) within this heartbeat interval; ignoring",e,s),null===(a=this.metrics)||void 0===a||a.ihaveRcvIgnored.inc({reason:q7.MaxIhave}),[];const c=null!==(r=this.iasked.get(e))&&void 0!==r?r:0;var l;if(c>=E7)return this.log("IHAVE: peer %s has already advertised too many messages (%d); ignoring",e,c),null===(l=this.metrics)||void 0===l||l.ihaveRcvIgnored.inc({reason:q7.MaxIasked}),[];const u=new Map;if(t.forEach((e=>{var t;let{topicID:n,messageIDs:r}=e;if(null==n||null==r||!this.mesh.has(n))return;let i=0;r.forEach((e=>{const t=this.msgIdToStrFn(e);this.seenCache.has(t)||(u.set(t,e),i++)})),null===(t=this.metrics)||void 0===t||t.onIhaveRcv(n,r.length,i)})),0===u.size)return[];let h=u.size;h+c>E7&&(h=E7-c),this.log("IHAVE: Asking for %d out of %d messages from %s",h,u.size,e);let d=Array.from(u.values());return gee(d),d=d.slice(0,h),this.iasked.set(e,c+h),[{messageIDs:d}]}handleIWant(e,t){var n;if(0===t.length)return[];const r=this.score.score(e);if(r<this.opts.scoreThresholds.gossipThreshold)return this.log("IWANT: ignoring peer %s with score below threshold [score = %d]",e,r),[];const i=new Map,o=new Map;let s=0;return t.forEach((t=>{let{messageIDs:n}=t;null===n||void 0===n||n.forEach((t=>{var n;const r=this.msgIdToStrFn(t),a=this.mcache.getWithIWantCount(r,e);null!=a?(o.set(a.msg.topic,1+(null!==(n=o.get(a.msg.topic))&&void 0!==n?n:0)),a.count>3?this.log("IWANT: Peer %s has asked for message %s too many times: ignoring request",e,t):i.set(r,a.msg)):s++}))})),null===(n=this.metrics)||void 0===n||n.onIwantRcv(o,s),0===i.size?(this.log("IWANT: Could not provide any wanted messages to %s",e),[]):(this.log("IWANT: Sending %d messages to %s",i.size,e),Array.from(i.values()))}async handleGraft(e,t){const n=[],r=this.score.score(e),i=Date.now();let o=this.opts.doPX;if(t.forEach((t=>{var s,a,c;let{topicID:l}=t;if(null==l)return;const u=this.mesh.get(l);if(null==u)return void(o=!1);if(u.has(e))return;if(this.direct.has(e))return this.log("GRAFT: ignoring request from direct peer %s",e),n.push(l),void(o=!1);const h=null===(s=this.backoff.get(l))||void 0===s?void 0:s.get(e);if("number"===typeof h&&i<h){this.log("GRAFT: ignoring backed off peer %s",e),this.score.addPenalty(e,1,H7.GraftBackoff),o=!1;const t=h+this.opts.graftFloodThreshold-this.opts.pruneBackoff;return i<t&&this.score.addPenalty(e,1,H7.GraftBackoff),this.addBackoff(e,l),void n.push(l)}return r<0?(this.log("GRAFT: ignoring peer %s with negative score: score=%d, topic=%s",e,r,l),n.push(l),o=!1,void this.addBackoff(e,l)):u.size>=this.opts.Dhi&&(null===(a=this.outbound.get(e))||void 0===a||!a)?(n.push(l),void this.addBackoff(e,l)):(this.log("GRAFT: Add mesh link from %s in %s",e,l),this.score.graft(e,l),u.add(e),void(null===(c=this.metrics)||void 0===c||c.onAddToMesh(l,z7.Subscribed,1)))})),0===n.length)return[];return Promise.all(n.map((async t=>this.makePrune(e,t,o,false))))}async handlePrune(e,t){const n=this.score.score(e);for(const{topicID:i,backoff:o,peers:s}of t){if(null==i)continue;const t=this.mesh.get(i);if(null==t)return;var r;if(this.log("PRUNE: Remove mesh link to %s in %s",e,i),this.score.prune(e,i),t.has(e))t.delete(e),null===(r=this.metrics)||void 0===r||r.onRemoveFromMesh(i,V7.Prune,1);if("number"===typeof o&&o>0?this.doAddBackoff(e,i,1e3*o):this.addBackoff(e,i),null!=s&&s.length>0){if(n<this.opts.scoreThresholds.acceptPXThreshold){this.log("PRUNE: ignoring PX from peer %s with insufficient score [score = %d, topic = %s]",e,n,i);continue}await this.pxConnect(s)}}}addBackoff(e,t){this.doAddBackoff(e,t,this.opts.pruneBackoff)}doAddBackoff(e,t,n){var r;let i=this.backoff.get(t);null==i&&(i=new Map,this.backoff.set(t,i));const o=Date.now()+n;(null!==(r=i.get(e))&&void 0!==r?r:0)<o&&i.set(e,o)}applyIwantPenalties(){this.gossipTracer.getBrokenPromises().forEach(((e,t)=>{this.log("peer %s didn't follow up in %d IWANT requests; adding penalty",t,e),this.score.addPenalty(t,e,H7.BrokenPromise)}))}clearBackoff(){if(this.heartbeatTicks%15!==0)return;const e=Date.now();this.backoff.forEach(((t,n)=>{t.forEach(((n,r)=>{n+1*this.opts.heartbeatInterval<e&&t.delete(r)})),0===t.size&&this.backoff.delete(n)}))}async directConnect(){const e=[];this.direct.forEach((t=>{this.streamsOutbound.has(t)||e.push(t)})),await Promise.all(e.map((async e=>this.connect(e))))}async pxConnect(e){e.length>this.opts.prunePeers&&(gee(e),e=e.slice(0,this.opts.prunePeers));const t=[];await Promise.all(e.map((async e=>{if(null==e.peerID)return;const n=o7(e.peerID),r=n.toString();if(!this.peers.has(r))if(null!=e.signedPeerRecord)try{if(!await this.components.peerStore.consumePeerRecord(e.signedPeerRecord,n))return void this.log("bogus peer record obtained through px: could not add peer record to address book");t.push(r)}catch(i){this.log("bogus peer record obtained through px: invalid signature or not a peer record")}else t.push(r)}))),0!==t.length&&await Promise.all(t.map((async e=>this.connect(e))))}async connect(e){this.log("Initiating connection with %s",e);const t=i7(e),n=await this.components.connectionManager.openConnection(t);for(const i of this.multicodecs)for(const e of this.components.registrar.getTopologies(i)){var r;null===(r=e.onConnect)||void 0===r||r.call(e,t,n)}}subscribe(e){if(this.status.code!==One.started)throw new Error("Pubsub has not started");if(!this.subscriptions.has(e)){this.subscriptions.add(e);for(const t of this.peers.keys())this.sendSubscriptions(t,[e],!0)}this.join(e)}unsubscribe(e){if(this.status.code!==One.started)throw new Error("Pubsub is not started");const t=this.subscriptions.delete(e);if(this.log("unsubscribe from %s - am subscribed %s",e,t),t)for(const n of this.peers.keys())this.sendSubscriptions(n,[e],!1);this.leave(e)}join(e){var t;if(this.status.code!==One.started)throw new Error("Gossipsub has not started");if(this.mesh.has(e))return;this.log("JOIN %s",e),null===(t=this.metrics)||void 0===t||t.onJoin(e);const n=new Set,r=this.backoff.get(e),i=this.fanout.get(e);var o;null!=i&&(this.fanout.delete(e),this.fanoutLastpub.delete(e),i.forEach((e=>{this.direct.has(e)||!(this.score.score(e)>=0)||null!=r&&r.has(e)||n.add(e)})),null===(o=this.metrics)||void 0===o||o.onAddToMesh(e,z7.Fanout,n.size));if(n.size<this.opts.D){var s;const t=n.size;this.getRandomGossipPeers(e,this.opts.D,(e=>!n.has(e)&&!this.direct.has(e)&&this.score.score(e)>=0&&(null==r||!r.has(e)))).forEach((e=>{n.add(e)})),null===(s=this.metrics)||void 0===s||s.onAddToMesh(e,z7.Random,n.size-t)}this.mesh.set(e,n),n.forEach((t=>{this.log("JOIN: Add mesh link to %s in %s",t,e),this.sendGraft(t,e)}))}leave(e){var t;if(this.status.code!==One.started)throw new Error("Gossipsub has not started");this.log("LEAVE %s",e),null===(t=this.metrics)||void 0===t||t.onLeave(e);const n=this.mesh.get(e);null!=n&&(Promise.all(Array.from(n).map((async t=>{this.log("LEAVE: Remove mesh link to %s in %s",t,e),await this.sendPrune(t,e)}))).catch((e=>{this.log("Error sending prunes to mesh peers",e)})),this.mesh.delete(e))}selectPeersToForward(e,t,n){const r=new Set,i=this.topics.get(e);null!=i&&(this.direct.forEach((e=>{var o;!i.has(e)||t===e||null!==(o=null===n||void 0===n?void 0:n.has(e))&&void 0!==o&&o||r.add(e)})),this.floodsubPeers.forEach((e=>{var o;i.has(e)&&t!==e&&(null===(o=null===n||void 0===n?void 0:n.has(e))||void 0===o||!o)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&r.add(e)})));const o=this.mesh.get(e);return null!=o&&o.size>0&&o.forEach((e=>{var i;t===e||null!==(i=null===n||void 0===n?void 0:n.has(e))&&void 0!==i&&i||r.add(e)})),r}selectPeersToPublish(e){const t=new Set,n={direct:0,floodsub:0,mesh:0,fanout:0},r=this.topics.get(e);if(null!=r)if(this.opts.floodPublish)r.forEach((e=>{this.direct.has(e)?(t.add(e),n.direct++):this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),n.floodsub++)}));else{this.direct.forEach((e=>{r.has(e)&&(t.add(e),n.direct++)})),this.floodsubPeers.forEach((e=>{r.has(e)&&this.score.score(e)>=this.opts.scoreThresholds.publishThreshold&&(t.add(e),n.floodsub++)}));const i=this.mesh.get(e);if(null!=i&&i.size>0)i.forEach((e=>{t.add(e),n.mesh++}));else{const r=this.fanout.get(e);if(null!=r&&r.size>0)r.forEach((e=>{t.add(e),n.fanout++}));else{const r=this.getRandomGossipPeers(e,this.opts.D,(e=>this.score.score(e)>=this.opts.scoreThresholds.publishThreshold));r.size>0&&(this.fanout.set(e,r),r.forEach((e=>{t.add(e),n.fanout++})))}this.fanoutLastpub.set(e,Date.now())}}return{tosend:t,tosendCount:n}}forwardMessage(e,t,n,r){var i;null!=n&&this.score.deliverMessage(n,e,t.topic);const o=this.selectPeersToForward(t.topic,n,r);o.forEach((e=>{this.sendRpc(e,{messages:[t]})})),null===(i=this.metrics)||void 0===i||i.onForwardMsg(t.topic,o.size)}async publish(e,t,n){var r,i,o;const s=Date.now(),a=null!=this.dataTransform?this.dataTransform.outboundTransform(e,t):t;if(null==this.publishConfig)throw Error("PublishError.Uninitialized");const{raw:c,msg:l}=await async function(e,t,n,r){switch(e.type){case U7.Signing:{const i={from:e.author.toBytes(),data:r,seqno:Z9(8),topic:t,signature:void 0,key:void 0},o=(0,Ls.z)([pee,B7.Message.encode(i).finish()]);return i.signature=await e.privateKey.sign(o),i.key=e.key,{raw:i,msg:{type:"signed",from:e.author,data:n,sequenceNumber:BigInt("0x".concat((0,Su.B)(i.seqno,"base16"))),topic:t,signature:i.signature,key:i.key}}}case U7.Anonymous:return{raw:{from:void 0,data:r,seqno:void 0,topic:t,signature:void 0,key:void 0},msg:{type:"unsigned",data:n,topic:t}};default:throw new Error("Unreachable")}}(this.publishConfig,e,t,a),u=await this.msgIdFn(l),h=this.msgIdToStrFn(u),d=null!==(r=null===n||void 0===n?void 0:n.ignoreDuplicatePublishError)&&void 0!==r?r:this.opts.ignoreDuplicatePublishError;if(this.seenCache.has(h)){var f;if(d)return null===(f=this.metrics)||void 0===f||f.onPublishDuplicateMsg(e),{recipients:[]};throw Error("PublishError.Duplicate")}const{tosend:p,tosendCount:g}=this.selectPeersToPublish(e),y=this.opts.emitSelf&&this.subscriptions.has(e),m=null!==(i=null===n||void 0===n?void 0:n.allowPublis
turn t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new eI(e,n,r,i||sI(e,n,r.bytes))}if(!0===t[aI]){const{version:e,multihash:n,code:r}=t,i=Z_(n);return eI.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==iI)throw new Error("Version 0 CID must use dag-pb (code: ".concat(iI,") block encoding"));return new eI(e,t,n,n.bytes);case 1:{const r=sI(e,t,n.bytes);return new eI(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return eI.create(0,iI,e)}static createV1(e,t){return eI.create(1,e,t)}static decode(e){const[t,n]=eI.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=eI.inspectBytes(e),n=t.size-t.multihashSize,r=RS(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new z_(t.multihashCode,t.digestSize,i,r);return[0===t.version?eI.createV0(o):eI.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=U_(e.subarray(t));return t+=r,n};let r=n(),i=iI;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=tI(e,t),i=eI.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return $_(i).set(n,e),i}}const tI=(e,t)=>{switch(e[0]){case"Q":{const n=t||US;return[US.prefix,n.decode("".concat(US.prefix).concat(e))]}case US.prefix:{const n=t||US;return[US.prefix,n.decode(e)]}case WS.prefix:{const n=t||WS;return[WS.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},nI=(e,t,n)=>{const{prefix:r}=n;if(r!==US.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},rI=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},iI=112,oI=18,sI=(e,t,n)=>{const r=K_(e),i=r+K_(t),o=new Uint8Array(i+n.byteLength);return F_(e,o,0),F_(t,o,r),o.set(n,i),o},aI=Symbol.for("@ipld/js-cid/CID"),cI={...ue,...ie,...le,...ne,...re,...se,...ae,...te,...ce,...oe};let lI;const uI=Symbol.for("nodejs.util.inspect.custom"),hI=Object.values(cI).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),cI.identity.decoder),dI=114,fI=36,pI=37;lI=Symbol.toStringTag;class gI{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,pu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[lI](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=US.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return eI.createV1(dI,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return bI(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[uI](){return"PeerId(".concat(this.toString(),")")}}class yI extends gI{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class mI extends gI{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class vI extends gI{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function bI(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:hI,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=Z_(US.decode("z".concat(e)));return e.startsWith("12D")?new mI({multihash:t}):e.startsWith("16U")?new vI({multihash:t}):new yI({multihash:t})}return wI(hI.decode(e))}function wI(e){try{const t=Z_(e);if(t.code===H_.code){if(t.digest.length===fI)return new mI({multihash:t});if(t.digest.length===pI)return new vI({multihash:t})}if(t.code===Q_.code)return new yI({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==dI)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===Q_.code)return new yI({multihash:e.multihash});if(t.code===H_.code){if(t.digest.length===fI)return new mI({multihash:e.multihash});if(t.digest.length===pI)return new vI({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(eI.decode(e))}throw new Error("Supplied PeerID CID is invalid")}var EI=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const AI=EI,SI=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class _I{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class II{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return TI(this,e)}}class CI{constructor(e){this.decoders=e}or(e){return TI(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const TI=(e,t)=>new CI({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class kI{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new _I(e,t,n),this.decoder=new II(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const RI=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new kI(t,n,r,i)},xI=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=AI(r,n);return RI({prefix:t,name:n,encode:i,decode:e=>SI(o(e))})},PI=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return RI({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},DI=xI({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),OI=xI({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var NI=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=MI;)n[r++]=255&t|BI,t/=128;for(;t&LI;)n[r++]=255&t|BI,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},BI=128,LI=-128,MI=Math.pow(2,31);var UI=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&KI)<<o:(r&KI)*Math.pow(2,o),o+=7}while(r>=FI);return e.bytes=s-n,i},FI=128,KI=127;var jI=Math.pow(2,7),ZI=Math.pow(2,14),zI=Math.pow(2,21),VI=Math.pow(2,28),HI=Math.pow(2,35),qI=Math.pow(2,42),GI=Math.pow(2,49),WI=Math.pow(2,56),QI=Math.pow(2,63);const YI={encode:NI,decode:UI,encodingLength:function(e){return e<jI?1:e<ZI?2:e<zI?3:e<VI?4:e<HI?5:e<qI?6:e<GI?7:e<WI?8:e<QI?9:10}},JI=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[YI.decode(e,t),YI.decode.bytes]},XI=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return YI.encode(e,t,n),t},$I=e=>YI.encodingLength(e),eC=(e,t)=>{const n=t.byteLength,r=$I(e),i=r+$I(n),o=new Uint8Array(i+n);return XI(e,o,0),XI(n,o,r),o.set(t,i),new nC(e,n,t,o)},tC=e=>{const t=SI(e),[n,r]=JI(t),[i,o]=JI(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new nC(n,i,s,t)};class nC{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const rC=SI,iC={code:0,name:"identity",encode:rC,digest:e=>eC(0,rC(e))},oC=e=>{let{name:t,code:n,encode:r}=e;return new sC(t,n,r)};class sC{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?eC(this.code,t):t.then((e=>eC(this.code,e)))}throw Error("Unknown type, must be binary type")}}const aC=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),cC=oC({name:"sha2-256",code:18,encode:aC("SHA-256")}),lC=oC({name:"sha2-512",code:19,encode:aC("SHA-512")});function uC(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Su.B)(n,"base64url")}function hC(e){const t=function(e,t){let n=(0,mu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(yu().jsbn.BigInteger)((0,Su.B)(t,"base16"),16)}function dC(e){return null!=e&&("function"===typeof e.then&&"function"===typeof e.catch&&"function"===typeof e.finally)}const fC=32,pC=64,gC=32;function yC(e,t){const n=new Uint8Array(pC);for(let r=0;r<gC;r++)n[r]=e[r],n[gC+r]=t[r];return n}const mC=PI({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),vC=PI({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),bC=PI({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),wC=PI({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),EC={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p/blob/main/packages/crypto/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},AC={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function SC(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=EC.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",AC,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",AC,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",AC,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return mC.encode(r)}var _C,IC,CC,TC;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(_C||(_C={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(IC||(IC={})),function(e){e.codec=()=>bs(IC)}(_C||(_C={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),_C.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=_C.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(CC||(CC={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),_C.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=_C.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(TC||(TC={}));class kC{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=NC(e,fC)}verify(e,t){return function(e,t,n){return Gl.verify(t,n instanceof Uint8Array?n:n.subarray(),e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return CC.encode({Type:_C.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=cC.digest(this.bytes);return dC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class RC{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=NC(e,pC),this._publicKey=NC(t,fC)}sign(e){return function(e,t){const n=e.subarray(0,gC);return Gl.sign(t instanceof Uint8Array?t:t.subarray(),n)}(this._key,e)}get public(){return new kC(this._publicKey)}marshal(){return this._key}get bytes(){return TC.encode({Type:_C.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=cC.digest(this.bytes);let t;return dC(e)?({bytes:t}=await e):t=e.bytes,t}async id(){const e=iC.digest(this.public.bytes);return DI.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return SC(this.bytes,e);throw new pu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function xC(e){if(e.length>pC){const t=(e=NC(e,pC+fC)).subarray(0,pC),n=e.subarray(pC,e.length);return new RC(t,n)}const t=(e=NC(e,pC)).subarray(0,pC),n=e.subarray(fC);return new RC(t,n)}function PC(e){return e=NC(e,fC),new kC(e)}async function DC(){const{privateKey:e,publicKey:t}=function(){const e=Gl.utils.randomPrivateKey(),t=Gl.getPublicKey(e);return{privateKey:yC(e,t),publicKey:t}}();return new RC(e,t)}async function OC(e){const{privateKey:t,publicKey:n}=function(e){if(e.length!==gC)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=Gl.getPublicKey(t);return{privateKey:yC(t,n),publicKey:n}}(e);return new RC(t,n)}function NC(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new pu.sv("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}const BC={"P-256":256,"P-384":384,"P-521":521};Object.keys(BC).join(" / ");function LC(e,t){return t.map((t=>hC(e[t])))}async function MC(e){const t=[await EC.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await FC(e)],n=await UC({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function UC(e){if(null==e.privateKey||null==e.publicKey)throw new pu.sv("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([EC.get().subtle.exportKey("jwk",e.privateKey),EC.get().subtle.exportKey("jwk",e.publicKey)])}async function FC(e){return EC.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function KC(e,t,n,r){const i=t?function(e){return yu().pki.setRsaPublicKey(...LC(e,["n","e"]))}(e):function(e){return yu().pki.setRsaPrivateKey(...LC(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Su.B)(n instanceof Uint8Array?n:n.subarray(),"ascii"),i);return(0,mu.m)(o,"ascii")}function jC(e){if("RSA"!==e.kty)throw new pu.sv("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new pu.sv("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,mu.m)(e.n,"base64url").length}const ZC=8192;class zC{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}verify(e,t){return async function(e,t,n){const r=await EC.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return EC.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n instanceof Uint8Array?n:n.subarray())}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new pu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.publicKeyToAsn1({n:hC(e.n),e:hC(e.e)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return CC.encode({Type:_C.RSA,Data:this.marshal()}).subarray()}encrypt(e){return KC(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=cC.digest(this.bytes);return dC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}}class VC{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return function(e){if(isNaN(e)||e<=0)throw new pu.sv("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Ic(e)}(16)}sign(e){return async function(e,t){const n=await EC.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await EC.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,t instanceof Uint8Array?t:t.subarray());return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new pu.sv("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new zC(this._publicKey)}decrypt(e){return KC(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new pu.sv("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.privateKeyToAsn1({n:hC(e.n),e:hC(e.e),d:hC(e.d),p:hC(e.p),q:hC(e.q),dP:hC(e.dp),dQ:hC(e.dq),qInv:hC(e.qi)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return TC.encode({Type:_C.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=cC.digest(this.bytes);return dC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(yu().util.ByteBuffer)(this.marshal()),n=yu().asn1.fromDer(t),r=yu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return yu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return SC(this.bytes,e);throw new pu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function HC(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:uC(n.n),e:uC(n.e),d:uC(n.d),p:uC(n.p),q:uC(n.q),dp:uC(n.dP),dq:uC(n.dQ),qi:uC(n.qInv),alg:"RS256"}}(e);if(jC(t)>ZC)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await MC(t);return new VC(n.privateKey,n.publicKey)}function qC(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:uC(n.n),e:uC(n.e)}}(e);if(jC(t)>ZC)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new zC(t)}async function GC(e){if(jC(e)>ZC)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await MC(e);return new VC(t.privateKey,t.publicKey)}async function WC(e){if(e>ZC)throw new pu.sv("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await EC.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await UC(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new VC(t.privateKey,t.publicKey)}function QC(e){try{Ah.ProjectivePoint.fromHex(e)}catch(t){throw new pu.sv(String(t),"ERR_INVALID_PUBLIC_KEY")}}class YC{constructor(e){(0,Yo.Z)(this,"_key",void 0),QC(e),this._key=e}verify(e,t){return function(e,t,n){const r=cC.digest(n instanceof Uint8Array?n:n.subarray());if(dC(r))return r.then((n=>{let{digest:r}=n;return Ah.verify(t,r,e)})).catch((e=>{throw new pu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Ah.verify(t,r.digest,e)}catch(i){throw new pu.sv(String(i),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Ah.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return CC.encode({Type:_C.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const e=cC.digest(this.bytes);let t;return dC(e)?({bytes:t}=await e):t=e.bytes,t}}class JC{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Ah.getPublicKey(e,!0)}catch(t){throw new pu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Ah.getPublicKey(e,!0)}catch(t){throw new pu.sv(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),QC(this._publicKey)}sign(e){return function(e,t){const n=cC.digest(t instanceof Uint8Array?t:t.subarray());if(dC(n))return n.then((t=>{let{digest:n}=t;return Ah.sign(n,e).toDERRawBytes()})).catch((e=>{throw new pu.sv(String(e),"ERR_INVALID_INPUT")}));try{return Ah.sign(n.digest,e).toDERRawBytes()}catch(r){throw new pu.sv(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new YC(this._publicKey)}marshal(){return this._key}get bytes(){return TC.encode({Type:_C.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}hash(){const e=cC.digest(this.bytes);return dC(e)?e.then((e=>{let{bytes:t}=e;return t})):e.bytes}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return SC(this.bytes,e);throw new pu.sv("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function XC(e){return new JC(e)}function $C(e){return new YC(e)}async function eT(){const e=Ah.utils.randomPrivateKey();return new JC(e)}const tT={rsa:we,ed25519:be,secp256k1:Ee};function nT(e){const t=Object.keys(tT).join(" / ");return new pu.sv("invalid or unsupported key type ".concat(e,". Must be ").concat(t),"ERR_UNSUPPORTED_KEY_TYPE")}async function rT(e){var t,n;const r=TC.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case _C.RSA:return tT.rsa.unmarshalRsaPrivateKey(i);case _C.Ed25519:return tT.ed25519.unmarshalEd25519PrivateKey(i);case _C.Secp256k1:return tT.secp256k1.unmarshalSecp256k1PrivateKey(i);default:throw nT(null!==(n=r.Type)&&void 0!==n?n:"RSA")}}const iT=xI({prefix:"9",name:"base10",alphabet:"0123456789"}),oT=PI({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),sT=PI({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),aT=PI({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),cT=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),lT=cT.reduce(((e,t,n)=>(e[n]=t,e)),[]),uT=cT.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const hT=RI({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=lT[t]),"")},decode:function(e){const t=[];for(const n of e){const e=uT[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),dT=PI({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),fT=PI({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),pT=PI({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),gT=PI({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),yT=PI({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),mT=PI({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),vT=PI({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),bT=PI({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),wT=PI({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),ET=xI({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),AT=xI({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),ST=PI({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),_T=RI({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),IT=new TextEncoder,CT=new TextDecoder,TT="json",kT=512,RT=e=>IT.encode(JSON.stringify(e)),xT=e=>JSON.parse(CT.decode(e)),PT="raw",DT=85,OT=e=>SI(e),NT=e=>SI(e),BT=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?KT(n,MT(e),t||DI.encoder):jT(n,MT(e),t||dT.encoder)},LT=new WeakMap,MT=e=>{const t=LT.get(e);if(null==t){const t=new Map;return LT.set(e,t),t}return t};class UT{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==ZT)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==zT)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return UT.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=eC(e,t);return UT.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return UT.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return BT(this,e)}toJSON(){return{"/":BT(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof UT)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new UT(e,n,r,i||VT(e,n,r.bytes))}if(!0===t[HT]){const{version:e,multihash:n,code:r}=t,i=tC(n);return UT.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==ZT)throw new Error("Version 0 CID must use dag-pb (code: ".concat(ZT,") block encoding"));return new UT(e,t,n,n.bytes);case 1:{const r=VT(e,t,n.bytes);return new UT(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return UT.create(0,ZT,e)}static createV1(e,t){return UT.create(1,e,t)}static decode(e){const[t,n]=UT.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=UT.inspectBytes(e),n=t.size-t.multihashSize,r=SI(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new nC(t.multihashCode,t.digestSize,i,r);return[0===t.version?UT.createV0(o):UT.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=JI(e.subarray(t));return t+=r,n};let r=n(),i=ZT;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=FT(e,t),i=UT.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return MT(i).set(n,e),i}}const FT=(e,t)=>{switch(e[0]){case"Q":{const n=t||DI;return[DI.prefix,n.decode("".concat(DI.prefix).concat(e))]}case DI.prefix:{const n=t||DI;return[DI.prefix,n.decode(e)]}case dT.prefix:{const n=t||dT;return[dT.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},KT=(e,t,n)=>{const{prefix:r}=n;if(r!==DI.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},jT=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},ZT=112,zT=18,VT=(e,t,n)=>{const r=$I(e),i=r+$I(t),o=new Uint8Array(i+n.byteLength);return XI(e,o,0),XI(t,o,r),o.set(n,i),o},HT=Symbol.for("@ipld/js-cid/CID"),qT={...Re,..._e,...ke,...Ae,...Se,...Ce,...Te,...ge,...ve,...Ie};let GT;const WT=Symbol.for("nodejs.util.inspect.custom"),QT=Object.values(qT).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),qT.identity.decoder),YT=114,JT=36,XT=37;GT=Symbol.toStringTag;class $T{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,pu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[GT](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=DI.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return UT.createV1(YT,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:QT,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=tC(DI.decode("z".concat(e)));return e.startsWith("12D")?new tk({multihash:t}):e.startsWith("16U")?new nk({multihash:t}):new ek({multihash:t})}return rk(QT.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[WT](){return"PeerId(".concat(this.toString(),")")}}class ek extends $T{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class tk extends $T{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class nk extends $T{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function rk(e){try{const t=tC(e);if(t.code===iC.code){if(t.digest.length===JT)return new tk({multihash:t});if(t.digest.length===XT)return new nk({multihash:t})}if(t.code===cC.code)return new ek({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==YT)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===cC.code)return new ek({multihash:e.multihash});if(t.code===iC.code){if(t.digest.length===JT)return new tk({multihash:e.multihash});if(t.digest.length===XT)return new nk({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(UT.decode(e))}throw new Error("Supplied PeerID CID is invalid")}const ik="ERR_SIGNATURE_NOT_VALID";var ok;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.publicKey&&e.publicKey.byteLength>0&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.payloadType&&e.payloadType.byteLength>0&&(t.uint32(18),t.bytes(e.payloadType)),null!=e.payload&&e.payload.byteLength>0&&(t.uint32(26),t.bytes(e.payload)),null!=e.signature&&e.signature.byteLength>0&&(t.uint32(42),t.bytes(e.signature)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={publicKey:new Uint8Array(0),payloadType:new Uint8Array(0),payload:new Uint8Array(0),signature:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.publicKey=e.bytes();break;case 2:n.payloadType=e.bytes();break;case 3:n.payload=e.bytes();break;case 5:n.signature=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(ok||(ok={}));class sk{constructor(e){(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"payloadType",void 0),(0,Yo.Z)(this,"payload",void 0),(0,Yo.Z)(this,"signature",void 0),(0,Yo.Z)(this,"marshaled",void 0);const{peerId:t,payloadType:n,payload:r,signature:i}=e;this.peerId=t,this.payloadType=n,this.payload=r,this.signature=i}marshal(){if(null==this.peerId.publicKey)throw new Error("Missing public key");return null==this.marshaled&&(this.marshaled=ok.encode({publicKey:this.peerId.publicKey,payloadType:this.payloadType,payload:this.payload.subarray(),signature:this.signature})),this.marshaled}equals(e){return(0,Ms.f)(this.marshal(),e.marshal())}async validate(e){const t=ak(e,this.payloadType,this.payload);if(null==this.peerId.publicKey)throw new Error("Missing public key");const n=function(e){var t,n;const r=CC.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case _C.RSA:return tT.rsa.unmarshalRsaPublicKey(i);case _C.Ed25519:return tT.ed25519.unmarshalEd25519PublicKey(i);case _C.Secp256k1:return tT.secp256k1.unmarshalSecp256k1PublicKey(i);default:throw nT(null!==(n=r.Type)&&void 0!==n?n:"unknown")}}(this.peerId.publicKey);return n.verify(t.subarray(),this.signature)}}(0,Yo.Z)(sk,"createFromProtobuf",(async e=>{const t=ok.decode(e),n=await async function(e,t){return e.length===JT?new tk({multihash:eC(iC.code,e),privateKey:t}):e.length===XT?new nk({multihash:eC(iC.code,e),privateKey:t}):new ek({multihash:await cC.digest(e),publicKey:e,privateKey:t})}(t.publicKey);return new sk({peerId:n,payloadType:t.payloadType,payload:t.payload,signature:t.signature})})),(0,Yo.Z)(sk,"seal",(async(e,t)=>{if(null==t.privateKey)throw new Error("Missing private key");const n=e.domain,r=e.codec,i=e.marshal(),o=ak(n,r,i),s=await rT(t.privateKey),a=await s.sign(o.subarray());return new sk({peerId:t,payloadType:r,payload:i,signature:a})})),(0,Yo.Z)(sk,"openAndCertify",(async(e,t)=>{const n=await sk.createFromProtobuf(e);if(!await n.validate(t))throw new pu.sv("envelope signature is not valid for the given domain",ik);return n}));const ak=(e,t,n)=>{const r=(0,mu.m)(e),i=Bs.cv(r.byteLength),o=Bs.cv(t.length),s=Bs.cv(n.length);return new Zs(i,r,o,t,s,n)};const ck=Uint8Array.from([3,1]);var lk;!function(e){let t,n;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.multiaddr&&e.multiaddr.byteLength>0&&(t.uint32(10),t.bytes(e.multiaddr)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={multiaddr:new Uint8Array(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();if(t>>>3===1)n.multiaddr=e.bytes();else e.skipType(7&t)}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(t=e.AddressInfo||(e.AddressInfo={})),e.codec=()=>(null==n&&(n=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==r.lengthDelimited&&n.fork(),null!=t.peerId&&t.peerId.byteLength>0&&(n.uint32(10),n.bytes(t.peerId)),null!=t.seq&&0n!==t.seq&&(n.uint32(16),n.uint64(t.seq)),null!=t.addresses)for(const i of t.addresses)n.uint32(26),e.AddressInfo.codec().encode(i,n);!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={peerId:new Uint8Array(0),seq:0n,addresses:[]},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.peerId=t.bytes();break;case 2:r.seq=t.uint64();break;case 3:r.addresses.push(e.AddressInfo.codec().decode(t,t.uint32()));break;default:t.skipType(7&n)}}return r}))),n),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(lk||(lk={}));class uk{constructor(e){(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"multiaddrs",void 0),(0,Yo.Z)(this,"seqNumber",void 0),(0,Yo.Z)(this,"domain",uk.DOMAIN),(0,Yo.Z)(this,"codec",uk.CODEC),(0,Yo.Z)(this,"marshaled",void 0);const{peerId:t,multiaddrs:n,seqNumber:r}=e;this.peerId=t,this.multiaddrs=null!==n&&void 0!==n?n:[],this.seqNumber=null!==r&&void 0!==r?r:BigInt(Date.now())}marshal(){return null==this.marshaled&&(this.marshaled=lk.encode({peerId:this.peerId.toBytes(),seq:BigInt(this.seqNumber),addresses:this.multiaddrs.map((e=>({multiaddr:e.bytes})))})),this.marshaled}equals(e){return e instanceof uk&&(!!this.peerId.equals(e.peerId)&&(this.seqNumber===e.seqNumber&&!!function(e,t){const n=(e,t)=>e.toString().localeCompare(t.toString());return e.length===t.length&&(t.sort(n),e.sort(n).every(((e,n)=>t[n].equals(e))))}(this.multiaddrs,e.multiaddrs)))}}function hk(e,t){const n=ua(e,t),r={read:async(e,t)=>{const r=await n.read(t);return e.decode(r)},write:async(e,t,r)=>{await n.write(t.encode(e),r)},writeV:async(e,t,r)=>{await n.writeV(e.map((e=>t.encode(e))),r)},pb:e=>({read:async t=>r.read(e,t),write:async(t,n)=>r.write(t,e,n),writeV:async(t,n)=>r.writeV(t,e,n),unwrap:()=>r}),unwrap:()=>n.unwrap()};return r}(0,Yo.Z)(uk,"createFromProtobuf",(e=>{var t;const n=lk.decode(e),r=rk(n.peerId),i=(null!==(t=n.addresses)&&void 0!==t?t:[]).map((e=>(0,og.HM)(e.multiaddr))),o=n.seq;return new uk({peerId:r,multiaddrs:i,seqNumber:o})})),(0,Yo.Z)(uk,"DOMAIN","libp2p-peer-record"),(0,Yo.Z)(uk,"CODEC",ck);BigInt(1<<17);const dk="/libp2p/circuit/relay/0.2.0/hop",fk="/libp2p/circuit/relay/0.2.0/stop",pk="ERR_RELAYED_DIAL";var gk,yk,mk,vk,bk,wk,Ek,Ak;function Sk(e){const t=e*BigInt(1e3),n=(new Date).getTime();return Number(t-BigInt(n))}!function(e){let t,n,r;!function(e){e.RESERVE="RESERVE",e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.RESERVE=0]="RESERVE",e[e.CONNECT=1]="CONNECT",e[e.STATUS=2]="STATUS"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),mk.codec().encode(t.peer,n)),null!=t.reservation&&(n.uint32(26),vk.codec().encode(t.reservation,n)),null!=t.limit&&(n.uint32(34),bk.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(40),wk.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=mk.codec().decode(t,t.uint32());break;case 3:r.reservation=vk.codec().decode(t,t.uint32());break;case 4:r.limit=bk.codec().decode(t,t.uint32());break;case 5:r.status=wk.codec().decode(t);break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(gk||(gk={})),function(e){let t,n,r;!function(e){e.CONNECT="CONNECT",e.STATUS="STATUS"}(t=e.Type||(e.Type={})),function(e){e[e.CONNECT=0]="CONNECT",e[e.STATUS=1]="STATUS"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.peer&&(n.uint32(18),mk.codec().encode(t.peer,n)),null!=t.limit&&(n.uint32(26),bk.codec().encode(t.limit,n)),null!=t.status&&(n.uint32(32),wk.codec().encode(t.status,n)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.peer=mk.codec().decode(t,t.uint32());break;case 3:r.limit=bk.codec().decode(t,t.uint32());break;case 4:r.status=wk.codec().decode(t);break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(yk||(yk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.id&&e.id.byteLength>0&&(t.uint32(10),t.bytes(e.id)),null!=e.addrs)for(const r of e.addrs)t.uint32(18),t.bytes(r);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={id:new Uint8Array(0),addrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.id=e.bytes();break;case 2:n.addrs.push(e.bytes());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(mk||(mk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.expire&&0n!==e.expire&&(t.uint32(8),t.uint64(e.expire)),null!=e.addrs)for(const r of e.addrs)t.uint32(18),t.bytes(r);null!=e.voucher&&(t.uint32(26),t.bytes(e.voucher)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={expire:0n,addrs:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.expire=e.uint64();break;case 2:n.addrs.push(e.bytes());break;case 3:n.voucher=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(vk||(vk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.duration&&(t.uint32(8),t.uint32(e.duration)),null!=e.data&&(t.uint32(16),t.uint64(e.data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.duration=e.uint32();break;case 2:n.data=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(bk||(bk={})),function(e){e.UNUSED="UNUSED",e.OK="OK",e.RESERVATION_REFUSED="RESERVATION_REFUSED",e.RESOURCE_LIMIT_EXCEEDED="RESOURCE_LIMIT_EXCEEDED",e.PERMISSION_DENIED="PERMISSION_DENIED",e.CONNECTION_FAILED="CONNECTION_FAILED",e.NO_RESERVATION="NO_RESERVATION",e.MALFORMED_MESSAGE="MALFORMED_MESSAGE",e.UNEXPECTED_MESSAGE="UNEXPECTED_MESSAGE"}(wk||(wk={})),function(e){e[e.UNUSED=0]="UNUSED",e[e.OK=100]="OK",e[e.RESERVATION_REFUSED=200]="RESERVATION_REFUSED",e[e.RESOURCE_LIMIT_EXCEEDED=201]="RESOURCE_LIMIT_EXCEEDED",e[e.PERMISSION_DENIED=202]="PERMISSION_DENIED",e[e.CONNECTION_FAILED=203]="CONNECTION_FAILED",e[e.NO_RESERVATION=204]="NO_RESERVATION",e[e.MALFORMED_MESSAGE=400]="MALFORMED_MESSAGE",e[e.UNEXPECTED_MESSAGE=401]="UNEXPECTED_MESSAGE"}(Ek||(Ek={})),function(e){e.codec=()=>bs(Ek)}(wk||(wk={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.relay&&e.relay.byteLength>0&&(t.uint32(10),t.bytes(e.relay)),null!=e.peer&&e.peer.byteLength>0&&(t.uint32(18),t.bytes(e.peer)),null!=e.expiration&&0n!==e.expiration&&(t.uint32(24),t.uint64(e.expiration)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={relay:new Uint8Array(0),peer:new Uint8Array(0),expiration:0n},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.relay=e.bytes();break;case 2:n.peer=e.bytes();break;case 3:n.expiration=e.uint64();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Ak||(Ak={}));n(99158);Object.prototype.toString,new Set(["Failed to fetch","NetworkError when attempting to fetch resource.","The Internet connection appears to be offline.","Load failed","Network request failed","fetch failed"]);var _k=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const Ik=_k,Ck=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class Tk{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class kk{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return xk(this,e)}}class Rk{constructor(e){this.decoders=e}or(e){return xk(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const xk=(e,t)=>new Rk({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class Pk{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new Tk(e,t,n),this.decoder=new kk(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const Dk=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new Pk(t,n,r,i)},Ok=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=Ik(r,n);return Dk({prefix:t,name:n,encode:i,decode:e=>Ck(o(e))})},Nk=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return Dk({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},Bk=Ok({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),Lk=Ok({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),Mk=Ok({prefix:"9",name:"base10",alphabet:"0123456789"}),Uk=Nk({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),Fk=Nk({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),Kk=Nk({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),jk=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),Zk=jk.reduce(((e,t,n)=>(e[n]=t,e)),[]),zk=jk.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const Vk=Dk({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=Zk[t]),"")},decode:function(e){const t=[];for(const n of e){const e=zk[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),Hk=Nk({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),qk=Nk({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),Gk=Nk({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),Wk=Nk({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),Qk=Nk({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),Yk=Nk({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),Jk=Nk({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),Xk=Nk({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),$k=Nk({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),eR=Ok({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),tR=Ok({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),nR=Nk({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),rR=Nk({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),iR=Nk({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),oR=Nk({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),sR=Nk({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),aR=Dk({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),cR=new TextEncoder,lR=new TextDecoder,uR="json",hR=512,dR=e=>cR.encode(JSON.stringify(e)),fR=e=>JSON.parse(lR.decode(e)),pR="raw",gR=85,yR=e=>Ck(e),mR=e=>Ck(e);var vR=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=ER;)n[r++]=255&t|bR,t/=128;for(;t&wR;)n[r++]=255&t|bR,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},bR=128,wR=-128,ER=Math.pow(2,31);var AR=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&_R)<<o:(r&_R)*Math.pow(2,o),o+=7}while(r>=SR);return e.bytes=s-n,i},SR=128,_R=127;var IR=Math.pow(2,7),CR=Math.pow(2,14),TR=Math.pow(2,21),kR=Math.pow(2,28),RR=Math.pow(2,35),xR=Math.pow(2,42),PR=Math.pow(2,49),DR=Math.pow(2,56),OR=Math.pow(2,63);const NR={encode:vR,decode:AR,encodingLength:function(e){return e<IR?1:e<CR?2:e<TR?3:e<kR?4:e<RR?5:e<xR?6:e<PR?7:e<DR?8:e<OR?9:10}},BR=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[NR.decode(e,t),NR.decode.bytes]},LR=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return NR.encode(e,t,n),t},MR=e=>NR.encodingLength(e),UR=(e,t)=>{const n=t.byteLength,r=MR(e),i=r+MR(n),o=new Uint8Array(i+n);return LR(e,o,0),LR(n,o,r),o.set(t,i),new KR(e,n,t,o)},FR=e=>{const t=Ck(e),[n,r]=BR(t),[i,o]=BR(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new KR(n,i,s,t)};class KR{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const jR=Ck,ZR={code:0,name:"identity",encode:jR,digest:e=>UR(0,jR(e))},zR=e=>{let{name:t,code:n,encode:r}=e;return new VR(t,n,r)};class VR{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?UR(this.code,t):t.then((e=>UR(this.code,e)))}throw Error("Unknown type, must be binary type")}}const HR=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),qR=zR({name:"sha2-256",code:18,encode:HR("SHA-256")}),GR=zR({name:"sha2-512",code:19,encode:HR("SHA-512")}),WR=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?$R(n,YR(e),t||Bk.encoder):ex(n,YR(e),t||Hk.encoder)},QR=new WeakMap,YR=e=>{const t=QR.get(e);if(null==t){const t=new Map;return QR.set(e,t),t}return t};class JR{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==tx)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==nx)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return JR.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=UR(e,t);return JR.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return JR.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return WR(this,e)}toJSON(){return{"/":WR(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof JR)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new JR(e,n,r,i||rx(e,n,r.bytes))}if(!0===t[ix]){const{version:e,multihash:n,code:r}=t,i=FR(n);return JR.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==tx)throw new Error("Version 0 CID must use dag-pb (code: ".concat(tx,") block encoding"));return new JR(e,t,n,n.bytes);case 1:{const r=rx(e,t,n.bytes);return new JR(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return JR.create(0,tx,e)}static createV1(e,t){return JR.create(1,e,t)}static decode(e){const[t,n]=JR.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=JR.inspectBytes(e),n=t.size-t.multihashSize,r=Ck(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new KR(t.multihashCode,t.digestSize,i,r);return[0===t.version?JR.createV0(o):JR.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=BR(e.subarray(t));return t+=r,n};let r=n(),i=tx;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=XR(e,t),i=JR.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return YR(i).set(n,e),i}}const XR=(e,t)=>{switch(e[0]){case"Q":{const n=t||Bk;return[Bk.prefix,n.decode("".concat(Bk.prefix).concat(e))]}case Bk.prefix:{const n=t||Bk;return[Bk.prefix,n.decode(e)]}case Hk.prefix:{const n=t||Hk;return[Hk.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},$R=(e,t,n)=>{const{prefix:r}=n;if(r!==Bk.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},ex=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},tx=112,nx=18,rx=(e,t,n)=>{const r=MR(e),i=r+MR(t),o=new Uint8Array(i+n.byteLength);return LR(e,o,0),LR(t,o,r),o.set(n,i),o},ix=Symbol.for("@ipld/js-cid/CID"),ox={...je,...Be,...Ke,...Oe,...Ne,...Me,...Ue,...De,...Fe,...Le};let sx;const ax=Symbol.for("nodejs.util.inspect.custom"),cx=Object.values(ox).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),ox.identity.decoder),lx=114,ux=36,hx=37;sx=Symbol.toStringTag;class dx{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,pu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[sx](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=Bk.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return JR.createV1(lx,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return yx(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[ax](){return"PeerId(".concat(this.toString(),")")}}class fx extends dx{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class px extends dx{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class gx extends dx{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function yx(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:cx,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=FR(Bk.decode("z".concat(e)));return e.startsWith("12D")?new px({multihash:t}):e.startsWith("16U")?new gx({multihash:t}):new fx({multihash:t})}return function(e){try{const t=FR(e);if(t.code===ZR.code){if(t.digest.length===ux)return new px({multihash:t});if(t.digest.length===hx)return new gx({multihash:t})}if(t.code===qR.code)return new fx({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==lx)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===qR.code)return new fx({multihash:e.multihash});if(t.code===ZR.code){if(t.digest.length===ux)return new px({multihash:e.multihash});if(t.digest.length===hx)return new gx({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(JR.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(cx.decode(e))}function mx(e,t){const n={[Symbol.iterator]:()=>n,next:()=>{const n=e.next(),r=n.value;if(!0===n.done||null==r){return{done:!0,value:void 0}}return{done:!1,value:t(r)}}};return n}let vx,bx,wx;vx=Symbol.iterator;class Ex{constructor(e){if((0,Yo.Z)(this,"map",void 0),this.map=new Map,null!=e)for(const[t,n]of e.entries())this.map.set(t.toString(),n)}[vx](){return this.entries()}clear(){this.map.clear()}delete(e){this.map.delete(e.toString())}entries(){return mx(this.map.entries(),(e=>[yx(e[0]),e[1]]))}forEach(e){this.map.forEach(((t,n)=>{e(t,yx(n),this)}))}get(e){return this.map.get(e.toString())}has(e){return this.map.has(e.toString())}set(e,t){this.map.set(e.toString(),t)}keys(){return mx(this.map.keys(),(e=>yx(e)))}values(){return this.map.values()}get size(){return this.map.size}}bx=Symbol.iterator;class Ax{constructor(e){if((0,Yo.Z)(this,"set",void 0),this.set=new Set,null!=e)for(const t of e)this.set.add(t.toString())}get size(){return this.set.size}[bx](){return this.values()}add(e){this.set.add(e.toString())}clear(){this.set.clear()}delete(e){this.set.delete(e.toString())}entries(){return mx(this.set.entries(),(e=>{const t=yx(e[0]);return[t,t]}))}forEach(e){this.set.forEach((t=>{const n=yx(t);e(n,n,this)}))}has(e){return this.set.has(e.toString())}values(){return mx(this.set.values(),(e=>yx(e)))}intersection(e){const t=new Ax;for(const n of e)this.has(n)&&t.add(n);return t}difference(e){const t=new Ax;for(const n of this)e.has(n)||t.add(n);return t}union(e){const t=new Ax;for(const n of e)t.add(n);for(const n of this)t.add(n);return t}}wx=Symbol.iterator;class Sx extends pu.Le{constructor(e){super(),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"contentRouting",void 0),(0,Yo.Z)(this,"registrar",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"topologyId",void 0),(0,Yo.Z)(this,"log",void 0),this.log=e.logger.forComponent("libp2p:circuit-relay:discover-relays"),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.contentRouting=e.contentRouting,this.registrar=e.registrar}isStarted(){return this.started}async start(){this.topologyId=await this.registrar.register(dk,{notifyOnTransient:!0,onConnect:e=>{this.safeDispatchEvent("relay:discover",{detail:e})}}),this.discover().catch((e=>{this.log.error("error listening on relays",e)})),this.started=!0}stop(){null!=this.topologyId&&this.registrar.unregister(this.topologyId),this.started=!1}async discover(){this.log("searching peer store for relays");const e=await this.peerStore.all({filters:[e=>e.protocols.includes(dk)],orders:[()=>Math.random()<.5?1:-1]});for(const n of e)this.log("found relay peer %p in content peer store",n.id),this.safeDispatchEvent("relay:discover",{detail:n.id});this.log("found %d relay peers in peer store",e.length);try{this.log("searching content routing for relays");const e=await async function(e){const t=(new TextEncoder).encode(e),n=await Q_.digest(t);return eI.createV0(n)}("/libp2p/relay");let t=0;for await(const n of this.contentRouting.findProviders(e))if(n.multiaddrs.length>0&&!n.id.equals(this.peerId)){const e=n.id;t++,await this.peerStore.merge(e,{multiaddrs:n.multiaddrs}),this.log("found relay peer %p in content routing",e),this.safeDispatchEvent("relay:discover",{detail:e})}this.log("found %d relay peers in content routing",t)}catch(t){this.log.error("failed when finding relays on the network",t)}}}var _x=n(44743),Ix=n(58271);var Cx=new WeakMap;class Tx{constructor(){(0,_x.Z)(this,Cx,{writable:!0,value:[]})}enqueue(e,t){var n;const r=null===t||void 0===t?void 0:t.peerId,i=null!==(n=null===t||void 0===t?void 0:t.priority)&&void 0!==n?n:0;if(null==r)throw new pu.sv("missing peer id",pu.Mb);const o={priority:i,peerId:r,run:e};if(this.size>0&&(0,Ix.Z)(this,Cx)[this.size-1].priority>=i)return void(0,Ix.Z)(this,Cx).push(o);const s=function(e,t,n){let r=0,i=e.length;for(;i>0;){const o=Math.trunc(i/2);let s=r+o;n(e[s],t)<=0?(r=++s,i-=o+1):i=o}return r}((0,Ix.Z)(this,Cx),o,((e,t)=>t.priority-e.priority));(0,Ix.Z)(this,Cx).splice(s,0,o)}dequeue(){const e=(0,Ix.Z)(this,Cx).shift();return null===e||void 0===e?void 0:e.run}filter(e){if(null!=e.peerId){const t=e.peerId;return(0,Ix.Z)(this,Cx).filter((e=>t.equals(e.peerId))).map((e=>e.run))}return(0,Ix.Z)(this,Cx).filter((t=>t.priority===e.priority)).map((e=>e.run))}get size(){return(0,Ix.Z)(this,Cx).length}}class kx extends Fm.Z{constructor(){super({...arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},queueClass:Tx})}hasJob(e){return this.sizeBy({peerId:e})>0}}var Rx=new WeakSet,xx=new WeakSet;class Px extends pu.Le{constructor(e,t){var n,r,i,o;super(),Jd(this,xx),Jd(this,Rx),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"events",void 0),(0,Yo.Z)(this,"reserveQueue",void 0),(0,Yo.Z)(this,"reservations",void 0),(0,Yo.Z)(this,"maxDiscoveredRelays",void 0),(0,Yo.Z)(this,"maxReservationQueueLength",void 0),(0,Yo.Z)(this,"reservationCompletionTimeout",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"log",void 0),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:reservation-store"),this.peerId=e.peerId,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.peerStore=e.peerStore,this.events=e.events,this.reservations=new Ex,this.maxDiscoveredRelays=null!==(n=null===t||void 0===t?void 0:t.discoverRelays)&&void 0!==n?n:0,this.maxReservationQueueLength=null!==(r=null===t||void 0===t?void 0:t.maxReservationQueueLength)&&void 0!==r?r:100,this.reservationCompletionTimeout=null!==(i=null===t||void 0===t?void 0:t.reservationCompletionTimeout)&&void 0!==i?i:1e4,this.started=!1,this.reserveQueue=new kx({concurrency:null!==(o=null===t||void 0===t?void 0:t.reservationConcurrency)&&void 0!==o?o:1}),this.events.addEventListener("peer:disconnect",(e=>{Xd(this,xx,Ox).call(this,e.detail)}))}isStarted(){return this.started}async start(){this.started=!0}async stop(){this.reserveQueue.clear(),this.reservations.forEach((e=>{let{timeout:t}=e;clearTimeout(t)})),this.reservations.clear(),this.started=!1}async addRelay(e,t){this.peerId.equals(e)?this.log("not trying to use self as relay"):this.reserveQueue.size>this.maxReservationQueueLength?this.log("not adding relay as the queue is full"):this.reserveQueue.hasJob(e)?this.log("relay peer is already in the reservation queue"):(this.log("add relay %p",e),await this.reserveQueue.add((async()=>{try{const n=this.reservations.get(e);if(null!=n){if(Sk(n.reservation.expire)>6e5)return void this.log("already have reservation on relay peer %p and it expires in more than 10 minutes",e);clearTimeout(n.timeout),this.reservations.delete(e)}if("discovered"===t&&[...this.reservations.values()].reduce(((e,t)=>("discovered"===t.type&&e++,e)),0)>=this.maxDiscoveredRelays)return void this.log("already have enough discovered relays");const r=AbortSignal.timeout(this.reservationCompletionTimeout),i=await this.connectionManager.openConnection(e,{signal:r});if(i.remoteAddr.protoNames().includes("p2p-circuit"))return void this.log("not creating reservation over relayed connection");const o=await Xd(this,Rx,Dx).call(this,i,{signal:r});this.log("created reservation on relay peer %p",e);const s=Sk(o.expire),a=Math.min(Math.max(s-3e5,3e4),Math.pow(2,31)-1),c=setTimeout((()=>{this.addRelay(e,t).catch((t=>{this.log.error("could not refresh reservation to relay %p",e,t)}))}),a);this.reservations.set(e,{timeout:c,reservation:o,type:t}),await this.peerStore.merge(e,{tags:{"circuit-relay-relay":{value:1,ttl:s}}}),await this.transportManager.listen([(0,og.HM)("/p2p/".concat(e.toString(),"/p2p-circuit"))])}catch(n){this.log.error("could not reserve slot on %p",e,n);const t=this.reservations.get(e);null!=t&&clearTimeout(t.timeout),this.reservations.delete(e)}}),{peerId:e}))}hasReservation(e){return this.reservations.has(e)}getReservation(e){var t;return null===(t=this.reservations.get(e))||void 0===t?void 0:t.reservation}}async function Dx(e,t){var n,r;null===(n=t.signal)||void 0===n||n.throwIfAborted(),this.log("requesting reservation from %p",e.remotePeer);const i=await e.newStream(dk,t),o=hk(i).pb(gk);let s;await o.write({type:gk.Type.RESERVE},t);try{s=await o.read(t)}catch(c){throw this.log.error("error parsing reserve message response from %p because",e.remotePeer,c),i.abort(c),c}finally{await i.close()}if(s.status===wk.OK&&null!=s.reservation){let t=!1;const n=e.remoteAddr.bytes;for(const e of s.reservation.addrs)if((0,Ms.f)(n,e)){t=!0;break}return t||s.reservation.addrs.push(n),s.reservation}const a="reservation failed with status ".concat(null!==(r=s.status)&&void 0!==r?r:"undefined");throw this.log.error(a),new Error(a)}function Ox(e){const t=this.reservations.get(e);null!=t&&(this.log("connection to relay %p closed, removing reservation from local store",e),clearTimeout(t.timeout),this.reservations.delete(e),this.safeDispatchEvent("relay:removed",{detail:e}),this.reservations.size<this.maxDiscoveredRelays&&(this.log("not enough relays %d/%d",this.reservations.size,this.maxDiscoveredRelays),this.safeDispatchEvent("relay:not-enough-relays",{})))}function Nx(e){const{stream:t,remoteAddr:n,logger:r}=e,i=r.forComponent("libp2p:stream:converter");let o=!1,s=!1;const a=t.close.bind(t);t.close=async e=>{await a(e),h(!0)};const c=t.abort.bind(t);t.abort=e=>{c(e),h(!0)};const l=t.sink.bind(t);t.sink=async e=>{try{await l(e)}catch(t){"aborted"!==t.type&&i(t)}finally{s=!0,h()}};const u={log:i,sink:t.sink,source:async function*(){try{for await(const e of t.source)e instanceof Uint8Array?yield e:yield*e}finally{o=!0,h()}}(),remoteAddr:n,timeline:{open:Date.now(),close:void 0},close:t.close,abort:t.abort};function h(e){!0===e&&(o=!0,s=!0),o&&s&&null==u.timeline.close&&(u.timeline.close=Date.now())}return u}const Bx=dP("dns4"),Lx=dP("dns6"),Mx=dP("dnsaddr"),Ux=hP(dP("dns"),Mx,Bx,Lx),Fx=hP(dP("ip4"),dP("ip6")),Kx=hP(uP(Fx,dP("tcp")),uP(Ux,dP("tcp"))),jx=uP(Fx,dP("udp")),Zx=uP(jx,dP("utp")),zx=uP(jx,dP("quic")),Vx=uP(jx,dP("quic-v1")),Hx=hP(uP(Kx,dP("ws")),uP(Ux,dP("ws"))),qx=hP(uP(Hx,dP("p2p")),Hx),Gx=hP(uP(Kx,dP("wss")),uP(Ux,dP("wss")),uP(Kx,dP("tls"),dP("ws")),uP(Ux,dP("tls"),dP("ws"))),Wx=hP(uP(Gx,dP("p2p")),Gx),Qx=hP(uP(Kx,dP("http")),uP(Fx,dP("http")),uP(Ux,dP("http"))),Yx=hP(uP(Kx,dP("https")),uP(Fx,dP("https")),uP(Ux,dP("https"))),Jx=uP(jx,dP("webrtc-direct"),dP("certhash")),Xx=hP(uP(Jx,dP("p2p")),Jx),$x=uP(Vx,dP("webtransport"),dP("certhash"),dP("certhash")),eP=hP(uP($x,dP("p2p")),$x),tP=hP(uP(qx,dP("p2p-webrtc-star"),dP("p2p")),uP(Wx,dP("p2p-webrtc-star"),dP("p2p")),uP(qx,dP("p2p-webrtc-star")),uP(Wx,dP("p2p-webrtc-star"))),nP=(hP(uP(qx,dP("p2p-websocket-star"),dP("p2p")),uP(Wx,dP("p2p-websocket-star"),dP("p2p")),uP(qx,dP("p2p-websocket-star")),uP(Wx,dP("p2p-websocket-star"))),hP(uP(Qx,dP("p2p-webrtc-direct"),dP("p2p")),uP(Yx,dP("p2p-webrtc-direct"),dP("p2p")),uP(Qx,dP("p2p-webrtc-direct")),uP(Yx,dP("p2p-webrtc-direct")))),rP=hP(Hx,Gx,Qx,Yx,tP,nP,Kx,Zx,zx,Ux,Xx,eP),iP=(hP(uP(rP,dP("p2p-stardust"),dP("p2p")),uP(rP,dP("p2p-stardust"))),hP(uP(rP,dP("p2p")),tP,nP,Xx,eP,dP("p2p"))),oP=hP(uP(iP,dP("p2p-circuit"),iP),uP(iP,dP("p2p-circuit")),uP(dP("p2p-circuit"),iP),uP(rP,dP("p2p-circuit")),uP(dP("p2p-circuit"),rP),dP("p2p-circuit")),sP=()=>hP(uP(oP,sP),oP),aP=sP(),cP=hP(uP(aP,iP,aP),uP(iP,aP),uP(aP,iP),aP,iP);hP(uP(aP,dP("webrtc"),dP("p2p")),uP(aP,dP("webrtc")),uP(rP,dP("webrtc"),dP("p2p")),uP(rP,dP("webrtc")),dP("webrtc"));function lP(e){return function(t){let n;try{n=(0,og.HM)(t)}catch(i){return!1}const r=e(n.protoNames());return null!==r&&(!0===r||!1===r?r:0===r.length)}}function uP(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];function r(e){if(e.length<t.length)return null;let n=e;return t.some((t=>(n="function"===typeof t?t().partialMatch(e):t.partialMatch(e),Array.isArray(n)&&(e=n),null===n))),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:lP(r),partialMatch:r}}function hP(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];function r(e){let n=null;return t.some((t=>{const r="function"===typeof t?t().partialMatch(e):t.partialMatch(e);return null!=r&&(n=r,!0)})),n}return{toString:function(){return"{ "+t.join(" ")+" }"},input:t,matches:lP(r),partialMatch:r}}function dP(e){const t=e;return{toString:function(){return t},matches:function(e){let n;try{n=(0,og.HM)(e)}catch(i){return!1}const r=n.protoNames();return 1===r.length&&r[0]===t},partialMatch:function(e){return 0===e.length?null:e[0]===t?e.slice(1):null}}}var fP=new WeakSet;class pP extends pu.Le{constructor(e){super(),Jd(this,fP),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"relayStore",void 0),(0,Yo.Z)(this,"listeningAddrs",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"_onRemoveRelayPeer",(e=>{Xd(this,fP,gP).call(this,e.detail)})),this.log=e.logger.forComponent("libp2p:circuit-relay:transport:listener"),this.connectionManager=e.connectionManager,this.relayStore=e.relayStore,this.listeningAddrs=new Ex,this.relayStore.addEventListener("relay:removed",this._onRemoveRelayPeer)}async listen(e){this.log("listen on %a",e);const t=e.decapsulate("/p2p-circuit"),n=await this.connectionManager.openConnection(t);if(!this.relayStore.hasReservation(n.remotePeer))return this.log("making reservation on peer %p",n.remotePeer),void await this.relayStore.addRelay(n.remotePeer,"configured");const r=this.relayStore.getReservation(n.remotePeer);if(null==r)throw new pu.sv("Did not have reservation after making reservation","ERR_NO_RESERVATION");this.listeningAddrs.has(n.remotePeer)?this.log("already listening on relay %p",n.remotePeer):(this.listeningAddrs.set(n.remotePeer,r.addrs.map((e=>(0,og.HM)(e).encapsulate("/p2p-circuit")))),this.safeDispatchEvent("listening",{}))}getAddrs(){return[...this.listeningAddrs.values()].flat()}async close(){}}function gP(e){const t=this.listeningAddrs.has(e);this.log("relay peer removed %p - had reservation",e,t),this.listeningAddrs.delete(e),t&&(this.log.trace("removing relay event listener for peer %p",e),this.relayStore.removeEventListener("relay:removed",this._onRemoveRelayPeer),this.safeDispatchEvent("close",{}))}let yP;const mP=300,vP=300,bP=3e4;yP=Symbol.toStringTag;class wP{constructor(e,t){var n,r,i;(0,Yo.Z)(this,"discovery",void 0),(0,Yo.Z)(this,"registrar",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"upgrader",void 0),(0,Yo.Z)(this,"addressManager",void 0),(0,Yo.Z)(this,"connectionGater",void 0),(0,Yo.Z)(this,"reservationStore",void 0),(0,Yo.Z)(this,"logger",void 0),(0,Yo.Z)(this,"maxInboundStopStreams",void 0),(0,Yo.Z)(this,"maxOutboundStopStreams",void 0),(0,Yo.Z)(this,"stopTimeout",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,pu.SF,!0),(0,Yo.Z)(this,yP,"libp2p/circuit-relay-v2"),this.log=e.logger.forComponent("libp2p:circuit-relay:transport"),this.registrar=e.registrar,this.peerStore=e.peerStore,this.connectionManager=e.connectionManager,this.transportManager=e.transportManager,this.logger=e.logger,this.peerId=e.peerId,this.upgrader=e.upgrader,this.addressManager=e.addressManager,this.connectionGater=e.connectionGater,this.maxInboundStopStreams=null!==(n=t.maxInboundStopStreams)&&void 0!==n?n:mP,this.maxOutboundStopStreams=null!==(r=t.maxOutboundStopStreams)&&void 0!==r?r:vP,this.stopTimeout=null!==(i=t.stopTimeout)&&void 0!==i?i:bP,null!=t.discoverRelays&&t.discoverRelays>0&&(this.discovery=new Sx(e),this.discovery.addEventListener("relay:discover",(e=>{this.reservationStore.addRelay(e.detail,"discovered").catch((t=>{this.log.error("could not add discovered relay %p",e.detail,t)}))}))),this.reservationStore=new Px(e,t),this.reservationStore.addEventListener("relay:not-enough-relays",(()=>{var e;null===(e=this.discovery)||void 0===e||e.discover().catch((e=>{this.log.error("could not discover relays",e)}))})),this.started=!1}isStarted(){return this.started}async start(){var e;await this.reservationStore.start(),await(null===(e=this.discovery)||void 0===e?void 0:e.start()),await this.registrar.handle(fk,(e=>{this.onStop(e).catch((t=>{this.log.error("error while handling STOP protocol",t),e.stream.abort(t)}))}),{maxInboundStreams:this.maxInboundStopStreams,maxOutboundStreams:this.maxOutboundStopStreams,runOnTransientConnection:!0}),this.started=!0}async stop(){var e;null===(e=this.discovery)||void 0===e||e.stop(),await this.reservationStore.stop(),await this.registrar.unhandle(fk),this.started=!1}async dial(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(1!==e.protoCodes().filter((e=>290===e)).length){const t="Invalid circuit relay address";throw this.log.error(t,e),new pu.sv(t,pk)}const n=e.toString().split("/p2p-circuit"),r=(0,og.HM)(n[0]),i=(0,og.HM)(n[n.length-1]),o=r.getPeerId(),s=i.getPeerId();if(null==o||null==s){const t="Circuit relay dial to ".concat(e.toString()," failed as address did not have peer ids");throw this.log.error(t),new pu.sv(t,pk)}const a=bI(o),c=bI(s);let l=!1;let u,h=this.connectionManager.getConnections(a)[0];null==h&&(await this.peerStore.merge(a,{multiaddrs:[r]}),h=await this.connectionManager.openConnection(a,t),l=!0);try{return u=await h.newStream(dk),await this.connectV2({stream:u,connection:h,destinationPeer:c,destinationAddr:i,relayAddr:r,ma:e,disconnectOnFailure:l})}catch(d){throw this.log.error("circuit relay dial to destination %p via relay %p failed",c,a,d),null!=u&&u.abort(d),l&&await h.close(),d}}async connectV2(e){let{stream:t,connection:n,destinationPeer:r,destinationAddr:i,relayAddr:o,ma:s,disconnectOnFailure:a}=e;try{const e=hk(t),n=e.pb(gk);await n.write({type:gk.Type.CONNECT,peer:{id:r.toBytes(),addrs:[(0,og.HM)(i).bytes]}});const a=await n.read();var c,l;if(a.status!==wk.OK)throw new pu.sv("failed to connect via relay with status ".concat(null!==(c=null===a||void 0===a||null===(l=a.status)||void 0===l?void 0:l.toString())&&void 0!==c?c:"undefined"),"ERR_HOP_REQUEST_FAILED");const u=Nx({stream:e.unwrap(),remoteAddr:s,localAddr:o.encapsulate("/p2p-circuit/p2p/".concat(this.peerId.toString())),logger:this.logger});return this.log("new outbound transient connection %a",u.remoteAddr),await this.upgrader.upgradeOutbound(u,{transient:!0})}catch(u){throw this.log.error("Circuit relay dial to destination ".concat(r.toString()," via relay ").concat(n.remotePeer.toString()," failed"),u),a&&await n.close(),u}}createListener(e){return function(e){return new pP(e)}({connectionManager:this.connectionManager,relayStore:this.reservationStore,logger:this.logger})}filter(e){return(e=Array.isArray(e)?e:[e]).filter((e=>aP.matches(e)))}async onStop(e){var t,n;let{connection:r,stream:i}=e;if(!this.reservationStore.hasReservation(r.remotePeer))try{this.log("dialed via relay we did not have a reservation on, start listening on that relay address"),await this.transportManager.listen([r.remoteAddr.encapsulate("/p2p-circuit")])}catch(d){this.log.error("failed to listen on a relay peer we were dialed via but did not have a reservation on",d)}const o=AbortSignal.timeout(this.stopTimeout),s=hk(i).pb(yk),a=await s.read({signal:o});if(this.log("new circuit relay v2 stop stream from %p with type %s",r.remotePeer,a.type),void 0===(null===a||void 0===a?void 0:a.type))return this.log.error("type was missing from circuit v2 stop protocol request from %s",r.remotePeer),await s.write({type:yk.Type.STATUS,status:wk.MALFORMED_MESSAGE},{signal:o}),void await i.close();if(a.type!==yk.Type.CONNECT)return this.log.error("invalid stop connect request via peer %p",r.remotePeer),await s.write({type:yk.Type.STATUS,status:wk.UNEXPECTED_MESSAGE},{signal:o}),void await i.close();if(!(e=>{if(null==e.peer)return!1;try{e.peer.addrs.forEach(og.HM)}catch{return!1}return!0})(a))return this.log.error("invalid stop connect request via peer %p",r.remotePeer),await s.write({type:yk.Type.STATUS,status:wk.MALFORMED_MESSAGE},{signal:o}),void await i.close();const c=wI(a.peer.id);if(!0===await(null===(t=(n=this.connectionGater).denyInboundRelayedConnection)||void 0===t?void 0:t.call(n,r.remotePeer,c)))return this.log.error("connection gater denied inbound relayed connection from %p",r.remotePeer),await s.write({type:yk.Type.STATUS,status:wk.PERMISSION_DENIED},{signal:o}),void await i.close();this.log.trace("sending success response to %p",r.remotePeer),await s.write({type:yk.Type.STATUS,status:wk.OK},{signal:o});const l=r.remoteAddr.encapsulate("/p2p-circuit/p2p/".concat(c.toString())),u=this.addressManager.getAddresses()[0],h=Nx({stream:s.unwrap().unwrap(),remoteAddr:l,localAddr:u,logger:this.logger});this.log("new inbound transient connection %a",h.remoteAddr),await this.upgrader.upgradeInbound(h,{transient:!0}),this.log("%s connection %a upgraded","inbound",h.remoteAddr)}}function EP(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=>new wP(t,e)}var AP=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const SP=AP,_P=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class IP{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class CP{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return kP(this,e)}}class TP{constructor(e){this.decoders=e}or(e){return kP(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const kP=(e,t)=>new TP({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class RP{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new IP(e,t,n),this.decoder=new CP(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const xP=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new RP(t,n,r,i)},PP=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=SP(r,n);return xP({prefix:t,name:n,encode:i,decode:e=>_P(o(e))})},DP=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return xP({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},OP=PP({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),NP=PP({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),BP=PP({prefix:"9",name:"base10",alphabet:"0123456789"}),LP=DP({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),MP=DP({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),UP=DP({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),FP=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),KP=FP.reduce(((e,t,n)=>(e[n]=t,e)),[]),jP=FP.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const ZP=xP({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=KP[t]),"")},decode:function(e){const t=[];for(const n of e){const e=jP[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),zP=DP({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),VP=DP({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),HP=DP({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),qP=DP({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),GP=DP({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),WP=DP({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),QP=DP({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),YP=DP({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),JP=DP({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),XP=PP({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),$P=PP({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),eD=DP({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),tD=DP({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),nD=DP({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),rD=DP({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),iD=DP({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),oD=xP({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),sD=new TextEncoder,aD=new TextDecoder,cD="json",lD=512,uD=e=>sD.encode(JSON.stringify(e)),hD=e=>JSON.parse(aD.decode(e)),dD="raw",fD=85,pD=e=>_P(e),gD=e=>_P(e);var yD=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=bD;)n[r++]=255&t|mD,t/=128;for(;t&vD;)n[r++]=255&t|mD,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},mD=128,vD=-128,bD=Math.pow(2,31);var wD=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&AD)<<o:(r&AD)*Math.pow(2,o),o+=7}while(r>=ED);return e.bytes=s-n,i},ED=128,AD=127;var SD=Math.pow(2,7),_D=Math.pow(2,14),ID=Math.pow(2,21),CD=Math.pow(2,28),TD=Math.pow(2,35),kD=Math.pow(2,42),RD=Math.pow(2,49),xD=Math.pow(2,56),PD=Math.pow(2,63);const DD={encode:yD,decode:wD,encodingLength:function(e){return e<SD?1:e<_D?2:e<ID?3:e<CD?4:e<TD?5:e<kD?6:e<RD?7:e<xD?8:e<PD?9:10}},OD=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[DD.decode(e,t),DD.decode.bytes]},ND=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return DD.encode(e,t,n),t},BD=e=>DD.encodingLength(e),LD=(e,t)=>{const n=t.byteLength,r=BD(e),i=r+BD(n),o=new Uint8Array(i+n);return ND(e,o,0),ND(n,o,r),o.set(t,i),new UD(e,n,t,o)},MD=e=>{const t=_P(e),[n,r]=OD(t),[i,o]=OD(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new UD(n,i,s,t)};class UD{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const FD=_P,KD={code:0,name:"identity",encode:FD,digest:e=>LD(0,FD(e))},jD=e=>{let{name:t,code:n,encode:r}=e;return new ZD(t,n,r)};class ZD{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?LD(this.code,t):t.then((e=>LD(this.code,e)))}throw Error("Unknown type, must be binary type")}}const zD=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),VD=jD({name:"sha2-256",code:18,encode:zD("SHA-256")}),HD=jD({name:"sha2-512",code:19,encode:zD("SHA-512")}),qD=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?JD(n,WD(e),t||OP.encoder):XD(n,WD(e),t||zP.encoder)},GD=new WeakMap,WD=e=>{const t=GD.get(e);if(null==t){const t=new Map;return GD.set(e,t),t}return t};class QD{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==$D)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==eO)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return QD.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=LD(e,t);return QD.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return QD.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return qD(this,e)}toJSON(){return{"/":qD(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof QD)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new QD(e,n,r,i||tO(e,n,r.bytes))}if(!0===t[nO]){const{version:e,multihash:n,code:r}=t,i=MD(n);return QD.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==$D)throw new Error("Version 0 CID must use dag-pb (code: ".concat($D,") block encoding"));return new QD(e,t,n,n.bytes);case 1:{const r=tO(e,t,n.bytes);return new QD(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return QD.create(0,$D,e)}static createV1(e,t){return QD.create(1,e,t)}static decode(e){const[t,n]=QD.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=QD.inspectBytes(e),n=t.size-t.multihashSize,r=_P(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new UD(t.multihashCode,t.digestSize,i,r);return[0===t.version?QD.createV0(o):QD.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=OD(e.subarray(t));return t+=r,n};let r=n(),i=$D;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=YD(e,t),i=QD.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return WD(i).set(n,e),i}}const YD=(e,t)=>{switch(e[0]){case"Q":{const n=t||OP;return[OP.prefix,n.decode("".concat(OP.prefix).concat(e))]}case OP.prefix:{const n=t||OP;return[OP.prefix,n.decode(e)]}case zP.prefix:{const n=t||zP;return[zP.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},JD=(e,t,n)=>{const{prefix:r}=n;if(r!==OP.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},XD=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},$D=112,eO=18,tO=(e,t,n)=>{const r=BD(e),i=r+BD(t),o=new Uint8Array(i+n.byteLength);return ND(e,o,0),ND(t,o,r),o.set(n,i),o},nO=Symbol.for("@ipld/js-cid/CID"),rO={...tt,...Qe,...et,...Ge,...We,...Je,...Xe,...qe,...$e,...Ye};let iO;const oO=Symbol.for("nodejs.util.inspect.custom"),sO=Object.values(rO).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),rO.identity.decoder),aO=114,cO=36,lO=37;iO=Symbol.toStringTag;class uO{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,pu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[iO](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=OP.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return QD.createV1(aO,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:sO,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=MD(OP.decode("z".concat(e)));return e.startsWith("12D")?new dO({multihash:t}):e.startsWith("16U")?new fO({multihash:t}):new hO({multihash:t})}return function(e){try{const t=MD(e);if(t.code===KD.code){if(t.digest.length===cO)return new dO({multihash:t});if(t.digest.length===lO)return new fO({multihash:t})}if(t.code===VD.code)return new hO({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==aO)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===VD.code)return new hO({multihash:e.multihash});if(t.code===KD.code){if(t.digest.length===cO)return new dO({multihash:e.multihash});if(t.digest.length===lO)return new fO({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(QD.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(sO.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[oO](){return"PeerId(".concat(this.toString(),")")}}class hO extends uO{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class dO extends uO{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class fO extends uO{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}async function pO(e,t){return e.length===cO?new dO({multihash:LD(KD.code,e),privateKey:t}):e.length===lO?new fO({multihash:LD(KD.code,e),privateKey:t}):new hO({multihash:await VD.digest(e),publicKey:e,privateKey:t})}var gO=n(25546),yO=n(82193),mO=n.n(yO);const vO="object"===typeof window&&"object"===typeof document&&9===document.nodeType,bO=mO()(),wO=vO&&!bO,EO=bO&&!vO,AO=bO&&vO,SO="undefined"!==typeof globalThis.process&&"undefined"!==typeof globalThis.process.release&&"node"===globalThis.process.release.name&&!bO,_O="function"===typeof importScripts&&"undefined"!==typeof self&&"undefined"!==typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope,IO=("undefined"!==typeof globalThis.process&&"undefined"!==typeof globalThis.process.env&&globalThis.process.env.NODE_ENV,"undefined"!==typeof navigator&&"ReactNative"===navigator.product);var CO;!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.protocolVersion&&(t.uint32(42),t.string(e.protocolVersion)),null!=e.agentVersion&&(t.uint32(50),t.string(e.agentVersion)),null!=e.publicKey&&(t.uint32(10),t.bytes(e.publicKey)),null!=e.listenAddrs)for(const r of e.listenAddrs)t.uint32(18),t.bytes(r);if(null!=e.observedAddr&&(t.uint32(34),t.bytes(e.observedAddr)),null!=e.protocols)for(const r of e.protocols)t.uint32(26),t.string(r);null!=e.signedPeerRecord&&(t.uint32(66),t.bytes(e.signedPeerRecord)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={listenAddrs:[],protocols:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 5:n.protocolVersion=e.string();break;case 6:n.agentVersion=e.string();break;case 1:n.publicKey=e.bytes();break;case 2:n.listenAddrs.push(e.bytes());break;case 4:n.observedAddr=e.bytes();break;case 3:n.protocols.push(e.string());break;case 8:n.signedPeerRecord=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(CO||(CO={}));const TO=8192,kO="ipfs",RO=6e4,xO=1,PO=1,DO=1,OO=1,NO=10,BO=8192,LO=!0,MO=!0;var UO=new WeakSet;class FO{constructor(e){var t,n,r,i,o,s,a,c,l,u,h,d,f;let p=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};Jd(this,UO),(0,Yo.Z)(this,"identifyProtocolStr",void 0),(0,Yo.Z)(this,"identifyPushProtocolStr",void 0),(0,Yo.Z)(this,"host",void 0),(0,Yo.Z)(this,"started",void 0),(0,Yo.Z)(this,"timeout",void 0),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"peerStore",void 0),(0,Yo.Z)(this,"registrar",void 0),(0,Yo.Z)(this,"connectionManager",void 0),(0,Yo.Z)(this,"addressManager",void 0),(0,Yo.Z)(this,"maxInboundStreams",void 0),(0,Yo.Z)(this,"maxOutboundStreams",void 0),(0,Yo.Z)(this,"maxPushIncomingStreams",void 0),(0,Yo.Z)(this,"maxPushOutgoingStreams",void 0),(0,Yo.Z)(this,"maxIdentifyMessageSize",void 0),(0,Yo.Z)(this,"maxObservedAddresses",void 0),(0,Yo.Z)(this,"events",void 0),(0,Yo.Z)(this,"runOnTransientConnection",void 0),(0,Yo.Z)(this,"log",void 0),this.started=!1,this.peerId=e.peerId,this.peerStore=e.peerStore,this.registrar=e.registrar,this.addressManager=e.addressManager,this.connectionManager=e.connectionManager,this.events=e.events,this.log=e.logger.forComponent("libp2p:identify"),this.identifyProtocolStr="/".concat(null!==(t=p.protocolPrefix)&&void 0!==t?t:kO,"/").concat("id","/").concat("1.0.0"),this.identifyPushProtocolStr="/".concat(null!==(n=p.protocolPrefix)&&void 0!==n?n:kO,"/").concat("id/push","/").concat("1.0.0"),this.timeout=null!==(r=p.timeout)&&void 0!==r?r:RO,this.maxInboundStreams=null!==(i=p.maxInboundStreams)&&void 0!==i?i:xO,this.maxOutboundStreams=null!==(o=p.maxOutboundStreams)&&void 0!==o?o:PO,this.maxPushIncomingStreams=null!==(s=p.maxPushIncomingStreams)&&void 0!==s?s:DO,this.maxPushOutgoingStreams=null!==(a=p.maxPushOutgoingStreams)&&void 0!==a?a:OO,this.maxIdentifyMessageSize=null!==(c=p.maxIdentifyMessageSize)&&void 0!==c?c:BO,this.maxObservedAddresses=null!==(l=p.maxObservedAddresses)&&void 0!==l?l:NO,this.runOnTransientConnection=null!==(u=p.runOnTransientConnection)&&void 0!==u?u:MO,this.host={protocolVersion:"".concat(null!==(h=p.protocolPrefix)&&void 0!==h?h:kO,"/").concat("0.1.0"),agentVersion:null!==(d=p.agentVersion)&&void 0!==d?d:"".concat(e.nodeInfo.name,"/").concat(e.nodeInfo.version)},(null!==(f=p.runOnConnectionOpen)&&void 0!==f?f:LO)&&e.events.addEventListener("connection:open",(e=>{const t=e.detail;this.identify(t).catch((e=>{this.log.error("error during identify trigged by connection:open",e)}))})),e.events.addEventListener("self:peer:update",(e=>{this.push().catch((e=>{this.log.error(e)}))})),this.host.agentVersion==="".concat(e.nodeInfo.name,"/").concat(e.nodeInfo.version)&&(SO||EO?this.host.agentVersion+=" UserAgent=".concat(globalThis.process.version):(wO||_O||AO||IO)&&(this.host.agentVersion+=" UserAgent=".concat(globalThis.navigator.userAgent)))}isStarted(){return this.started}async start(){this.started||(await this.peerStore.merge(this.peerId,{metadata:{AgentVersion:(0,mu.m)(this.host.agentVersion),ProtocolVersion:(0,mu.m)(this.host.protocolVersion)}}),await this.registrar.handle(this.identifyProtocolStr,(e=>{this._handleIdentify(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxInboundStreams,maxOutboundStreams:this.maxOutboundStreams,runOnTransientConnection:this.runOnTransientConnection}),await this.registrar.handle(this.identifyPushProtocolStr,(e=>{this._handlePush(e).catch((e=>{this.log.error(e)}))}),{maxInboundStreams:this.maxPushIncomingStreams,maxOutboundStreams:this.maxPushOutgoingStreams,runOnTransientConnection:this.runOnTransientConnection}),this.started=!0)}async stop(){await this.registrar.unhandle(this.identifyProtocolStr),await this.registrar.unhandle(this.identifyPushProtocolStr),this.started=!1}async pushToConnections(e){var t,n;const r=this.addressManager.getAddresses().map((e=>e.decapsulateCode((0,og.a_)("p2p").code))),i=new uk({peerId:this.peerId,multiaddrs:r}),o=await sk.seal(i,this.peerId),s=this.registrar.getProtocols(),a=await this.peerStore.get(this.peerId),c=(0,Su.B)(null!==(t=a.metadata.get("AgentVersion"))&&void 0!==t?t:(0,mu.m)(this.host.agentVersion)),l=(0,Su.B)(null!==(n=a.metadata.get("ProtocolVersion"))&&void 0!==n?n:(0,mu.m)(this.host.protocolVersion)),u=e.map((async e=>{let t;const n=AbortSignal.timeout(this.timeout);(0,pu.Wp)(1/0,n);try{var i;t=await e.newStream(this.identifyPushProtocolStr,{signal:n,runOnTransientConnection:this.runOnTransientConnection});const a=hk(t,{maxDataLength:null!==(i=this.maxIdentifyMessageSize)&&void 0!==i?i:TO}).pb(CO);await a.write({listenAddrs:r.map((e=>e.bytes)),signedPeerRecord:o.marshal(),protocols:s,agentVersion:c,protocolVersion:l},{signal:n}),await t.close({signal:n})}catch(u){var a;this.log.error("could not push identify update to peer",u),null===(a=t)||void 0===a||a.abort(u)}}));await Promise.all(u)}async push(){if(!this.isStarted())return;const e=[];await Promise.all(this.connectionManager.getConnections().map((async t=>{try{if(!(await this.peerStore.get(t.remotePeer)).protocols.includes(this.identifyPushProtocolStr))return;e.push(t)}catch(n){if(n.code!==pu.Vc)throw n}}))),await this.pushToConnections(e)}async _identify(e){let t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(null==n.signal){const e=AbortSignal.timeout(this.timeout);(0,pu.Wp)(1/0,e),n={...n,signal:e}}try{var r;t=await e.newStream(this.identifyProtocolStr,{...n,runOnTransientConnection:this.runOnTransientConnection});const i=hk(t,{maxDataLength:null!==(r=this.maxIdentifyMessageSize)&&void 0!==r?r:TO}).pb(CO),o=await i.read(n);return await t.close(n),o}catch(o){var i;throw this.log.error("error while reading identify message",o),null===(i=t)||void 0===i||i.abort(o),o}}async identify(e){var t;let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=await this._identify(e,n),{publicKey:i,protocols:o,observedAddr:s}=r;if(null==i)throw new pu.sv("public key was missing from identify message","ERR_MISSING_PUBLIC_KEY");const a=await pO(i);if(!e.remotePeer.equals(a))throw new pu.sv("identified peer does not match the expected peer","ERR_INVALID_PEER");if(this.peerId.equals(a))throw new pu.sv("identified peer is our own peer id?","ERR_INVALID_PEER");const c=function(e){if(null!=e&&e.length>0)try{return(0,og.HM)(e)}catch{}}(s);return this.log("identify completed for peer %p and protocols %o",a,o),this.log("our observed address is %a",c),null!=c&&this.addressManager.getObservedAddrs().length<(null!==(t=this.maxObservedAddresses)&&void 0!==t?t:1/0)&&(this.log("storing our observed address %a",c),this.addressManager.addObservedAddr(c)),Xd(this,UO,KO).call(this,e,r)}async _handleIdentify(e){const{connection:t,stream:n}=e,r=AbortSignal.timeout(this.timeout);(0,pu.Wp)(1/0,r);try{var i;const e=null!==(i=this.peerId.publicKey)&&void 0!==i?i:new Uint8Array(0),o=await this.peerStore.get(this.peerId),s=this.addressManager.getAddresses().map((e=>e.decapsulateCode((0,og.a_)("p2p").code)));let a=o.peerRecordEnvelope;if(s.length>0&&null==a){const e=new uk({peerId:this.peerId,multiaddrs:s});a=(await sk.seal(e,this.peerId)).marshal().subarray()}let c=t.remoteAddr.bytes;gO.Iq.matches(t.remoteAddr)||(c=void 0);const l=hk(n).pb(CO);await l.write({protocolVersion:this.host.protocolVersion,agentVersion:this.host.agentVersion,publicKey:e,listenAddrs:s.map((e=>e.bytes)),signedPeerRecord:a,observedAddr:c,protocols:o.protocols},{signal:r}),await n.close({signal:r})}catch(o){this.log.error("could not respond to identify request",o),n.abort(o)}}async _handlePush(e){const{connection:t,stream:n}=e;try{var r;if(this.peerId.equals(t.remotePeer))throw new Error("received push from ourselves?");const e={signal:AbortSignal.timeout(this.timeout)},i=hk(n,{maxDataLength:null!==(r=this.maxIdentifyMessageSize)&&void 0!==r?r:TO}).pb(CO),o=await i.read(e);await n.close(e),await Xd(this,UO,KO).call(this,t,o)}catch(i){return this.log.error("received invalid message",i),void n.abort(i)}this.log("handled push from %p",t.remotePeer)}}async function KO(e,t){if(this.log("received identify from %p",e.remotePeer),null==t)throw new pu.sv("message was null or undefined","ERR_INVALID_MESSAGE");const n={};if(t.listenAddrs.length>0&&(n.addresses=t.listenAddrs.map((e=>({isCertified:!1,multiaddr:(0,og.HM)(e)})))),t.protocols.length>0&&(n.protocols=t.protocols),null!=t.publicKey){n.publicKey=t.publicKey;if(!(await pO(t.publicKey)).equals(e.remotePeer))throw new pu.sv("public key did not match remote PeerId","ERR_INVALID_PUBLIC_KEY")}let r;if(null!=t.signedPeerRecord){this.log("received signedPeerRecord from %p",e.remotePeer);let i=t.signedPeerRecord;const s=await sk.openAndCertify(i,uk.DOMAIN);let a,c=uk.createFromProtobuf(s.payload);if(!c.peerId.equals(s.peerId))throw new pu.sv("signing key does not match PeerId in the PeerRecord","ERR_INVALID_SIGNING_KEY");if(!e.remotePeer.equals(c.peerId))throw new pu.sv("signing key does not match remote PeerId","ERR_INVALID_PEER_RECORD_KEY");try{a=await this.peerStore.get(c.peerId)}catch(o){if("ERR_NOT_FOUND"!==o.code)throw o}if(null!=a&&(n.metadata=a.metadata,null!=a.peerRecordEnvelope)){const e=await sk.createFromProtobuf(a.peerRecordEnvelope),t=uk.createFromProtobuf(e.payload);t.seqNumber>=c.seqNumber&&(this.log("sequence number was lower or equal to existing sequence number - stored: %d received: %d",t.seqNumber,c.seqNumber),c=t,i=a.peerRecordEnvelope)}n.peerRecordEnvelope=i,n.addresses=c.multiaddrs.map((e=>({isCertified:!0,multiaddr:e}))),r={seq:c.seqNumber,addresses:c.multiaddrs}}else this.log("%p did not send a signed peer record",e.remotePeer);if(this.log("patching %p with",e.remotePeer,n),await this.peerStore.patch(e.remotePeer,n),null!=t.agentVersion||null!=t.protocolVersion){const n={};null!=t.agentVersion&&(n.AgentVersion=(0,mu.m)(t.agentVersion)),null!=t.protocolVersion&&(n.ProtocolVersion=(0,mu.m)(t.protocolVersion)),this.log("merging %p metadata",e.remotePeer,n),await this.peerStore.merge(e.remotePeer,{metadata:n})}const i={peerId:e.remotePeer,protocolVersion:t.protocolVersion,agentVersion:t.agentVersion,publicKey:t.publicKey,listenAddrs:t.listenAddrs.map((e=>(0,og.HM)(e))),observedAddr:null==t.observedAddr?void 0:(0,og.HM)(t.observedAddr),protocols:t.protocols,signedPeerRecord:r,connection:e};return this.events.safeDispatchEvent("peer:identify",{detail:i}),i}function jO(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return t=>new FO(t,e)}var ZO=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const zO=ZO,VO=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class HO{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class qO{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return WO(this,e)}}class GO{constructor(e){this.decoders=e}or(e){return WO(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const WO=(e,t)=>new GO({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class QO{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new HO(e,t,n),this.decoder=new qO(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const YO=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new QO(t,n,r,i)},JO=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=zO(r,n);return YO({prefix:t,name:n,encode:i,decode:e=>VO(o(e))})},XO=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return YO({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},$O=JO({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),eN=JO({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),tN=JO({prefix:"9",name:"base10",alphabet:"0123456789"}),nN=XO({prefix:"f",name:"base16",alphabet:"0123456789abcdef",bitsPerChar:4}),rN=XO({prefix:"F",name:"base16upper",alphabet:"0123456789ABCDEF",bitsPerChar:4}),iN=XO({prefix:"0",name:"base2",alphabet:"01",bitsPerChar:1}),oN=Array.from("\ud83d\ude80\ud83e\ude90\u2604\ud83d\udef0\ud83c\udf0c\ud83c\udf11\ud83c\udf12\ud83c\udf13\ud83c\udf14\ud83c\udf15\ud83c\udf16\ud83c\udf17\ud83c\udf18\ud83c\udf0d\ud83c\udf0f\ud83c\udf0e\ud83d\udc09\u2600\ud83d\udcbb\ud83d\udda5\ud83d\udcbe\ud83d\udcbf\ud83d\ude02\u2764\ud83d\ude0d\ud83e\udd23\ud83d\ude0a\ud83d\ude4f\ud83d\udc95\ud83d\ude2d\ud83d\ude18\ud83d\udc4d\ud83d\ude05\ud83d\udc4f\ud83d\ude01\ud83d\udd25\ud83e\udd70\ud83d\udc94\ud83d\udc96\ud83d\udc99\ud83d\ude22\ud83e\udd14\ud83d\ude06\ud83d\ude44\ud83d\udcaa\ud83d\ude09\u263a\ud83d\udc4c\ud83e\udd17\ud83d\udc9c\ud83d\ude14\ud83d\ude0e\ud83d\ude07\ud83c\udf39\ud83e\udd26\ud83c\udf89\ud83d\udc9e\u270c\u2728\ud83e\udd37\ud83d\ude31\ud83d\ude0c\ud83c\udf38\ud83d\ude4c\ud83d\ude0b\ud83d\udc97\ud83d\udc9a\ud83d\ude0f\ud83d\udc9b\ud83d\ude42\ud83d\udc93\ud83e\udd29\ud83d\ude04\ud83d\ude00\ud83d\udda4\ud83d\ude03\ud83d\udcaf\ud83d\ude48\ud83d\udc47\ud83c\udfb6\ud83d\ude12\ud83e\udd2d\u2763\ud83d\ude1c\ud83d\udc8b\ud83d\udc40\ud83d\ude2a\ud83d\ude11\ud83d\udca5\ud83d\ude4b\ud83d\ude1e\ud83d\ude29\ud83d\ude21\ud83e\udd2a\ud83d\udc4a\ud83e\udd73\ud83d\ude25\ud83e\udd24\ud83d\udc49\ud83d\udc83\ud83d\ude33\u270b\ud83d\ude1a\ud83d\ude1d\ud83d\ude34\ud83c\udf1f\ud83d\ude2c\ud83d\ude43\ud83c\udf40\ud83c\udf37\ud83d\ude3b\ud83d\ude13\u2b50\u2705\ud83e\udd7a\ud83c\udf08\ud83d\ude08\ud83e\udd18\ud83d\udca6\u2714\ud83d\ude23\ud83c\udfc3\ud83d\udc90\u2639\ud83c\udf8a\ud83d\udc98\ud83d\ude20\u261d\ud83d\ude15\ud83c\udf3a\ud83c\udf82\ud83c\udf3b\ud83d\ude10\ud83d\udd95\ud83d\udc9d\ud83d\ude4a\ud83d\ude39\ud83d\udde3\ud83d\udcab\ud83d\udc80\ud83d\udc51\ud83c\udfb5\ud83e\udd1e\ud83d\ude1b\ud83d\udd34\ud83d\ude24\ud83c\udf3c\ud83d\ude2b\u26bd\ud83e\udd19\u2615\ud83c\udfc6\ud83e\udd2b\ud83d\udc48\ud83d\ude2e\ud83d\ude46\ud83c\udf7b\ud83c\udf43\ud83d\udc36\ud83d\udc81\ud83d\ude32\ud83c\udf3f\ud83e\udde1\ud83c\udf81\u26a1\ud83c\udf1e\ud83c\udf88\u274c\u270a\ud83d\udc4b\ud83d\ude30\ud83e\udd28\ud83d\ude36\ud83e\udd1d\ud83d\udeb6\ud83d\udcb0\ud83c\udf53\ud83d\udca2\ud83e\udd1f\ud83d\ude41\ud83d\udea8\ud83d\udca8\ud83e\udd2c\u2708\ud83c\udf80\ud83c\udf7a\ud83e\udd13\ud83d\ude19\ud83d\udc9f\ud83c\udf31\ud83d\ude16\ud83d\udc76\ud83e\udd74\u25b6\u27a1\u2753\ud83d\udc8e\ud83d\udcb8\u2b07\ud83d\ude28\ud83c\udf1a\ud83e\udd8b\ud83d\ude37\ud83d\udd7a\u26a0\ud83d\ude45\ud83d\ude1f\ud83d\ude35\ud83d\udc4e\ud83e\udd32\ud83e\udd20\ud83e\udd27\ud83d\udccc\ud83d\udd35\ud83d\udc85\ud83e\uddd0\ud83d\udc3e\ud83c\udf52\ud83d\ude17\ud83e\udd11\ud83c\udf0a\ud83e\udd2f\ud83d\udc37\u260e\ud83d\udca7\ud83d\ude2f\ud83d\udc86\ud83d\udc46\ud83c\udfa4\ud83d\ude47\ud83c\udf51\u2744\ud83c\udf34\ud83d\udca3\ud83d\udc38\ud83d\udc8c\ud83d\udccd\ud83e\udd40\ud83e\udd22\ud83d\udc45\ud83d\udca1\ud83d\udca9\ud83d\udc50\ud83d\udcf8\ud83d\udc7b\ud83e\udd10\ud83e\udd2e\ud83c\udfbc\ud83e\udd75\ud83d\udea9\ud83c\udf4e\ud83c\udf4a\ud83d\udc7c\ud83d\udc8d\ud83d\udce3\ud83e\udd42"),sN=oN.reduce(((e,t,n)=>(e[n]=t,e)),[]),aN=oN.reduce(((e,t,n)=>(e[t.codePointAt(0)]=n,e)),[]);const cN=YO({prefix:"\ud83d\ude80",name:"base256emoji",encode:function(e){return e.reduce(((e,t)=>e+=sN[t]),"")},decode:function(e){const t=[];for(const n of e){const e=aN[n.codePointAt(0)];if(void 0===e)throw new Error("Non-base256emoji character: ".concat(n));t.push(e)}return new Uint8Array(t)}}),lN=XO({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),uN=XO({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),hN=XO({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),dN=XO({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),fN=XO({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),pN=XO({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),gN=XO({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),yN=XO({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),mN=XO({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),vN=JO({prefix:"k",name:"base36",alphabet:"0123456789abcdefghijklmnopqrstuvwxyz"}),bN=JO({prefix:"K",name:"base36upper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ"}),wN=XO({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),EN=XO({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),AN=XO({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),SN=XO({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),_N=XO({prefix:"7",name:"base8",alphabet:"01234567",bitsPerChar:3}),IN=YO({prefix:"\0",name:"identity",encode:e=>{return t=e,(new TextDecoder).decode(t);var t},decode:e=>(e=>(new TextEncoder).encode(e))(e)}),CN=new TextEncoder,TN=new TextDecoder,kN="json",RN=512,xN=e=>CN.encode(JSON.stringify(e)),PN=e=>JSON.parse(TN.decode(e)),DN="raw",ON=85,NN=e=>VO(e),BN=e=>VO(e);var LN=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=FN;)n[r++]=255&t|MN,t/=128;for(;t&UN;)n[r++]=255&t|MN,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},MN=128,UN=-128,FN=Math.pow(2,31);var KN=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&ZN)<<o:(r&ZN)*Math.pow(2,o),o+=7}while(r>=jN);return e.bytes=s-n,i},jN=128,ZN=127;var zN=Math.pow(2,7),VN=Math.pow(2,14),HN=Math.pow(2,21),qN=Math.pow(2,28),GN=Math.pow(2,35),WN=Math.pow(2,42),QN=Math.pow(2,49),YN=Math.pow(2,56),JN=Math.pow(2,63);const XN={encode:LN,decode:KN,encodingLength:function(e){return e<zN?1:e<VN?2:e<HN?3:e<qN?4:e<GN?5:e<WN?6:e<QN?7:e<YN?8:e<JN?9:10}},$N=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[XN.decode(e,t),XN.decode.bytes]},eB=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return XN.encode(e,t,n),t},tB=e=>XN.encodingLength(e),nB=(e,t)=>{const n=t.byteLength,r=tB(e),i=r+tB(n),o=new Uint8Array(i+n);return eB(e,o,0),eB(n,o,r),o.set(t,i),new iB(e,n,t,o)},rB=e=>{const t=VO(e),[n,r]=$N(t),[i,o]=$N(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new iB(n,i,s,t)};class iB{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const oB=VO,sB={code:0,name:"identity",encode:oB,digest:e=>nB(0,oB(e))},aB=e=>{let{name:t,code:n,encode:r}=e;return new cB(t,n,r)};class cB{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?nB(this.code,t):t.then((e=>nB(this.code,e)))}throw Error("Unknown type, must be binary type")}}const lB=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),uB=aB({name:"sha2-256",code:18,encode:lB("SHA-256")}),hB=aB({name:"sha2-512",code:19,encode:lB("SHA-512")}),dB=(e,t)=>{const{bytes:n,version:r}=e;return 0===r?mB(n,pB(e),t||$O.encoder):vB(n,pB(e),t||lN.encoder)},fB=new WeakMap,pB=e=>{const t=fB.get(e);if(null==t){const t=new Map;return fB.set(e,t),t}return t};class gB{constructor(e,t,n,r){this.code=t,this.version=e,this.multihash=n,this.bytes=r,this["/"]=r}get asCID(){return this}get byteOffset(){return this.bytes.byteOffset}get byteLength(){return this.bytes.byteLength}toV0(){switch(this.version){case 0:return this;case 1:{const{code:e,multihash:t}=this;if(e!==bB)throw new Error("Cannot convert a non dag-pb CID to CIDv0");if(t.code!==wB)throw new Error("Cannot convert non sha2-256 multihash CID to CIDv0");return gB.createV0(t)}default:throw Error("Can not convert CID version ".concat(this.version," to version 0. This is a bug please report"))}}toV1(){switch(this.version){case 0:{const{code:e,digest:t}=this.multihash,n=nB(e,t);return gB.createV1(this.code,n)}case 1:return this;default:throw Error("Can not convert CID version ".concat(this.version," to version 1. This is a bug please report"))}}equals(e){return gB.equals(this,e)}static equals(e,t){const n=t;return n&&e.code===n.code&&e.version===n.version&&((e,t)=>{if(e===t)return!0;{const n=t;return e.code===n.code&&e.size===n.size&&n.bytes instanceof Uint8Array&&((e,t)=>{if(e===t)return!0;if(e.byteLength!==t.byteLength)return!1;for(let n=0;n<e.byteLength;n++)if(e[n]!==t[n])return!1;return!0})(e.bytes,n.bytes)}})(e.multihash,n.multihash)}toString(e){return dB(this,e)}toJSON(){return{"/":dB(this)}}link(){return this}get[Symbol.toStringTag](){return"CID"}[Symbol.for("nodejs.util.inspect.custom")](){return"CID(".concat(this.toString(),")")}static asCID(e){if(null==e)return null;const t=e;if(t instanceof gB)return t;if(null!=t["/"]&&t["/"]===t.bytes||t.asCID===t){const{version:e,code:n,multihash:r,bytes:i}=t;return new gB(e,n,r,i||EB(e,n,r.bytes))}if(!0===t[AB]){const{version:e,multihash:n,code:r}=t,i=rB(n);return gB.create(e,r,i)}return null}static create(e,t,n){if("number"!==typeof t)throw new Error("String codecs are no longer supported");if(!(n.bytes instanceof Uint8Array))throw new Error("Invalid digest");switch(e){case 0:if(t!==bB)throw new Error("Version 0 CID must use dag-pb (code: ".concat(bB,") block encoding"));return new gB(e,t,n,n.bytes);case 1:{const r=EB(e,t,n.bytes);return new gB(e,t,n,r)}default:throw new Error("Invalid version")}}static createV0(e){return gB.create(0,bB,e)}static createV1(e,t){return gB.create(1,e,t)}static decode(e){const[t,n]=gB.decodeFirst(e);if(n.length)throw new Error("Incorrect length");return t}static decodeFirst(e){const t=gB.inspectBytes(e),n=t.size-t.multihashSize,r=VO(e.subarray(n,n+t.multihashSize));if(r.byteLength!==t.multihashSize)throw new Error("Incorrect length");const i=r.subarray(t.multihashSize-t.digestSize),o=new iB(t.multihashCode,t.digestSize,i,r);return[0===t.version?gB.createV0(o):gB.createV1(t.codec,o),e.subarray(t.size)]}static inspectBytes(e){let t=0;const n=()=>{const[n,r]=$N(e.subarray(t));return t+=r,n};let r=n(),i=bB;if(18===r?(r=0,t=0):i=n(),0!==r&&1!==r)throw new RangeError("Invalid CID version ".concat(r));const o=t,s=n(),a=n(),c=t+a;return{version:r,codec:i,multihashCode:s,digestSize:a,multihashSize:c-o,size:c}}static parse(e,t){const[n,r]=yB(e,t),i=gB.decode(r);if(0===i.version&&"Q"!==e[0])throw Error("Version 0 CID string must not include multibase prefix");return pB(i).set(n,e),i}}const yB=(e,t)=>{switch(e[0]){case"Q":{const n=t||$O;return[$O.prefix,n.decode("".concat($O.prefix).concat(e))]}case $O.prefix:{const n=t||$O;return[$O.prefix,n.decode(e)]}case lN.prefix:{const n=t||lN;return[lN.prefix,n.decode(e)]}default:if(null==t)throw Error("To parse non base32 or base58btc encoded CID multibase decoder must be provided");return[e[0],t.decode(e)]}},mB=(e,t,n)=>{const{prefix:r}=n;if(r!==$O.prefix)throw Error("Cannot string encode V0 in ".concat(n.name," encoding"));const i=t.get(r);if(null==i){const i=n.encode(e).slice(1);return t.set(r,i),i}return i},vB=(e,t,n)=>{const{prefix:r}=n,i=t.get(r);if(null==i){const i=n.encode(e);return t.set(r,i),i}return i},bB=112,wB=18,EB=(e,t,n)=>{const r=tB(e),i=r+tB(t),o=new Uint8Array(i+n.byteLength);return eB(e,o,0),eB(t,o,r),o.set(n,i),o},AB=Symbol.for("@ipld/js-cid/CID"),SB={...gt,...lt,...pt,...at,...ct,...ht,...dt,...st,...ft,...ut};let _B;const IB=Symbol.for("nodejs.util.inspect.custom"),CB=Object.values(SB).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),SB.identity.decoder),TB=114,kB=36,RB=37;_B=Symbol.toStringTag;class xB{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,pu.Cs,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[_B](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=$O.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return gB.createV1(TB,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return NB(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[IB](){return"PeerId(".concat(this.toString(),")")}}class PB extends xB{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class DB extends xB{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class OB extends xB{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}function NB(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:CB,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=rB($O.decode("z".concat(e)));return e.startsWith("12D")?new DB({multihash:t}):e.startsWith("16U")?new OB({multihash:t}):new PB({multihash:t})}return function(e){try{const t=rB(e);if(t.code===sB.code){if(t.digest.length===kB)return new DB({multihash:t});if(t.digest.length===RB)return new OB({multihash:t})}if(t.code===uB.code)return new PB({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==TB)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===uB.code)return new PB({multihash:e.multihash});if(t.code===sB.code){if(t.digest.length===kB)return new DB({multihash:e.multihash});if(t.digest.length===RB)return new OB({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(gB.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(CB.decode(e))}var BB;!function(e){e.ERR_ALREADY_ABORTED="ERR_ALREADY_ABORTED",e.ERR_DATA_CHANNEL="ERR_DATA_CHANNEL",e.ERR_CONNECTION_CLOSED="ERR_CONNECTION_CLOSED",e.ERR_HASH_NOT_SUPPORTED="ERR_HASH_NOT_SUPPORTED",e.ERR_INVALID_MULTIADDR="ERR_INVALID_MULTIADDR",e.ERR_INVALID_FINGERPRINT="ERR_INVALID_FINGERPRINT",e.ERR_INVALID_PARAMETERS="ERR_INVALID_PARAMETERS",e.ERR_NOT_IMPLEMENTED="ERR_NOT_IMPLEMENTED",e.ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_INBOUND_PROTOCOL_STREAMS",e.ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS="ERR_TOO_MANY_OUTBOUND_PROTOCOL_STREAMS"}(BB||(BB={}));class LB extends pu.sv{constructor(e,t){super("WebRTC transport error: ".concat(e),null!==t&&void 0!==t?t:""),this.name="WebRTCTransportError"}}class MB extends LB{constructor(e,t){super("[stream: ".concat(e,"] data channel error: ").concat(t),BB.ERR_DATA_CHANNEL),this.name="WebRTC/DataChannelError"}}function UB(e,t){return new MB(e,t)}class FB extends LB{constructor(e){super("There was a problem with the Multiaddr which was passed in: ".concat(e),BB.ERR_INVALID_MULTIADDR),this.name="WebRTC/InappropriateMultiaddrError"}}function KB(e){return new FB(e)}class jB extends LB{constructor(e){super("There was a problem with a provided argument: ".concat(e),BB.ERR_INVALID_PARAMETERS),this.name="WebRTC/InvalidArgumentError"}}function ZB(e){return new jB(e)}class zB extends LB{constructor(e,t){super('Invalid fingerprint "'.concat(e,'" within ').concat(t),BB.ERR_INVALID_FINGERPRINT),this.name="WebRTC/InvalidFingerprintError"}}function VB(e,t){return new zB(e,t)}class HB extends LB{constructor(e){super("A method (".concat(e,") was called though it has been intentionally left unimplemented."),BB.ERR_NOT_IMPLEMENTED),this.name="WebRTC/UnimplementedError"}}class qB extends LB{constructor(e){super("unsupported hash algorithm: ".concat(e),BB.ERR_HASH_NOT_SUPPORTED),this.name="WebRTC/UnsupportedHashAlgorithmError"}}var GB=n(1426),WB=function(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))},QB=function(e,t,n){this.name=e,this.version=t,this.os=n,this.type="browser"},YB=function(e){this.version=e,this.type="node",this.name="node",this.os=GB.platform},JB=function(e,t,n,r){this.name=e,this.version=t,this.os=n,this.bot=r,this.type="bot-device"},XB=function(){this.type="bot",this.bot=!0,this.name="bot",this.version=null,this.os=null},$B=function(){this.type="react-native",this.name="react-native",this.version=null,this.os=null},eL=/(nuhk|curl|Googlebot|Yammybot|Openbot|Slurp|MSNBot|Ask\ Jeeves\/Teoma|ia_archiver)/,tL=3,nL=[["aol",/AOLShield\/([0-9\._]+)/],["edge",/Edge\/([0-9\._]+)/],["edge-ios",/EdgiOS\/([0-9\._]+)/],["yandexbrowser",/YaBrowser\/([0-9\._]+)/],["kakaotalk",/KAKAOTALK\s([0-9\.]+)/],["samsung",/SamsungBrowser\/([0-9\.]+)/],["silk",/\bSilk\/([0-9._-]+)\b/],["miui",/MiuiBrowser\/([0-9\.]+)$/],["beaker",/BeakerBrowser\/([0-9\.]+)/],["edge-chromium",/EdgA?\/([0-9\.]+)/],["chromium-webview",/(?!Chrom.*OPR)wv\).*Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["chrome",/(?!Chrom.*OPR)Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["phantomjs",/PhantomJS\/([0-9\.]+)(:?\s|$)/],["crios",/CriOS\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["fxios",/FxiOS\/([0-9\.]+)/],["opera-mini",/Opera Mini.*Version\/([0-9\.]+)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["opera",/OPR\/([0-9\.]+)(:?\s|$)/],["pie",/^Microsoft Pocket Internet Explorer\/(\d+\.\d+)$/],["pie",/^Mozilla\/\d\.\d+\s\(compatible;\s(?:MSP?IE|MSInternet Explorer) (\d+\.\d+);.*Windows CE.*\)$/],["netfront",/^Mozilla\/\d\.\d+.*NetFront\/(\d.\d)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+).*\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/Version\/([0-9\._]+).*Mobile.*Safari.*/],["safari",/Version\/([0-9\._]+).*Safari/],["facebook",/FB[AS]V\/([0-9\.]+)/],["instagram",/Instagram\s([0-9\.]+)/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Mobile/],["ios-webview",/AppleWebKit\/([0-9\.]+).*Gecko\)$/],["curl",/^curl\/([0-9\.]+)$/],["searchbot",/alexa|bot|crawl(er|ing)|facebookexternalhit|feedburner|google web preview|nagios|postrank|pingdom|slurp|spider|yahoo!|yandex/]],rL=[["iOS",/iP(hone|od|ad)/],["Android OS",/Android/],["BlackBerry OS",/BlackBerry|BB10/],["Windows Mobile",/IEMobile/],["Amazon OS",/Kindle/],["Windows 3.11",/Win16/],["Windows 95",/(Windows 95)|(Win95)|(Windows_95)/],["Windows 98",/(Windows 98)|(Win98)/],["Windows 2000",/(Windows NT 5.0)|(Windows 2000)/],["Windows XP",/(Windows NT 5.1)|(Windows XP)/],["Windows Server 2003",/(Windows NT 5.2)/],["Windows Vista",/(Windows NT 6.0)/],["Windows 7",/(Windows NT 6.1)/],["Windows 8",/(Windows NT 6.2)/],["Windows 8.1",/(Windows NT 6.3)/],["Windows 10",/(Windows NT 10.0)/],["Windows ME",/Windows ME/],["Windows CE",/Windows CE|WinCE|Microsoft Pocket Internet Explorer/],["Open BSD",/OpenBSD/],["Sun OS",/SunOS/],["Chrome OS",/CrOS/],["Linux",/(Linux)|(X11)/],["Mac OS",/(Mac_PowerPC)|(Macintosh)/],["QNX",/QNX/],["BeOS",/BeOS/],["OS/2",/OS\/2/]];function iL(e){return e?sL(e):"undefined"===typeof document&&"undefined"!==typeof navigator&&"ReactNative"===navigator.product?new $B:"undefined"!==typeof navigator?sL(navigator.userAgent):function(){var e="undefined"!==typeof GB&&GB.version;return e?new YB(GB.version.slice(1)):null}()}function oL(e){return""!==e&&nL.reduce((function(t,n){var r=n[0],i=n[1];if(t)return t;var o=i.exec(e);return!!o&&[r,o]}),!1)}function sL(e){var t=oL(e);if(!t)return null;var n=t[0],r=t[1];if("searchbot"===n)return new XB;var i=r[1]&&r[1].split(".").join("_").split("_").slice(0,3);i?i.length<tL&&(i=WB(WB([],i,!0),function(e){for(var t=[],n=0;n<e;n++)t.push("0");return t}(tL-i.length),!0)):i=[];var o=i.join("."),s=function(e){for(var t=0,n=rL.length;t<n;t++){var r=rL[t],i=r[0];if(r[1].exec(e))return i}return null}(e),a=eL.exec(e);return a&&a[1]?new JB(n,o,s,a[1]):new QB(n,o,s)}class aL extends Error{constructor(e){super(e),this.name="TimeoutError"}}class cL extends Error{constructor(e){super(),this.name="AbortError",this.message=e}}const lL=e=>void 0===globalThis.DOMException?new cL(e):new DOMException(e),uL=e=>{const t=void 0===e.reason?lL("This operation was aborted."):e.reason;return t instanceof Error?t:lL(t)};function hL(e,t){const{milliseconds:n,fallback:r,message:i,customTimers:o={setTimeout:setTimeout,clearTimeout:clearTimeout}}=t;let s;const a=new Promise(((a,c)=>{if("number"!==typeof n||1!==Math.sign(n))throw new TypeError("Expected `milliseconds` to be a positive number, got `".concat(n,"`"));if(t.signal){const{signal:e}=t;e.aborted&&c(uL(e)),e.addEventListener("abort",(()=>{c(uL(e))}))}if(n===Number.POSITIVE_INFINITY)return void e.then(a,c);const l=new aL;s=o.setTimeout.call(void 0,(()=>{if(r)try{a(r())}catch(t){c(t)}else"function"===typeof e.cancel&&e.cancel(),!1===i?a():i instanceof Error?c(i):(l.message=null!==i&&void 0!==i?i:"Promise timed out after ".concat(n," milliseconds"),c(l))}),n),(async()=>{try{a(await e)}catch(t){c(t)}})()})).finally((()=>{a.clear()}));return a.clear=()=>{o.clearTimeout.call(void 0,s),s=void 0},a}const dL=iL(),fL=null!=dL&&"firefox"===dL.name,pL=async function*(){},gL=async e=>{},yL=3e4;class mL{constructor(e,t){(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"peerConnection",void 0),(0,Yo.Z)(this,"remoteAddr",void 0),(0,Yo.Z)(this,"timeline",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"source",pL()),(0,Yo.Z)(this,"sink",gL),this.log=e.logger.forComponent("libp2p:webrtc:maconn"),this.remoteAddr=t.remoteAddr,this.timeline=t.timeline,this.peerConnection=t.peerConnection;const n=this.peerConnection.connectionState;this.peerConnection.onconnectionstatechange=()=>{this.log.trace("peer connection state change",this.peerConnection.connectionState,"initial state",n),"disconnected"!==this.peerConnection.connectionState&&"failed"!==this.peerConnection.connectionState&&"closed"!==this.peerConnection.connectionState||(this.timeline.close=Date.now())}}async close(e){var t;this.log.trace("closing connection"),this.peerConnection.close(),this.timeline.close=Date.now(),null===(t=this.metrics)||void 0===t||t.increment({close:!0})}abort(e){var t;this.log.error("closing connection due to error",e),this.peerConnection.close(),this.timeline.close=Date.now(),null===(t=this.metrics)||void 0===t||t.increment({abort:!0})}}function vL(e){return null!=e[Symbol.asyncIterator]}const bL=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),bL.bytes=t,n};function wL(e,t){var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:bL;function*o(e){const t=i(e.byteLength);t instanceof Uint8Array?yield t:yield*t,e instanceof Uint8Array?yield e:yield*e}return vL(e)?async function*(){for await(const t of e)yield*o(t)}():function*(){for(const t of e)yield*o(t)}()}bL.bytes=0,wL.single=(e,t)=>{var n,r;const i=null!==(r=(t=null!==(n=t)&&void 0!==n?n:{}).lengthEncoder)&&void 0!==r?r:bL;return new Zs(i(e.byteLength),e)};var EL;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(EL||(EL={}));const AL=e=>{const t=Bs.Jx(e);return AL.bytes=Bs.P$(t),t};function SL(e,t){var n,r,i;const o=new Zs;let s=EL.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:AL,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===EL.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=EL.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===EL.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=EL.LENGTH}}}return vL(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}AL.bytes=0,SL.fromReader=(e,t)=>{let n=1;return SL(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};class _L{constructor(e){if((0,Yo.Z)(this,"buffer",void 0),(0,Yo.Z)(this,"mask",void 0),(0,Yo.Z)(this,"top",void 0),(0,Yo.Z)(this,"btm",void 0),(0,Yo.Z)(this,"next",void 0),!(e>0)||0!==(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class IL{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"size",void 0),(0,Yo.Z)(this,"hwm",void 0),(0,Yo.Z)(this,"head",void 0),(0,Yo.Z)(this,"tail",void 0),this.hwm=null!==(e=t.splitLimit)&&void 0!==e?e:16,this.head=new _L(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}push(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new _L(2*this.head.buffer.length),this.head.push(e)}}shift(){var e;let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}class CL extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"code",void 0),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function TL(){return kL((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function kL(e,t){var n;let r,i,o,s=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,a=new IL,c=Ws();const l=e=>null!=i?i(e):(a.push(e),r),u=e=>{var n;if(o)return r;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},h=e=>o?r:(o=!0,null!=e?(e=>(a=new IL,null!=i?i({error:e}):(a.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return a.isEmpty()?o?{done:!0}:await new Promise(((t,n)=>{i=o=>{i=null,a.push(o);try{t(e(a))}catch(s){n(s)}return r}})):e(a)}finally{a.isEmpty()&&queueMicrotask((()=>{c.resolve(),c=Ws()}))}},return:()=>(a=new IL,h(),{done:!0}),throw:e=>(h(e),{done:!0}),push:u,end:h,get readableLength(){return a.size},onEmpty:async e=>{const t=null===e||void 0===e?void 0:e.signal;if(null===t||void 0===t||t.throwIfAborted(),a.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new CL)},t.addEventListener("abort",r)})));try{await Promise.race([c.promise,n])}finally{null!=r&&null!=t&&(null===t||void 0===t||t.removeEventListener("abort",r))}}},null==s)return r;const d=r;return r={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(d.return(),null!=s&&(s(),s=void 0),{done:!0}),push:u,end:e=>(d.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},r}const RL=e=>{const t=e.on||e.addListener||e.addEventListener,n=e.off||e.removeListener||e.removeEventListener;if(!t||!n)throw new TypeError("Emitter is not compatible");return{addListener:t.bind(e),removeListener:n.bind(e)}};function xL(e,t,n){"function"===typeof n&&(n={filter:n});const r=function(e,t,n){let r;const i=new Promise(((i,o)=>{var s;if(!((n={rejectionEvents:["error"],multiArgs:!1,resolveImmediately:!1,...n}).count>=0)||n.count!==Number.POSITIVE_INFINITY&&!Number.isInteger(n.count))throw new TypeError("The `count` option should be at least 0 or more");null===(s=n.signal)||void 0===s||s.throwIfAborted();const a=[t].flat(),c=[],{addListener:l,removeListener:u}=RL(e),h=function(){for(var e=arguments.length,t=new Array(e),o=0;o<e;o++)t[o]=arguments[o];const s=n.multiArgs?t:t[0];n.filter&&!n.filter(s)||(c.push(s),n.count===c.length&&(r(),i(c)))},d=e=>{r(),o(e)};r=()=>{for(const e of a)u(e,h);for(const e of n.rejectionEvents)u(e,d)};for(const e of a)l(e,h);for(const e of n.rejectionEvents)l(e,d);n.signal&&n.signal.addEventListener("abort",(()=>{d(n.signal.reason)}),{once:!0}),n.resolveImmediately&&i(c)}));if(i.cancel=r,"number"===typeof n.timeout){const e=hL(i,{milliseconds:n.timeout});return e.cancel=r,e}return i}(e,t,n={...n,count:1,resolveImmediately:!1}),i=r.then((e=>e[0]));return i.cancel=r.cancel,i}var PL;!function(e){let t,n,r;!function(e){e.FIN="FIN",e.STOP_SENDING="STOP_SENDING",e.RESET="RESET",e.FIN_ACK="FIN_ACK"}(t=e.Flag||(e.Flag={})),function(e){e[e.FIN=0]="FIN",e[e.STOP_SENDING=1]="STOP_SENDING",e[e.RESET=2]="RESET",e[e.FIN_ACK=3]="FIN_ACK"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Flag||(e.Flag={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.flag&&(n.uint32(8),e.Flag.codec().encode(t.flag,n)),null!=t.message&&(n.uint32(18),n.bytes(t.message)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.flag=e.Flag.codec().decode(t);break;case 2:r.message=t.bytes();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(PL||(PL={}));class DL extends Kd{constructor(e){var t,n,r,i,o;const s=e.onEnd;switch(e.onEnd=e=>{this.log.trace("readable and writeable ends closed",this.status),Promise.resolve((async()=>{if(null==this.timeline.abort&&null===this.timeline.reset)try{await hL(this.receiveFinAck.promise,{milliseconds:this.finAckTimeout})}catch(e){this.log.error("error receiving FIN_ACK",e)}})).then((()=>{this.incomingData.end(),null===s||void 0===s||s(e)})).catch((e=>{this.log.error("error ending stream",e)}))},super(e),(0,Yo.Z)(this,"channel",void 0),(0,Yo.Z)(this,"incomingData",void 0),(0,Yo.Z)(this,"maxBufferedAmount",void 0),(0,Yo.Z)(this,"bufferedAmountLowEventTimeout",void 0),(0,Yo.Z)(this,"maxMessageSize",void 0),(0,Yo.Z)(this,"receiveFinAck",void 0),(0,Yo.Z)(this,"finAckTimeout",void 0),(0,Yo.Z)(this,"openTimeout",void 0),this.channel=e.channel,this.channel.binaryType="arraybuffer",this.incomingData=TL(),this.bufferedAmountLowEventTimeout=null!==(t=e.bufferedAmountLowEventTimeout)&&void 0!==t?t:3e4,this.maxBufferedAmount=null!==(n=e.maxBufferedAmount)&&void 0!==n?n:16777216,this.maxMessageSize=(null!==(r=e.maxMessageSize)&&void 0!==r?r:16384)-5-2,this.receiveFinAck=Ws(),this.finAckTimeout=null!==(i=e.closeTimeout)&&void 0!==i?i:5e3,this.openTimeout=null!==(o=e.openTimeout)&&void 0!==o?o:5e3,this.channel.readyState){case"open":this.timeline.open=(new Date).getTime();break;case"closed":case"closing":void 0!==this.timeline.close&&0!==this.timeline.close||(this.timeline.close=Date.now());break;case"connecting":break;default:throw this.log.error("unknown datachannel state %s",this.channel.readyState),new pu.sv("Unknown datachannel state","ERR_INVALID_STATE")}this.channel.onopen=e=>{this.timeline.open=(new Date).getTime()},this.channel.onclose=e=>{this.receiveFinAck.resolve(),this.close().catch((e=>{this.log.error("error closing stream after channel closed",e)}))},this.channel.onerror=e=>{const t=e.error;this.abort(t)},this.channel.onmessage=async e=>{const{data:t}=e;null!==t&&0!==t.byteLength&&this.incomingData.push(new Uint8Array(t,0,t.byteLength))};const a=this;Promise.resolve().then((async()=>{for await(const e of SL(this.incomingData)){const t=a.processIncomingProtobuf(e);null!=t&&a.sourcePush(new Zs(t))}})).catch((e=>{this.log.error("error processing incoming data channel messages",e)}))}sendNewStream(){}async _sendMessage(e){if((!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&this.channel.bufferedAmount>this.maxBufferedAmount)try{this.log('channel buffer is %d, wait for "bufferedamountlow" event',this.channel.bufferedAmount),await xL(this.channel,"bufferedamountlow",{timeout:this.bufferedAmountLowEventTimeout})}catch(t){if(t instanceof aL)throw new pu.sv("Timed out waiting for DataChannel buffer to clear after ".concat(this.bufferedAmountLowEventTimeout,"ms"),"ERR_BUFFER_CLEAR_TIMEOUT");throw t}if("closed"===this.channel.readyState||"closing"===this.channel.readyState)throw new pu.sv("Invalid datachannel state - ".concat(this.channel.readyState),"ERR_INVALID_STATE");"open"!==this.channel.readyState&&(this.log('channel state is "%s" and not "open", waiting for "open" event before sending data',this.channel.readyState),await xL(this.channel,"open",{timeout:this.openTimeout}),this.log('channel state is now "%s", sending data',this.channel.readyState)),this.channel.send(e.subarray())}async sendData(e){for(e=e.sublist();e.byteLength>0;){const t=Math.min(e.byteLength,this.maxMessageSize),n=e.subarray(0,t),r=PL.encode({message:n}),i=wL.single(r);await this._sendMessage(i),e.consume(t)}}async sendReset(){await this._sendFlag(PL.Flag.RESET)}async sendCloseWrite(e){if(await this._sendFlag(PL.Flag.FIN)){this.log.trace("awaiting FIN_ACK");try{await Ys(this.receiveFinAck.promise,null===e||void 0===e?void 0:e.signal,{errorMessage:"sending close-write was aborted before FIN_ACK was received",errorCode:"ERR_FIN_ACK_NOT_RECEIVED"})}catch(t){this.log.error("failed to await FIN_ACK",t)}}else this.log.trace("sending FIN failed, not awaiting FIN_ACK");this.receiveFinAck.resolve()}async sendCloseRead(){await this._sendFlag(PL.Flag.STOP_SENDING)}processIncomingProtobuf(e){const t=PL.decode(e);if(void 0!==t.flag&&(this.log.trace('incoming flag %s, write status "%s", read status "%s"',t.flag,this.writeStatus,this.readStatus),t.flag===PL.Flag.FIN&&(this.remoteCloseWrite(),this.log.trace("sending FIN_ACK"),this._sendFlag(PL.Flag.FIN_ACK).catch((e=>{this.log.error("error sending FIN_ACK immediately",e)}))),t.flag===PL.Flag.RESET&&this.reset(),t.flag===PL.Flag.STOP_SENDING&&this.remoteCloseRead(),t.flag===PL.Flag.FIN_ACK&&(this.log.trace("received FIN_ACK"),this.receiveFinAck.resolve())),"ready"===this.readStatus)return t.message}async _sendFlag(e){if("open"!==this.channel.readyState)return this.log.trace('not sending flag %s because channel is "%s" and not "open"',this.channel.readyState,e.toString()),!1;this.log.trace("sending flag %s",e.toString());const t=PL.encode({flag:e}),n=wL.single(t);try{return await this._sendMessage(n,!1),!0}catch(r){this.log.error("could not send flag %s",e.toString(),r)}return!1}}function OL(e){const{channel:t,direction:n}=e;return new DL({id:"inbound"===n?"i".concat(t.id):"r".concat(t.id),log:e.logger.forComponent("libp2p:webrtc:stream:".concat(n,":").concat(t.id)),...e})}const NL="/webrtc";class BL{constructor(e,t){var n,r;(0,Yo.Z)(this,"protocol",void 0),(0,Yo.Z)(this,"peerConnection",void 0),(0,Yo.Z)(this,"bufferedStreams",[]),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"dataChannelOptions",void 0),(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"log",void 0),this.components=e,this.peerConnection=t.peerConnection,this.metrics=t.metrics,this.protocol=null!==(n=t.protocol)&&void 0!==n?n:NL,this.dataChannelOptions=null!==(r=t.dataChannelOptions)&&void 0!==r?r:{},this.log=e.logger.forComponent("libp2p:webrtc:datachannelmuxerfactory"),this.peerConnection.ondatachannel=t=>{let{channel:n}=t;if(this.log.trace('incoming early datachannel with channel id %d and label "%s"',n.id),"init"===n.label)return this.log.trace("closing early init channel"),void n.close();const r={},i=OL({channel:n,direction:"inbound",onEnd:e=>{r.onEnd(e)},logger:e.logger,...this.dataChannelOptions});r.stream=i,r.channel=n,r.onEnd=()=>{this.bufferedStreams=this.bufferedStreams.filter((e=>e.stream.id!==i.id))},this.bufferedStreams.push(r)}}createStreamMuxer(e){return new ML(this.components,{...e,peerConnection:this.peerConnection,dataChannelOptions:this.dataChannelOptions,metrics:this.metrics,streams:this.bufferedStreams,protocol:this.protocol})}}var LL=new WeakSet;class ML{constructor(e,t){var n,r;Jd(this,LL),(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,"streams",void 0),(0,Yo.Z)(this,"protocol",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"peerConnection",void 0),(0,Yo.Z)(this,"dataChannelOptions",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"logger",void 0),(0,Yo.Z)(this,"source",pL()),(0,Yo.Z)(this,"sink",gL),this.init=t,this.log=e.logger.forComponent("libp2p:webrtc:muxer"),this.logger=e.logger,this.streams=t.streams.map((e=>e.stream)),this.peerConnection=t.peerConnection,this.protocol=null!==(n=t.protocol)&&void 0!==n?n:NL,this.metrics=t.metrics,this.dataChannelOptions=null!==(r=t.dataChannelOptions)&&void 0!==r?r:{},this.peerConnection.ondatachannel=e=>{var n,r;let{channel:i}=e;if(this.log.trace("incoming datachannel with channel id %d",i.id),"init"===i.label)return this.log.trace("closing init channel"),void i.close();const o=OL({channel:i,direction:"inbound",onEnd:()=>{this.log("incoming channel %s ended with state %s",i.id,i.readyState),Xd(this,LL,UL).call(this,o,i)},logger:this.logger,...this.dataChannelOptions});this.streams.push(o),null===(n=this.metrics)||void 0===n||n.increment({incoming_stream:!0}),null===t||void 0===t||null===(r=t.onIncomingStream)||void 0===r||r.call(t,o)},this.init.streams.length>0&&queueMicrotask((()=>{this.init.streams.forEach((e=>{var t,n,r;e.onEnd=()=>{this.log("incoming early channel %s ended with state %s",e.channel.id,e.channel.readyState),Xd(this,LL,UL).call(this,e.stream,e.channel)},null===(t=this.metrics)||void 0===t||t.increment({incoming_stream:!0}),null===(n=this.init)||void 0===n||null===(r=n.onIncomingStream)||void 0===r||r.call(n,e.stream)}))}))}async close(e){try{await Promise.all(this.streams.map((async t=>t.close(e))))}catch(t){this.abort(t)}}abort(e){for(const t of this.streams)t.abort(e)}newStream(){var e;const t=this.peerConnection.createDataChannel("");this.log.trace("opened outgoing datachannel with channel id %s",t.id);const n=OL({channel:t,direction:"outbound",onEnd:()=>{this.log("outgoing channel %s ended with state %s",t.id,t.readyState),Xd(this,LL,UL).call(this,n,t)},logger:this.logger,...this.dataChannelOptions});return this.streams.push(n),null===(e=this.metrics)||void 0===e||e.increment({outgoing_stream:!0}),n}}function UL(e,t){var n,r,i;this.log.trace("stream %s %s %s onEnd",e.direction,e.id,e.protocol),function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:yL,r=arguments.length>3?arguments[3]:void 0;"open"===e.readyState&&Promise.resolve().then((async()=>{if(e.bufferedAmount>0){r.log("%s drain channel with %d buffered bytes",t,e.bufferedAmount);const i=Ws();let o=!1;e.bufferedAmountLowThreshold=0;const s=()=>{o||(r.log("%s drain channel closed before drain",t),i.resolve())};e.addEventListener("close",s,{once:!0}),e.addEventListener("bufferedamountlow",(()=>{o=!0,e.removeEventListener("close",s),i.resolve()})),await hL(i.promise,{milliseconds:n})}})).then((async()=>{"open"===e.readyState&&e.close()})).catch((e=>{r.log.error("error closing outbound stream",e)}))}(t,"".concat(e.direction," ").concat(e.id," ").concat(e.protocol),this.dataChannelOptions.drainTimeout,{log:this.log}),this.streams=this.streams.filter((t=>t.id!==e.id)),null===(n=this.metrics)||void 0===n||n.increment({stream_end:!0}),null===(r=this.init)||void 0===r||null===(i=r.onStreamEnd)||void 0===i||i.call(r,e)}const FL=globalThis.RTCPeerConnection,KL=globalThis.RTCSessionDescription,jL=globalThis.RTCIceCandidate;var ZL;!function(e){let t,n,r;!function(e){e.SDP_OFFER="SDP_OFFER",e.SDP_ANSWER="SDP_ANSWER",e.ICE_CANDIDATE="ICE_CANDIDATE"}(t=e.Type||(e.Type={})),function(e){e[e.SDP_OFFER=0]="SDP_OFFER",e[e.SDP_ANSWER=1]="SDP_ANSWER",e[e.ICE_CANDIDATE=2]="ICE_CANDIDATE"}(n||(n={})),function(e){e.codec=()=>bs(n)}(t=e.Type||(e.Type={})),e.codec=()=>(null==r&&(r=ws((function(t,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==r.lengthDelimited&&n.fork(),null!=t.type&&(n.uint32(8),e.Type.codec().encode(t.type,n)),null!=t.data&&(n.uint32(18),n.string(t.data)),!1!==r.lengthDelimited&&n.ldelim()}),((t,n)=>{const r={},i=null==n?t.len:t.pos+n;for(;t.pos<i;){const n=t.uint32();switch(n>>>3){case 1:r.type=e.Type.codec().decode(t);break;case 2:r.data=t.string();break;default:t.skipType(7&n)}}return r}))),r),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(ZL||(ZL={}));const zL=async(e,t,n,r)=>{const i=new AbortController;e.promise.then((()=>{i.abort()}),(()=>{i.abort()}));const o=function(e){const t=new globalThis.AbortController;function n(){t.abort();for(const t of e)null!=(null===t||void 0===t?void 0:t.removeEventListener)&&t.removeEventListener("abort",n)}for(const i of e){if(!0===(null===i||void 0===i?void 0:i.aborted)){n();break}null!=(null===i||void 0===i?void 0:i.addEventListener)&&i.addEventListener("abort",n)}const r=t.signal;return r.clear=function(){for(const t of e)null!=(null===t||void 0===t?void 0:t.removeEventListener)&&t.removeEventListener("abort",n)},r}([i.signal,r.signal]),s=()=>{Ud(n.unwrap().unwrap().source,r.log)};o.addEventListener("abort",s);try{for(;;){var a;const i=await Promise.race([e.promise,n.read()]);if(null==i)break;if(i.type!==ZL.Type.ICE_CANDIDATE)throw new pu.sv("ICE candidate message expected","ERR_NOT_ICE_CANDIDATE");const o=JSON.parse(null!==(a=i.data)&&void 0!==a?a:"null");if(""===o||null===o){r.log.trace("end-of-candidates received");continue}const s=new jL(o);r.log.trace("%s received new ICE candidate",r.direction,s);try{await t.addIceCandidate(s)}catch(c){r.log.error("%s bad candidate received",r.direction,o,c)}}}catch(c){r.log.error("%s error parsing ICE candidate",r.direction,c)}finally{o.removeEventListener("abort",s),o.clear()}};function VL(e,t){e[fL?"oniceconnectionstatechange":"onconnectionstatechange"]=n=>{switch(fL?e.iceConnectionState:e.connectionState){case"connected":t.resolve();break;case"failed":case"disconnected":case"closed":t.reject(new pu.sv("RTCPeerConnection was closed","ERR_CONNECTION_CLOSED_BEFORE_CONNECTED"))}}}async function HL(e){let{peerConnection:t,signal:n,metrics:r,multiaddr:i,connectionManager:o,transportManager:s,log:a}=e;const{baseAddr:c}=function(e){const t=e.toString().split(WL+"/");if(2!==t.length)throw new pu.sv("webrtc protocol was not present in multiaddr",BB.ERR_INVALID_MULTIADDR);if(!t[0].includes(QL))throw new pu.sv("p2p-circuit protocol was not present in multiaddr",BB.ERR_INVALID_MULTIADDR);let n=(0,og.HM)(t[0]);const r=(0,og.HM)("/"+t[1]).getPeerId();if(null==r)throw new pu.sv("destination peer id was missing",BB.ERR_INVALID_MULTIADDR);const i=n.protos().pop();if(void 0===i)throw new pu.sv("invalid multiaddr",BB.ERR_INVALID_MULTIADDR);"p2p"!==i.name&&(n=n.encapsulate("/p2p/".concat(r)));return{baseAddr:n,peerId:NB(r)}}(i);null===r||void 0===r||r.dialerEvents.increment({open:!0}),a.trace("dialing base address: %a",c);const l=c.getPeerId();if(null==l)throw new pu.sv("Relay peer was missing","ERR_INVALID_ADDRESS");const u=o.getConnections(NB(l));let h,d=!1;0===u.length?(h=await s.dial(c,{signal:n}),d=!0):h=u[0];try{const e=await h.newStream(YL,{signal:n,runOnTransientConnection:!0}),r=hk(e).pb(ZL),o=Ws(),s=()=>{o.reject(new pu.sv("SDP handshake aborted","ERR_SDP_HANDSHAKE_ABORTED"))};try{VL(t,o),null===n||void 0===n||n.addEventListener("abort",s);const e=t.createDataChannel("init");t.onicecandidate=e=>{var t;let{candidate:i}=e;const o=JSON.stringify(null!==(t=null===i||void 0===i?void 0:i.toJSON())&&void 0!==t?t:null);a.trace("initiator sending ICE candidate %s",o),r.write({type:ZL.Type.ICE_CANDIDATE,data:o},{signal:n}).catch((e=>{a.error("error sending ICE candidate",e)}))},t.onicecandidateerror=e=>{a("initiator ICE candidate error",e)};const c=await t.createOffer();a.trace("initiator send SDP offer %s",c.sdp),await r.write({type:ZL.Type.SDP_OFFER,data:c.sdp},{signal:n}),await t.setLocalDescription(c).catch((e=>{throw a.error("could not execute setLocalDescription",e),new pu.sv("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")}));const l=await r.read({signal:n});if(l.type!==ZL.Type.SDP_ANSWER)throw new pu.sv("remote should send an SDP answer","ERR_SDP_HANDSHAKE_FAILED");a.trace("initiator receive SDP answer %s",l.data);const u=new KL({type:"answer",sdp:l.data});return await t.setRemoteDescription(u).catch((e=>{throw a.error("could not execute setRemoteDescription",e),new pu.sv("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")})),a.trace("initiator read candidates until connected"),await zL(o,t,r,{direction:"initiator",signal:n,log:a}),a.trace("initiator connected, closing init channel"),e.close(),a.trace("initiator closing signalling stream"),await r.unwrap().unwrap().close({signal:n}),a.trace("initiator connected to remote address %s",i),{remoteAddress:i}}catch(f){throw t.close(),e.abort(f),f}finally{null===n||void 0===n||n.removeEventListener("abort",s),t.onicecandidate=null,t.onicecandidateerror=null}}finally{if(d)try{await h.close({signal:n})}catch(f){h.abort(f)}}}class qL extends pu.Le{constructor(e,t){super(),(0,Yo.Z)(this,"peerId",void 0),(0,Yo.Z)(this,"transportManager",void 0),(0,Yo.Z)(this,"shutdownController",void 0),this.peerId=e.peerId,this.transportManager=e.transportManager,this.shutdownController=t.shutdownController}async listen(){this.safeDispatchEvent("listening",{})}getAddrs(){return this.transportManager.getListeners().filter((e=>e!==this)).map((e=>e.getAddrs().filter((e=>aP.matches(e))).map((e=>e.encapsulate("/webrtc/p2p/".concat(this.peerId)))))).flat()}async close(){this.shutdownController.abort(),this.safeDispatchEvent("close",{})}}let GL;const WL="/webrtc",QL="/p2p-circuit",YL="/webrtc-signaling/0.0.1";GL=Symbol.toStringTag;class JL{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"_started",!1),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"shutdownController",void 0),(0,Yo.Z)(this,GL,"@libp2p/webrtc"),(0,Yo.Z)(this,pu.SF,!0),this.components=e,this.init=t,this.log=e.logger.forComponent("libp2p:webrtc"),this.shutdownController=new AbortController,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_dialer_events_total",{label:"event",help:"Total count of WebRTC dialer events by type"}),listenerEvents:e.metrics.registerCounterGroup("libp2p_webrtc_listener_events_total",{label:"event",help:"Total count of WebRTC listener events by type"})})}isStarted(){return this._started}async start(){await this.components.registrar.handle(YL,(e=>{this._onProtocol(e).catch((t=>{this.log.error("failed to handle incoming connect from %p",e.connection.remotePeer,t)}))}),{runOnTransientConnection:!0}),this._started=!0}async stop(){await this.components.registrar.unhandle(YL),this._started=!1}createListener(e){return new qL(this.components,{shutdownController:this.shutdownController})}filter(e){return e.filter(gO.uF.exactMatch)}async dial(e,t){var n;this.log.trace("dialing address: %a",e);const r=new FL(this.init.rtcConfiguration),i=new BL(this.components,{peerConnection:r,dataChannelOptions:this.init.dataChannel}),{remoteAddress:o}=await HL({peerConnection:r,multiaddr:e,dataChannelOptions:this.init.dataChannel,signal:t.signal,connectionManager:this.components.connectionManager,transportManager:this.components.transportManager,log:this.log}),s=new mL(this.components,{peerConnection:r,timeline:{open:Date.now()},remoteAddr:o,metrics:null===(n=this.metrics)||void 0===n?void 0:n.dialerEvents}),a=await t.upgrader.upgradeOutbound(s,{skipProtection:!0,skipEncryption:!0,muxerFactory:i});return this._closeOnShutdown(r,s),a}async _onProtocol(e){var t;let{connection:n,stream:r}=e;const i=AbortSignal.timeout(null!==(t=this.init.inboundConnectionTimeout)&&void 0!==t?t:3e4),o=new FL(this.init.rtcConfiguration),s=new BL(this.components,{peerConnection:o,dataChannelOptions:this.init.dataChannel});try{var a;const{remoteAddress:e}=await async function(e){let{peerConnection:t,stream:n,signal:r,connection:i,log:o}=e;o.trace("new inbound signaling stream");const s=hk(n).pb(ZL);try{const e=Ws(),n=Ws();r.onabort=()=>{e.reject(new pu.sv("Timed out while trying to connect","ERR_TIMEOUT"))},t.onicecandidate=t=>{let{candidate:i}=t;n.promise.then((async()=>{var e;const t=JSON.stringify(null!==(e=null===i||void 0===i?void 0:i.toJSON())&&void 0!==e?e:null);o.trace("recipient sending ICE candidate %s",t),await s.write({type:ZL.Type.ICE_CANDIDATE,data:t},{signal:r})}),(t=>{o.error("cannot set candidate since sending answer failed",t),e.reject(t)}))},VL(t,e);const i=await s.read({signal:r});var a;if(i.type!==ZL.Type.SDP_OFFER)throw new pu.sv("expected message type SDP_OFFER, received: ".concat(null!==(a=i.type)&&void 0!==a?a:"undefined"," "),"ERR_SDP_HANDSHAKE_FAILED");o.trace("recipient receive SDP offer %s",i.data);const c=new KL({type:"offer",sdp:i.data});await t.setRemoteDescription(c).catch((e=>{throw o.error("could not execute setRemoteDescription",e),new pu.sv("Failed to set remoteDescription","ERR_SDP_HANDSHAKE_FAILED")}));const l=await t.createAnswer().catch((e=>{throw o.error("could not execute createAnswer",e),n.reject(e),new pu.sv("Failed to create answer","ERR_SDP_HANDSHAKE_FAILED")}));o.trace("recipient send SDP answer %s",l.sdp),await s.write({type:ZL.Type.SDP_ANSWER,data:l.sdp},{signal:r}),await t.setLocalDescription(l).catch((e=>{throw o.error("could not execute setLocalDescription",e),n.reject(e),new pu.sv("Failed to set localDescription","ERR_SDP_HANDSHAKE_FAILED")})),n.resolve(),o.trace("recipient read candidates until connected"),await zL(e,t,s,{direction:"recipient",signal:r,log:o}),o.trace("recipient connected, closing signaling stream"),await s.unwrap().unwrap().close({signal:r})}catch(l){if("connected"!==t.connectionState)throw o.error("error while handling signaling stream from peer %a",i.remoteAddr,l),t.close(),l;o("error while handling signaling stream from peer %a, ignoring as the RTCPeerConnection is already connected",i.remoteAddr,l)}const c=(0,og.HM)("/webrtc/p2p/".concat(i.remoteAddr.getPeerId()));return o.trace("recipient connected to remote address %s",c),{remoteAddress:c}}({peerConnection:o,connection:n,stream:r,signal:i,log:this.log}),t=new mL(this.components,{peerConnection:o,timeline:{open:(new Date).getTime()},remoteAddr:e,metrics:null===(a=this.metrics)||void 0===a?void 0:a.listenerEvents});this._closeOnShutdown(o,t),await this.components.upgrader.upgradeInbound(t,{skipEncryption:!0,skipProtection:!0,muxerFactory:s}),await r.close({signal:i})}catch(c){throw r.abort(c),c}}_closeOnShutdown(e,t){const n=()=>{t.close().catch((e=>{this.log.error("could not close WebRTCMultiaddrConnection",e)}))};this.shutdownController.signal.addEventListener("abort",n),e.addEventListener("close",(()=>{this.shutdownController.signal.removeEventListener("abort",n)}))}}function XL(){const e=Ws();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}const $L=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[];for(const i of t)null==i[Symbol.asyncIterator]&&r.push(i);return r.length===t.length?function*(){for(const e of r)yield*e}():async function*(){const e=TL({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(t.map((async t=>{for await(const n of t)e.push(n)}))),e.end()}catch(n){e.end(n)}})),yield*e}()};const eM=function(){let e;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},tM=e=>null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator]),nM=e=>null!=(null===e||void 0===e?void 0:e[Symbol.iterator]),rM=e=>null!=e&&(null!=e.sink&&null!=e.source),iM=e=>t=>{const n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){const t=TL({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const i=e.source;if(tM(i))r=async function*(){yield*i,t.end()};else{if(!nM(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return $L(t,r())}return e.source};var oM,sM;const aM=65535,cM=Boolean(null===(oM=globalThis.process)||void 0===oM||null===(sM=oM.env)||void 0===sM?void 0:sM.DUMP_SESSION_KEYS),lM={hashSHA256:e=>cu(e),getHKDF(e,t){const n=$l(cu,t,e),r=nu(cu,n,void 0,96);return[r.subarray(0,32),r.subarray(32,64),r.subarray(64,96)]},generateX25519KeyPair(){const e=Ql.utils.randomPrivateKey();return{publicKey:Ql.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Ql.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Ql.getSharedSecret(e,t),chaCha20Poly1305Encrypt:(e,t,n,r)=>uc(r,t,n).encrypt(e),chaCha20Poly1305Decrypt:(e,t,n,r,i)=>uc(r,t,n).decrypt(e,i)},uM=e=>{const t=(0,Us.E)(2);return new DataView(t.buffer,t.byteOffset,t.byteLength).setUint16(0,e,!1),t};uM.bytes=2;const hM=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};hM.bytes=2;class dM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=dM.code,this.type=dM.type}}(0,Yo.Z)(dM,"code","ABORT_ERR"),(0,Yo.Z)(dM,"type","aborted");class fM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=fM.code}}(0,Yo.Z)(fM,"code","ERR_UNEXPECTED_PEER");class pM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=pM.code}}(0,Yo.Z)(pM,"code","ERR_INVALID_CRYPTO_EXCHANGE");class gM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=gM.code}}(0,Yo.Z)(gM,"code","ERR_INVALID_CRYPTO_TRANSMISSION");class yM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=yM.code,this.type=yM.type}}(0,Yo.Z)(yM,"code","ABORT_ERR"),(0,Yo.Z)(yM,"type","aborted");class mM extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class vM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=vM.code}}(0,Yo.Z)(vM,"code","ERR_UNEXPECTED_PEER");class bM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=bM.code}}(0,Yo.Z)(bM,"code","ERR_INVALID_CRYPTO_EXCHANGE");class wM extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=wM.code}}(0,Yo.Z)(wM,"code","ERR_INVALID_CRYPTO_TRANSMISSION");const EM=32,AM=64,SM=32;function _M(e,t){const n=new Uint8Array(AM);for(let r=0;r<SM;r++)n[r]=e[r],n[SM+r]=t[r];return n}const IM={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},CM={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function TM(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=IM.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",CM,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",CM,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",CM,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return wN.encode(r)}var kM,RM,xM,PM;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(kM||(kM={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(RM||(RM={})),function(e){e.codec=()=>bs(RM)}(kM||(kM={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),kM.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=kM.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(xM||(xM={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),kM.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=kM.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(PM||(PM={}));class DM{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=UM(e,EM)}async verify(e,t){return async function(e,t,n){return Gl.verify(t,n,e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return xM.encode({Type:kM.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await uB.digest(this.bytes);return e}}class OM{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=UM(e,AM),this._publicKey=UM(t,EM)}async sign(e){return async function(e,t){const n=e.subarray(0,SM);return Gl.sign(t,n)}(this._key,e)}get public(){return new DM(this._publicKey)}marshal(){return this._key}get bytes(){return PM.encode({Type:kM.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await uB.digest(this.bytes);return e}async id(){const e=sB.digest(this.public.bytes);return $O.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return TM(this.bytes,e);throw new mM("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function NM(e){if(e.length>AM){const t=(e=UM(e,AM+EM)).subarray(0,AM),n=e.subarray(AM,e.length);return new OM(t,n)}const t=(e=UM(e,AM)).subarray(0,AM),n=e.subarray(EM);return new OM(t,n)}function BM(e){return e=UM(e,EM),new DM(e)}async function LM(){const{privateKey:e,publicKey:t}=await async function(){const e=Gl.utils.randomPrivateKey(),t=Gl.getPublicKey(e);return{privateKey:_M(e,t),publicKey:t}}();return new OM(e,t)}async function MM(e){const{privateKey:t,publicKey:n}=await async function(e){if(e.length!==SM)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=Gl.getPublicKey(t);return{privateKey:_M(t,n),publicKey:n}}(e);return new OM(t,n)}function UM(e,t){var n;if((e=Uint8Array.from(null!==(n=e)&&void 0!==n?n:[])).length!==t)throw new mM("Key must be a Uint8Array of length ".concat(t,", got ").concat(e.length),"ERR_INVALID_KEY_TYPE");return e}function FM(e,t){let n=Uint8Array.from(e.abs().toByteArray());if(n=0===n[0]?n.subarray(1):n,null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return(0,Su.B)(n,"base64url")}function KM(e){const t=function(e,t){let n=(0,mu.m)(e,"base64urlpad");if(null!=t){if(n.length>t)throw new Error("byte array longer than desired length");n=(0,Ls.z)([new Uint8Array(t-n.length),n])}return n}(e);return new(yu().jsbn.BigInteger)((0,Su.B)(t,"base16"),16)}const jM={"P-256":256,"P-384":384,"P-521":521};Object.keys(jM).join(" / ");function ZM(e,t){return t.map((t=>KM(e[t])))}async function zM(e){const t=[await IM.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["sign"]),await HM(e)],n=await VM({privateKey:t[0],publicKey:t[1]});return{privateKey:n[0],publicKey:n[1]}}async function VM(e){if(null==e.privateKey||null==e.publicKey)throw new mM("Private and public key are required","ERR_INVALID_PARAMETERS");return Promise.all([IM.get().subtle.exportKey("jwk",e.privateKey),IM.get().subtle.exportKey("jwk",e.publicKey)])}async function HM(e){return IM.get().subtle.importKey("jwk",{kty:e.kty,n:e.n,e:e.e},{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!0,["verify"])}function qM(e,t,n,r){const i=t?function(e){return yu().pki.setRsaPublicKey(...ZM(e,["n","e"]))}(e):function(e){return yu().pki.setRsaPrivateKey(...ZM(e,["n","e","d","p","q","dp","dq","qi"]))}(e),o=r((0,Su.B)(Uint8Array.from(n),"ascii"),i);return(0,mu.m)(o,"ascii")}function GM(e){if("RSA"!==e.kty)throw new mM("invalid key type","ERR_INVALID_KEY_TYPE");if(null==e.n)throw new mM("invalid key modulus","ERR_INVALID_KEY_MODULUS");return 8*(0,mu.m)(e.n,"base64url").length}const WM=8192;class QM{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=e}async verify(e,t){return async function(e,t,n){const r=await IM.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["verify"]);return IM.get().subtle.verify({name:"RSASSA-PKCS1-v1_5"},r,t,n)}(this._key,t,e)}marshal(){return function(e){if(null==e.n||null==e.e)throw new mM("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.publicKeyToAsn1({n:KM(e.n),e:KM(e.e)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return xM.encode({Type:kM.RSA,Data:this.marshal()}).subarray()}encrypt(e){return qM(this._key,!0,e,((e,t)=>t.encrypt(e)))}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await uB.digest(this.bytes);return e}}class YM{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=t}genSecret(){return function(e){if(isNaN(e)||e<=0)throw new mM("random bytes length must be a Number bigger than 0","ERR_INVALID_LENGTH");return Ic(e)}(16)}async sign(e){return async function(e,t){const n=await IM.get().subtle.importKey("jwk",e,{name:"RSASSA-PKCS1-v1_5",hash:{name:"SHA-256"}},!1,["sign"]),r=await IM.get().subtle.sign({name:"RSASSA-PKCS1-v1_5"},n,Uint8Array.from(t));return new Uint8Array(r,0,r.byteLength)}(this._key,e)}get public(){if(null==this._publicKey)throw new mM("public key not provided","ERR_PUBKEY_NOT_PROVIDED");return new QM(this._publicKey)}decrypt(e){return qM(this._key,!1,e,((e,t)=>t.decrypt(e)))}marshal(){return function(e){if(null==e.n||null==e.e||null==e.d||null==e.p||null==e.q||null==e.dp||null==e.dq||null==e.qi)throw new mM("JWK was missing components","ERR_INVALID_PARAMETERS");const t=yu().pki.privateKeyToAsn1({n:KM(e.n),e:KM(e.e),d:KM(e.d),p:KM(e.p),q:KM(e.q),dP:KM(e.dp),dQ:KM(e.dq),qInv:KM(e.qi)});return(0,mu.m)(yu().asn1.toDer(t).getBytes(),"ascii")}(this._key)}get bytes(){return PM.encode({Type:kM.RSA,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await uB.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"pkcs-8";if("pkcs-8"===t){const t=new(yu().util.ByteBuffer)(this.marshal()),n=yu().asn1.fromDer(t),r=yu().pki.privateKeyFromAsn1(n),i={algorithm:"aes256",count:1e4,saltSize:16,prfAlgorithm:"sha512"};return yu().pki.encryptRsaPrivateKey(r,e,i)}if("libp2p-key"===t)return TM(this.bytes,e);throw new mM("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}async function JM(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.privateKeyFromAsn1(t);return{kty:"RSA",n:FM(n.n),e:FM(n.e),d:FM(n.d),p:FM(n.p),q:FM(n.q),dp:FM(n.dP),dq:FM(n.dQ),qi:FM(n.qInv),alg:"RS256"}}(e);if(GM(t)>WM)throw new mM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const n=await zM(t);return new YM(n.privateKey,n.publicKey)}function XM(e){const t=function(e){const t=yu().asn1.fromDer((0,Su.B)(e,"ascii")),n=yu().pki.publicKeyFromAsn1(t);return{kty:"RSA",n:FM(n.n),e:FM(n.e)}}(e);if(GM(t)>WM)throw new mM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");return new QM(t)}async function $M(e){if(GM(e)>WM)throw new mM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await zM(e);return new YM(t.privateKey,t.publicKey)}async function eU(e){if(e>WM)throw new mM("key size is too large","ERR_KEY_SIZE_TOO_LARGE");const t=await async function(e){const t=await IM.get().subtle.generateKey({name:"RSASSA-PKCS1-v1_5",modulusLength:e,publicExponent:new Uint8Array([1,0,1]),hash:{name:"SHA-256"}},!0,["sign","verify"]),n=await VM(t);return{privateKey:n[0],publicKey:n[1]}}(e);return new YM(t.privateKey,t.publicKey)}function tU(e){try{Ah.ProjectivePoint.fromHex(e)}catch(t){throw new mM(String(t),"ERR_INVALID_PUBLIC_KEY")}}class nU{constructor(e){(0,Yo.Z)(this,"_key",void 0),tU(e),this._key=e}async verify(e,t){return async function(e,t,n){try{const{digest:r}=await uB.digest(n);return Ah.verify(t,r,e)}catch(r){throw new mM(String(r),"ERR_INVALID_INPUT")}}(this._key,t,e)}marshal(){return e=this._key,Ah.ProjectivePoint.fromHex(e).toRawBytes(!0);var e}get bytes(){return xM.encode({Type:kM.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await uB.digest(this.bytes);return e}}class rU{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=e,this._publicKey=null!==t&&void 0!==t?t:function(e){try{return Ah.getPublicKey(e,!0)}catch(t){throw new mM(String(t),"ERR_INVALID_PRIVATE_KEY")}}(e),function(e){try{Ah.getPublicKey(e,!0)}catch(t){throw new mM(String(t),"ERR_INVALID_PRIVATE_KEY")}}(this._key),tU(this._publicKey)}async sign(e){return async function(e,t){const{digest:n}=await uB.digest(t);try{return Ah.sign(n,e).toDERRawBytes()}catch(r){throw new mM(String(r),"ERR_INVALID_INPUT")}}(this._key,e)}get public(){return new nU(this._publicKey)}marshal(){return this._key}get bytes(){return PM.encode({Type:kM.Secp256k1,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await uB.digest(this.bytes);return e}async id(){const e=await this.public.hash();return(0,Su.B)(e,"base58btc")}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return TM(this.bytes,e);throw new mM("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function iU(e){return new rU(e)}function oU(e){return new nU(e)}async function sU(){const e=Ah.utils.randomPrivateKey();return new rU(e)}const aU={rsa:Et,ed25519:wt,secp256k1:At};function cU(e){const t=Object.keys(aU).join(" / ");return new mM("invalid or unsupported key type ".concat(e,". Must be ").concat(t),"ERR_UNSUPPORTED_KEY_TYPE")}async function lU(e){var t,n;const r=PM.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case kM.RSA:return aU.rsa.unmarshalRsaPrivateKey(i);case kM.Ed25519:return aU.ed25519.unmarshalEd25519PrivateKey(i);case kM.Secp256k1:return aU.secp256k1.unmarshalSecp256k1PrivateKey(i);default:throw cU(null!==(n=r.Type)&&void 0!==n?n:"RSA")}}const uU=Symbol.for("@libp2p/peer-id");let hU;const dU=Symbol.for("nodejs.util.inspect.custom"),fU=Object.values(SB).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)),SB.identity.decoder),pU=114,gU=36,yU=37;hU=Symbol.toStringTag;class mU{constructor(e){(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"multihash",void 0),(0,Yo.Z)(this,"privateKey",void 0),(0,Yo.Z)(this,"publicKey",void 0),(0,Yo.Z)(this,"string",void 0),(0,Yo.Z)(this,uU,!0),this.type=e.type,this.multihash=e.multihash,this.privateKey=e.privateKey,Object.defineProperty(this,"string",{enumerable:!1,writable:!0})}get[hU](){return"PeerId(".concat(this.toString(),")")}toString(){return null==this.string&&(this.string=$O.encode(this.multihash.bytes).slice(1)),this.string}toCID(){return gB.createV1(pU,this.multihash)}toBytes(){return this.multihash.bytes}toJSON(){return this.toString()}equals(e){var t;if(e instanceof Uint8Array)return(0,Ms.f)(this.multihash.bytes,e);if("string"===typeof e)return function(e,t){var n;if(t=null!==(n=t)&&void 0!==n?n:fU,"1"===e.charAt(0)||"Q"===e.charAt(0)){const t=rB($O.decode("z".concat(e)));return e.startsWith("12D")?new bU({multihash:t}):e.startsWith("16U")?new wU({multihash:t}):new vU({multihash:t})}return function(e){try{const t=rB(e);if(t.code===sB.code){if(t.digest.length===gU)return new bU({multihash:t});if(t.digest.length===yU)return new wU({multihash:t})}if(t.code===uB.code)return new vU({multihash:t})}catch{return function(e){if(null==e||null==e.multihash||null==e.version||1===e.version&&e.code!==pU)throw new Error("Supplied PeerID CID is invalid");const t=e.multihash;if(t.code===uB.code)return new vU({multihash:e.multihash});if(t.code===sB.code){if(t.digest.length===gU)return new bU({multihash:e.multihash});if(t.digest.length===yU)return new wU({multihash:e.multihash})}throw new Error("Supplied PeerID CID is invalid")}(gB.decode(e))}throw new Error("Supplied PeerID CID is invalid")}(fU.decode(e))}(e).equals(this);if(null!=(null===e||void 0===e||null===(t=e.multihash)||void 0===t?void 0:t.bytes))return(0,Ms.f)(this.multihash.bytes,e.multihash.bytes);throw new Error("not valid Id")}[dU](){return"PeerId(".concat(this.toString(),")")}}class vU extends mU{constructor(e){super({...e,type:"RSA"}),(0,Yo.Z)(this,"type","RSA"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.publicKey}}class bU extends mU{constructor(e){super({...e,type:"Ed25519"}),(0,Yo.Z)(this,"type","Ed25519"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}class wU extends mU{constructor(e){super({...e,type:"secp256k1"}),(0,Yo.Z)(this,"type","secp256k1"),(0,Yo.Z)(this,"publicKey",void 0),this.publicKey=e.multihash.digest}}async function EU(e,t){return e.length===gU?new bU({multihash:nB(sB.code,e),privateKey:t}):e.length===yU?new wU({multihash:nB(sB.code,e),privateKey:t}):new vU({multihash:await uB.digest(e),publicKey:e,privateKey:t})}var AU,SU;async function _U(e,t,n){const r=await async function(e,t){if(null==e.privateKey)throw new Error("PrivateKey was missing from PeerId");return(await lU(e.privateKey)).sign(t)}(e,TU(t));if(null==e.publicKey)throw new Error("PublicKey was missing from local PeerId");return function(e,t,n){return SU.encode({identityKey:e,identitySig:t,extensions:null!==n&&void 0!==n?n:{webtransportCerthashes:[]}}).subarray()}(e.publicKey,r,n)}async function IU(e){return EU(e.identityKey)}function CU(e){return SU.decode(e)}function TU(e){const t=(0,mu.m)("noise-libp2p-static-key:");return(0,Ls.z)([t,e],t.length+e.length)}async function kU(e,t,n){const r=await EU(t.identityKey);if(!r.equals(n))throw new Error("Payload identity key ".concat(r.toString()," does not match expected remote peer ").concat(n.toString()));const i=TU(e);if(null==r.publicKey)throw new Error("PublicKey was missing from PeerId");if(null==t.identitySig)throw new Error("Signature was missing from message");const o=function(e){var t,n;const r=xM.decode(e),i=null!==(t=r.Data)&&void 0!==t?t:new Uint8Array;switch(r.Type){case kM.RSA:return aU.rsa.unmarshalRsaPublicKey(i);case kM.Ed25519:return aU.ed25519.unmarshalEd25519PublicKey(i);case kM.Secp256k1:return aU.secp256k1.unmarshalSecp256k1PublicKey(i);default:throw cU(null!==(n=r.Type)&&void 0!==n?n:"unknown")}}(r.publicKey);if(!await o.verify(i,t.identitySig))throw new Error("Static key doesn't match to peer that signed payload!");return r}function RU(e){return e instanceof Uint8Array&&32===e.length}function xU(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}("".concat(e,":trace"));return cf().enabled("".concat(e,":trace"))&&null!=cf().names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=cf()("".concat(e,":trace"))),Object.assign(cf()(e),{error:cf()("".concat(e,":error")),trace:t})}!function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(!1!==n.lengthDelimited&&t.fork(),null!=e.webtransportCerthashes)for(const r of e.webtransportCerthashes)t.uint32(10),t.bytes(r);!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={webtransportCerthashes:[]},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();if(t>>>3===1)n.webtransportCerthashes.push(e.bytes());else e.skipType(7&t)}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(AU||(AU={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.identityKey&&e.identityKey.byteLength>0&&(t.uint32(10),t.bytes(e.identityKey)),null!=e.identitySig&&e.identitySig.byteLength>0&&(t.uint32(18),t.bytes(e.identitySig)),null!=e.extensions&&(t.uint32(34),AU.codec().encode(e.extensions,t)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={identityKey:(0,Us.u)(0),identitySig:(0,Us.u)(0)},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.identityKey=e.bytes();break;case 2:n.identitySig=e.bytes();break;case 4:n.extensions=AU.codec().decode(e,e.uint32());break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(SU||(SU={})),cf().formatters.b=e=>null==e?"undefined":$O.baseEncode(e),cf().formatters.t=e=>null==e?"undefined":lN.baseEncode(e),cf().formatters.m=e=>null==e?"undefined":wN.baseEncode(e),cf().formatters.p=e=>null==e?"undefined":e.toString(),cf().formatters.c=e=>null==e?"undefined":e.toString(),cf().formatters.k=e=>null==e?"undefined":e.toString(),cf().formatters.a=e=>null==e?"undefined":e.toString();const PU=xU("libp2p:noise");let DU;function OU(e){e?(DU("LOCAL_PUBLIC_EPHEMERAL_KEY ".concat((0,Su.B)(e.publicKey,"hex"))),DU("LOCAL_PRIVATE_EPHEMERAL_KEY ".concat((0,Su.B)(e.privateKey,"hex")))):DU("Missing local ephemeral keys.")}function NU(e){DU("REMOTE_EPHEMERAL_PUBLIC_KEY ".concat((0,Su.B)(e,"hex")))}DU=cM?PU:Object.assign((()=>{}),{enabled:!1,trace:()=>{},error:()=>{}});class BU{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;(0,Yo.Z)(this,"n",void 0),(0,Yo.Z)(this,"bytes",void 0),(0,Yo.Z)(this,"view",void 0),this.n=e,this.bytes=(0,Us.u)(12),this.view=new DataView(this.bytes.buffer,this.bytes.byteOffset,this.bytes.byteLength),this.view.setUint32(4,e,!0)}increment(){this.n++,this.view.setUint32(4,this.n,!0)}getBytes(){return this.bytes}getUint64(){return this.n}assertValue(){if(this.n>4294967295)throw new Error("Cipherstate has reached maximum n, a new handshake must be performed")}}class LU{constructor(e){(0,Yo.Z)(this,"crypto",void 0),this.crypto=e}encryptWithAd(e,t,n){const r=this.encrypt(e.k,e.n,t,n);return e.n.increment(),r}decryptWithAd(e,t,n,r){const{plaintext:i,valid:o}=this.decrypt(e.k,e.n,t,n,r);return o&&e.n.increment(),{plaintext:i,valid:o}}hasKey(e){return!this.isEmptyKey(e.k)}createEmptyKey(){return(0,Us.u)(32)}isEmptyKey(e){const t=this.createEmptyKey();return(0,Ms.f)(t,e)}encrypt(e,t,n,r){return t.assertValue(),this.crypto.chaCha20Poly1305Encrypt(r,t.getBytes(),n,e)}encryptAndHash(e,t){let n;return n=this.hasKey(e.cs)?this.encryptWithAd(e.cs,e.h,t):t,this.mixHash(e,n),n}decrypt(e,t,n,r,i){t.assertValue();const o=this.crypto.chaCha20Poly1305Decrypt(r,t.getBytes(),n,e,i);return o?{plaintext:o,valid:!0}:{plaintext:(0,Us.u)(0),valid:!1}}decryptAndHash(e,t){let n,r=!0;return this.hasKey(e.cs)?({plaintext:n,valid:r}=this.decryptWithAd(e.cs,e.h,t)):n=t,this.mixHash(e,t),{plaintext:n,valid:r}}dh(e,t){try{const n=this.crypto.generateX25519SharedKey(e,t);return 32===n.length?n:n.subarray(0,32)}catch(n){const e=n;return PU.error(e),(0,Us.u)(32)}}mixHash(e,t){e.h=this.getHash(e.h,t)}getHash(e,t){return this.crypto.hashSHA256((0,Ls.z)([e,t],e.length+t.length))}mixKey(e,t){const[n,r]=this.crypto.getHKDF(e.ck,t);e.cs=this.initializeKey(r),e.ck=n}initializeKey(e){return{k:e,n:new BU}}initializeSymmetric(e){const t=(0,ed.mL)(e,"utf-8"),n=this.hashProtocolName(t),r=n,i=this.createEmptyKey();return{cs:this.initializeKey(i),ck:r,h:n}}hashProtocolName(e){if(e.length<=32){const t=(0,Us.u)(32);return t.set(e),t}return this.getHash(e,(0,Us.u)(0))}split(e){const[t,n]=this.crypto.getHKDF(e.ck,(0,Us.u)(0));return{cs1:this.initializeKey(t),cs2:this.initializeKey(n)}}writeMessageRegular(e,t){const n=this.encryptWithAd(e,(0,Us.u)(0),t);return{ne:this.createEmptyKey(),ns:(0,Us.u)(0),ciphertext:n}}readMessageRegular(e,t){return this.decryptWithAd(e,(0,Us.u)(0),t.ciphertext)}}class MU extends LU{initializeInitiator(e,t,n,r){const i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(i,e);return{ss:i,s:t,rs:n,psk:r,re:(0,Us.u)(32)}}initializeResponder(e,t,n,r){const i=this.initializeSymmetric("Noise_XX_25519_ChaChaPoly_SHA256");this.mixHash(i,e);return{ss:i,s:t,rs:n,psk:r,re:(0,Us.u)(32)}}writeMessageA(e,t,n){const r=(0,Us.u)(0);e.e=void 0!==n?n:this.crypto.generateX25519KeyPair();const i=e.e.publicKey;this.mixHash(e.ss,i);return{ne:i,ns:r,ciphertext:this.encryptAndHash(e.ss,t)}}writeMessageB(e,t){e.e=this.crypto.generateX25519KeyPair();const n=e.e.publicKey;this.mixHash(e.ss,n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const r=e.s.publicKey,i=this.encryptAndHash(e.ss,r);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));return{ne:n,ns:i,ciphertext:this.encryptAndHash(e.ss,t)}}writeMessageC(e,t){const n=e.s.publicKey,r=this.encryptAndHash(e.ss,n);this.mixKey(e.ss,this.dh(e.s.privateKey,e.re));const i=this.encryptAndHash(e.ss,t),o={ne:this.createEmptyKey(),ns:r,ciphertext:i},{cs1:s,cs2:a}=this.split(e.ss);return{h:e.ss.h,messageBuffer:o,cs1:s,cs2:a}}readMessageA(e,t){return RU(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),this.decryptAndHash(e.ss,t.ciphertext)}readMessageB(e,t){if(RU(t.ne)&&(e.re=t.ne),this.mixHash(e.ss,e.re),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.re));const{plaintext:n,valid:r}=this.decryptAndHash(e.ss,t.ns);r&&RU(n)&&(e.rs=n),this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext);return{plaintext:i,valid:r&&o}}readMessageC(e,t){const{plaintext:n,valid:r}=this.decryptAndHash(e.ss,t.ns);if(r&&RU(n)&&(e.rs=n),!e.e)throw new Error("Handshake state `e` param is missing.");this.mixKey(e.ss,this.dh(e.e.privateKey,e.rs));const{plaintext:i,valid:o}=this.decryptAndHash(e.ss,t.ciphertext),{cs1:s,cs2:a}=this.split(e.ss);return{h:e.ss.h,plaintext:i,valid:r&&o,cs1:s,cs2:a}}initSession(e,t,n){const r=this.createEmptyKey(),i=(0,Us.u)(32);let o;return o=e?this.initializeInitiator(t,n,i,r):this.initializeResponder(t,n,i,r),{hs:o,i:e,mc:0}}sendMessage(e,t,n){let r;if(0===e.mc)r=this.writeMessageA(e.hs,t,n);else if(1===e.mc)r=this.writeMessageB(e.hs,t);else if(2===e.mc){const{h:n,messageBuffer:i,cs1:o,cs2:s}=this.writeMessageC(e.hs,t);r=i,e.h=n,e.cs1=o,e.cs2=s}else{if(!(e.mc>2))throw new Error("Session invalid.");if(e.i){if(!e.cs1)throw new Error("CS1 (cipher state) is not defined");r=this.writeMessageRegular(e.cs1,t)}else{if(!e.cs2)throw new Error("CS2 (cipher state) is not defined");r=this.writeMessageRegular(e.cs2,t)}}return e.mc++,r}recvMessage(e,t){let n=(0,Us.u)(0),r=!1;if(0===e.mc)({plaintext:n,valid:r}=this.readMessageA(e.hs,t));else if(1===e.mc)({plaintext:n,valid:r}=this.readMessageB(e.hs,t));else if(2===e.mc){const{h:i,plaintext:o,valid:s,cs1:a,cs2:c}=this.readMessageC(e.hs,t);n=o,r=s,e.h=i,e.cs1=a,e.cs2=c}return e.mc++,{plaintext:n,valid:r}}}class UU{constructor(e,t,n,r,i,o,s,a){(0,Yo.Z)(this,"isInitiator",void 0),(0,Yo.Z)(this,"session",void 0),(0,Yo.Z)(this,"remotePeer",void 0),(0,Yo.Z)(this,"remoteExtensions",{webtransportCerthashes:[]}),(0,Yo.Z)(this,"payload",void 0),(0,Yo.Z)(this,"connection",void 0),(0,Yo.Z)(this,"xx",void 0),(0,Yo.Z)(this,"staticKeypair",void 0),(0,Yo.Z)(this,"prologue",void 0),this.isInitiator=e,this.payload=t,this.prologue=n,this.staticKeypair=i,this.connection=o,s&&(this.remotePeer=s),this.xx=null!==a&&void 0!==a?a:new MU(r),this.session=this.xx.initSession(this.isInitiator,this.prologue,this.staticKeypair)}async propose(){var e;if(e=this.session.hs.s,DU("LOCAL_STATIC_PUBLIC_KEY ".concat((0,Su.B)(e.publicKey,"hex"))),DU("LOCAL_STATIC_PRIVATE_KEY ".concat((0,Su.B)(e.privateKey,"hex"))),this.isInitiator){PU.trace("Stage 0 - Initiator starting to send first message.");const e=this.xx.sendMessage(this.session,(0,Us.u)(0));await this.connection.write(function(e){return(0,Ls.z)([e.ne,e.ciphertext],e.ne.length+e.ciphertext.length)}(e)),PU.trace("Stage 0 - Initiator finished sending first message."),OU(this.session.hs.e)}else{PU.trace("Stage 0 - Responder waiting to receive first message...");const e=function(e){if(e.length<32)throw new Error("Cannot decode stage 0 MessageBuffer: length less than 32 bytes.");return{ne:e.subarray(0,32),ciphertext:e.subarray(32,e.length),ns:(0,Us.u)(0)}}((await this.connection.read()).subarray()),{valid:t}=this.xx.recvMessage(this.session,e);if(!t)throw new pM("xx handshake stage 0 validation fail");PU.trace("Stage 0 - Responder received first message."),NU(this.session.hs.re)}}async exchange(){if(this.isInitiator){PU.trace("Stage 1 - Initiator waiting to receive first message from responder...");const n=function(e){if(e.length<80)throw new Error("Cannot decode stage 1 MessageBuffer: length less than 80 bytes.");return{ne:e.subarray(0,32),ns:e.subarray(32,80),ciphertext:e.subarray(80,e.length)}}((await this.connection.read()).subarray()),{plaintext:r,valid:i}=this.xx.recvMessage(this.session,n);if(!i)throw new pM("xx handshake stage 1 validation fail");PU.trace("Stage 1 - Initiator received the message."),NU(this.session.hs.re),e=this.session.hs.rs,DU("REMOTE_STATIC_PUBLIC_KEY ".concat((0,Su.B)(e,"hex"))),PU.trace("Initiator going to check remote's signature...");try{const e=CU(r);this.remotePeer=this.remotePeer||await IU(e),await kU(this.session.hs.rs,e,this.remotePeer),this.setRemoteNoiseExtension(e.extensions)}catch(t){throw new fM("Error occurred while verifying signed payload: ".concat(t.message))}PU.trace("All good with the signature!")}else{PU.trace("Stage 1 - Responder sending out first message with signed payload and static key.");const e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(function(e){return(0,Ls.z)([e.ne,e.ns,e.ciphertext],e.ne.length+e.ns.length+e.ciphertext.length)}(e)),PU.trace("Stage 1 - Responder sent the second handshake message with signed payload."),OU(this.session.hs.e)}var e}async finish(){if(this.isInitiator){PU.trace("Stage 2 - Initiator sending third handshake message.");const e=this.xx.sendMessage(this.session,this.payload);await this.connection.write(function(e){return(0,Ls.z)([e.ns,e.ciphertext],e.ns.length+e.ciphertext.length)}(e)),PU.trace("Stage 2 - Initiator sent message with signed payload.")}else{PU.trace("Stage 2 - Responder waiting for third handshake message...");const e=function(e){if(e.length<48)throw new Error("Cannot decode stage 2 MessageBuffer: length less than 48 bytes.");return{ne:(0,Us.u)(0),ns:e.subarray(0,48),ciphertext:e.subarray(48,e.length)}}((await this.connection.read()).subarray()),{plaintext:n,valid:r}=this.xx.recvMessage(this.session,e);if(!r)throw new pM("xx handshake stage 2 validation fail");PU.trace("Stage 2 - Responder received the message, finished handshake.");try{const e=CU(n);this.remotePeer=this.remotePeer||await IU(e),await kU(this.session.hs.rs,e,this.remotePeer),this.setRemoteNoiseExtension(e.extensions)}catch(t){throw new fM("Error occurred while verifying signed payload: ".concat(t.message))}}var e;(e=this.session).cs1&&e.cs2?(DU("CIPHER_STATE_1 ".concat(e.cs1.n.getUint64()," ").concat((0,Su.B)(e.cs1.k,"hex"))),DU("CIPHER_STATE_2 ".concat(e.cs2.n.getUint64()," ").concat((0,Su.B)(e.cs2.k,"hex")))):DU("Missing cipher state.")}encrypt(e,t){const n=this.getCS(t);return this.xx.encryptWithAd(n,(0,Us.u)(0),e)}decrypt(e,t,n){const r=this.getCS(t,!1);return this.xx.decryptWithAd(r,(0,Us.u)(0),e,n)}getRemoteStaticKey(){return this.session.hs.rs}getCS(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(!e.cs1||!e.cs2)throw new pM("Handshake not completed properly, cipher state does not exist.");return this.isInitiator?t?e.cs1:e.cs2:t?e.cs2:e.cs1}setRemoteNoiseExtension(e){e&&(this.remoteExtensions=e)}}class FU{constructor(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"protocol","/noise"),(0,Yo.Z)(this,"crypto",void 0),(0,Yo.Z)(this,"prologue",void 0),(0,Yo.Z)(this,"staticKeys",void 0),(0,Yo.Z)(this,"extensions",void 0),(0,Yo.Z)(this,"metrics",void 0);const{staticNoiseKey:t,extensions:n,crypto:r,prologueBytes:i,metrics:o}=e;this.crypto=null!==r&&void 0!==r?r:lM,this.extensions=n,this.metrics=o?function(e){return{xxHandshakeSuccesses:e.registerCounter("libp2p_noise_xxhandshake_successes_total",{help:"Total count of noise xxHandshakes successes_"}),xxHandshakeErrors:e.registerCounter("libp2p_noise_xxhandshake_error_total",{help:"Total count of noise xxHandshakes errors"}),encryptedPackets:e.registerCounter("libp2p_noise_encrypted_packets_total",{help:"Total count of noise encrypted packets successfully"}),decryptedPackets:e.registerCounter("libp2p_noise_decrypted_packets_total",{help:"Total count of noise decrypted packets"}),decryptErrors:e.registerCounter("libp2p_noise_decrypt_errors_total",{help:"Total count of noise decrypt errors"})}}(o):void 0,this.staticKeys=t?this.crypto.generateX25519KeyPairFromSeed(t):this.crypto.generateX25519KeyPair(),this.prologue=null!==i&&void 0!==i?i:(0,Us.u)(0)}async secureOutbound(e,t,n){const r=ua(t,{lengthEncoder:uM,lengthDecoder:hM,maxDataLength:aM}),i=await this.performHandshake({connection:r,isInitiator:!0,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(r,i),remoteExtensions:i.remoteExtensions,remotePeer:i.remotePeer}}async secureInbound(e,t,n){const r=ua(t,{lengthEncoder:uM,lengthDecoder:hM,maxDataLength:aM}),i=await this.performHandshake({connection:r,isInitiator:!1,localPeer:e,remotePeer:n});return{conn:await this.createSecureConnection(r,i),remotePeer:i.remotePeer,remoteExtensions:i.remoteExtensions}}async performHandshake(e){const t=await _U(e.localPeer,this.staticKeys.publicKey,this.extensions);return this.performXXHandshake(e,t)}async performXXHandshake(e,t){const{isInitiator:n,remotePeer:r,connection:i}=e,o=new UU(n,t,this.prologue,this.crypto,this.staticKeys,i,r);try{var s;await o.propose(),await o.exchange(),await o.finish(),null===(s=this.metrics)||void 0===s||s.xxHandshakeSuccesses.increment()}catch(c){var a;if(null===(a=this.metrics)||void 0===a||a.xxHandshakeErrors.increment(),c instanceof Error)throw c.message="Error occurred during XX handshake: ".concat(c.message),c}return o}async createSecureConnection(e,t){const[n,r]=function(){const e=XL(),t=XL();return[{source:e.source,sink:t.sink},{source:t.source,sink:e.sink}]}(),i=e.unwrap();return await function(e){if(null==e)throw new Error("Empty pipeline");if(rM(e)){const t=e;e=()=>t.source}else if(nM(e)||tM(e)){const t=e;e=()=>t}for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];const i=[e,...n];if(i.length>1&&rM(i[i.length-1])&&(i[i.length-1]=i[i.length-1].sink),i.length>2)for(let o=1;o<i.length-1;o++)rM(i[o])&&(i[o]=iM(i[o]));return eM(...i)}(n,function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=65519){let i=n+65519;i>r.length&&(i=r.length);const o=e.encrypt(r.subarray(n,i),e.session);null===t||void 0===t||t.encryptedPackets.increment(),yield(0,ed.zo)([uM(o.byteLength),o],2+o.byteLength)}}}(t,this.metrics),i,(e=>SL(e,{lengthDecoder:hM})),function(e,t){return async function*(n){for await(const r of n)for(let n=0;n<r.length;n+=aM){let i=n+aM;if(i>r.length&&(i=r.length),i-16<n)throw new Error("Invalid chunk");const o=r.subarray(n,i),s=r.subarray(n,i-16),{plaintext:a,valid:c}=e.decrypt(o,e.session,s);if(!c)throw null===t||void 0===t||t.decryptErrors.increment(),new Error("Failed to validate decrypted chunk");null===t||void 0===t||t.decryptedPackets.increment(),yield a}}}(t,this.metrics),n),r}}var KU=n(53765);const jU=Object.values(SB).map((e=>e.decoder)).reduce(((e,t)=>e.or(t)));function ZU(e,t){var n;const r=null===(n=e.getConfiguration().certificates)||void 0===n?void 0:n.at(0);if(null==r||null==r.getFingerprints){t.log.trace("fetching fingerprint from local SDP");const n=e.localDescription;if(null==n)return;return function(e){var t;const n=e.match(zU);return null===n||void 0===n||null===(t=n.groups)||void 0===t?void 0:t.fingerprint}(n.sdp)}if(t.log.trace("fetching fingerprint from local certificate"),0===r.getFingerprints().length)return;const i=r.getFingerprints()[0].value;if(null==i)throw VB("","no fingerprint on local certificate");return i}const zU=/^a=fingerprint:(?:\w+-[0-9]+)\s(?<fingerprint>(:?[0-9a-fA-F]{2})+)$/m;function VU(e){const t=e.stringTuples().filter((e=>e[0]===YU)).map((e=>e[1]))[0];if(void 0===t||""===t)throw KB("Couldn't find a certhash component of multiaddr: ".concat(e.toString()));return t}function HU(e){const t=jU.decode(e);return KU.decode(t)}function qU(e){switch(e){case"sha1":return"sha-1";case"sha2-256":return"sha-256";case"sha2-512":return"sha-512";default:throw new qB(e)}}function GU(e,t){const{host:n,port:r}=e.toOptions(),i=function(e){for(const t of e.protoNames())if(t.startsWith("ip"))return t.toUpperCase();return"IP6"}(e),[o]=function(e){const t=HU(VU(e)),n=qU(t.name),r=t.digest.reduce(((e,t)=>e+t.toString(16).padStart(2,"0")),""),i=r.match(/.{1,2}/g);if(null==i)throw VB(r,e.toString());return["".concat(n.toUpperCase()," ").concat(i.join(":").toUpperCase()),r]}(e);return"v=0\no=- 0 0 IN ".concat(i," ").concat(n,"\ns=-\nc=IN ").concat(i," ").concat(n,"\nt=0 0\na=ice-lite\nm=application ").concat(r," UDP/DTLS/SCTP webrtc-datachannel\na=mid:0\na=setup:passive\na=ice-ufrag:").concat(t,"\na=ice-pwd:").concat(t,"\na=fingerprint:").concat(o,"\na=sctp-port:5000\na=max-message-size:16384\na=candidate:1467250027 1 UDP 1467250027 ").concat(n," ").concat(r," typ host\r\n")}const WU=Array.from("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/");let QU;(0,og.a_)("webrtc-direct").code;const YU=(0,og.a_)("certhash").code;QU=Symbol.toStringTag;class JU{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};(0,Yo.Z)(this,"log",void 0),(0,Yo.Z)(this,"metrics",void 0),(0,Yo.Z)(this,"components",void 0),(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,QU,"@libp2p/webrtc-direct"),(0,Yo.Z)(this,pu.SF,!0),this.log=e.logger.forComponent("libp2p:webrtc-direct"),this.components=e,this.init=t,null!=e.metrics&&(this.metrics={dialerEvents:e.metrics.registerCounterGroup("libp2p_webrtc-direct_dialer_events_total",{label:"event",help:"Total count of WebRTC-direct dial events by type"})})}async dial(e,t){const n=await this._connect(e,t);return this.log("dialing address: %a",e),n}createListener(e){throw new HB("WebRTCTransport.createListener")}filter(e){return e.filter(gO.Ih.exactMatch)}async _connect(e,t){const n=new AbortController,r=n.signal,i=e.getPeerId();if(null===i)throw KB("we need to have the remote's PeerId");const o=NB(i),s=HU(VU(e)),a=await FL.generateCertificate({name:"ECDSA",namedCurve:"P-256",hash:qU(s.name)}),c=new FL({certificates:[a]});try{var l,u,h,d;const i=new Promise(((e,t)=>{const n=c.createDataChannel("",{negotiated:!0,id:0}),r=setTimeout((()=>{var e;const r="Data channel was never opened: state: ".concat(n.readyState);this.log.error(r),null===(e=this.metrics)||void 0===e||e.dialerEvents.increment({open_error:!0}),t(UB("data",r))}),1e4);n.onopen=t=>{clearTimeout(r),e(n)},n.onerror=e=>{var n,i,o;clearTimeout(r);const s=null!==(n=null===(i=e.target)||void 0===i?void 0:i.toString())&&void 0!==n?n:"not specified",a="Error opening a data channel for handshaking: ".concat(s);this.log.error(a),null===(o=this.metrics)||void 0===o||o.dialerEvents.increment({unknown_error:!0}),t(UB("data",a))}})),a="libp2p+webrtc+v1/"+[...Array(32)].map((()=>WU.at(Math.floor(Math.random()*WU.length)))).join(""),f=function(e,t){if(void 0===e.sdp)throw ZB("Can't munge a missing SDP");return e.sdp=e.sdp.replace(/\na=ice-ufrag:[^\n]*\n/,"\na=ice-ufrag:"+t+"\n").replace(/\na=ice-pwd:[^\n]*\n/,"\na=ice-pwd:"+t+"\n"),e}(await c.createOffer(),a);await c.setLocalDescription(f);const p=function(e,t){return{type:"answer",sdp:GU(e,t)}}(e,a);await c.setRemoteDescription(p);const g=await i,y=this.components.peerId,m=function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return()=>new FU(e)}({prologueBytes:this.generateNoisePrologue(c,s.code,e)})(),v=OL({channel:g,direction:"inbound",logger:this.components.logger,...null!==(l=this.init.dataChannel)&&void 0!==l?l:{}}),b={...v,sink:v.sink.bind(v),source:async function*(){for await(const e of v.source)for(const t of e)yield t}()},w=new mL(this.components,{peerConnection:c,remoteAddr:e,timeline:{open:Date.now()},metrics:null===(u=this.metrics)||void 0===u?void 0:u.dialerEvents}),E=fL?"iceconnectionstatechange":"connectionstatechange";c.addEventListener(E,(()=>{switch(c.connectionState){case"failed":case"disconnected":case"closed":w.close().catch((e=>{this.log.error("error closing connection",e)})).finally((()=>{n.abort()}))}}),{signal:r}),null===(h=this.metrics)||void 0===h||h.dialerEvents.increment({peer_connection:!0});const A=new BL(this.components,{peerConnection:c,metrics:null===(d=this.metrics)||void 0===d?void 0:d.dialerEvents,dataChannelOptions:this.init.dataChannel});return await m.secureInbound(y,b,o),await t.upgrader.upgradeOutbound(w,{skipProtection:!0,skipEncryption:!0,muxerFactory:A})}catch(f){throw c.close(),f}}generateNoisePrologue(e,t,n){var r;if(0===(null===(r=e.getConfiguration().certificates)||void 0===r?void 0:r.length))throw ZB("no local certificate");const i=ZU(e,{log:this.log});if(null==i)throw ZB("no local fingerprint found");const o=i.trim().toLowerCase().replaceAll(":",""),s=(0,mu.m)(o,"hex"),a=KU.encode(s,t),c=jU.decode(VU(n)),l=(0,mu.m)("libp2p-webrtc-noise:");return(0,Ls.z)([l,a,c])}}function XU(e){return t=>new JU(t,e)}class $U extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=$U.code,this.type=$U.type}}(0,Yo.Z)($U,"code","ABORT_ERR"),(0,Yo.Z)($U,"type","aborted");class eF extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class tF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=tF.code}}(0,Yo.Z)(tF,"code","ERR_UNEXPECTED_PEER");class nF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=nF.code}}(0,Yo.Z)(nF,"code","ERR_INVALID_CRYPTO_EXCHANGE");class rF extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=rF.code}}(0,Yo.Z)(rF,"code","ERR_INVALID_CRYPTO_TRANSMISSION");const iF=Symbol.for("@libp2p/transport");var oF;!function(e){e[e.FATAL_ALL=0]="FATAL_ALL",e[e.NO_FATAL=1]="NO_FATAL"}(oF||(oF={}));var sF=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const aF=sF;new Uint8Array(0);class cF{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class lF{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return hF(this,e)}}class uF{constructor(e){this.decoders=e}or(e){return hF(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const hF=(e,t)=>new uF({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class dF{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new cF(e,t,n),this.decoder=new lF(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const fF=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new dF(t,n,r,i)},pF=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=aF(r,n);return fF({prefix:t,name:n,encode:i,decode:e=>(e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")})(o(e))})},gF=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return fF({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},yF=gF({prefix:"b",name:"base32",alphabet:"abcdefghijklmnopqrstuvwxyz234567",bitsPerChar:5}),mF=(gF({prefix:"B",name:"base32upper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567",bitsPerChar:5}),gF({prefix:"c",name:"base32pad",alphabet:"abcdefghijklmnopqrstuvwxyz234567=",bitsPerChar:5}),gF({prefix:"C",name:"base32padupper",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ234567=",bitsPerChar:5}),gF({prefix:"v",name:"base32hex",alphabet:"0123456789abcdefghijklmnopqrstuv",bitsPerChar:5}),gF({prefix:"V",name:"base32hexupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV",bitsPerChar:5}),gF({prefix:"t",name:"base32hexpad",alphabet:"0123456789abcdefghijklmnopqrstuv=",bitsPerChar:5}),gF({prefix:"T",name:"base32hexpadupper",alphabet:"0123456789ABCDEFGHIJKLMNOPQRSTUV=",bitsPerChar:5}),gF({prefix:"h",name:"base32z",alphabet:"ybndrfg8ejkmcpqxot1uwisza345h769",bitsPerChar:5}),pF({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"})),vF=(pF({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"}),gF({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}));gF({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),gF({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),gF({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6});function bF(e){let t=function(e){const t=()=>{};return t.enabled=!1,t.color="",t.diff=0,t.log=()=>{},t.namespace=e,t.destroy=()=>!0,t.extend=()=>t,t}("".concat(e,":trace"));return cf().enabled("".concat(e,":trace"))&&null!=cf().names.map((e=>e.toString())).find((e=>e.includes(":trace")))&&(t=cf()("".concat(e,":trace"))),Object.assign(cf()(e),{error:cf()("".concat(e,":error")),trace:t})}cf().formatters.b=e=>null==e?"undefined":mF.baseEncode(e),cf().formatters.t=e=>null==e?"undefined":yF.baseEncode(e),cf().formatters.m=e=>null==e?"undefined":vF.baseEncode(e),cf().formatters.p=e=>null==e?"undefined":e.toString(),cf().formatters.c=e=>null==e?"undefined":e.toString(),cf().formatters.k=e=>null==e?"undefined":e.toString(),cf().formatters.a=e=>null==e?"undefined":e.toString();var wF=n(96118);const EF=async e=>{if(e.readyState>=2)throw new Error("socket closed");1!==e.readyState&&await new Promise(((t,n)=>{function r(){e.removeEventListener("open",i),e.removeEventListener("error",o)}function i(){r(),t()}function o(t){var i;r(),n(null!==(i=t.error)&&void 0!==i?i:new Error("connect ECONNREFUSED ".concat(e.url)))}e.addEventListener("open",i),e.addEventListener("error",o)}))},AF=(e,t)=>{var n;(t=null!==(n=t)&&void 0!==n?n:{}).closeOnEnd=!1!==t.closeOnEnd;return async n=>{for await(const t of n){try{await EF(e)}catch(r){if("socket closed"===r.message)break;throw r}if(e.readyState===e.CLOSING||e.readyState===e.CLOSED)break;e.send(t)}null!=t.closeOnEnd&&e.readyState<=1&&await new Promise(((t,n)=>{e.addEventListener("close",(e=>{if(e.wasClean||1006===e.code)t();else{const t=Object.assign(new Error("ws error"),{event:e});n(t)}})),setTimeout((()=>{e.close()}))}))}};var SF=n(3634);function _F(e){var t;return e instanceof ArrayBuffer||"ArrayBuffer"===(null===e||void 0===e||null===(t=e.constructor)||void 0===t?void 0:t.name)&&"number"===typeof(null===e||void 0===e?void 0:e.byteLength)}const IF=(e,t)=>{var n;t=null!==(n=t)&&void 0!==n?n:{};const r=(e=>{e.binaryType="arraybuffer";const t=async()=>{await new Promise(((t,n)=>{if(i)return void t();if(null!=r)return void n(r);const o=t=>{e.removeEventListener("open",s),e.removeEventListener("error",a),t()},s=()=>{o(t)},a=t=>{o((()=>{var r;n(null!==(r=t.error)&&void 0!==r?r:new Error("connect ECONNREFUSED ".concat(e.url)))}))};e.addEventListener("open",s),e.addEventListener("error",a)}))},n=async function*(){const n=new SF.zN((t=>{let{push:n,stop:r,fail:i}=t;const o=e=>{let t=null;"string"===typeof e.data&&(t=(0,mu.m)(e.data)),_F(e.data)&&(t=new Uint8Array(e.data)),e.data instanceof Uint8Array&&(t=e.data),null!=t&&n(t)},s=e=>{var t;i(null!==(t=e.error)&&void 0!==t?t:new Error("Socket error"))};return e.addEventListener("message",o),e.addEventListener("error",s),e.addEventListener("close",r),()=>{e.removeEventListener("message",o),e.removeEventListener("error",s),e.removeEventListener("close",r)}}),{highWaterMark:1/0});await t();for await(const e of n)yield _F(e)?new Uint8Array(e):e}();let r,i=1===e.readyState;return e.addEventListener("open",(()=>{i=!0,r=null})),e.addEventListener("close",(()=>{i=!1,r=null})),e.addEventListener("error",(t=>{var n;i||(r=null!==(n=t.error)&&void 0!==n?n:new Error("connect ECONNREFUSED ".concat(e.url)))})),Object.assign(n,{connected:t})})(e);let i=t.remoteAddress,o=t.remotePort;if(null!=e.url)try{const t=new URL(e.url);i=t.hostname,o=parseInt(t.port,10)}catch{}if(null==i||null==o)throw new Error("Remote connection did not have address and/or port");return{sink:AF(e,t),source:r,connected:async()=>{await r.connected()},close:async()=>{e.readyState!==e.CONNECTING&&e.readyState!==e.OPEN||await new Promise((t=>{e.addEventListener("close",(()=>{t()})),e.close()}))},destroy:()=>{null!=e.terminate?e.terminate():e.close()},remoteAddress:i,remotePort:o,socket:e}},CF=WebSocket;var TF=n(16791);const kF={http:"ws",https:"wss"};function RF(e,t){var n;t=null!==(n=t)&&void 0!==n?n:{};const r=((e,t)=>(0,TF.relative)(e,t,kF,"ws"))(e,("undefined"===typeof window?"":window.location).toString()),i=new CF(r,t.websocket);return IF(i,t)}class xF extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function PF(e,t,n){const r=null!==n&&void 0!==n?n:{},i=ld(e);return async function*(){let n;const o=()=>{null!=n&&n()};for(t.addEventListener("abort",o);;){let a;try{if(t.aborted){const{abortMessage:e,abortCode:t}=r;throw new xF(e,t)}const e=new Promise(((e,t)=>{n=()=>{const{abortMessage:e,abortCode:n}=r;t(new xF(e,n))}}));a=await Promise.race([e,i.next()]),n=null}catch(s){t.removeEventListener("abort",o);const n="aborted"===s.type&&t.aborted;if(n&&null!=r.onAbort&&r.onAbort(e),"function"===typeof i.return)try{const e=i.return();e instanceof Promise&&e.catch((e=>{null!=r.onReturnError&&r.onReturnError(e)}))}catch(s){null!=r.onReturnError&&r.onReturnError(s)}if(n&&!0===r.returnOnAbort)return;throw s}if(!0===a.done)break;yield a.value}t.removeEventListener("abort",o)}()}function DF(e,t,n){return r=>e(PF(r,t,n))}function OF(e,t,n){return{sink:DF(e.sink,t,{...n,onAbort:void 0}),source:PF(e.source,t,n)}}const NF=bF("libp2p:websockets:socket");let BF;const LF=bF("libp2p:websockets");BF=Symbol.toStringTag;class MF{constructor(e){(0,Yo.Z)(this,"init",void 0),(0,Yo.Z)(this,BF,"@libp2p/websockets"),(0,Yo.Z)(this,iF,!0),this.init=e}async dial(e,t){var n;LF("dialing %s",e),t=null!==(n=t)&&void 0!==n?n:{};const r=function(e,t,n){var r;const i={async sink(t){var r;null!=(null===(r=n)||void 0===r?void 0:r.signal)&&(t=PF(t,n.signal));try{await e.sink(t)}catch(i){"aborted"!==i.type&&NF.error(i)}},source:null!=(n=null!==(r=n)&&void 0!==r?r:{}).signal?PF(e.source,n.signal):e.source,remoteAddr:t,timeline:{open:Date.now()},async close(){var t;let n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};const r=Date.now();if(null==n.signal){const e=AbortSignal.timeout(500);n={...n,signal:e}}const o=()=>{const{host:e,port:t}=i.remoteAddr.toOptions();NF("timeout closing stream to %s:%s after %dms, destroying it manually",e,t,Date.now()-r),this.abort(new eF("Socket close timeout","ERR_SOCKET_CLOSE_TIMEOUT"))};null===(t=n.signal)||void 0===t||t.addEventListener("abort",o);try{await e.close()}catch(a){NF.error("error closing WebSocket gracefully",a),this.abort(a)}finally{var s;null===(s=n.signal)||void 0===s||s.removeEventListener("abort",o),i.timeline.close=Date.now()}},abort(t){const{host:n,port:r}=i.remoteAddr.toOptions();NF("timeout closing stream to %s:%s due to error",n,r,t),e.destroy(),i.timeline.close=Date.now()}};return e.socket.addEventListener("close",(()=>{null==i.timeline.close&&(i.timeline.close=Date.now())}),{once:!0}),i}(await this._connect(e,t),e);LF("new outbound connection %s",r.remoteAddr);const i=await t.upgrader.upgradeOutbound(r);return LF("outbound connection %s upgraded",r.remoteAddr),i}async _connect(e,t){var n;if(!0===(null===t||void 0===t||null===(n=t.signal)||void 0===n?void 0:n.aborted))throw new $U;const r=e.toOptions();LF("dialing %s:%s",r.host,r.port);const i=Ws(),o=RF((0,wF.k)(e),this.init);if(o.socket.addEventListener("error",(()=>{const t=new eF("Could not connect to ".concat(e.toString()),"ERR_CONNECTION_FAILED");LF.error("connection error:",t),i.reject(t)})),null==t.signal)return await Promise.race([o.connected(),i.promise]),LF("connected %s",e),o;let s;const a=new Promise(((e,n)=>{var r,i;s=()=>{n(new $U),o.close().catch((e=>{LF.error("error closing raw socket",e)}))},!0!==(null===t||void 0===t||null===(r=t.signal)||void 0===r?void 0:r.aborted)?null===t||void 0===t||null===(i=t.signal)||void 0===i||i.addEventListener("abort",s):s()}));try{await Promise.race([a,i.promise,o.connected()])}finally{var c;if(null!=s)null===t||void 0===t||null===(c=t.signal)||void 0===c||c.removeEventListener("abort",s)}return LF("connected %s",e),o}createListener(e){return function(){throw new Error("WebSocket Servers can not be created in the browser!")}(this.init)}filter(e){var t,n;return e=Array.isArray(e)?e:[e],null!=(null===(t=this.init)||void 0===t?void 0:t.filter)?null===(n=this.init)||void 0===n?void 0:n.filter(e):wO||_O?function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return Wx.matches(t)}))}(e):function(e){return e.filter((e=>{if(e.protoCodes().includes(290))return!1;const t=e.decapsulateCode(421);return qx.matches(t)||Wx.matches(t)}))}(e)}}function UF(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return()=>new MF(e)}function FF(e){return null!=e[Symbol.asyncIterator]}const KF=e=>{const t=Bs.P$(e),n=(0,Us.E)(t);return Bs.cv(e,n),KF.bytes=t,n};KF.bytes=0;var jF;!function(e){e[e.LENGTH=0]="LENGTH",e[e.DATA=1]="DATA"}(jF||(jF={}));const ZF=e=>{const t=Bs.Jx(e);return ZF.bytes=Bs.P$(t),t};function zF(e,t){var n,r,i;const o=new Zs;let s=jF.LENGTH,a=-1;const c=null!==(n=null===t||void 0===t?void 0:t.lengthDecoder)&&void 0!==n?n:ZF,l=null!==(r=null===t||void 0===t?void 0:t.maxLengthLength)&&void 0!==r?r:8,u=null!==(i=null===t||void 0===t?void 0:t.maxDataLength)&&void 0!==i?i:4194304;function*h(){for(;o.byteLength>0;){if(s===jF.LENGTH)try{if(a=c(o),a<0)throw Xo()(new Error("invalid message length"),"ERR_INVALID_MSG_LENGTH");if(a>u)throw Xo()(new Error("message length too long"),"ERR_MSG_DATA_TOO_LONG");const e=c.bytes;o.consume(e),null!=(null===t||void 0===t?void 0:t.onLength)&&t.onLength(a),s=jF.DATA}catch(e){if(e instanceof RangeError){if(o.byteLength>l)throw Xo()(new Error("message length length too long"),"ERR_MSG_LENGTH_TOO_LONG");break}throw e}if(s===jF.DATA){if(o.byteLength<a)break;const e=o.sublist(0,a);o.consume(a),null!=(null===t||void 0===t?void 0:t.onData)&&t.onData(e),yield e,s=jF.LENGTH}}}return FF(e)?async function*(){for await(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}():function*(){for(const t of e)o.append(t),yield*h();if(o.byteLength>0)throw Xo()(new Error("unexpected end of input"),"ERR_UNEXPECTED_EOF")}()}function VF(){const e=Ws();let t=!1;return{sink:async n=>{if(t)throw new Error("already piped");t=!0,e.resolve(n)},source:async function*(){const t=await e.promise;yield*t}()}}ZF.bytes=0,zF.fromReader=(e,t)=>{let n=1;return zF(async function*(){for(;;)try{const{done:t,value:r}=await e.next(n);if(!0===t)return;null!=r&&(yield r)}catch(t){if("ERR_UNDER_READ"===t.code)return{done:!0,value:null};throw t}finally{n=1}}(),{...null!==t&&void 0!==t?t:{},onLength:e=>{n=e}})};class HF{constructor(e){if((0,Yo.Z)(this,"buffer",void 0),(0,Yo.Z)(this,"mask",void 0),(0,Yo.Z)(this,"top",void 0),(0,Yo.Z)(this,"btm",void 0),(0,Yo.Z)(this,"next",void 0),!(e>0)||0!==(e-1&e))throw new Error("Max size for a FixedFIFO should be a power of two");this.buffer=new Array(e),this.mask=e-1,this.top=0,this.btm=0,this.next=null}push(e){return void 0===this.buffer[this.top]&&(this.buffer[this.top]=e,this.top=this.top+1&this.mask,!0)}shift(){const e=this.buffer[this.btm];if(void 0!==e)return this.buffer[this.btm]=void 0,this.btm=this.btm+1&this.mask,e}isEmpty(){return void 0===this.buffer[this.btm]}}class qF{constructor(){var e;let t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,Yo.Z)(this,"size",void 0),(0,Yo.Z)(this,"hwm",void 0),(0,Yo.Z)(this,"head",void 0),(0,Yo.Z)(this,"tail",void 0),this.hwm=null!==(e=t.splitLimit)&&void 0!==e?e:16,this.head=new HF(this.hwm),this.tail=this.head,this.size=0}calculateSize(e){return null!=(null===e||void 0===e?void 0:e.byteLength)?e.byteLength:1}push(e){if(null!=(null===e||void 0===e?void 0:e.value)&&(this.size+=this.calculateSize(e.value)),!this.head.push(e)){const t=this.head;this.head=t.next=new HF(2*this.head.buffer.length),this.head.push(e)}}shift(){var e;let t=this.tail.shift();if(void 0===t&&null!=this.tail.next){const e=this.tail.next;this.tail.next=null,this.tail=e,t=this.tail.shift()}return null!=(null===(e=t)||void 0===e?void 0:e.value)&&(this.size-=this.calculateSize(t.value)),t}isEmpty(){return this.head.isEmpty()}}class GF extends Error{constructor(e,t){super(null!==e&&void 0!==e?e:"The operation was aborted"),(0,Yo.Z)(this,"type",void 0),(0,Yo.Z)(this,"code",void 0),this.type="aborted",this.code=null!==t&&void 0!==t?t:"ABORT_ERR"}}function WF(){return QF((e=>{const t=e.shift();if(null==t)return{done:!0};if(null!=t.error)throw t.error;return{done:!0===t.done,value:t.value}}),arguments.length>0&&void 0!==arguments[0]?arguments[0]:{})}function QF(e,t){var n;let r,i,o,s=(t=null!==(n=t)&&void 0!==n?n:{}).onEnd,a=new qF,c=Ws();const l=e=>null!=i?i(e):(a.push(e),r),u=e=>{var n;if(o)return r;if(!0!==(null===(n=t)||void 0===n?void 0:n.objectMode)&&null==(null===e||void 0===e?void 0:e.byteLength))throw new Error("objectMode was not true but tried to push non-Uint8Array value");return l({done:!1,value:e})},h=e=>o?r:(o=!0,null!=e?(e=>(a=new qF,null!=i?i({error:e}):(a.push({error:e}),r)))(e):l({done:!0}));if(r={[Symbol.asyncIterator](){return this},next:async()=>{try{return a.isEmpty()?o?{done:!0}:await new Promise(((t,n)=>{i=o=>{i=null,a.push(o);try{t(e(a))}catch(s){n(s)}return r}})):e(a)}finally{a.isEmpty()&&queueMicrotask((()=>{c.resolve(),c=Ws()}))}},return:()=>(a=new qF,h(),{done:!0}),throw:e=>(h(e),{done:!0}),push:u,end:h,get readableLength(){return a.size},onEmpty:async e=>{const t=null===e||void 0===e?void 0:e.signal;if(null===t||void 0===t||t.throwIfAborted(),a.isEmpty())return;let n,r;null!=t&&(n=new Promise(((e,n)=>{r=()=>{n(new GF)},t.addEventListener("abort",r)})));try{await Promise.race([c.promise,n])}finally{null!=r&&null!=t&&(null===t||void 0===t||t.removeEventListener("abort",r))}}},null==s)return r;const d=r;return r={[Symbol.asyncIterator](){return this},next:()=>d.next(),throw:e=>(d.throw(e),null!=s&&(s(e),s=void 0),{done:!0}),return:()=>(d.return(),null!=s&&(s(),s=void 0),{done:!0}),push:u,end:e=>(d.end(e),null!=s&&(s(e),s=void 0),r),get readableLength(){return d.readableLength},onEmpty:e=>d.onEmpty(e)},r}const YF=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];const r=[];for(const i of t)null==i[Symbol.asyncIterator]&&r.push(i);return r.length===t.length?function*(){for(const e of r)yield*e}():async function*(){const e=WF({objectMode:!0});Promise.resolve().then((async()=>{try{await Promise.all(t.map((async t=>{for await(const n of t)e.push(n)}))),e.end()}catch(n){e.end(n)}})),yield*e}()};const JF=function(){let e;for(var t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];for(;n.length>0;)e=n.shift()(e);return e},XF=e=>null!=(null===e||void 0===e?void 0:e[Symbol.asyncIterator]),$F=e=>null!=(null===e||void 0===e?void 0:e[Symbol.iterator]),eK=e=>null!=e&&(null!=e.sink&&null!=e.source),tK=e=>t=>{const n=e.sink(t);if(null!=(null===n||void 0===n?void 0:n.then)){const t=WF({objectMode:!0});let r;n.then((()=>{t.end()}),(e=>{t.end(e)}));const i=e.source;if(XF(i))r=async function*(){yield*i,t.end()};else{if(!$F(i))throw new Error("Unknown duplex source type - must be Iterable or AsyncIterable");r=function*(){yield*i,t.end()}}return YF(t,r())}return e.source};var nK,rK;const iK=65535,oK=Boolean(null===(nK=globalThis.process)||void 0===nK||null===(rK=nK.env)||void 0===rK?void 0:rK.DUMP_SESSION_KEYS),sK={hashSHA256:e=>cu(e),getHKDF(e,t){const n=$l(cu,t,e),r=nu(cu,n,void 0,96);return[r.subarray(0,32),r.subarray(32,64),r.subarray(64,96)]},generateX25519KeyPair(){const e=Ql.utils.randomPrivateKey();return{publicKey:Ql.getPublicKey(e),privateKey:e}},generateX25519KeyPairFromSeed:e=>({publicKey:Ql.getPublicKey(e),privateKey:e}),generateX25519SharedKey:(e,t)=>Ql.getSharedSecret(e,t),chaCha20Poly1305Encrypt:(e,t,n,r)=>uc(r,t,n).encrypt(e),chaCha20Poly1305Decrypt:(e,t,n,r,i)=>uc(r,t,n).decrypt(e,i)},aK=e=>{const t=(0,Us.E)(2);return new DataView(t.buffer,t.byteOffset,t.byteLength).setUint16(0,e,!1),t};aK.bytes=2;const cK=e=>{if(e.length<2)throw RangeError("Could not decode int16BE");return e instanceof Uint8Array?new DataView(e.buffer,e.byteOffset,e.byteLength).getUint16(0,!1):e.getUint16(0)};cK.bytes=2;class lK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=lK.code,this.type=lK.type}}(0,Yo.Z)(lK,"code","ABORT_ERR"),(0,Yo.Z)(lK,"type","aborted");class uK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=uK.code}}(0,Yo.Z)(uK,"code","ERR_UNEXPECTED_PEER");class hK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=hK.code}}(0,Yo.Z)(hK,"code","ERR_INVALID_CRYPTO_EXCHANGE");class dK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=dK.code}}(0,Yo.Z)(dK,"code","ERR_INVALID_CRYPTO_TRANSMISSION");class fK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"The operation was aborted"),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"type",void 0),this.code=fK.code,this.type=fK.type}}(0,Yo.Z)(fK,"code","ABORT_ERR"),(0,Yo.Z)(fK,"type","aborted");class pK extends Error{constructor(e,t,n){var r;super(e),(0,Yo.Z)(this,"code",void 0),(0,Yo.Z)(this,"props",void 0),this.code=t,this.name=null!==(r=null===n||void 0===n?void 0:n.name)&&void 0!==r?r:"CodeError",this.props=null!==n&&void 0!==n?n:{}}}class gK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Unexpected Peer"),(0,Yo.Z)(this,"code",void 0),this.code=gK.code}}(0,Yo.Z)(gK,"code","ERR_UNEXPECTED_PEER");class yK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto exchange"),(0,Yo.Z)(this,"code",void 0),this.code=yK.code}}(0,Yo.Z)(yK,"code","ERR_INVALID_CRYPTO_EXCHANGE");class mK extends Error{constructor(){super(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"Invalid crypto transmission"),(0,Yo.Z)(this,"code",void 0),this.code=mK.code}}(0,Yo.Z)(mK,"code","ERR_INVALID_CRYPTO_TRANSMISSION");var vK=function(e,t){if(e.length>=255)throw new TypeError("Alphabet too long");for(var n=new Uint8Array(256),r=0;r<n.length;r++)n[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==n[s])throw new TypeError(o+" is ambiguous");n[s]=i}var a=e.length,c=e.charAt(0),l=Math.log(a)/Math.log(256),u=Math.log(256)/Math.log(a);function h(e){if("string"!==typeof e)throw new TypeError("Expected String");if(0===e.length)return new Uint8Array;var t=0;if(" "!==e[t]){for(var r=0,i=0;e[t]===c;)r++,t++;for(var o=(e.length-t)*l+1>>>0,s=new Uint8Array(o);e[t];){var u=n[e.charCodeAt(t)];if(255===u)return;for(var h=0,d=o-1;(0!==u||h<i)&&-1!==d;d--,h++)u+=a*s[d]>>>0,s[d]=u%256>>>0,u=u/256>>>0;if(0!==u)throw new Error("Non-zero carry");i=h,t++}if(" "!==e[t]){for(var f=o-i;f!==o&&0===s[f];)f++;for(var p=new Uint8Array(r+(o-f)),g=r;f!==o;)p[g++]=s[f++];return p}}}return{encode:function(t){if(t instanceof Uint8Array||(ArrayBuffer.isView(t)?t=new Uint8Array(t.buffer,t.byteOffset,t.byteLength):Array.isArray(t)&&(t=Uint8Array.from(t))),!(t instanceof Uint8Array))throw new TypeError("Expected Uint8Array");if(0===t.length)return"";for(var n=0,r=0,i=0,o=t.length;i!==o&&0===t[i];)i++,n++;for(var s=(o-i)*u+1>>>0,l=new Uint8Array(s);i!==o;){for(var h=t[i],d=0,f=s-1;(0!==h||d<r)&&-1!==f;f--,d++)h+=256*l[f]>>>0,l[f]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");r=d,i++}for(var p=s-r;p!==s&&0===l[p];)p++;for(var g=c.repeat(n);p<s;++p)g+=e.charAt(l[p]);return g},decodeUnsafe:h,decode:function(e){var n=h(e);if(n)return n;throw new Error("Non-".concat(t," character"))}}};const bK=vK,wK=(new Uint8Array(0),e=>{if(e instanceof Uint8Array&&"Uint8Array"===e.constructor.name)return e;if(e instanceof ArrayBuffer)return new Uint8Array(e);if(ArrayBuffer.isView(e))return new Uint8Array(e.buffer,e.byteOffset,e.byteLength);throw new Error("Unknown type, must be binary type")});class EK{constructor(e,t,n){this.name=e,this.prefix=t,this.baseEncode=n}encode(e){if(e instanceof Uint8Array)return"".concat(this.prefix).concat(this.baseEncode(e));throw Error("Unknown type, must be binary type")}}class AK{constructor(e,t,n){if(this.name=e,this.prefix=t,void 0===t.codePointAt(0))throw new Error("Invalid prefix character");this.prefixCodePoint=t.codePointAt(0),this.baseDecode=n}decode(e){if("string"===typeof e){if(e.codePointAt(0)!==this.prefixCodePoint)throw Error("Unable to decode multibase string ".concat(JSON.stringify(e),", ").concat(this.name," decoder only supports inputs prefixed with ").concat(this.prefix));return this.baseDecode(e.slice(this.prefix.length))}throw Error("Can only multibase decode strings")}or(e){return _K(this,e)}}class SK{constructor(e){this.decoders=e}or(e){return _K(this,e)}decode(e){const t=e[0],n=this.decoders[t];if(n)return n.decode(e);throw RangeError("Unable to decode multibase string ".concat(JSON.stringify(e),", only inputs prefixed with ").concat(Object.keys(this.decoders)," are supported"))}}const _K=(e,t)=>new SK({...e.decoders||{[e.prefix]:e},...t.decoders||{[t.prefix]:t}});class IK{constructor(e,t,n,r){this.name=e,this.prefix=t,this.baseEncode=n,this.baseDecode=r,this.encoder=new EK(e,t,n),this.decoder=new AK(e,t,r)}encode(e){return this.encoder.encode(e)}decode(e){return this.decoder.decode(e)}}const CK=e=>{let{name:t,prefix:n,encode:r,decode:i}=e;return new IK(t,n,r,i)},TK=e=>{let{prefix:t,name:n,alphabet:r}=e;const{encode:i,decode:o}=bK(r,n);return CK({prefix:t,name:n,encode:i,decode:e=>wK(o(e))})},kK=e=>{let{name:t,prefix:n,bitsPerChar:r,alphabet:i}=e;return CK({prefix:n,name:t,encode:e=>((e,t,n)=>{const r="="===t[t.length-1],i=(1<<n)-1;let o="",s=0,a=0;for(let c=0;c<e.length;++c)for(a=a<<8|e[c],s+=8;s>n;)s-=n,o+=t[i&a>>s];if(s&&(o+=t[i&a<<n-s]),r)for(;o.length*n&7;)o+="=";return o})(e,i,r),decode:e=>((e,t,n,r)=>{const i={};for(let u=0;u<t.length;++u)i[t[u]]=u;let o=e.length;for(;"="===e[o-1];)--o;const s=new Uint8Array(o*n/8|0);let a=0,c=0,l=0;for(let u=0;u<o;++u){const t=i[e[u]];if(void 0===t)throw new SyntaxError("Non-".concat(r," character"));c=c<<n|t,a+=n,a>=8&&(a-=8,s[l++]=255&c>>a)}if(a>=n||255&c<<8-a)throw new SyntaxError("Unexpected end of data");return s})(e,i,r,t)})},RK=TK({name:"base58btc",prefix:"z",alphabet:"123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz"}),xK=TK({name:"base58flickr",prefix:"Z",alphabet:"123456789abcdefghijkmnopqrstuvwxyzABCDEFGHJKLMNPQRSTUVWXYZ"});var PK=function e(t,n,r){n=n||[];var i=r=r||0;for(;t>=NK;)n[r++]=255&t|DK,t/=128;for(;t&OK;)n[r++]=255&t|DK,t>>>=7;return n[r]=0|t,e.bytes=r-i+1,n},DK=128,OK=-128,NK=Math.pow(2,31);var BK=function e(t,n){var r,i=0,o=0,s=n=n||0,a=t.length;do{if(s>=a)throw e.bytes=0,new RangeError("Could not decode varint");r=t[s++],i+=o<28?(r&MK)<<o:(r&MK)*Math.pow(2,o),o+=7}while(r>=LK);return e.bytes=s-n,i},LK=128,MK=127;var UK=Math.pow(2,7),FK=Math.pow(2,14),KK=Math.pow(2,21),jK=Math.pow(2,28),ZK=Math.pow(2,35),zK=Math.pow(2,42),VK=Math.pow(2,49),HK=Math.pow(2,56),qK=Math.pow(2,63);const GK={encode:PK,decode:BK,encodingLength:function(e){return e<UK?1:e<FK?2:e<KK?3:e<jK?4:e<ZK?5:e<zK?6:e<VK?7:e<HK?8:e<qK?9:10}},WK=function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return[GK.decode(e,t),GK.decode.bytes]},QK=function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return GK.encode(e,t,n),t},YK=e=>GK.encodingLength(e),JK=(e,t)=>{const n=t.byteLength,r=YK(e),i=r+YK(n),o=new Uint8Array(i+n);return QK(e,o,0),QK(n,o,r),o.set(t,i),new $K(e,n,t,o)},XK=e=>{const t=wK(e),[n,r]=WK(t),[i,o]=WK(t.subarray(r)),s=t.subarray(r+o);if(s.byteLength!==i)throw new Error("Incorrect length");return new $K(n,i,s,t)};class $K{constructor(e,t,n,r){this.code=e,this.size=t,this.digest=n,this.bytes=r}}const ej=wK,tj={code:0,name:"identity",encode:ej,digest:e=>JK(0,ej(e))},nj=e=>{let{name:t,code:n,encode:r}=e;return new rj(t,n,r)};class rj{constructor(e,t,n){this.name=e,this.code=t,this.encode=n}digest(e){if(e instanceof Uint8Array){const t=this.encode(e);return t instanceof Uint8Array?JK(this.code,t):t.then((e=>JK(this.code,e)))}throw Error("Unknown type, must be binary type")}}const ij=e=>async t=>new Uint8Array(await crypto.subtle.digest(e,t)),oj=nj({name:"sha2-256",code:18,encode:ij("SHA-256")}),sj=nj({name:"sha2-512",code:19,encode:ij("SHA-512")}),aj=32,cj=64,lj=32;function uj(e,t){const n=new Uint8Array(cj);for(let r=0;r<lj;r++)n[r]=e[r],n[lj+r]=t[r];return n}const hj=kK({prefix:"m",name:"base64",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",bitsPerChar:6}),dj=kK({prefix:"M",name:"base64pad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",bitsPerChar:6}),fj=kK({prefix:"u",name:"base64url",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",bitsPerChar:6}),pj=kK({prefix:"U",name:"base64urlpad",alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_=",bitsPerChar:6}),gj={get(){const e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:globalThis).crypto;if(null==e||null==e.subtle)throw Object.assign(new Error("Missing Web Crypto API. The most likely cause of this error is that this page is being accessed from an insecure context (i.e. not HTTPS). For more information and possible resolutions see https://github.com/libp2p/js-libp2p-crypto/blob/master/README.md#web-crypto-api"),{code:"ERR_MISSING_WEB_CRYPTO"});return e}},yj={alg:"A128GCM",ext:!0,k:"scm9jmO_4BJAgdwWGVulLg",key_ops:["encrypt","decrypt"],kty:"oct"};async function mj(e,t){const n=function(e){var t,n,r,i,o,s;const a=null!==(t=null===e||void 0===e?void 0:e.algorithm)&&void 0!==t?t:"AES-GCM";let c=null!==(n=null===e||void 0===e?void 0:e.keyLength)&&void 0!==n?n:16;const l=null!==(r=null===e||void 0===e?void 0:e.nonceLength)&&void 0!==r?r:12,u=null!==(i=null===e||void 0===e?void 0:e.digest)&&void 0!==i?i:"SHA-256",h=null!==(o=null===e||void 0===e?void 0:e.saltLength)&&void 0!==o?o:16,d=null!==(s=null===e||void 0===e?void 0:e.iterations)&&void 0!==s?s:32767,f=gj.get();return c*=8,{encrypt:async function(e,t){const n=f.getRandomValues(new Uint8Array(h)),r=f.getRandomValues(new Uint8Array(l)),i={name:a,iv:r};let o;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length){o=await f.subtle.importKey("jwk",yj,{name:"AES-GCM"},!0,["encrypt"]);try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}catch{o=await f.subtle.importKey("jwk",yj,{name:"AES-GCM"},!0,["encrypt"])}}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);o=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["encrypt"])}const s=await f.subtle.encrypt(i,o,e);return(0,Ls.z)([n,i.iv,new Uint8Array(s)])},decrypt:async function(e,t){const n=e.subarray(0,h),r=e.subarray(h,h+l),i=e.subarray(h+l),o={name:a,iv:r};let s;if("string"===typeof t&&(t=(0,mu.m)(t)),0===t.length)try{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}catch{s=await f.subtle.importKey("jwk",yj,{name:"AES-GCM"},!0,["decrypt"])}else{const e={name:"PBKDF2",salt:n,iterations:d,hash:{name:u}},r=await f.subtle.importKey("raw",t,{name:"PBKDF2"},!1,["deriveKey"]);s=await f.subtle.deriveKey(e,r,{name:a,length:c},!0,["decrypt"])}const p=await f.subtle.decrypt(o,s,i);return new Uint8Array(p)}}}(),r=await n.encrypt(e,t);return hj.encode(r)}var vj,bj,wj,Ej;!function(e){e.RSA="RSA",e.Ed25519="Ed25519",e.Secp256k1="Secp256k1"}(vj||(vj={})),function(e){e[e.RSA=0]="RSA",e[e.Ed25519=1]="Ed25519",e[e.Secp256k1=2]="Secp256k1"}(bj||(bj={})),function(e){e.codec=()=>bs(bj)}(vj||(vj={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),vj.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=vj.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(wj||(wj={})),function(e){let t;e.codec=()=>(null==t&&(t=ws((function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};!1!==n.lengthDelimited&&t.fork(),null!=e.Type&&(t.uint32(8),vj.codec().encode(e.Type,t)),null!=e.Data&&(t.uint32(18),t.bytes(e.Data)),!1!==n.lengthDelimited&&t.ldelim()}),((e,t)=>{const n={},r=null==t?e.len:e.pos+t;for(;e.pos<r;){const t=e.uint32();switch(t>>>3){case 1:n.Type=vj.codec().decode(e);break;case 2:n.Data=e.bytes();break;default:e.skipType(7&t)}}return n}))),t),e.encode=t=>fs(t,e.codec()),e.decode=t=>ds(t,e.codec())}(Ej||(Ej={}));class Aj{constructor(e){(0,Yo.Z)(this,"_key",void 0),this._key=kj(e,aj)}async verify(e,t){return async function(e,t,n){return Gl.verify(t,n,e)}(this._key,t,e)}marshal(){return this._key}get bytes(){return wj.encode({Type:vj.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await oj.digest(this.bytes);return e}}class Sj{constructor(e,t){(0,Yo.Z)(this,"_key",void 0),(0,Yo.Z)(this,"_publicKey",void 0),this._key=kj(e,cj),this._publicKey=kj(t,aj)}async sign(e){return async function(e,t){const n=e.subarray(0,lj);return Gl.sign(t,n)}(this._key,e)}get public(){return new Aj(this._publicKey)}marshal(){return this._key}get bytes(){return Ej.encode({Type:vj.Ed25519,Data:this.marshal()}).subarray()}equals(e){return(0,Ms.f)(this.bytes,e.bytes)}async hash(){const{bytes:e}=await oj.digest(this.bytes);return e}async id(){const e=tj.digest(this.public.bytes);return RK.encode(e.bytes).substring(1)}async export(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"libp2p-key";if("libp2p-key"===t)return mj(this.bytes,e);throw new pK("export format '".concat(t,"' is not supported"),"ERR_INVALID_EXPORT_FORMAT")}}function _j(e){if(e.length>cj){const t=(e=kj(e,cj+aj)).subarray(0,cj),n=e.subarray(cj,e.length);return new Sj(t,n)}const t=(e=kj(e,cj)).subarray(0,cj),n=e.subarray(aj);return new Sj(t,n)}function Ij(e){return e=kj(e,aj),new Aj(e)}async function Cj(){const{privateKey:e,publicKey:t}=await async function(){const e=Gl.utils.randomPrivateKey(),t=Gl.getPublicKey(e);return{privateKey:uj(e,t),publicKey:t}}();return new Sj(e,t)}async function Tj(e){const{privateKey:t,publicKey:n}=await async function(e){if(e.length!==lj)throw new TypeError('"seed" must be 32 bytes in length.');if(!(e instanceof Uint8Array))throw new TypeError('"seed" must be a node.js Buffer, or Uint8Array.');const t=e,n=Gl.getPublicKey(t);return{privat